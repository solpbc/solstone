<style>
/* Entity cards grid */
.entity-cards-container {
  background: white;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  padding: 1.5em;
}

.entity-type-group {
  margin-bottom: 1.5em;
}

.entity-type-group:last-child {
  margin-bottom: 0;
}

.entity-type-header {
  font-size: 0.85em;
  font-weight: 600;
  color: #6c757d;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-bottom: 0.75em;
  padding-bottom: 0.5em;
  border-bottom: 1px solid #e9ecef;
}

.entity-cards-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 0.75em;
}

.entity-card {
  background: #f8f9fa;
  border: 1px solid #e9ecef;
  border-radius: 8px;
  padding: 0.75em 1em;
  cursor: pointer;
  transition: all 0.15s;
  position: relative;
}

.entity-card:hover {
  background: #fff;
  border-color: var(--facet-color, #667eea);
  box-shadow: 0 2px 8px var(--facet-bg, rgba(102, 126, 234, 0.15));
}

.entity-card-name {
  font-weight: 500;
  color: #212529;
  margin-bottom: 0.25em;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.entity-card-meta {
  font-size: 0.8em;
  color: #6c757d;
  display: flex;
  align-items: center;
  gap: 0.5em;
}

.entity-card-meta .voiceprint-icon {
  color: var(--facet-color, #667eea);
}

.entity-card-obs-badge {
  position: absolute;
  top: 0;
  right: 0;
  background: color-mix(in srgb, var(--facet-color, #667eea) 25%, white);
  color: var(--facet-color, #667eea);
  font-size: 0.7em;
  font-weight: 600;
  min-width: 1.4em;
  height: 1.4em;
  padding: 0 0.4em;
  border-radius: 0 7px 0 6px;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Pending card state */
.entity-card-pending {
  opacity: 0.5;
  pointer-events: none;
  cursor: not-allowed;
}

/* Principal card state - the journal owner */
.entity-card-principal {
  background: linear-gradient(135deg, #fff9e6 0%, #fff4d6 100%);
  border-color: #f0c040;
}

.entity-card-principal:hover {
  border-color: #d4a012;
  box-shadow: 0 2px 8px rgba(212, 160, 18, 0.25);
}

.entity-card-principal-badge {
  position: absolute;
  top: 0;
  left: 0;
  background: linear-gradient(135deg, #f0c040 0%, #d4a012 100%);
  color: white;
  font-size: 0.65em;
  font-weight: 600;
  padding: 0.15em 0.5em;
  border-radius: 7px 0 6px 0;
}

/* Entity detail view */
.entity-detail-view {
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  overflow: hidden;
}

.entity-detail-header {
  padding: 1.5em;
  border-bottom: 1px solid #e9ecef;
}

.entity-detail-back {
  display: inline-flex;
  align-items: center;
  gap: 0.5em;
  color: var(--facet-color, #667eea);
  text-decoration: none;
  font-size: 0.9em;
  margin-bottom: 1em;
  cursor: pointer;
}

.entity-detail-back:hover {
  text-decoration: underline;
}

.entity-detail-title {
  display: flex;
  align-items: center;
  gap: 1em;
  margin-bottom: 0.5em;
}

.entity-detail-name {
  font-size: 1.5em;
  font-weight: 600;
  margin: 0;
}

.entity-detail-type {
  background: #e9ecef;
  color: #495057;
  padding: 0.25em 0.75em;
  border-radius: 20px;
  font-size: 0.75em;
  font-weight: 500;
}

.entity-detail-detached-badge {
  background: #ffc107;
  color: #212529;
  padding: 0.25em 0.75em;
  border-radius: 20px;
  font-size: 0.75em;
  font-weight: 500;
}

.entity-detail-principal-badge {
  background: linear-gradient(135deg, #fff9e6 0%, #f0c040 100%);
  color: #8b6914;
  padding: 0.25em 0.75em;
  border-radius: 20px;
  font-size: 0.75em;
  font-weight: 500;
}

/* Detached entity state - disable editing */
.entity-detail-view.detached .entity-detail-section {
  opacity: 0.6;
  pointer-events: none;
}

.entity-detail-view.detached .entity-detach-section {
  opacity: 1;
  pointer-events: auto;
}

.entity-detail-aka {
  color: #6c757d;
  font-size: 0.9em;
}

.entity-detail-indicators {
  display: flex;
  gap: 1em;
  margin-top: 0.75em;
  font-size: 0.85em;
  color: #6c757d;
}

.entity-detail-section {
  padding: 1.5em;
  border-bottom: 1px solid #e9ecef;
}

.entity-detail-section:last-child {
  border-bottom: none;
}

.entity-detail-section h4 {
  margin: 0 0 1em 0;
  font-size: 0.9em;
  font-weight: 600;
  color: #495057;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

/* Description section */
.entity-desc-display {
  color: #212529;
  line-height: 1.5;
}

.entity-desc-display.empty {
  color: #6c757d;
  font-style: italic;
}

.entity-desc-edit-container {
  display: flex;
  gap: 0.5em;
  align-items: flex-start;
}

.entity-desc-input {
  flex: 1;
  padding: 0.5em 0.75em;
  border: 1px solid #ced4da;
  border-radius: 6px;
  font-size: inherit;
  font-family: inherit;
  resize: vertical;
  min-height: 60px;
}

.entity-desc-input:focus {
  outline: none;
  border-color: var(--facet-color, #667eea);
  box-shadow: 0 0 0 3px var(--facet-bg, rgba(102, 126, 234, 0.1));
}

/* Edit form */
.entity-edit-form {
  display: grid;
  gap: 1em;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 0.5em;
}

.form-group label {
  font-weight: 500;
  color: #495057;
  font-size: 0.9em;
}

.form-group input,
.form-group select {
  padding: 0.5em 0.75em;
  border: 1px solid #ced4da;
  border-radius: 6px;
  font-size: inherit;
  font-family: inherit;
}

.form-group input:focus,
.form-group select:focus {
  outline: none;
  border-color: var(--facet-color, #667eea);
  box-shadow: 0 0 0 3px var(--facet-bg, rgba(102, 126, 234, 0.1));
}

.form-group small {
  color: #6c757d;
  font-size: 0.85em;
}

.form-actions {
  display: flex;
  gap: 0.5em;
  justify-content: flex-end;
  padding-top: 0.5em;
}

/* Observations list */
.observations-list {
  display: flex;
  flex-direction: column;
  gap: 0.75em;
}

.observation-item {
  background: #f8f9fa;
  border-radius: 6px;
  padding: 0.75em 1em;
}

.observation-content {
  color: #212529;
  margin-bottom: 0.25em;
}

.observation-meta {
  font-size: 0.8em;
  color: #6c757d;
}

.observations-empty {
  color: #6c757d;
  font-style: italic;
}

/* Detach/Re-attach section in detail view */
.entity-detach-section {
  padding: 1.5em;
  border-top: 1px solid #e9ecef;
  background: #fafafa;
}

/* Buttons */
.btn {
  padding: 0.5em 1em;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.9em;
  font-weight: 500;
  transition: all 0.15s;
}

.btn-primary {
  background: var(--facet-color, #667eea);
  color: white;
}

.btn-primary:hover {
  background: #5568d3;
}

.btn-primary:disabled {
  background: #adb5bd;
  cursor: not-allowed;
}

.btn-secondary {
  background: #e9ecef;
  color: #495057;
}

.btn-secondary:hover {
  background: #dee2e6;
}

.btn-danger {
  background: #dc3545;
  color: white;
}

.btn-danger:hover {
  background: #c82333;
}

.btn-sm {
  padding: 0.35em 0.75em;
  font-size: 0.85em;
}

.btn-icon {
  background: none;
  border: none;
  cursor: pointer;
  padding: 0.25em;
  font-size: 1.1em;
  transition: transform 0.15s;
}

.btn-icon:hover {
  transform: scale(1.15);
}

.btn-icon.generating {
  animation: spin 1s linear infinite;
}

/* Detected entities table */
.entities-container {
  background: white;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.entities-table {
  width: 100%;
  border-collapse: collapse;
}

.entities-table th,
.entities-table td {
  padding: 12px;
  text-align: left;
  border-bottom: 1px solid #e9ecef;
}

.entities-table th {
  background: #f8f9fa;
  font-weight: 600;
  color: #495057;
}

.entities-table tr:hover {
  background: #f8f9fa;
}

.entity-type {
  width: 120px;
  font-weight: 500;
  color: #6c757d;
}

.entity-name {
  font-weight: 500;
}

.entity-desc {
  color: #6c757d;
  position: relative;
}

.star-button {
  background: none;
  border: none;
  cursor: pointer;
  font-size: 1.5em;
  padding: 0;
  line-height: 1;
  transition: transform 0.2s;
  width: 40px;
  color: #ccc;
}

.star-button:hover {
  transform: scale(1.2);
  color: #ffc107;
}

.entity-delete-btn {
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  cursor: pointer;
  opacity: 0;
  transition: opacity 0.2s;
  font-size: 1em;
  background: white;
  padding: 2px 4px;
  border-radius: 4px;
}

tr:hover .entity-delete-btn {
  opacity: 0.6;
}

.entity-delete-btn:hover {
  opacity: 1 !important;
}

/* Section headers */
.entities-section {
  margin-bottom: 2em;
}

.entities-section h3 {
  padding: 1em 1.5em;
  margin: 0;
  background: #f8f9fa;
  border-bottom: 1px solid #e9ecef;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.no-entities {
  padding: 3em;
  text-align: center;
  color: #6c757d;
  font-style: italic;
}

.entity-search-input {
  max-width: 250px;
  padding: 6px 12px;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-size: 0.9em;
  font-family: inherit;
}

.entity-search-input:focus {
  outline: none;
  border-color: var(--facet-color, #667eea);
}

.detection-count-badge {
  margin-left: 8px;
  background: color-mix(in srgb, var(--facet-color, #1976d2) 15%, white);
  color: var(--facet-color, #1976d2);
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 0.8em;
  font-weight: 500;
}

/* Loading and states */
.no-facet-message {
  text-align: center;
  padding: 4em 2em;
  color: #666;
}

.no-facet-message h2 {
  color: #999;
  margin-bottom: 0.5em;
}

.entities-loading {
  text-align: center;
  padding: 4em;
  color: #666;
}

.spinner {
  display: inline-block;
  width: 40px;
  height: 40px;
  border: 4px solid #f0f0f0;
  border-top-color: var(--facet-color, #667eea);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 1em;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Modal styling */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: var(--app-bar-height, 60px);
  width: 100%;
  height: calc(100% - var(--app-bar-height, 60px));
  background: rgba(0,0,0,0.6);
  align-items: center;
  justify-content: center;
}

.modal-content {
  background: white;
  padding: 0;
  width: 90%;
  max-width: 500px;
  max-height: 80%;
  overflow: auto;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
}

.modal-header {
  padding: 1.5em;
  border-bottom: 1px solid #e9ecef;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.modal-header h3 {
  margin: 0;
  font-size: 1.25em;
}

.modal-header.danger h3 {
  color: #dc3545;
}

.modal-body {
  padding: 1.5em;
}

.modal-footer {
  padding: 1.5em;
  border-top: 1px solid #e9ecef;
  display: flex;
  gap: 0.5em;
  justify-content: flex-end;
}

.close {
  color: #aaa;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
  line-height: 20px;
}

.close:hover {
  color: #000;
}

.delete-warning {
  background: #fff3cd;
  border: 1px solid #ffc107;
  border-radius: 6px;
  padding: 12px;
  margin-bottom: 1em;
  color: #856404;
}

.delete-days-list {
  max-height: 200px;
  overflow-y: auto;
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 6px;
  padding: 12px;
  margin-top: 8px;
}

.delete-day-item {
  padding: 6px 0;
  border-bottom: 1px solid #dee2e6;
}

.delete-day-item:last-child {
  border-bottom: none;
}

/* Error message */
.error-message {
  color: #dc3545;
  background: #f8d7da;
  border: 1px solid #f5c6cb;
  border-radius: 6px;
  padding: 0.75em 1em;
  margin-bottom: 1em;
}
</style>

<div class="workspace-content">
  <div id="entities-loading" class="entities-loading">
    <div class="spinner"></div>
    <p>Loading entities...</p>
  </div>

  <div id="no-facet-message" class="no-facet-message" style="display: none;">
    <h2>Select a facet to view entities</h2>
    <p>Choose a facet from the pills above to see its entities.</p>
  </div>

  <!-- Main list view -->
  <div id="entities-list-view" style="display: none;">
    <!-- Facet Entities Section (Cards) -->
    <div class="entities-section">
      <div class="entity-cards-container">
        <div id="entity-cards-content"></div>
        <div id="no-facet-entities" class="no-entities" style="display: none;">
          No entities added to this facet yet. Star entities below to add them.
        </div>
      </div>
    </div>

    <!-- Detected Entities Section (Table) -->
    <div class="entities-section">
      <div class="entities-container">
        <h3 id="all-entities-title">
          <span>Detected Entities</span>
          <input type="text" id="entity-search" class="entity-search-input" placeholder="Search entities...">
        </h3>
        <table class="entities-table">
          <thead>
            <tr>
              <th></th>
              <th class="entity-type">Type</th>
              <th class="entity-name">Name</th>
              <th class="entity-desc">Description</th>
            </tr>
          </thead>
          <tbody id="all-entities-tbody">
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Entity detail view -->
  <div id="entity-detail-view" class="entity-detail-view" style="display: none;">
    <div class="entity-detail-header">
      <a class="entity-detail-back" onclick="navigateToList()">‚Üê Back to entities</a>
      <div class="entity-detail-title">
        <h2 class="entity-detail-name" id="detail-name"></h2>
        <span class="entity-detail-type" id="detail-type"></span>
      </div>
      <div class="entity-detail-aka" id="detail-aka"></div>
      <div class="entity-detail-indicators" id="detail-indicators"></div>
    </div>

    <div class="entity-detail-section">
      <h4>Description</h4>
      <div id="detail-description-container"></div>
    </div>

    <div class="entity-detail-section">
      <h4>Edit Entity</h4>
      <div id="detail-edit-error" class="error-message" style="display: none;"></div>
      <form class="entity-edit-form" id="detail-edit-form">
        <div class="form-group">
          <label for="detail-edit-name">Name</label>
          <input type="text" id="detail-edit-name" required>
        </div>
        <div class="form-group">
          <label for="detail-edit-type">Type</label>
          <select id="detail-edit-type">
            <option value="Person">Person</option>
            <option value="Organization">Organization</option>
            <option value="Project">Project</option>
            <option value="Tool">Tool</option>
            <option value="Location">Location</option>
            <option value="Event">Event</option>
          </select>
        </div>
        <div class="form-group">
          <label for="detail-edit-akas">Alternative Names (AKAs)</label>
          <input type="text" id="detail-edit-akas" placeholder="alias1, alias2, alias3">
          <small>Comma-separated list of alternative names for audio transcription</small>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn btn-primary" id="detail-save-btn">Save Changes</button>
        </div>
      </form>
    </div>

    <div class="entity-detail-section">
      <h4>Observations</h4>
      <div id="detail-observations"></div>
    </div>

    <div class="entity-detach-section">
      <button class="btn" id="detail-detach-btn"></button>
    </div>
  </div>
</div>

<!-- Delete Entity Confirmation Modal -->
<div id="deleteModal" class="modal">
  <div class="modal-content">
    <div class="modal-header danger">
      <h3>Delete Detected Entity</h3>
      <span class="close" onclick="closeDeleteModal()">&times;</span>
    </div>
    <div class="modal-body">
      <div class="delete-warning">
        ‚ö†Ô∏è This will permanently remove this entity from all detected day files. This action cannot be undone.
      </div>
      <p>Entity: <strong id="deleteEntityName"></strong></p>
      <div id="deleteDaysContainer" style="display: none;">
        <p>Found in <strong id="deleteDaysCount"></strong>:</p>
        <div class="delete-days-list" id="deleteDaysList"></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
      <button id="confirmDeleteBtn" class="btn btn-danger" onclick="confirmEntityDelete()">Delete</button>
    </div>
  </div>
</div>

<script>
let currentFacet = window.selectedFacet;
let entitiesData = null;
let currentDetailEntity = null;
const pendingEntities = new Map(); // agent_id ‚Üí { name, element }
const pendingAgentCallbacks = new Map(); // agent_id ‚Üí callback function

// Type display order for grouping entity cards
const TYPE_ORDER = ['Person', 'Organization', 'Project', 'Tool', 'Location', 'Event'];

// Parse YYYYMMDD string to Date object
function parseYYYYMMDD(dateStr) {
  const year = parseInt(dateStr.slice(0, 4));
  const month = parseInt(dateStr.slice(4, 6)) - 1;
  const day = parseInt(dateStr.slice(6, 8));
  return new Date(year, month, day);
}

// Format relative date (Today, Yesterday, Monday, Jan 15, Jan 15 '24)
// Matches Python convey/utils.py format_date_short()
function formatDateShort(dateStr) {
  if (!dateStr) return null;

  // Handle YYYYMMDD format
  if (!/^\d{8}$/.test(dateStr)) {
    return dateStr;
  }

  const date = parseYYYYMMDD(dateStr);

  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const dateNorm = new Date(date);
  dateNorm.setHours(0, 0, 0, 0);

  const diffDays = Math.round((dateNorm - today) / (1000 * 60 * 60 * 24));

  if (diffDays === 0) return 'Today';
  if (diffDays === -1) return 'Yesterday';
  if (diffDays === 1) return 'Tomorrow';
  if (diffDays >= -6 && diffDays < 0) {
    return date.toLocaleDateString('en-US', { weekday: 'long' });
  }

  // Default short format
  let short = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
  // Add year suffix if >6 months ago AND different year
  const monthsAgo = (today.getFullYear() - date.getFullYear()) * 12 + (today.getMonth() - date.getMonth());
  if (monthsAgo > 6 && date.getFullYear() !== today.getFullYear()) {
    short += " '" + String(date.getFullYear()).slice(-2);
  }
  return short;
}

// Format timestamp (epoch ms) to relative date
function formatTimestamp(epochMs) {
  if (!epochMs) return null;
  const date = new Date(epochMs);
  const dateStr = date.toISOString().slice(0, 10).replace(/-/g, '');
  return formatDateShort(dateStr);
}

// Get display date for entity using pre-computed last_active_ts from server
function getEntityDisplayDate(entity) {
  if (entity.last_active_ts) {
    return formatTimestamp(entity.last_active_ts);
  }
  return null;
}

// Listen for facet changes
window.addEventListener('facet.switch', (e) => {
  currentFacet = e.detail.facet;
  entitiesData = null;
  // Clear hash when switching facets
  if (location.hash) {
    history.pushState(null, '', location.pathname);
  }
  loadEntities();
});

// Hash-based routing
window.addEventListener('hashchange', handleHashChange);

function handleHashChange() {
  const hash = location.hash.slice(1);
  if (hash) {
    showDetailView(hash);
  } else {
    showListView();
  }
}

function navigateToEntity(entityId) {
  location.hash = entityId;
}

function navigateToList() {
  history.pushState(null, '', location.pathname);
  showListView();
}

function showListView() {
  document.getElementById('entities-list-view').style.display = 'block';
  document.getElementById('entity-detail-view').style.display = 'none';
  currentDetailEntity = null;
}

function showDetailView(entityId) {
  if (!currentFacet) return;

  document.getElementById('entities-list-view').style.display = 'none';
  document.getElementById('entity-detail-view').style.display = 'block';

  // Show loading state
  document.getElementById('detail-name').textContent = 'Loading...';
  document.getElementById('detail-type').textContent = '';
  document.getElementById('detail-aka').textContent = '';
  document.getElementById('detail-indicators').innerHTML = '';
  document.getElementById('detail-description-container').innerHTML = '<span class="entity-desc-display empty">Loading...</span>';
  document.getElementById('detail-observations').innerHTML = '<span class="observations-empty">Loading...</span>';

  // Fetch entity details
  fetch(`api/${encodeURIComponent(currentFacet)}/entity/${encodeURIComponent(entityId)}`)
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        throw new Error(data.error);
      }
      currentDetailEntity = data.entity;
      renderDetailView(data.entity, data.observations);
    })
    .catch(error => {
      console.error('Error loading entity:', error);
      document.getElementById('detail-name').textContent = 'Error';
      document.getElementById('detail-description-container').innerHTML =
        `<div class="error-message">${window.AppServices._escapeHtml(error.message)}</div>`;
    });
}

function renderDetailView(entity, observations) {
  const isDetached = entity.detached === true;
  const detailView = document.getElementById('entity-detail-view');

  // Toggle detached class on container
  if (isDetached) {
    detailView.classList.add('detached');
  } else {
    detailView.classList.remove('detached');
  }

  // Header
  document.getElementById('detail-name').textContent = entity.name;

  // Type badge and detached badge
  const typeEl = document.getElementById('detail-type');
  typeEl.textContent = entity.type;

  // Add or remove detached badge
  let detachedBadge = document.getElementById('detail-detached-badge');
  if (isDetached) {
    if (!detachedBadge) {
      detachedBadge = document.createElement('span');
      detachedBadge.id = 'detail-detached-badge';
      detachedBadge.className = 'entity-detail-detached-badge';
      detachedBadge.textContent = 'Detached';
      typeEl.parentNode.insertBefore(detachedBadge, typeEl.nextSibling);
    }
  } else if (detachedBadge) {
    detachedBadge.remove();
  }

  // Add or remove principal badge
  const isPrincipal = entity.is_principal === true;
  let principalBadge = document.getElementById('detail-principal-badge');
  if (isPrincipal) {
    if (!principalBadge) {
      principalBadge = document.createElement('span');
      principalBadge.id = 'detail-principal-badge';
      principalBadge.className = 'entity-detail-principal-badge';
      principalBadge.textContent = 'You';
      principalBadge.title = 'This is your entity in this facet';
      typeEl.parentNode.insertBefore(principalBadge, typeEl.nextSibling);
    }
  } else if (principalBadge) {
    principalBadge.remove();
  }

  // AKAs
  const akaEl = document.getElementById('detail-aka');
  if (entity.aka && entity.aka.length > 0) {
    akaEl.textContent = `Also known as: ${entity.aka.join(', ')}`;
  } else {
    akaEl.textContent = '';
  }

  // Indicators (last seen, voiceprint)
  const indicators = [];
  const displayDate = getEntityDisplayDate(entity);
  if (displayDate) {
    indicators.push(`Last active: ${displayDate}`);
  }
  if (entity.has_voiceprint) {
    indicators.push('üé§ Has voiceprint');
  }
  document.getElementById('detail-indicators').innerHTML = indicators.join(' ¬∑ ');

  // Description
  renderDescriptionSection(entity);

  // Edit form
  document.getElementById('detail-edit-name').value = entity.name;
  document.getElementById('detail-edit-type').value = entity.type;
  document.getElementById('detail-edit-akas').value = (entity.aka || []).join(', ');
  document.getElementById('detail-edit-error').style.display = 'none';

  // Observations
  const obsContainer = document.getElementById('detail-observations');
  if (observations && observations.length > 0) {
    obsContainer.innerHTML = '<div class="observations-list"></div>';
    const list = obsContainer.querySelector('.observations-list');
    observations.forEach(obs => {
      const item = document.createElement('div');
      item.className = 'observation-item';

      const content = document.createElement('div');
      content.className = 'observation-content';
      content.textContent = obs.content;

      const meta = document.createElement('div');
      meta.className = 'observation-meta';
      const metaParts = [];
      if (obs.source_day) {
        metaParts.push(formatDateShort(obs.source_day));
      }
      if (obs.observed_at) {
        const date = new Date(obs.observed_at);
        metaParts.push(date.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }));
      }
      meta.textContent = metaParts.join(' ¬∑ ');

      item.appendChild(content);
      item.appendChild(meta);
      list.appendChild(item);
    });
  } else {
    obsContainer.innerHTML = '<span class="observations-empty">No observations recorded yet.</span>';
  }

  // Detach/Re-attach button
  const detachBtn = document.getElementById('detail-detach-btn');
  if (isDetached) {
    detachBtn.textContent = 'Re-attach';
    detachBtn.className = 'btn btn-primary';
    detachBtn.onclick = () => reattachEntity(entity);
  } else {
    detachBtn.textContent = 'Detach';
    detachBtn.className = 'btn btn-danger';
    detachBtn.onclick = () => detachEntity(entity);
  }
}

function renderDescriptionSection(entity) {
  const container = document.getElementById('detail-description-container');
  container.innerHTML = '';

  const descSpan = document.createElement('span');
  descSpan.className = entity.description ? 'entity-desc-display' : 'entity-desc-display empty';
  descSpan.textContent = entity.description || 'No description. Click to add...';
  descSpan.style.cursor = 'pointer';
  descSpan.onclick = () => startDescriptionEdit(entity);

  container.appendChild(descSpan);
}

function startDescriptionEdit(entity) {
  const container = document.getElementById('detail-description-container');
  container.innerHTML = '';

  const editContainer = document.createElement('div');
  editContainer.className = 'entity-desc-edit-container';

  const textarea = document.createElement('textarea');
  textarea.className = 'entity-desc-input';
  textarea.value = entity.description || '';
  textarea.placeholder = 'Enter description...';

  const btnContainer = document.createElement('div');
  btnContainer.style.display = 'flex';
  btnContainer.style.flexDirection = 'column';
  btnContainer.style.gap = '0.25em';

  const generateBtn = document.createElement('button');
  generateBtn.type = 'button';
  generateBtn.className = 'btn-icon';
  generateBtn.textContent = '‚ú®';
  generateBtn.title = 'Generate with AI';

  const saveBtn = document.createElement('button');
  saveBtn.type = 'button';
  saveBtn.className = 'btn btn-primary btn-sm';
  saveBtn.textContent = 'Save';

  const cancelBtn = document.createElement('button');
  cancelBtn.type = 'button';
  cancelBtn.className = 'btn btn-secondary btn-sm';
  cancelBtn.textContent = 'Cancel';

  btnContainer.appendChild(generateBtn);
  btnContainer.appendChild(saveBtn);
  btnContainer.appendChild(cancelBtn);

  editContainer.appendChild(textarea);
  editContainer.appendChild(btnContainer);
  container.appendChild(editContainer);

  textarea.focus();

  // Event handlers
  saveBtn.onclick = () => saveDescription(entity, textarea.value.trim());
  cancelBtn.onclick = () => renderDescriptionSection(entity);

  textarea.onkeydown = (e) => {
    if (e.key === 'Escape') {
      e.preventDefault();
      renderDescriptionSection(entity);
    }
  };

  generateBtn.onclick = () => {
    textarea.disabled = true;
    generateBtn.classList.add('generating');

    fetch(`api/${encodeURIComponent(currentFacet)}/generate-description`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        type: entity.type,
        name: entity.name,
        current_description: textarea.value
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success && data.agent_id) {
        listenForAgentCompletion(data.agent_id, (result) => {
          if (result.success && result.response) {
            saveDescription(entity, result.response);
          } else {
            textarea.disabled = false;
            generateBtn.classList.remove('generating');
          }
        });
      } else {
        throw new Error(data.error || 'Failed to start generation');
      }
    })
    .catch(error => {
      console.error('Error generating description:', error);
      textarea.disabled = false;
      generateBtn.classList.remove('generating');
    });
  };
}

function saveDescription(entity, newDescription) {
  fetch(`api/${encodeURIComponent(currentFacet)}/description`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      name: entity.name,
      description: newDescription
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      entity.description = newDescription;
      currentDetailEntity.description = newDescription;
      renderDescriptionSection(entity);
    } else {
      throw new Error(data.error || 'Failed to save');
    }
  })
  .catch(error => {
    console.error('Error saving description:', error);
    alert('Error saving: ' + error.message);
  });
}

function detachEntity(entity) {
  fetch(`api/${encodeURIComponent(currentFacet)}`, {
    method: 'DELETE',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name: entity.name })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Go back to list view and refresh
      navigateToList();
      loadEntities();
    } else {
      throw new Error(data.error || 'Failed to detach');
    }
  })
  .catch(error => {
    console.error('Error detaching entity:', error);
    alert('Error: ' + error.message);
  });
}

function reattachEntity(entity) {
  fetch(`api/${encodeURIComponent(currentFacet)}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      type: entity.type,
      name: entity.name,
      description: entity.description || ''
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Update local state and re-render detail view
      delete entity.detached;
      delete currentDetailEntity.detached;
      // Reload to get fresh observations
      showDetailView(entity.id);
      loadEntities();  // Refresh list in background
    } else {
      throw new Error(data.error || 'Failed to re-attach');
    }
  })
  .catch(error => {
    console.error('Error re-attaching entity:', error);
    alert('Error: ' + error.message);
  });
}

// Edit form submission
document.addEventListener('DOMContentLoaded', function() {
  loadEntities();
  setupCortexListener();

  // Handle initial hash
  if (location.hash) {
    // Delay to allow entities to load first
    setTimeout(() => handleHashChange(), 100);
  }

  // Entity search
  const entitySearchInput = document.getElementById('entity-search');
  if (entitySearchInput) {
    entitySearchInput.addEventListener('input', function() {
      if (entitiesData) {
        renderEntities(this.value.trim());
      }
    });
  }

  // Entity assistant input (in app bar)
  const assistInput = document.getElementById('entity-assist-input');
  if (assistInput) {
    assistInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        submitEntityAssist();
      }
    });
  }

  // Edit form submission
  document.getElementById('detail-edit-form').addEventListener('submit', function(e) {
    e.preventDefault();
    saveEntityEdit();
  });

  // Modal close on outside click
  window.onclick = function(event) {
    const deleteModal = document.getElementById('deleteModal');
    if (event.target == deleteModal) {
      closeDeleteModal();
    }
  };
});

function loadEntities() {
  if (!currentFacet) {
    document.getElementById('entities-loading').style.display = 'none';
    document.getElementById('no-facet-message').style.display = 'block';
    document.getElementById('entities-list-view').style.display = 'none';
    document.getElementById('entity-detail-view').style.display = 'none';
    return;
  }

  document.getElementById('entities-loading').style.display = 'block';
  document.getElementById('no-facet-message').style.display = 'none';
  document.getElementById('entities-list-view').style.display = 'none';
  document.getElementById('entity-detail-view').style.display = 'none';

  fetch(`api/${encodeURIComponent(currentFacet)}`)
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        throw new Error(data.error);
      }

      entitiesData = {
        attached: data.attached || [],
        detected: data.detected || []
      };

      document.getElementById('entities-loading').style.display = 'none';

      // Check if we should show detail view
      if (location.hash) {
        handleHashChange();
      } else {
        showListView();
      }

      renderEntities();
    })
    .catch(error => {
      console.error('Error loading entities:', error);
      document.getElementById('entities-loading').innerHTML =
        `<div class="error-message">${window.AppServices._escapeHtml(error.message || 'Network error')}</div>`;
    });
}

function renderEntities(searchTerm = '') {
  if (!entitiesData) return;

  renderEntityCards();
  renderDetectedTable(searchTerm);
}

function renderEntityCards() {
  const container = document.getElementById('entity-cards-content');
  const noEntities = document.getElementById('no-facet-entities');

  // Preserve pending cards
  const pendingCards = Array.from(container.querySelectorAll('.entity-card-pending'));

  container.innerHTML = '';

  // Re-insert pending cards at top
  pendingCards.forEach(card => container.appendChild(card));

  const attached = entitiesData.attached || [];

  if (attached.length === 0 && pendingCards.length === 0) {
    noEntities.style.display = 'block';
    return;
  }

  noEntities.style.display = 'none';

  // Group by type
  const groups = {};
  attached.forEach(entity => {
    const type = entity.type || 'Other';
    if (!groups[type]) groups[type] = [];
    groups[type].push(entity);
  });

  // Render groups in order
  const orderedTypes = [...TYPE_ORDER, ...Object.keys(groups).filter(t => !TYPE_ORDER.includes(t))];

  orderedTypes.forEach(type => {
    const entities = groups[type];
    if (!entities || entities.length === 0) return;

    // Sort by activity date (most recent first) using server-computed timestamp
    entities.sort((a, b) => (b.last_active_ts || 0) - (a.last_active_ts || 0));

    const groupDiv = document.createElement('div');
    groupDiv.className = 'entity-type-group';

    const header = document.createElement('div');
    header.className = 'entity-type-header';
    header.textContent = pluralizeType(type);
    groupDiv.appendChild(header);

    const grid = document.createElement('div');
    grid.className = 'entity-cards-grid';

    entities.forEach(entity => {
      const card = createEntityCard(entity);
      grid.appendChild(card);
    });

    groupDiv.appendChild(grid);
    container.appendChild(groupDiv);
  });
}

function createEntityCard(entity) {
  const card = document.createElement('div');
  card.className = 'entity-card';

  // Principal styling for the journal owner
  if (entity.is_principal) {
    card.classList.add('entity-card-principal');

    // "You" badge (top-left corner)
    const principalBadge = document.createElement('div');
    principalBadge.className = 'entity-card-principal-badge';
    principalBadge.textContent = 'You';
    card.appendChild(principalBadge);
  }

  card.onclick = () => navigateToEntity(entity.id);

  // Observation count badge (top-right corner)
  if (entity.observation_count && entity.observation_count > 0) {
    const badge = document.createElement('div');
    badge.className = 'entity-card-obs-badge';
    badge.textContent = entity.observation_count;
    badge.title = `${entity.observation_count} observation${entity.observation_count > 1 ? 's' : ''}`;
    card.appendChild(badge);
  }

  // Name
  const name = document.createElement('div');
  name.className = 'entity-card-name';
  name.textContent = entity.name;
  card.appendChild(name);

  // Meta line (last seen, voiceprint)
  const meta = document.createElement('div');
  meta.className = 'entity-card-meta';

  // Date (last_seen ‚Üí updated_at ‚Üí attached_at)
  const displayDate = getEntityDisplayDate(entity);
  if (displayDate) {
    const textSpan = document.createElement('span');
    textSpan.textContent = displayDate;
    meta.appendChild(textSpan);
  }

  // Voiceprint icon
  if (entity.has_voiceprint) {
    const voiceIcon = document.createElement('span');
    voiceIcon.className = 'voiceprint-icon';
    voiceIcon.textContent = 'üé§';
    voiceIcon.title = 'Has voiceprint';
    meta.appendChild(voiceIcon);
  }

  if (meta.childNodes.length > 0) {
    card.appendChild(meta);
  }

  return card;
}

function createPendingCard(name, agentId) {
  const card = document.createElement('div');
  card.className = 'entity-card entity-card-pending';
  card.dataset.agentId = agentId;
  card.title = 'Processing...';

  const nameEl = document.createElement('div');
  nameEl.className = 'entity-card-name';
  nameEl.textContent = name;
  card.appendChild(nameEl);

  const meta = document.createElement('div');
  meta.className = 'entity-card-meta';
  meta.textContent = 'Adding...';
  card.appendChild(meta);

  return card;
}

function renderDetectedTable(searchTerm = '') {
  const tbody = document.getElementById('all-entities-tbody');
  tbody.innerHTML = '';

  const detected = entitiesData.detected || [];
  const attachedNames = new Set((entitiesData.attached || []).map(e => e.name));

  // Filter out already attached and apply search
  let filtered = detected.filter(e => !attachedNames.has(e.name));

  if (searchTerm) {
    const term = searchTerm.toLowerCase();
    filtered = filtered.filter(e => e.name.toLowerCase().includes(term));
  }

  filtered.forEach(entity => {
    const row = createDetectedRow(entity);
    tbody.appendChild(row);
  });
}

function createDetectedRow(entity) {
  const row = document.createElement('tr');

  // Star cell
  const starCell = document.createElement('td');
  const starBtn = document.createElement('button');
  starBtn.className = 'star-button';
  starBtn.textContent = '‚òÜ';
  starBtn.title = 'Add to facet';
  starBtn.onclick = () => attachDetectedEntity(entity, starBtn);
  starCell.appendChild(starBtn);
  row.appendChild(starCell);

  // Type
  const typeCell = document.createElement('td');
  typeCell.className = 'entity-type';
  typeCell.textContent = entity.type;
  row.appendChild(typeCell);

  // Name
  const nameCell = document.createElement('td');
  nameCell.className = 'entity-name';
  nameCell.textContent = entity.name;

  // Count badge
  if (entity.count && entity.count > 1) {
    const badge = document.createElement('span');
    badge.className = 'detection-count-badge';
    badge.textContent = `${entity.count} detections`;
    nameCell.appendChild(badge);
  }
  row.appendChild(nameCell);

  // Description
  const descCell = document.createElement('td');
  descCell.className = 'entity-desc';
  descCell.textContent = entity.description || '‚Äî';

  // Delete button
  const deleteBtn = document.createElement('span');
  deleteBtn.className = 'entity-delete-btn';
  deleteBtn.textContent = 'üóëÔ∏è';
  deleteBtn.title = 'Delete detected entity';
  deleteBtn.onclick = (e) => {
    e.stopPropagation();
    previewEntityDelete(entity.name);
  };
  descCell.appendChild(deleteBtn);
  row.appendChild(descCell);

  return row;
}

function attachDetectedEntity(entity, button) {
  button.disabled = true;
  button.style.opacity = '0.5';

  fetch(`api/${encodeURIComponent(currentFacet)}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      type: entity.type,
      name: entity.name,
      description: entity.description || ''
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Reload to get full entity data
      loadEntities();
    } else {
      throw new Error(data.error || 'Failed to attach');
    }
  })
  .catch(error => {
    console.error('Error attaching entity:', error);
    alert('Error: ' + error.message);
    button.disabled = false;
    button.style.opacity = '1';
  });
}

// Entity assist (add with AI)
function submitEntityAssist() {
  const input = document.getElementById('entity-assist-input');
  const name = input.value.trim();

  if (!name || !currentFacet) return;

  input.value = '';
  input.focus();

  // Create pending card
  const tempId = `temp-${Date.now()}`;
  const card = createPendingCard(name, tempId);

  // Insert at beginning of first type group or create new one
  const container = document.getElementById('entity-cards-content');
  const noEntities = document.getElementById('no-facet-entities');
  noEntities.style.display = 'none';

  // Insert at start
  if (container.firstChild) {
    container.insertBefore(card, container.firstChild);
  } else {
    container.appendChild(card);
  }

  pendingEntities.set(tempId, { name, element: card });

  fetch(`api/${encodeURIComponent(currentFacet)}/assist`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success && data.agent_id) {
      const pending = pendingEntities.get(tempId);
      if (pending) {
        pendingEntities.delete(tempId);
        pendingEntities.set(data.agent_id, pending);
        pending.element.dataset.agentId = data.agent_id;
      }
    } else {
      throw new Error(data.error || 'Failed to start assistant');
    }
  })
  .catch(error => {
    console.error('Error with entity assistant:', error);
    failPendingEntity(tempId, error.message);
  });
}

// Cortex event listener for agent operations
function setupCortexListener() {
  if (!window.appEvents) {
    console.warn('appEvents not available');
    return;
  }

  window.appEvents.listen('cortex', (msg) => {
    const agentId = msg.agent_id;
    if (!agentId) return;

    // Pending entity additions
    if (pendingEntities.has(agentId)) {
      if (msg.event === 'tool_end' && msg.tool === 'entity_attach') {
        const result = msg.result;
        if (result && result.entity) {
          updatePendingEntity(agentId, result.entity);
        }
      } else if (msg.event === 'finish') {
        completePendingEntity(agentId, msg.result);
      } else if (msg.event === 'error') {
        failPendingEntity(agentId, msg.error || 'Unknown error');
      }
    }

    // One-off callbacks (description generation)
    if (pendingAgentCallbacks.has(agentId)) {
      if (msg.event === 'finish') {
        const callback = pendingAgentCallbacks.get(agentId);
        pendingAgentCallbacks.delete(agentId);
        callback({ success: true, response: msg.result });
      } else if (msg.event === 'error') {
        const callback = pendingAgentCallbacks.get(agentId);
        pendingAgentCallbacks.delete(agentId);
        callback({ success: false, error: msg.error });
      }
    }
  });
}

function listenForAgentCompletion(agentId, callback) {
  if (!window.appEvents) {
    callback({ success: false, error: 'Events not available' });
    return;
  }
  pendingAgentCallbacks.set(agentId, callback);
}

function updatePendingEntity(agentId, entity) {
  const pending = pendingEntities.get(agentId);
  if (!pending) return;

  // Update display
  const nameEl = pending.element.querySelector('.entity-card-name');
  if (nameEl) nameEl.textContent = entity.name || pending.name;

  pending.entity = entity;
}

function completePendingEntity(agentId, agentMessage) {
  const pending = pendingEntities.get(agentId);
  if (!pending) return;

  if (pending.entity) {
    finalizePendingEntity(agentId, pending.entity);
    return;
  }

  // Fetch to check if entity was added
  fetch(`api/${encodeURIComponent(currentFacet)}`)
    .then(response => response.json())
    .then(data => {
      if (data.attached) {
        const entity = data.attached.find(e =>
          e.name.toLowerCase().includes(pending.name.toLowerCase()) ||
          pending.name.toLowerCase().includes(e.name.toLowerCase())
        );
        if (entity) {
          finalizePendingEntity(agentId, entity);
          return;
        }
      }
      failPendingEntity(agentId, agentMessage || 'Entity was not added');
    })
    .catch(error => {
      failPendingEntity(agentId, agentMessage || 'Failed to verify');
    });
}

function finalizePendingEntity(agentId, entity) {
  const pending = pendingEntities.get(agentId);
  if (!pending) return;

  // Add to local data
  if (entitiesData && entitiesData.attached) {
    const exists = entitiesData.attached.some(e => e.name === entity.name);
    if (!exists) {
      entitiesData.attached.unshift(entity);
    }
  }

  // Remove pending card and re-render
  pending.element.remove();
  pendingEntities.delete(agentId);
  renderEntityCards();
}

function failPendingEntity(agentId, error) {
  const pending = pendingEntities.get(agentId);
  if (!pending) return;

  // Show error state briefly then remove
  pending.element.classList.remove('entity-card-pending');
  pending.element.style.background = '#fee';
  pending.element.style.borderColor = '#fcc';
  pending.element.title = `Error: ${error}`;

  const meta = pending.element.querySelector('.entity-card-meta');
  if (meta) {
    meta.textContent = `Error: ${error}`;
    meta.style.color = '#c33';
  }

  pendingEntities.delete(agentId);

  // Remove after delay
  setTimeout(() => {
    pending.element.remove();
    if (entitiesData.attached.length === 0 && pendingEntities.size === 0) {
      document.getElementById('no-facet-entities').style.display = 'block';
    }
  }, 5000);
}

// Edit entity from detail view
function saveEntityEdit() {
  if (!currentDetailEntity) return;

  const nameInput = document.getElementById('detail-edit-name');
  const typeSelect = document.getElementById('detail-edit-type');
  const akasInput = document.getElementById('detail-edit-akas');
  const saveBtn = document.getElementById('detail-save-btn');
  const errorDiv = document.getElementById('detail-edit-error');

  const newName = nameInput.value.trim();
  const newType = typeSelect.value;
  const akaList = akasInput.value.trim();

  if (!newName) {
    errorDiv.textContent = 'Name is required';
    errorDiv.style.display = 'block';
    return;
  }

  saveBtn.disabled = true;
  saveBtn.textContent = 'Saving...';
  errorDiv.style.display = 'none';

  fetch(`api/${encodeURIComponent(currentFacet)}/update`, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      old_name: currentDetailEntity.name,
      new_name: newName,
      type: newType,
      aka_list: akaList
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Update current entity and re-render
      currentDetailEntity.name = newName;
      currentDetailEntity.type = newType;
      currentDetailEntity.aka = akaList ? akaList.split(',').map(s => s.trim()).filter(s => s) : [];

      document.getElementById('detail-name').textContent = newName;
      document.getElementById('detail-type').textContent = newType;
      document.getElementById('detail-aka').textContent =
        currentDetailEntity.aka.length > 0 ? `Also known as: ${currentDetailEntity.aka.join(', ')}` : '';

      // Update hash if name changed (id will change)
      const newId = data.entity.id;
      if (location.hash.slice(1) !== newId) {
        history.replaceState(null, '', `#${newId}`);
      }

      // Reload entities to update cards
      loadEntities();
    } else {
      throw new Error(data.error || 'Failed to update');
    }
  })
  .catch(error => {
    console.error('Error updating entity:', error);
    errorDiv.textContent = error.message;
    errorDiv.style.display = 'block';
  })
  .finally(() => {
    saveBtn.disabled = false;
    saveBtn.textContent = 'Save Changes';
  });
}

// Delete detected entity
function previewEntityDelete(entityName) {
  fetch(`api/${encodeURIComponent(currentFacet)}/detected/preview?name=${encodeURIComponent(entityName)}`)
    .then(response => response.json())
    .then(data => {
      if (data.success && data.days) {
        if (data.days.length === 1) {
          // Single detection - delete directly
          removeEntityFromUI(entityName);
          deleteEntity(entityName, true);
          return;
        }

        // Multiple - show modal
        const modal = document.getElementById('deleteModal');
        document.getElementById('deleteEntityName').textContent = entityName;
        document.getElementById('deleteDaysCount').textContent = `${data.days.length} days`;

        const daysList = document.getElementById('deleteDaysList');
        daysList.innerHTML = '';
        data.days.forEach(item => {
          const div = document.createElement('div');
          div.className = 'delete-day-item';
          div.innerHTML = `<strong>${item.day}</strong> - ${item.type}`;
          daysList.appendChild(div);
        });

        document.getElementById('deleteDaysContainer').style.display = 'block';
        document.getElementById('confirmDeleteBtn').dataset.entityName = entityName;
        modal.style.display = 'flex';
      }
    })
    .catch(error => {
      console.error('Error previewing delete:', error);
      alert('Error: ' + error.message);
    });
}

function closeDeleteModal() {
  document.getElementById('deleteModal').style.display = 'none';
}

function deleteEntity(entityName, skipReload = false) {
  return fetch(`api/${encodeURIComponent(currentFacet)}/detected`, {
    method: 'DELETE',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name: entityName })
  })
  .then(response => response.json())
  .then(data => {
    if (!data.success) throw new Error(data.error);
    if (!skipReload) loadEntities();
  });
}

function removeEntityFromUI(entityName) {
  if (entitiesData && entitiesData.detected) {
    entitiesData.detected = entitiesData.detected.filter(e => e.name !== entityName);
  }
  renderDetectedTable(document.getElementById('entity-search').value.trim());
}

function confirmEntityDelete() {
  const entityName = document.getElementById('confirmDeleteBtn').dataset.entityName;
  if (!entityName) return;

  closeDeleteModal();
  removeEntityFromUI(entityName);
  deleteEntity(entityName, true).catch(error => {
    console.error('Error deleting:', error);
    loadEntities();
  });
}

// Utility
function pluralizeType(type) {
  if (type === 'Person') return 'People';
  return type + 's';
}
</script>
