<style>
.todo-add-input {
  flex: 1;
  min-width: 0;
  padding: 0.75em 1em;
  border: 1px solid #d1d5db;
  border-radius: 20px;
  font-family: inherit;
  font-size: 14px;
  line-height: 1.5;
  transition: border-color 0.15s, box-shadow 0.15s;
}

.todo-add-input:focus {
  outline: none;
  border-color: var(--facet-color, #2563eb);
  box-shadow: 0 0 0 3px var(--facet-bg, rgba(37, 99, 235, 0.1));
}

.todo-add-input::placeholder {
  color: #9ca3af;
}

.todo-add-input:disabled {
  background: #f3f4f6;
  color: #9ca3af;
  cursor: not-allowed;
  opacity: 0.7;
}

.todo-add-input:disabled::placeholder {
  color: #d1d5db;
}

.appbar-generate-btn {
  display: none;
  align-items: center;
  justify-content: center;
  width: 2.5rem;
  height: 2.5rem;
  padding: 0;
  border: none;
  border-radius: 50%;
  background: transparent;
  font-size: 1.25rem;
  cursor: pointer;
  transition: transform 0.2s, background 0.15s;
}

.appbar-generate-btn:hover {
  background: rgba(0, 0, 0, 0.05);
  transform: scale(1.1);
}

.appbar-generate-btn.generating {
  animation: appbar-spin 2s linear infinite;
}

@keyframes appbar-spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.appbar-generate-btn.visible {
  display: inline-flex;
}
</style>

<!-- Use display:contents to make form invisible to flexbox -->
<form method="post" style="display: contents;">
  <input type="hidden" name="action" value="add">
  <input
    type="text"
    name="text"
    id="todo-add-input"
    class="todo-add-input"
    placeholder="{% if selected_facet %}Add a todo to {{ facets|selectattr('name', 'equalto', selected_facet)|map(attribute='title')|first|default(selected_facet) }}...{% else %}Add a todo... (use #facet){% endif %}"
    autocomplete="off"
  >
</form>

<!-- Generate button for single-facet mode -->
<button
  type="button"
  class="appbar-generate-btn{% if selected_facet %} visible{% endif %}"
  id="appbar-generate-btn"
  data-day="{{ day }}"
  title="Generate weekly todos with AI"
>✨</button>

<script>
(function() {
  const input = document.getElementById('todo-add-input');
  const form = input?.closest('form');
  if (!input || !form || input.disabled) return;

  function updatePlaceholder(facetName) {
    if (facetName) {
      const facetData = window.facetsData?.find(f => f.name === facetName);
      const facetTitle = facetData?.title || facetName;
      input.placeholder = `Add a todo to ${facetTitle}...`;
    } else {
      input.placeholder = 'Add a todo... (use #facet)';
    }
  }

  // Listen for facet selection changes
  window.addEventListener('facet.switch', (e) => {
    updatePlaceholder(e.detail.facet);
  });

  // Handle form submission via AJAX
  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const text = input.value.trim();
    if (!text) {
      input.focus();
      return;
    }

    // Capture form data BEFORE disabling (disabled inputs are excluded from FormData)
    const formData = new FormData(form);
    input.disabled = true;

    try {
      const response = await fetch(window.location.href, {
        method: 'POST',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        body: formData
      });

      const data = await response.json();

      if (response.ok && data.status === 'ok') {
        input.value = '';
        window.dispatchEvent(new CustomEvent('todo.added', { detail: data.todo }));
      } else {
        alert(data.message || 'Failed to add todo');
      }
    } catch (error) {
      alert('Network error - please try again');
    } finally {
      input.disabled = false;
      input.focus();
    }
  });
})();
</script>

<script>
(function() {
  const generateBtn = document.getElementById('appbar-generate-btn');
  if (!generateBtn) return;

  const day = generateBtn.dataset.day;
  let currentFacet = window.selectedFacet;
  let agentId = null;

  // Show/hide button based on facet selection
  function updateVisibility(facetName) {
    currentFacet = facetName;
    if (facetName) {
      generateBtn.classList.add('visible');
      // Reset state when switching facets
      resetButton();
    } else {
      generateBtn.classList.remove('visible');
    }
  }

  function resetButton() {
    generateBtn.textContent = '✨';
    generateBtn.classList.remove('generating', 'completed');
    agentId = null;
  }

  // Listen for facet selection changes
  window.addEventListener('facet.switch', (e) => {
    updateVisibility(e.detail.facet);
  });

  // Handle click
  generateBtn.addEventListener('click', async () => {
    if (!currentFacet) return;

    // If completed, clicking does nothing
    if (generateBtn.classList.contains('completed')) return;

    // If generating, could navigate to agent (future enhancement)
    if (generateBtn.classList.contains('generating')) return;

    // Start generation
    generateBtn.textContent = '⏳';
    generateBtn.classList.add('generating');

    try {
      const response = await fetch(`/app/todos/${day}/generate-weekly/${currentFacet}`, {
        method: 'POST'
      });

      if (!response.ok) {
        throw new Error('Failed to start generation');
      }

      const data = await response.json();
      agentId = data.agent_id;

    } catch (error) {
      alert('Failed to start todo generation');
      resetButton();
    }
  });

  // Listen for cortex events (agent completion)
  if (window.appEvents) {
    window.appEvents.listen('cortex', msg => {
      if (!agentId || msg.agent_id !== agentId) return;

      if (msg.event === 'finish') {
        generateBtn.textContent = '✅';
        generateBtn.classList.remove('generating');
        generateBtn.classList.add('completed');
      } else if (msg.event === 'error') {
        alert('Todo generation failed: ' + (msg.error || 'Unknown error'));
        resetButton();
      }
    });
  }
})();
</script>
