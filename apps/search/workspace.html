<style>
/* Layout */
.search-container {
  display: flex;
  gap: 1.5rem;
  min-height: 400px;
}

/* Sidebar */
.search-sidebar {
  width: 200px;
  flex-shrink: 0;
}

.search-sidebar h3 {
  font-size: 0.7rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: #6b7280;
  margin: 0 0 0.5rem 0;
}

.filter-section {
  margin-bottom: 1.25rem;
}

.filter-list {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.filter-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.35rem 0.5rem;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.9rem;
  transition: background 0.15s;
}

.filter-item:hover {
  background: #f3f4f6;
}

.filter-item.active {
  background: #e5e7eb;
  font-weight: 500;
}

.filter-item input[type="radio"] {
  margin: 0;
  accent-color: #2563eb;
}

.filter-label {
  flex: 1;
  min-width: 0;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.filter-count {
  font-size: 0.75rem;
  color: #9ca3af;
  flex-shrink: 0;
}

.filter-icon {
  font-size: 0.85rem;
}

/* Main content area */
.search-main {
  flex: 1;
  min-width: 0;
}

/* Search input */
.search-input-area {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1rem;
}

.search-input-area input[type="text"] {
  flex: 1;
  padding: 0.75rem 1rem;
  border-radius: 8px;
  border: 1px solid #d1d5db;
  font-family: inherit;
  font-size: 1rem;
  outline: none;
  box-sizing: border-box;
}

.search-input-area input[type="text"]:focus {
  border-color: #2563eb;
  box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.15);
}

.search-input-area button {
  padding: 0.75rem 1.25rem;
  background: #2563eb;
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 500;
  font-size: 0.95rem;
}

.search-input-area button:hover {
  background: #1d4ed8;
}

/* Results summary */
.search-summary {
  font-size: 0.85rem;
  color: #6b7280;
  margin-bottom: 1rem;
}

/* Day cards */
.day-card {
  background: white;
  border-radius: 8px;
  margin-bottom: 0.75rem;
  box-shadow: 0 1px 3px rgba(0,0,0,0.08);
  overflow: hidden;
}

.day-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0.75rem 1rem;
  background: #f9fafb;
  border-bottom: 1px solid #e5e7eb;
  cursor: pointer;
}

.day-header:hover {
  background: #f3f4f6;
}

.day-date {
  font-weight: 600;
  color: #111827;
}

.day-count {
  font-size: 0.8rem;
  color: #6b7280;
}

.day-results {
  padding: 0;
}

/* Result items */
.result-item {
  padding: 0.75rem 1rem;
  border-bottom: 1px solid #f3f4f6;
}

.result-item:last-child {
  border-bottom: none;
}

.result-meta {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.35rem;
  flex-wrap: wrap;
}

.result-topic {
  display: flex;
  align-items: center;
  gap: 0.25rem;
  font-size: 0.8rem;
  font-weight: 500;
  color: #374151;
}

.result-topic-icon {
  font-size: 0.9rem;
}

.result-facet {
  font-size: 0.7rem;
  padding: 0.15rem 0.4rem;
  border-radius: 3px;
  background: #f3f4f6;
  color: #6b7280;
}

.result-facet.has-color {
  color: white;
}

.result-text {
  font-size: 0.9rem;
  color: #4b5563;
  line-height: 1.5;
  /* Fill available space */
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.result-text strong {
  color: #111827;
  background: #fef3c7;
  padding: 0 2px;
  border-radius: 2px;
}

/* Show more button */
.show-more-btn {
  display: block;
  width: 100%;
  padding: 0.6rem;
  background: #f9fafb;
  border: none;
  border-top: 1px solid #e5e7eb;
  color: #2563eb;
  font-size: 0.85rem;
  cursor: pointer;
  text-align: center;
}

.show-more-btn:hover {
  background: #f3f4f6;
}

/* Load more days */
.load-more-days {
  display: block;
  width: 100%;
  padding: 0.75rem;
  background: white;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  color: #2563eb;
  font-size: 0.9rem;
  cursor: pointer;
  text-align: center;
  margin-top: 0.5rem;
}

.load-more-days:hover {
  background: #f9fafb;
}

/* Empty state */
.search-empty {
  text-align: center;
  padding: 3rem 1rem;
  color: #6b7280;
}

.search-empty-icon {
  font-size: 2.5rem;
  margin-bottom: 0.5rem;
}

.search-empty-text {
  font-size: 0.95rem;
}

/* Loading state */
.search-loading {
  text-align: center;
  padding: 2rem;
  color: #6b7280;
}

/* Responsive */
@media (max-width: 768px) {
  .search-container {
    flex-direction: column;
  }

  .search-sidebar {
    width: 100%;
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .filter-section {
    flex: 1;
    min-width: 150px;
    margin-bottom: 0.5rem;
  }

  .filter-list {
    flex-direction: row;
    flex-wrap: wrap;
  }

  .filter-item {
    flex: 0 0 auto;
  }
}
</style>

<div class="workspace-content-wide">
  <div class="search-container">
    <!-- Sidebar -->
    <aside class="search-sidebar">
      <div class="filter-section" id="facet-filters">
        <h3>Facets</h3>
        <div class="filter-list" id="facet-list">
          <label class="filter-item active">
            <input type="radio" name="facet" value="" checked>
            <span class="filter-label">All</span>
          </label>
        </div>
      </div>

      <div class="filter-section" id="topic-filters">
        <h3>Topics</h3>
        <div class="filter-list" id="topic-list">
          <!-- Populated dynamically -->
        </div>
      </div>
    </aside>

    <!-- Main content -->
    <main class="search-main">
      <form id="searchForm" class="search-input-area">
        <input id="query" type="text" placeholder="Search your journal..." autocomplete="off" />
        <button type="submit">Search</button>
      </form>

      <div class="search-summary" id="search-summary" style="display: none;"></div>

      <div id="results-container">
        <div class="search-empty" id="search-empty">
          <div class="search-empty-icon">üîç</div>
          <div class="search-empty-text">Enter a search term to find content in your journal</div>
        </div>
      </div>

      <button id="load-more-days" class="load-more-days" style="display: none;">
        Load more days
      </button>
    </main>
  </div>
</div>

<script>
(function() {
  const searchUrl = '{{ url_for("app:search.search_journal_api") }}';
  const dayResultsUrl = '{{ url_for("app:search.day_results_api") }}';
  const calendarDayBase = '{{ url_for("app:calendar.calendar_day", day="") }}';

  // State
  let currentQuery = '';
  let currentFacet = '';
  let currentTopic = '';
  let dayOffset = 0;

  // DOM elements
  const queryInput = document.getElementById('query');
  const resultsContainer = document.getElementById('results-container');
  const searchSummary = document.getElementById('search-summary');
  const searchEmpty = document.getElementById('search-empty');
  const loadMoreDaysBtn = document.getElementById('load-more-days');
  const facetList = document.getElementById('facet-list');
  const topicList = document.getElementById('topic-list');

  // Initialize
  queryInput.focus();
  loadFromHash();
  window.addEventListener('hashchange', loadFromHash);

  function loadFromHash() {
    const hashParams = new URLSearchParams(window.location.hash.slice(1));
    const q = hashParams.get('q') || '';
    const f = hashParams.get('facet') || '';
    const t = hashParams.get('topic') || '';

    if (q !== currentQuery || f !== currentFacet || t !== currentTopic) {
      currentQuery = q;
      currentFacet = f;
      currentTopic = t;
      queryInput.value = q;

      if (q) {
        doSearch(true);
      }
    }
  }

  function updateHash() {
    const params = new URLSearchParams();
    if (currentQuery) params.set('q', currentQuery);
    if (currentFacet) params.set('facet', currentFacet);
    if (currentTopic) params.set('topic', currentTopic);
    window.location.hash = params.toString();
  }

  // Search form submission
  document.getElementById('searchForm').onsubmit = function(e) {
    e.preventDefault();
    currentQuery = queryInput.value.trim();
    if (!currentQuery) return;
    dayOffset = 0;
    updateHash();
    doSearch(true);
  };

  // Load more days
  loadMoreDaysBtn.onclick = function() {
    dayOffset += 20;
    doSearch(false);
  };

  // Main search function
  function doSearch(reset) {
    if (!currentQuery) {
      showEmpty();
      return;
    }

    if (reset) {
      dayOffset = 0;
      resultsContainer.innerHTML = '<div class="search-loading">Searching...</div>';
    }

    const url = new URL(searchUrl, window.location.origin);
    url.searchParams.set('q', currentQuery);
    url.searchParams.set('offset', dayOffset);
    if (currentFacet) url.searchParams.set('facet', currentFacet);
    if (currentTopic) url.searchParams.set('topic', currentTopic);

    fetch(url)
      .then(r => r.json())
      .then(data => {
        if (reset) {
          resultsContainer.innerHTML = '';
          renderFilters(data.facets, data.topics);
        }

        renderResults(data, reset);
        updateSummary(data);
        updateLoadMoreButton(data);
      })
      .catch(err => {
        console.error('Search error:', err);
        resultsContainer.innerHTML = '<div class="search-empty"><div class="search-empty-text">Search failed. Please try again.</div></div>';
      });
  }

  function showEmpty() {
    resultsContainer.innerHTML = '';
    resultsContainer.appendChild(searchEmpty.cloneNode(true));
    searchSummary.style.display = 'none';
    loadMoreDaysBtn.style.display = 'none';
  }

  function renderFilters(facets, topics) {
    // Render facet filters
    let facetHtml = `
      <label class="filter-item ${!currentFacet ? 'active' : ''}">
        <input type="radio" name="facet" value="" ${!currentFacet ? 'checked' : ''}>
        <span class="filter-label">All</span>
      </label>
    `;

    for (const f of facets) {
      const isActive = currentFacet === f.name;
      const emoji = f.emoji ? `<span class="filter-icon">${f.emoji}</span>` : '';
      facetHtml += `
        <label class="filter-item ${isActive ? 'active' : ''}">
          <input type="radio" name="facet" value="${escapeHtml(f.name)}" ${isActive ? 'checked' : ''}>
          ${emoji}
          <span class="filter-label">${escapeHtml(f.title || f.name)}</span>
          <span class="filter-count">${f.count}</span>
        </label>
      `;
    }
    facetList.innerHTML = facetHtml;

    // Add facet change handlers
    facetList.querySelectorAll('input[type="radio"]').forEach(input => {
      input.onchange = function() {
        currentFacet = this.value;
        facetList.querySelectorAll('.filter-item').forEach(item => {
          item.classList.toggle('active', item.querySelector('input').value === currentFacet);
        });
        updateHash();
        doSearch(true);
      };
    });

    // Render topic filters (radio buttons for single-select)
    let topicHtml = `
      <label class="filter-item ${!currentTopic ? 'active' : ''}">
        <input type="radio" name="topic" value="" ${!currentTopic ? 'checked' : ''}>
        <span class="filter-label">All</span>
      </label>
    `;
    for (const t of topics) {
      const isActive = currentTopic === t.name;
      topicHtml += `
        <label class="filter-item ${isActive ? 'active' : ''}">
          <input type="radio" name="topic" value="${escapeHtml(t.name)}" ${isActive ? 'checked' : ''}>
          <span class="filter-icon">${t.icon}</span>
          <span class="filter-label">${escapeHtml(t.label)}</span>
          <span class="filter-count">${t.count}</span>
        </label>
      `;
    }
    topicList.innerHTML = topicHtml;

    // Add topic change handlers
    topicList.querySelectorAll('input[type="radio"]').forEach(input => {
      input.onchange = function() {
        currentTopic = this.value;
        topicList.querySelectorAll('.filter-item').forEach(item => {
          item.classList.toggle('active', item.querySelector('input').value === currentTopic);
        });
        updateHash();
        doSearch(true);
      };
    });
  }

  function renderResults(data, reset) {
    if (data.days.length === 0 && reset) {
      resultsContainer.innerHTML = `
        <div class="search-empty">
          <div class="search-empty-icon">üîç</div>
          <div class="search-empty-text">No results found for "${escapeHtml(currentQuery)}"</div>
        </div>
      `;
      return;
    }

    for (const dayData of data.days) {
      const card = createDayCard(dayData);
      resultsContainer.appendChild(card);
    }
  }

  function createDayCard(dayData) {
    const card = document.createElement('div');
    card.className = 'day-card';
    card.dataset.day = dayData.day;

    const header = document.createElement('div');
    header.className = 'day-header';
    header.innerHTML = `
      <span class="day-date">${escapeHtml(dayData.date)}</span>
      <span class="day-count">${dayData.total} match${dayData.total !== 1 ? 'es' : ''}</span>
    `;
    header.onclick = function() {
      window.location.href = calendarDayBase + dayData.day;
    };

    const resultsDiv = document.createElement('div');
    resultsDiv.className = 'day-results';

    for (const result of dayData.results) {
      resultsDiv.appendChild(createResultItem(result));
    }

    card.appendChild(header);
    card.appendChild(resultsDiv);

    // Show more button if needed
    if (dayData.has_more) {
      const showMoreBtn = document.createElement('button');
      showMoreBtn.className = 'show-more-btn';
      showMoreBtn.textContent = `Show ${dayData.total - dayData.showing} more`;
      showMoreBtn.onclick = function(e) {
        e.stopPropagation();
        loadMoreForDay(dayData.day, dayData.showing, resultsDiv, showMoreBtn);
      };
      card.appendChild(showMoreBtn);
    }

    return card;
  }

  function createResultItem(result) {
    const item = document.createElement('div');
    item.className = 'result-item';

    // Build facet badge
    let facetBadge = '';
    if (result.facet) {
      const style = result.facet_color
        ? `background: ${result.facet_color}; color: white;`
        : '';
      const hasColor = result.facet_color ? 'has-color' : '';
      const emoji = result.facet_emoji ? result.facet_emoji + ' ' : '';
      facetBadge = `<span class="result-facet ${hasColor}" style="${style}">${emoji}#${escapeHtml(result.facet)}</span>`;
    }

    item.innerHTML = `
      <div class="result-meta">
        <span class="result-topic">
          <span class="result-topic-icon">${result.topic_icon}</span>
          ${escapeHtml(result.topic_label)}
        </span>
        ${facetBadge}
      </div>
      <div class="result-text">${result.text}</div>
    `;

    return item;
  }

  function loadMoreForDay(day, currentOffset, resultsDiv, btn) {
    btn.textContent = 'Loading...';
    btn.disabled = true;

    const url = new URL(dayResultsUrl, window.location.origin);
    url.searchParams.set('q', currentQuery);
    url.searchParams.set('day', day);
    url.searchParams.set('offset', currentOffset);
    url.searchParams.set('limit', 20);
    if (currentFacet) url.searchParams.set('facet', currentFacet);
    if (currentTopic) url.searchParams.set('topic', currentTopic);

    fetch(url)
      .then(r => r.json())
      .then(data => {
        for (const result of data.results) {
          resultsDiv.appendChild(createResultItem(result));
        }

        const newOffset = currentOffset + data.results.length;
        const remaining = data.total - newOffset;

        if (remaining > 0) {
          btn.textContent = `Show ${remaining} more`;
          btn.disabled = false;
          btn.onclick = function(e) {
            e.stopPropagation();
            loadMoreForDay(day, newOffset, resultsDiv, btn);
          };
        } else {
          btn.remove();
        }
      })
      .catch(err => {
        console.error('Load more error:', err);
        btn.textContent = 'Error - click to retry';
        btn.disabled = false;
      });
  }

  function updateSummary(data) {
    if (data.total === 0) {
      searchSummary.style.display = 'none';
      return;
    }

    searchSummary.textContent = `${data.total} results across ${data.total_days} day${data.total_days !== 1 ? 's' : ''}`;
    searchSummary.style.display = 'block';
  }

  function updateLoadMoreButton(data) {
    const totalDays = data.total_days;
    const shownDays = dayOffset + data.showing_days;

    if (shownDays < totalDays) {
      loadMoreDaysBtn.textContent = `Load more days (${shownDays}/${totalDays})`;
      loadMoreDaysBtn.style.display = 'block';
    } else {
      loadMoreDaysBtn.style.display = 'none';
    }
  }

  function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
})();
</script>
