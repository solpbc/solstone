{# Calendar day view - events timeline #}

<style>
.day-view {
  position: relative;
  border-left: 60px solid transparent;
}

.hour-line {
  position: absolute;
  left: 0;
  right: 0;
  border-top: 1px solid #eee;
  font-size: 0.75em;
  color: #777;
}

.hour-line span {
  position: absolute;
  left: -55px;
  top: -0.6em;
}

.occ {
  position: absolute;
  left: 0;
  right: 0;
  border-radius: 4px;
  opacity: 0.9;
  display: block;
  text-decoration: none;
  cursor: pointer;
}

.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
}

.modal-content {
  background: white;
  margin: 5% auto;
  padding: 1em;
  border-radius: 8px;
  max-width: 600px;
  position: relative;
}

.close {
  position: absolute;
  top: 10px;
  right: 15px;
  cursor: pointer;
  font-size: 24px;
}

.occ-field {
  margin-bottom: 0.5em;
}

.occ-field strong {
  display: inline-block;
  width: 90px;
}

.occ-desc {
  margin-top: 0.5em;
  white-space: pre-wrap;
}

.events-empty {
  color: #666;
  font-style: italic;
  padding: 2em;
  text-align: center;
}
</style>

<div class="workspace-content-wide">
  <h1>{{ title }}</h1>
  <div id="eventsView">
    <div class="events-empty">Loading events...</div>
  </div>

  <div id="eventModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <div id="modalBody"></div>
    </div>
  </div>
</div>

<script src="{{ url_for('root.static', filename='colors.js') }}"></script>
<script>
(function() {
  const day = '{{ day }}';
  let allEvents = [];
  let events = [];

  function filterEventsByFacet(eventList) {
    const facet = window.selectedFacet;
    if (!facet) return eventList;
    return eventList.filter(e => e.facet === facet);
  }

  function escapeHtml(text) {
    const d = document.createElement('div');
    d.textContent = text;
    return d.innerHTML;
  }

  function renderEvents(list) {
    const div = document.getElementById('eventsView');
    if (!list.length) {
      div.innerHTML = '<div class="events-empty">No events for this day.</div>';
      return;
    }

    // Determine time range
    let start = Infinity, end = -Infinity;
    list.forEach(o => {
      if (!o.startTime) return;
      const s = new Date(o.startTime);
      const e = o.endTime ? new Date(o.endTime) : new Date(s.getTime() + 3600000);
      const startMinutes = s.getHours() * 60 + s.getMinutes();
      if (startMinutes === 0) return; // Skip midnight events
      start = Math.min(start, startMinutes);
      end = Math.max(end, e.getHours() * 60 + e.getMinutes());
    });

    let startHour = Math.max(Math.floor(start / 60) - 1, 0);
    let endHour = Math.min(Math.ceil(end / 60) + 1, 24);
    const pxPerHour = 66.7;

    let html = `<div class='day-view' style='height:${(endHour - startHour) * pxPerHour}px'>`;

    // Hour lines
    for (let h = startHour; h <= endHour; h++) {
      const label = h === 0 ? '12am' : h < 12 ? h + 'am' : h === 12 ? '12pm' : (h - 12) + 'pm';
      html += `<div class='hour-line' style='top:${((h - startHour) / (endHour - startHour)) * 100}%'><span>${label}</span></div>`;
    }

    // Process events for layout
    const processedEvents = [];
    const topics = [];

    list.forEach((o, idx) => {
      if (!o.startTime) return;
      const startTime = new Date(o.startTime);
      const endTime = o.endTime ? new Date(o.endTime) : new Date(startTime.getTime() + 5 * 60000);
      let s = startTime.getHours() * 60 + startTime.getMinutes();
      let e = endTime.getHours() * 60 + endTime.getMinutes();
      s = Math.max(s, startHour * 60);
      e = Math.min(e, endHour * 60);
      if (e <= s) return;

      const topic = o.topic || 'other';
      if (!topics.includes(topic)) topics.push(topic);

      processedEvents.push({
        startMinutes: s,
        endMinutes: e,
        topic: topic,
        title: escapeHtml(o.title || o.summary || topic),
        color: o.color || '#6c757d',
        index: idx
      });
    });

    // Group by topic and calculate columns
    const eventsByTopic = {};
    topics.forEach(topic => {
      eventsByTopic[topic] = processedEvents.filter(e => e.topic === topic);
      eventsByTopic[topic].sort((a, b) => a.startMinutes - b.startMinutes);
    });

    const topicColumnCounts = {};
    topics.forEach(topic => {
      const topicEvents = eventsByTopic[topic];
      const topicColumns = [];

      topicEvents.forEach(event => {
        let columnIndex = 0;
        while (columnIndex < topicColumns.length &&
               topicColumns[columnIndex].some(existing =>
                 event.startMinutes < existing.endMinutes &&
                 event.endMinutes > existing.startMinutes)) {
          columnIndex++;
        }
        if (columnIndex === topicColumns.length) topicColumns.push([]);
        topicColumns[columnIndex].push(event);
        event.slugColumn = columnIndex;
      });

      topicColumnCounts[topic] = topicColumns.length;
    });

    let globalColumnOffset = 0;
    const topicColumnOffsets = {};
    topics.forEach(topic => {
      topicColumnOffsets[topic] = globalColumnOffset;
      globalColumnOffset += topicColumnCounts[topic];
    });

    const totalColumns = globalColumnOffset;
    const columnWidth = totalColumns > 0 ? 100 / totalColumns : 100;

    processedEvents.forEach(event => {
      event.column = topicColumnOffsets[event.topic] + event.slugColumn;
    });

    // Render event boxes
    processedEvents.forEach(event => {
      const top = ((event.startMinutes - startHour * 60) / ((endHour - startHour) * 60)) * 100;
      const height = Math.max((event.endMinutes - event.startMinutes) / ((endHour - startHour) * 60) * 100, 0.4);
      const left = event.column * columnWidth;
      const width = columnWidth * 0.95;
      html += `<a class='occ' data-index='${event.index}' style='top:${top}%;height:${height}%;left:${left}%;width:${width}%;background:${event.color}' title='${event.title}'></a>`;
    });

    html += '</div>';
    div.innerHTML = html;
  }

  function fmtTime(ts) {
    const d = new Date(ts);
    let h = d.getHours();
    const m = d.getMinutes();
    const suf = h >= 12 ? 'p' : 'a';
    h = h % 12 || 12;
    return m ? `${h}:${String(m).padStart(2, '0')}${suf}` : `${h}${suf}`;
  }

  function fmtLength(start, end) {
    const s = new Date(start);
    const e = end ? new Date(end) : new Date(s.getTime() + 5 * 60000);
    const mins = Math.max(1, Math.round((e - s) / 60000));
    if (mins >= 60) {
      const h = Math.floor(mins / 60);
      const m = mins % 60;
      return m ? `${h}h ${m}m` : `${h}h`;
    }
    return `${mins}m`;
  }

  function openModal(idx) {
    const occ = events[idx];
    if (!occ) return;
    const body = document.getElementById('modalBody');

    const topic = occ.topic ? occ.topic.charAt(0).toUpperCase() + occ.topic.slice(1) : '';
    const titleText = `${topic ? topic + ': ' : ''}${occ.title || ''}`.trim();
    const subtitle = occ.subject || occ.summary || '';

    let html = '';
    if (titleText) html += `<h3>${escapeHtml(titleText)}</h3>`;
    if (subtitle) html += `<h4>${escapeHtml(subtitle)}</h4>`;
    if (occ.startTime) {
      const when = fmtTime(occ.startTime);
      const len = fmtLength(occ.startTime, occ.endTime);
      html += `<div class="occ-field"><strong>Started</strong> ${when} - ${len}</div>`;
    }
    if (occ.facet) {
      html += `<div class="occ-field"><strong>Facet</strong> ${escapeHtml(occ.facet)}</div>`;
    }
    if (Array.isArray(occ.participants) && occ.participants.length > 1) {
      html += `<div class="occ-field"><strong>Participants</strong> ${escapeHtml(occ.participants.join(', '))}</div>`;
    }
    if (occ.details) {
      const det = typeof occ.details === 'string' ? occ.details : JSON.stringify(occ.details, null, 2);
      html += `<div class="occ-desc">${escapeHtml(det)}</div>`;
    }
    body.innerHTML = html;
    document.getElementById('eventModal').style.display = 'block';
  }

  function applyFacetFilter() {
    events = filterEventsByFacet(allEvents);
    renderEvents(events);
  }

  function loadEvents() {
    fetch(`/app/calendar/api/day/${day}/events`)
      .then(r => r.json())
      .then(d => {
        allEvents = d || [];
        applyFacetFilter();
        document.getElementById('eventsView').onclick = e => {
          const el = e.target.closest('.occ');
          if (el) {
            e.preventDefault();
            openModal(parseInt(el.dataset.index));
          }
        };
      })
      .catch(() => {
        document.getElementById('eventsView').innerHTML = '<div class="events-empty">Failed to load events.</div>';
      });
  }

  // Listen for facet changes
  window.addEventListener('facet.switch', applyFacetFilter);

  // Modal close handlers
  document.querySelector('#eventModal .close').onclick = () => {
    document.getElementById('eventModal').style.display = 'none';
  };
  window.onclick = e => {
    const modal = document.getElementById('eventModal');
    if (e.target === modal) modal.style.display = 'none';
  };

  // Load events on init
  loadEvents();
})();
</script>
