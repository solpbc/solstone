{# Agents day view - historical agent runs browser #}

<style>
/* ============================================================================
   Layout & Navigation
   ============================================================================ */
.agents-content {
  padding: 0 1em;
}

.view-header {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-bottom: 1.5rem;
  padding-bottom: 0.75rem;
  border-bottom: 2px solid #e0e0e0;
}

.back-btn {
  background: none;
  border: 1px solid #ddd;
  border-radius: 6px;
  padding: 0.5rem 0.75rem;
  cursor: pointer;
  font-size: 1rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  color: #666;
  transition: all 0.2s;
}

.back-btn:hover {
  background: #f5f5f5;
  border-color: #ccc;
  color: #333;
}

.view-title {
  margin: 0;
  font-size: 1.25rem;
  font-weight: 600;
  color: #333;
}

/* ============================================================================
   Day Summary Bar
   ============================================================================ */
.day-summary {
  display: flex;
  gap: 1.5rem;
  padding: 0.5rem 0 1rem;
  font-size: 0.85rem;
  color: #666;
}

.day-summary .summary-item {
  display: flex;
  align-items: center;
  gap: 0.3rem;
}

.day-summary .summary-failed {
  color: #c62828;
}

/* ============================================================================
   Agent Card Grid
   ============================================================================ */
.agent-section {
  margin-bottom: 2rem;
}

.section-title {
  font-size: 0.85rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: #666;
  margin-bottom: 0.75rem;
  padding-bottom: 0.25rem;
  border-bottom: 1px solid #e0e0e0;
}

.agent-cards {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 1rem;
}

.agent-card {
  background: white;
  border: 2px solid #e0e0e0;
  border-left: 4px solid #6c757d;
  border-radius: 8px;
  padding: 1rem;
  cursor: pointer;
  transition: all 0.2s ease;
}

.agent-card:hover {
  border-color: #007bff;
  box-shadow: 0 2px 8px rgba(0, 123, 255, 0.15);
}

.agent-card-header {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  margin-bottom: 0.25rem;
}

.agent-card-title {
  font-weight: 600;
  color: #333;
  font-size: 1rem;
  margin: 0;
}

.agent-card-badges {
  display: flex;
  gap: 0.4rem;
  flex-shrink: 0;
}

.badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0.15rem 0.5rem;
  border-radius: 12px;
  font-size: 0.75rem;
  font-weight: 600;
}

.badge-success {
  background: #e8f5e9;
  color: #2e7d32;
}

.badge-failed {
  background: #ffebee;
  color: #c62828;
}

.agent-card-description {
  font-size: 0.8rem;
  color: #888;
  margin: 0 0 0.5rem;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.agent-card-caps {
  display: flex;
  gap: 0.4rem;
  margin-bottom: 0.5rem;
  flex-wrap: wrap;
}

.cap-badge {
  display: inline-flex;
  align-items: center;
  padding: 0.1rem 0.4rem;
  border-radius: 3px;
  font-size: 0.7rem;
  font-weight: 500;
  background: #f0f0f0;
  color: #777;
  letter-spacing: 0.02em;
}

.agent-card-activity {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 0.75rem;
  font-size: 0.8rem;
  color: #666;
}

.activity-counts {
  display: flex;
  gap: 0.75rem;
}

.facet-dots {
  display: flex;
  gap: 0.4rem;
  flex-shrink: 0;
}

.activity-item {
  display: flex;
  align-items: center;
  gap: 0.25rem;
}

.facet-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  display: inline-block;
  border: 1px solid rgba(0,0,0,0.1);
}

/* ============================================================================
   Run List View
   ============================================================================ */
.run-list-header {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-bottom: 1rem;
}

.preview-btn {
  background: #f8f9fa;
  border: 1px solid #ddd;
  border-radius: 6px;
  padding: 0.4rem 0.75rem;
  cursor: pointer;
  font-size: 0.85rem;
  color: #666;
  transition: all 0.2s;
  margin-left: auto;
}

.preview-btn:hover {
  background: #e9ecef;
  border-color: #ccc;
}

.runs-table {
  width: 100%;
  border-collapse: collapse;
}

.runs-table th,
.runs-table td {
  padding: 0.75rem 0.5rem;
  text-align: left;
  border-bottom: 1px solid #e0e0e0;
}

.runs-table th {
  font-weight: 600;
  color: #666;
  font-size: 0.85rem;
  text-transform: uppercase;
  letter-spacing: 0.03em;
}

.runs-table tr {
  cursor: pointer;
  transition: background 0.15s;
}

.runs-table tbody tr:hover {
  background: #f8f9fa;
}

.runs-table tr.expanded {
  background: #f0f7ff;
}

.runs-table tr.expanded:hover {
  background: #e8f0fe;
}

.col-status { width: 50px; text-align: center; }
.col-time { width: 100px; }
.col-model { width: 140px; }
.col-runtime { width: 80px; text-align: right; }
.col-activity { width: 50px; text-align: center; }
.col-facet { width: 120px; }
.col-prompt { }

.status-icon {
  font-size: 1.1rem;
}

.status-ok { color: #4caf50; }
.status-failed { color: #f44336; }
.status-running { color: #ff9800; }

.facet-tag {
  display: inline-flex;
  align-items: center;
  gap: 0.3rem;
  padding: 0.2rem 0.5rem;
  border-radius: 4px;
  font-size: 0.85rem;
  background: #f5f5f5;
}

.prompt-snippet {
  max-width: 400px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  color: #666;
  font-size: 0.9rem;
}

.model-name {
  font-size: 0.8rem;
  color: #888;
}

.error-preview {
  font-size: 0.75rem;
  color: #c62828;
  margin-top: 0.2rem;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  max-width: 400px;
}

/* ============================================================================
   Run Detail (Expanded Row)
   ============================================================================ */
.run-detail-row td {
  padding: 0;
  background: #fafafa;
  border-bottom: 2px solid #e0e0e0;
}

.run-detail-content {
  padding: 1rem;
  max-height: 500px;
  overflow-y: auto;
}

.run-detail-header {
  display: flex;
  gap: 1.5rem;
  margin-bottom: 1rem;
  padding-bottom: 0.75rem;
  border-bottom: 1px solid #e0e0e0;
  font-size: 0.9rem;
  color: #666;
}

.run-detail-header .detail-stat {
  display: flex;
  align-items: center;
  gap: 0.4rem;
}

.run-detail-content .markdown {
  font-size: 0.9rem;
  line-height: 1.6;
}

.run-detail-content .markdown pre {
  background: #f5f5f5;
  padding: 0.75rem;
  border-radius: 4px;
  overflow-x: auto;
}

.run-detail-content .markdown code {
  background: #f0f0f0;
  padding: 0.1rem 0.3rem;
  border-radius: 3px;
  font-size: 0.85em;
}

.run-detail-content .markdown pre code {
  background: none;
  padding: 0;
}

.run-loading {
  text-align: center;
  padding: 2rem;
  color: #666;
}

/* ============================================================================
   Preview Modal
   ============================================================================ */
.modal-backdrop {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.5);
  z-index: 1000;
}

.modal-backdrop.show {
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal-content {
  background: white;
  border-radius: 8px;
  width: 90%;
  max-width: 800px;
  max-height: 80vh;
  display: flex;
  flex-direction: column;
}

.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 1rem;
  border-bottom: 1px solid #e0e0e0;
}

.modal-title {
  margin: 0;
  font-size: 1.1rem;
  font-weight: 600;
}

.modal-close {
  background: none;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
  color: #666;
  padding: 0;
  line-height: 1;
}

.modal-close:hover {
  color: #333;
}

.modal-body {
  padding: 1rem;
  overflow-y: auto;
  flex: 1;
}

.modal-body pre {
  background: #f5f5f5;
  padding: 1rem;
  border-radius: 4px;
  overflow-x: auto;
  white-space: pre-wrap;
  word-wrap: break-word;
  font-size: 0.85rem;
  line-height: 1.5;
  margin: 0;
}

/* ============================================================================
   Empty States
   ============================================================================ */
.empty-state {
  text-align: center;
  padding: 3rem 1rem;
  color: #666;
}

.empty-state-icon {
  font-size: 3rem;
  margin-bottom: 1rem;
  opacity: 0.5;
}

.empty-state-text {
  font-size: 1.1rem;
  margin-bottom: 0.5rem;
}

.empty-state-hint {
  font-size: 0.9rem;
  color: #999;
}

/* ============================================================================
   Loading
   ============================================================================ */
.loading {
  text-align: center;
  padding: 3rem;
  color: #666;
}

.spinner {
  display: inline-block;
  width: 32px;
  height: 32px;
  border: 3px solid #e0e0e0;
  border-top-color: #007bff;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: 1rem;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}
</style>

<div class="agents-content">
  <!-- Loading state -->
  <div id="loading-view" class="loading">
    <div class="spinner"></div>
    <div>Loading agents...</div>
  </div>

  <!-- Card Grid View -->
  <div id="grid-view" style="display: none;">
    <div id="day-summary" class="day-summary" style="display: none;"></div>
    <div id="agent-groups"></div>
    <div id="empty-state" class="empty-state" style="display: none;">
      <div class="empty-state-icon">ü§ñ</div>
      <div class="empty-state-text">No agent runs on this day</div>
      <div class="empty-state-hint">Agent runs will appear here when they complete</div>
    </div>
  </div>

  <!-- Run List View -->
  <div id="list-view" style="display: none;">
    <div class="view-header">
      <button class="back-btn" onclick="showGridView()">
        <span>‚Üê</span> Back
      </button>
      <h2 class="view-title" id="list-view-title"></h2>
      <button class="preview-btn" id="preview-btn" onclick="showPreview()">
        View Prompt
      </button>
    </div>
    <div class="run-list-header">
      <span id="list-view-count"></span>
    </div>
    <table class="runs-table">
      <thead>
        <tr>
          <th class="col-status"></th>
          <th class="col-time">Time</th>
          <th class="col-model">Model</th>
          <th class="col-runtime">Runtime</th>
          <th class="col-activity" title="Thinking events">üí≠</th>
          <th class="col-activity" title="Tool calls">üîß</th>
          <th class="col-activity" title="Cost">üí∞</th>
          <th class="col-facet">Facet</th>
          <th class="col-prompt">Prompt</th>
        </tr>
      </thead>
      <tbody id="runs-tbody"></tbody>
    </table>
  </div>
</div>

<script src="{{ vendor_lib('marked') }}"></script>

<!-- Preview Modal -->
<div id="preview-modal" class="modal-backdrop">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title" id="preview-modal-title">Agent Prompt</h3>
      <button class="modal-close" onclick="hidePreview()">&times;</button>
    </div>
    <div class="modal-body">
      <pre id="preview-modal-content"></pre>
    </div>
  </div>
</div>

<script>
(function() {
  // State
  let currentDay = null;
  let currentName = null;
  let allRuns = [];
  let agentsMeta = {};
  let facetsMeta = {};
  let expandedRunId = null;
  let runDetailCache = {};

  // Get current day from URL path
  function getDayFromUrl() {
    const path = window.location.pathname;
    const match = path.match(/\/app\/agents\/(\d{8})$/);
    return match ? match[1] : null;
  }

  // Format timestamp to time string
  function formatTime(ts) {
    if (!ts) return '\u2014';
    const d = new Date(ts);
    return d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  }

  // Format runtime
  function formatRuntime(seconds) {
    if (seconds === null || seconds === undefined) return '\u2014';
    if (seconds < 60) return `${Math.round(seconds)}s`;
    const mins = Math.floor(seconds / 60);
    const secs = Math.round(seconds % 60);
    return `${mins}m ${secs}s`;
  }

  // Truncate text for display
  function truncate(text, maxLen = 80) {
    if (!text) return '\u2014';
    const clean = text.replace(/\s+/g, ' ').trim();
    if (clean.length <= maxLen) return clean;
    return clean.substring(0, maxLen) + '...';
  }

  // Format cost in cents with exact USD in title
  function formatCost(costUSD) {
    if (costUSD === null || costUSD === undefined) {
      return { text: '\u2014', title: '' };
    }
    const cents = Math.round(costUSD * 100);
    const exactUSD = '$' + costUSD.toFixed(4);
    return { text: cents + 'c', title: exactUSD };
  }

  // Shorten model name for display
  function formatModel(model) {
    if (!model) return '\u2014';
    // Strip common provider prefixes and date suffixes
    return model
      .replace(/^(models\/|accounts\/[^/]+\/models\/)/, '')
      .replace(/-\d{8}$/, '');
  }

  // =========================================================================
  // Grouping & Aggregation (moved from server)
  // =========================================================================

  function groupRunsByAgent(runs) {
    const groups = {};

    for (const run of runs) {
      const name = run.name;
      if (!groups[name]) {
        const meta = agentsMeta[name] || {};
        groups[name] = {
          name: name,
          title: meta.title || name,
          description: meta.description || null,
          color: meta.color || '#6c757d',
          source: meta.source || 'system',
          app: meta.app || null,
          schedule: meta.schedule || null,
          has_tools: meta.has_tools || false,
          has_output: meta.has_output || false,
          multi_facet: meta.multi_facet || false,
          run_count: 0,
          failed_count: 0,
          thinking_count: 0,
          tool_count: 0,
          total_cost: 0.0,
          facets: new Set(),
        };
      }

      const g = groups[name];
      g.run_count++;
      if (run.failed) g.failed_count++;
      g.thinking_count += (run.thinking_count || 0);
      g.tool_count += (run.tool_count || 0);
      if (run.cost != null) g.total_cost += run.cost;
      if (run.facet) g.facets.add(run.facet);
    }

    return groups;
  }

  function organizeGroups(groups) {
    const systemGroups = [];
    const appGroups = {};

    for (const group of Object.values(groups)) {
      if (group.source === 'system') {
        systemGroups.push(group);
      } else {
        const appName = group.app || 'unknown';
        if (!appGroups[appName]) appGroups[appName] = [];
        appGroups[appName].push(group);
      }
    }

    // Sort alphabetically by title
    const sortByTitle = (a, b) => a.title.toLowerCase().localeCompare(b.title.toLowerCase());
    systemGroups.sort(sortByTitle);
    for (const appName of Object.keys(appGroups)) {
      appGroups[appName].sort(sortByTitle);
    }

    return { system: systemGroups, apps: appGroups };
  }

  // =========================================================================
  // Data Loading
  // =========================================================================

  async function loadAgents() {
    currentDay = getDayFromUrl();
    if (!currentDay) return;

    document.getElementById('loading-view').style.display = 'block';
    document.getElementById('grid-view').style.display = 'none';
    document.getElementById('list-view').style.display = 'none';

    try {
      const response = await fetch(`api/agents/${currentDay}`);
      const data = await response.json();

      allRuns = data.runs || [];
      agentsMeta = data.agents || {};
      facetsMeta = data.facets || {};

      renderGridView();
    } catch (error) {
      console.error('Error loading agents:', error);
      document.getElementById('loading-view').innerHTML =
        '<div class="empty-state"><div class="empty-state-text">Error loading agents</div></div>';
    }
  }

  // =========================================================================
  // Grid View
  // =========================================================================

  function renderGridView() {
    document.getElementById('loading-view').style.display = 'none';
    document.getElementById('grid-view').style.display = 'block';
    document.getElementById('list-view').style.display = 'none';

    const container = document.getElementById('agent-groups');
    container.innerHTML = '';

    if (allRuns.length === 0) {
      document.getElementById('day-summary').style.display = 'none';
      document.getElementById('empty-state').style.display = 'block';
      return;
    }

    document.getElementById('empty-state').style.display = 'none';

    // Group and organize
    const groups = groupRunsByAgent(allRuns);
    const organized = organizeGroups(groups);

    // Render summary bar
    renderDaySummary(allRuns);

    // Render system agents
    if (organized.system.length > 0) {
      container.appendChild(renderSection('System Agents', organized.system));
    }

    // Render app agent sections
    const appNames = Object.keys(organized.apps).sort();
    for (const appName of appNames) {
      const title = appName.charAt(0).toUpperCase() + appName.slice(1);
      container.appendChild(renderSection(title, organized.apps[appName]));
    }
  }

  function renderDaySummary(runs) {
    const summary = document.getElementById('day-summary');
    const totalRuns = runs.length;
    const failedRuns = runs.filter(r => r.failed).length;
    let totalCost = 0;
    for (const r of runs) {
      if (r.cost != null) totalCost += r.cost;
    }

    const parts = [];
    parts.push(`<span class="summary-item">${totalRuns} run${totalRuns !== 1 ? 's' : ''}</span>`);
    if (failedRuns > 0) {
      parts.push(`<span class="summary-item summary-failed">${failedRuns} failed</span>`);
    }
    if (totalCost > 0) {
      const costInfo = formatCost(totalCost);
      parts.push(`<span class="summary-item" title="${costInfo.title}">üí∞ ${costInfo.text}</span>`);
    }

    summary.innerHTML = parts.join('');
    summary.style.display = totalRuns > 0 ? 'flex' : 'none';
  }

  // Render a section with cards
  function renderSection(title, agents) {
    const section = document.createElement('div');
    section.className = 'agent-section';

    const titleEl = document.createElement('h3');
    titleEl.className = 'section-title';
    titleEl.textContent = title;
    section.appendChild(titleEl);

    const grid = document.createElement('div');
    grid.className = 'agent-cards';

    for (const agent of agents) {
      grid.appendChild(renderCard(agent));
    }

    section.appendChild(grid);
    return section;
  }

  // Render an agent card
  function renderCard(agent) {
    const card = document.createElement('div');
    card.className = 'agent-card';
    card.style.borderLeftColor = agent.color;
    card.onclick = () => showRunList(agent.name);

    // Header with title and badges
    const header = document.createElement('div');
    header.className = 'agent-card-header';

    const title = document.createElement('h4');
    title.className = 'agent-card-title';
    title.textContent = agent.title;
    header.appendChild(title);

    const badges = document.createElement('div');
    badges.className = 'agent-card-badges';

    const successCount = agent.run_count - agent.failed_count;
    if (successCount > 0) {
      const successBadge = document.createElement('span');
      successBadge.className = 'badge badge-success';
      successBadge.textContent = successCount;
      badges.appendChild(successBadge);
    }

    if (agent.failed_count > 0) {
      const failBadge = document.createElement('span');
      failBadge.className = 'badge badge-failed';
      failBadge.textContent = agent.failed_count;
      badges.appendChild(failBadge);
    }

    header.appendChild(badges);
    card.appendChild(header);

    // Description
    if (agent.description) {
      const desc = document.createElement('p');
      desc.className = 'agent-card-description';
      desc.textContent = agent.description;
      desc.title = agent.description;
      card.appendChild(desc);
    }

    // Capability badges
    const caps = [];
    if (agent.schedule) caps.push(agent.schedule);
    if (agent.has_tools) caps.push('tools');
    if (agent.has_output && !agent.has_tools) caps.push('output');
    if (agent.multi_facet) caps.push('per-facet');

    if (caps.length > 0) {
      const capsRow = document.createElement('div');
      capsRow.className = 'agent-card-caps';
      for (const cap of caps) {
        const pill = document.createElement('span');
        pill.className = 'cap-badge';
        pill.textContent = cap;
        capsRow.appendChild(pill);
      }
      card.appendChild(capsRow);
    }

    // Activity row: counts on left, facet dots on right
    const hasActivity = agent.thinking_count > 0 || agent.tool_count > 0 || agent.total_cost > 0;
    const facetNames = Array.from(agent.facets);
    const hasFacetDots = facetNames.length > 0;

    if (hasActivity || hasFacetDots) {
      const activity = document.createElement('div');
      activity.className = 'agent-card-activity';

      const counts = document.createElement('div');
      counts.className = 'activity-counts';

      if (agent.thinking_count > 0) {
        const thinking = document.createElement('span');
        thinking.className = 'activity-item';
        thinking.innerHTML = `üí≠ ${agent.thinking_count}`;
        thinking.title = `${agent.thinking_count} thinking events`;
        counts.appendChild(thinking);
      }

      if (agent.tool_count > 0) {
        const tools = document.createElement('span');
        tools.className = 'activity-item';
        tools.innerHTML = `üîß ${agent.tool_count}`;
        tools.title = `${agent.tool_count} tool calls`;
        counts.appendChild(tools);
      }

      if (agent.total_cost > 0) {
        const costInfo = formatCost(agent.total_cost);
        const cost = document.createElement('span');
        cost.className = 'activity-item';
        cost.innerHTML = `üí∞ ${costInfo.text}`;
        cost.title = costInfo.title;
        counts.appendChild(cost);
      }

      activity.appendChild(counts);

      if (hasFacetDots) {
        const dots = document.createElement('div');
        dots.className = 'facet-dots';

        for (const facetName of facetNames) {
          const facet = facetsMeta[facetName];
          const dot = document.createElement('span');
          dot.className = 'facet-dot';
          dot.style.backgroundColor = (facet && facet.color) || '#999';
          dot.title = (facet && facet.title) || facetName;
          dots.appendChild(dot);
        }

        activity.appendChild(dots);
      }

      card.appendChild(activity);
    }

    return card;
  }

  // =========================================================================
  // Run List View
  // =========================================================================

  function showRunList(name) {
    currentName = name;
    expandedRunId = null;
    runDetailCache = {};

    document.getElementById('grid-view').style.display = 'none';
    document.getElementById('list-view').style.display = 'block';

    // Filter runs client-side
    const runs = allRuns.filter(r => r.name === name);
    const meta = agentsMeta[name] || {};
    const title = meta.title || name;
    const failedCount = runs.filter(r => r.failed).length;

    document.getElementById('list-view-title').textContent = title;
    document.getElementById('list-view-count').textContent =
      `${runs.length} run${runs.length !== 1 ? 's' : ''}` +
      (failedCount > 0 ? ` (${failedCount} failed)` : '');

    renderRunList(runs);
  }

  // Render the run list table
  function renderRunList(runs) {
    const tbody = document.getElementById('runs-tbody');
    tbody.innerHTML = '';

    if (runs.length === 0) {
      tbody.innerHTML = '<tr><td colspan="9" class="run-loading">No runs found</td></tr>';
      return;
    }

    for (const run of runs) {
      const row = document.createElement('tr');
      row.dataset.runId = run.id;
      row.onclick = () => toggleRunDetail(run.id);

      // Status
      const statusCell = document.createElement('td');
      statusCell.className = 'col-status';
      const statusIcon = document.createElement('span');
      statusIcon.className = 'status-icon';
      if (run.status === 'running') {
        statusIcon.className += ' status-running';
        statusIcon.textContent = '\u23f3';
        statusIcon.title = 'Running';
      } else if (run.failed) {
        statusIcon.className += ' status-failed';
        statusIcon.textContent = '\u2717';
        statusIcon.title = 'Failed';
      } else {
        statusIcon.className += ' status-ok';
        statusIcon.textContent = '\u2713';
        statusIcon.title = 'Completed';
      }
      statusCell.appendChild(statusIcon);
      row.appendChild(statusCell);

      // Time
      const timeCell = document.createElement('td');
      timeCell.className = 'col-time';
      timeCell.textContent = formatTime(run.start);
      row.appendChild(timeCell);

      // Model
      const modelCell = document.createElement('td');
      modelCell.className = 'col-model';
      const modelSpan = document.createElement('span');
      modelSpan.className = 'model-name';
      modelSpan.textContent = formatModel(run.model);
      modelSpan.title = run.model || '';
      modelCell.appendChild(modelSpan);
      row.appendChild(modelCell);

      // Runtime
      const runtimeCell = document.createElement('td');
      runtimeCell.className = 'col-runtime';
      runtimeCell.textContent = formatRuntime(run.runtime_seconds);
      row.appendChild(runtimeCell);

      // Thinking count
      const thinkingCell = document.createElement('td');
      thinkingCell.className = 'col-activity';
      thinkingCell.textContent = run.thinking_count || 0;
      row.appendChild(thinkingCell);

      // Tool count
      const toolCell = document.createElement('td');
      toolCell.className = 'col-activity';
      toolCell.textContent = run.tool_count || 0;
      row.appendChild(toolCell);

      // Cost
      const costCell = document.createElement('td');
      costCell.className = 'col-activity';
      const costInfo = formatCost(run.cost);
      costCell.textContent = costInfo.text;
      if (costInfo.title) costCell.title = costInfo.title;
      row.appendChild(costCell);

      // Facet
      const facetCell = document.createElement('td');
      facetCell.className = 'col-facet';
      if (run.facet) {
        const facet = facetsMeta[run.facet];
        const tag = document.createElement('span');
        tag.className = 'facet-tag';
        if (facet && facet.color) {
          const dot = document.createElement('span');
          dot.className = 'facet-dot';
          dot.style.backgroundColor = facet.color;
          tag.appendChild(dot);
        }
        tag.appendChild(document.createTextNode((facet && facet.title) || run.facet));
        facetCell.appendChild(tag);
      } else {
        facetCell.textContent = '\u2014';
      }
      row.appendChild(facetCell);

      // Prompt + error preview
      const promptCell = document.createElement('td');
      promptCell.className = 'col-prompt';
      const promptSpan = document.createElement('span');
      promptSpan.className = 'prompt-snippet';
      promptSpan.textContent = truncate(run.prompt);
      promptSpan.title = run.prompt || '';
      promptCell.appendChild(promptSpan);

      if (run.failed && run.error_message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-preview';
        errorDiv.textContent = run.error_message;
        errorDiv.title = run.error_message;
        promptCell.appendChild(errorDiv);
      }

      row.appendChild(promptCell);

      tbody.appendChild(row);
    }
  }

  // Toggle run detail expansion
  async function toggleRunDetail(runId) {
    const tbody = document.getElementById('runs-tbody');
    const existingDetail = tbody.querySelector(`tr.run-detail-row[data-run-id="${runId}"]`);
    const mainRow = tbody.querySelector(`tr[data-run-id="${runId}"]`);

    // Collapse if already expanded
    if (existingDetail) {
      existingDetail.remove();
      mainRow.classList.remove('expanded');
      expandedRunId = null;
      return;
    }

    // Collapse any other expanded row
    const oldDetail = tbody.querySelector('tr.run-detail-row');
    const oldMain = tbody.querySelector('tr.expanded');
    if (oldDetail) oldDetail.remove();
    if (oldMain) oldMain.classList.remove('expanded');

    // Create detail row
    expandedRunId = runId;
    mainRow.classList.add('expanded');

    const detailRow = document.createElement('tr');
    detailRow.className = 'run-detail-row';
    detailRow.dataset.runId = runId;

    const detailCell = document.createElement('td');
    detailCell.colSpan = 9;

    const content = document.createElement('div');
    content.className = 'run-detail-content';

    if (runDetailCache[runId]) {
      const cached = runDetailCache[runId];
      content.innerHTML = buildDetailContent(cached.html, cached.thinking_count, cached.tool_count, cached.cost);
    } else {
      content.innerHTML = '<div class="run-loading"><div class="spinner"></div><div>Loading...</div></div>';

      try {
        const response = await fetch(`api/run/${runId}`);
        const data = await response.json();

        if (data.error) {
          content.innerHTML = `<div class="run-loading">Error: ${data.error}</div>`;
        } else {
          const html = marked.parse(data.markdown || '', { breaks: true, gfm: true });
          runDetailCache[runId] = {
            html: html,
            thinking_count: data.thinking_count || 0,
            tool_count: data.tool_count || 0,
            cost: data.cost
          };
          content.innerHTML = buildDetailContent(html, data.thinking_count || 0, data.tool_count || 0, data.cost);
        }
      } catch (error) {
        content.innerHTML = `<div class="run-loading">Error loading run details</div>`;
      }
    }

    detailCell.appendChild(content);
    detailRow.appendChild(detailCell);
    mainRow.after(detailRow);
  }

  // Build detail content with header and markdown
  function buildDetailContent(html, thinkingCount, toolCount, cost) {
    const headerParts = [];
    if (thinkingCount > 0) {
      headerParts.push(`<span class="detail-stat">üí≠ ${thinkingCount} Thinking</span>`);
    }
    if (toolCount > 0) {
      headerParts.push(`<span class="detail-stat">üîß ${toolCount} Tool calls</span>`);
    }
    if (cost !== null && cost !== undefined) {
      const costInfo = formatCost(cost);
      headerParts.push(`<span class="detail-stat" title="${costInfo.title}">üí∞ ${costInfo.text} Cost</span>`);
    }

    let headerHtml = '';
    if (headerParts.length > 0) {
      headerHtml = `<div class="run-detail-header">${headerParts.join('')}</div>`;
    }

    return `${headerHtml}<div class="markdown">${html}</div>`;
  }

  // =========================================================================
  // Navigation & Modals
  // =========================================================================

  window.showGridView = function() {
    currentName = null;
    expandedRunId = null;
    document.getElementById('grid-view').style.display = 'block';
    document.getElementById('list-view').style.display = 'none';
  };

  window.showPreview = async function() {
    if (!currentName) return;

    const modal = document.getElementById('preview-modal');
    const content = document.getElementById('preview-modal-content');
    const title = document.getElementById('preview-modal-title');

    content.textContent = 'Loading...';
    modal.classList.add('show');

    try {
      const response = await fetch(`api/preview/${encodeURIComponent(currentName)}`);
      const data = await response.json();

      if (data.error) {
        content.textContent = `Error: ${data.error}`;
      } else {
        title.textContent = `${data.title} - Prompt`;
        content.textContent = data.full_prompt;
      }
    } catch (error) {
      content.textContent = 'Error loading prompt';
    }
  };

  window.hidePreview = function() {
    document.getElementById('preview-modal').classList.remove('show');
  };

  // Close modal on backdrop click
  document.getElementById('preview-modal').addEventListener('click', function(e) {
    if (e.target === this) {
      hidePreview();
    }
  });

  // Close modal on Escape
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      hidePreview();
    }
  });

  // Listen for facet changes
  window.addEventListener('facet.switch', () => {
    loadAgents();
  });

  // Initial load
  loadAgents();
})();
</script>
