{% extends 'base.html' %}
{% set title = 'Import' %}
{% set active = 'import' %}
{% block head %}
<style>
.container { padding:0 1em; }
#dropArea { border:2px dashed #999; padding:2em; text-align:center; margin-bottom:1em; cursor:pointer; }
#dropArea.dragover { background:#eef; border-color:#333; }
button { margin-top:1em; padding:6px 12px; }
button:disabled { background:#ccc; color:#666; cursor:not-allowed; opacity:0.6; }
.modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); }
.modal-content { background:white; margin:5% auto; padding:1em; border-radius:8px; max-width:800px; max-height:80vh; overflow:auto; position:relative; }
.close { position:absolute; top:10px; right:15px; cursor:pointer; font-size:24px; }
.spinner { display:inline-block; width:12px; height:12px; border:2px solid #ccc; border-top-color:#333; border-radius:50%; animation:spin 1s linear infinite; margin-left:4px; }
#taskOutput { white-space: pre-wrap; word-wrap: break-word; }
.confirm-fields { display: flex; gap: 1em; flex-wrap: wrap; margin-top: 0.5em; }
.confirm-field { display: flex; flex-direction: column; flex: 1 1 180px; min-width: 180px; }
.confirm-field label { font-size: 0.9em; color: #666; margin-bottom: 0.25em; }
.confirm-field input,
.confirm-field select { padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; background: white; }
.modal-actions { margin-top: 1em; display: flex; justify-content: flex-end; }

/* Import list styles */
.import-list { margin-top: 2em; }
.import-list h2 { margin-bottom: 1em; }
.import-table { width: 100%; border-collapse: collapse; }
.import-table th { background: #f5f5f5; text-align: left; padding: 8px; border-bottom: 2px solid #ddd; font-size: 0.9em; }
.import-table td { padding: 8px; border-bottom: 1px solid #eee; }
.import-table tr:hover { background: #f9f9f9; cursor: pointer; }
.import-status { display: inline-block; padding: 2px 8px; border-radius: 3px; font-size: 0.85em; }
.import-status.success { background: #d4edda; color: #155724; }
.import-status.pending { background: #fff3cd; color: #856404; }
.import-status.failed { background: #f8d7da; color: #721c24; }
.import-status.running { background: #cfe2ff; color: #084298; display: inline-flex; align-items: center; gap: 6px; }
.import-status.running::before { content: ''; display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #084298; animation: pulse 1.5s ease-in-out infinite; }
.progress-detail { font-size: 0.8em; color: #666; margin-top: 2px; }
.file-size { color: #666; font-size: 0.9em; }
.timestamp-link { color: #007bff; text-decoration: none; }
.timestamp-link:hover { text-decoration: underline; }
.no-imports { color: #666; font-style: italic; padding: 2em; text-align: center; }

@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

@keyframes spin { to { transform:rotate(360deg); } }
</style>
{% endblock %}
{% block body %}
<div class="container">
  <div class="tabs">
    <div class="tab active" data-target="media">Upload File</div>
    <div class="tab" data-target="paste">Paste Text</div>
  </div>
  <form id="importForm">
    <div class="content" id="media">
      <div id="dropArea">
        <p>Drag file here or click to select</p>
        <input id="fileInput" type="file" style="display:none" />
        <div id="fileLabel"></div>
      </div>
    </div>
    <div class="content" id="paste" style="display:none">
      <textarea id="pasteText" placeholder="Paste text here" style="width:100%; min-height:300px;"></textarea>
    </div>
    <button type="submit" id="submitBtn">Submit</button>
  </form>
  
  <div class="import-list">
    <h2>Import History</h2>
    <div id="importListContent">
      <div class="no-imports">Loading imports...</div>
    </div>
  </div>
</div>

<div id="detectModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <div class="confirm-fields">
      <div class="confirm-field">
        <label for="timestampInput">Timestamp</label>
        <input id="timestampInput" />
      </div>
      <div class="confirm-field">
        <label for="facetSelect">Facet</label>
        <select id="facetSelect">
          <option value="">None</option>
        </select>
      </div>
      <div class="confirm-field">
        <label for="settingInput">Setting</label>
        <input id="settingInput" placeholder="e.g. Jer lunch with Joe" />
      </div>
    </div>
    <input type="hidden" id="savedPath" />
    <div class="modal-actions">
      <button id="startBtn">Start Import</button>
    </div>
  </div>
</div>

<script>
const tabs = Array.from(document.querySelectorAll('.tab'));
const contents = document.querySelectorAll('.content');
let activeTab = 'media';
function showTab(id){
  tabs.forEach(t=>t.classList.toggle('active', t.dataset.target===id));
  contents.forEach(c=>{c.style.display=c.id===id?'block':'none';});
  activeTab = id;
}
tabs.forEach(t=>t.addEventListener('click', ()=>showTab(t.dataset.target)));

const dropArea = document.getElementById('dropArea');
const fileInput = document.getElementById('fileInput');
const fileLabel = document.getElementById('fileLabel');
const facetSelect = document.getElementById('facetSelect');
const settingInput = document.getElementById('settingInput');
const startBtn = document.getElementById('startBtn');
let currentFile = null;

dropArea.onclick = () => fileInput.click();
['dragenter','dragover'].forEach(ev=>dropArea.addEventListener(ev,e=>{e.preventDefault();dropArea.classList.add('dragover');}));
['dragleave','drop'].forEach(ev=>dropArea.addEventListener(ev,e=>{e.preventDefault();dropArea.classList.remove('dragover');if(ev==='drop'){}}));
dropArea.addEventListener('drop',e=>{const f=e.dataTransfer.files[0];if(f){currentFile=f;fileLabel.textContent=f.name;}});
fileInput.onchange=e=>{currentFile=e.target.files[0];if(currentFile)fileLabel.textContent=currentFile.name;};

document.getElementById('importForm').onsubmit=e=>{
  e.preventDefault();
  const submitBtn = document.getElementById('submitBtn');
  const originalText = submitBtn.textContent;
  
  // Disable button and show processing state
  submitBtn.disabled = true;
  submitBtn.innerHTML = 'Processing<span class="spinner"></span>';
  
  const fd=new FormData();
  if(activeTab==='media'){
    if(currentFile) fd.append('file', currentFile);
  } else {
    fd.append('text', document.getElementById('pasteText').value);
  }
  // Add selected facet
  const facet = facetSelect.value;
  if(facet) fd.append('facet', facet);
  const settingValue = settingInput.value.trim();
  if(settingValue) fd.append('setting', settingValue);
  fetch('{{ url_for('import_view.import_save') }}', {method:'POST', body:fd})
    .then(async r=>{
      const d=await r.json();
      // Re-enable button
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
      
      if(!r.ok){
        if(window.showError)showError(d.error||'Upload failed');
        return;
      }
      showDetect(d);
    })
    .catch(err=>{
      // Re-enable button on error
      submitBtn.disabled = false;
      submitBtn.textContent = originalText;
      if(window.showError)showError('Upload failed');
    });
};

function showDetect(res){
  document.getElementById('timestampInput').value=res.timestamp||'';
  document.getElementById('savedPath').value=res.path;
  if(res.facet !== undefined) {
    facetSelect.value = res.facet || '';
  }
  settingInput.value = res.setting || '';
  document.getElementById('detectModal').style.display='block';
}

function formatFileSize(bytes) {
  if (bytes === 0) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

function formatDuration(minutes) {
  if (!minutes) return '';
  const hours = Math.floor(minutes / 60);
  const mins = minutes % 60;
  if (hours > 0) {
    return `${hours}h ${mins}m`;
  }
  return `${mins}m`;
}

function formatElapsed(ms) {
  if (!ms) return '0s';
  const totalSeconds = Math.floor(ms / 1000);
  const mins = Math.floor(totalSeconds / 60);
  const secs = totalSeconds % 60;
  if (mins > 0) {
    return `${mins}m ${secs}s`;
  }
  return `${secs}s`;
}

function capitalizeStage(stage) {
  if (!stage) return '';
  return stage.charAt(0).toUpperCase() + stage.slice(1);
}

function loadImports(){
  fetch('{{ url_for('import_view.import_list') }}').then(r=>r.json()).then(imports=>{
    const container = document.getElementById('importListContent');

    if (!imports || imports.length === 0) {
      container.innerHTML = '<div class="no-imports">No imports found</div>';
      return;
    }

    let html = '<table class="import-table">';
    html += '<thead><tr>';
    html += '<th>Imported At</th>';
    html += '<th>File</th>';
    html += '<th>Size</th>';
    html += '<th>Imported To</th>';
    html += '<th>Status</th>';
    html += '<th>Files Created</th>';
    html += '<th>Duration</th>';
    html += '</tr></thead><tbody>';

    imports.forEach(imp => {
      // Use imported_at timestamp for display
      const importedAt = imp.imported_at ? new Date(imp.imported_at * 1000).toLocaleString() : new Date(imp.created_at * 1000).toLocaleString();
      const targetDay = imp.target_day ? imp.target_day.replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3') : '-';

      // Determine status class and text based on new status field
      let statusClass, statusText, statusDetail = '';
      if (imp.status === 'success') {
        statusClass = 'success';
        statusText = 'Completed';
      } else if (imp.status === 'failed') {
        statusClass = 'failed';
        statusText = 'Failed';
        // Show error message if available
        if (imp.error) {
          const errorStage = imp.error_stage ? ` (${capitalizeStage(imp.error_stage)})` : '';
          statusDetail = `<div class="progress-detail">${imp.error}${errorStage}</div>`;
        }
      } else if (imp.status === 'running') {
        statusClass = 'running';
        statusText = 'Running';
      } else {
        statusClass = 'pending';
        statusText = 'Pending';
      }

      html += `<tr data-import-id="${imp.timestamp}" onclick="window.location.href='/import/${imp.timestamp}'">`;
      html += `<td>${importedAt}</td>`;
      html += `<td>${imp.original_filename || 'Unknown'}</td>`;
      html += `<td class="file-size">${formatFileSize(imp.file_size || 0)}</td>`;
      html += `<td>`;
      if (imp.target_day) {
        html += `<a href="/calendar/${imp.target_day}" class="timestamp-link" onclick="event.stopPropagation();">${targetDay}</a>`;
      } else {
        html += '-';
      }
      html += `</td>`;
      html += `<td class="status-cell"><span class="import-status ${statusClass}">${statusText}</span>${statusDetail}</td>`;
      html += `<td class="files-cell">${imp.total_files_created || 0}</td>`;
      html += `<td class="duration-cell">${formatDuration(imp.duration_minutes)}</td>`;
      html += '</tr>';
    });

    html += '</tbody></table>';
    container.innerHTML = html;
  }).catch(err => {
    document.getElementById('importListContent').innerHTML = '<div class="no-imports">Error loading imports</div>';
  });
}

// Update import row with live progress from importer events
function updateImportRow(importId, eventData) {
  const row = document.querySelector(`tr[data-import-id="${importId}"]`);
  if (!row) return; // Row not in current view

  const statusCell = row.querySelector('.status-cell');
  const filesCell = row.querySelector('.files-cell');
  const durationCell = row.querySelector('.duration-cell');

  if (eventData.event === 'started') {
    // Mark as running
    if (statusCell) {
      statusCell.innerHTML = `<span class="import-status running">${capitalizeStage(eventData.stage)}</span>`;
    }
  } else if (eventData.event === 'status') {
    // Update with stage and timing
    if (statusCell) {
      const stageTime = formatElapsed(eventData.stage_elapsed_ms);
      const totalTime = formatElapsed(eventData.elapsed_ms);
      statusCell.innerHTML = `<span class="import-status running">${capitalizeStage(eventData.stage)}</span><div class="progress-detail">${stageTime} (${totalTime} total)</div>`;
    }
  } else if (eventData.event === 'completed') {
    // Mark as completed
    if (statusCell) {
      statusCell.innerHTML = '<span class="import-status success">Completed</span>';
    }
    if (filesCell && eventData.total_files_created !== undefined) {
      filesCell.textContent = eventData.total_files_created;
    }
    if (durationCell && eventData.duration_ms) {
      durationCell.textContent = formatElapsed(eventData.duration_ms);
    }
    // Reload imports to get full updated data
    setTimeout(() => loadImports(), 1000);
  } else if (eventData.event === 'error') {
    // Mark as failed
    if (statusCell) {
      statusCell.innerHTML = `<span class="import-status failed">Failed</span><div class="progress-detail">${eventData.error || 'Unknown error'}</div>`;
    }
  }
}

// Listen for importer events
appEvents.listen('importer', msg => {
  updateImportRow(msg.import_id, msg);
});

startBtn.addEventListener('click', async () => {
  const ts = document.getElementById('timestampInput').value.trim();
  const path = document.getElementById('savedPath').value;
  const facet = facetSelect.value;
  const setting = settingInput.value.trim();
  const detectModal = document.getElementById('detectModal');

  if (!ts) {
    if (window.showError) showError('Timestamp is required before starting the import.');
    return;
  }

  const originalText = startBtn.textContent;
  startBtn.disabled = true;
  startBtn.innerHTML = 'Starting<span class="spinner"></span>';

  try {
    const response = await fetch('{{ url_for('import_view.import_update_metadata') }}', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ path, facet, setting })
    });

    if (!response.ok) {
      const errorData = await response.json().catch(() => ({}));
      throw new Error(errorData.error || 'Failed to save facet selection');
    }

    // Start the import task
    const startResponse = await fetch('{{ url_for('import_view.import_start') }}', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ path, timestamp: ts })
    });

    if (!startResponse.ok) {
      const errorData = await startResponse.json().catch(() => ({}));
      throw new Error(errorData.error || 'Failed to start import');
    }

    const result = await startResponse.json();

    startBtn.disabled = false;
    startBtn.textContent = originalText;
    detectModal.style.display = 'none';

    // Reload imports to show the new import in the list
    // Live updates will come via importer events
    loadImports();
  } catch (err) {
    startBtn.disabled = false;
    startBtn.textContent = originalText;
    if (window.showError && err instanceof Error) showError(err.message);
    return;
  }
});

document.querySelector('.close').onclick=()=>{document.getElementById('detectModal').style.display='none';};
window.onclick=e=>{if(e.target==document.getElementById('detectModal'))document.getElementById('detectModal').style.display='none';};

// Load facets for dropdown
function loadFacets(){
  fetch('{{ url_for('facets.facets_list') }}').then(r=>r.json()).then(facets=>{
    const select=document.getElementById('facetSelect');
    const current=select.value; // Preserve current selection
    select.innerHTML='<option value="">None</option>';
    Object.entries(facets).forEach(([name,data])=>{
      const opt=document.createElement('option');
      opt.value=name;
      opt.textContent=data.title||name;
      if(name===current) opt.selected=true;
      select.appendChild(opt);
    });
  }).catch(()=>{/*ignore*/});
}

// Auto-select facet from URL fragment
function checkUrlFragment(){
  const fragment = window.location.hash.substring(1); // Remove #
  if(fragment){
    const select = document.getElementById('facetSelect');
    const option = select.querySelector(`option[value="${fragment}"]`);
    if(option) {
      option.selected = true;
      // Clear the fragment to avoid confusion
      history.replaceState(null, null, window.location.pathname + window.location.search);
    }
  }
}

loadImports();
loadFacets();
setTimeout(checkUrlFragment, 100); // Wait for facets to load
</script>
{% endblock %}
