<!-- Status Pane Component -->
<div class="status-pane">
  <div class="status-pane-content">
    <h3>WebSocket Status</h3>
    <div style="display: flex; flex-direction: column; gap: 8px; font-size: 14px;">
      <div>
        <strong>Status:</strong> <span id="ws-status">Connecting...</span>
      </div>
      <div>
        <strong>Uptime:</strong> <span id="ws-uptime">-</span>
      </div>
      <div>
        <strong>Last message:</strong> <span id="ws-last-message">-</span>
      </div>
    </div>

    <h3 style="margin-top: 16px;">Recent Activity <span id="notif-bell" style="cursor: pointer; font-size: 14px; margin-left: 6px; opacity: 0.5;" title="Enable browser notifications">ðŸ””</span></h3>
    <div id="notification-history" style="display: flex; flex-direction: column; gap: 4px; font-size: 13px;">
      <span style="color: #9ca3af;">No recent activity</span>
    </div>
  </div>
</div>

<script>
// Status pane toggle logic
(function(){
  const statusIcon = document.querySelector('.facet-bar .status-icon');
  const statusPane = document.querySelector('.status-pane');
  let statusPaneOpen = false;

  if (statusIcon && statusPane) {
    statusIcon.addEventListener('click', (e) => {
      e.stopPropagation();
      statusPaneOpen = !statusPaneOpen;

      if (statusPaneOpen) {
        statusPane.classList.add('visible');
      } else {
        statusPane.classList.remove('visible');
      }
    });

    // Close status pane when clicking outside
    document.addEventListener('click', (e) => {
      if (statusPaneOpen && statusPane && statusIcon &&
          !statusIcon.contains(e.target) && !statusPane.contains(e.target)) {
        statusPaneOpen = false;
        statusPane.classList.remove('visible');
      }
    });
  }

  // Update status pane metrics
  function updateStatusPane() {
    if (!window.appEvents) return;

    const metrics = window.appEvents.getMetrics();
    const wsStatus = document.getElementById('ws-status');
    const wsUptime = document.getElementById('ws-uptime');
    const wsLastMessage = document.getElementById('ws-last-message');

    if (wsStatus) {
      wsStatus.textContent = metrics.connected ? 'ðŸŸ¢ Connected' : 'ðŸ”´ Disconnected';
      wsStatus.style.color = metrics.connected ? '#10b981' : '#ef4444';
    }

    if (wsUptime) {
      if (metrics.connected) {
        const seconds = Math.floor(metrics.uptimeMs / 1000);
        wsUptime.textContent = formatDuration(seconds);
      } else {
        wsUptime.textContent = '-';
      }
    }

    if (wsLastMessage) {
      if (metrics.lastMessageMs !== null) {
        const seconds = Math.floor(metrics.lastMessageMs / 1000);
        wsLastMessage.textContent = seconds === 0 ? 'Just now' : `${formatDuration(seconds)} ago`;
      } else if (metrics.connected) {
        wsLastMessage.textContent = 'No messages yet';
      } else {
        wsLastMessage.textContent = '-';
      }
    }

    // Update notification history
    updateNotificationHistory();
    updateBellState();
  }

  function updateNotificationHistory() {
    const container = document.getElementById('notification-history');
    if (!container || !window.AppServices?.notifications) return;

    const history = window.AppServices.notifications.getHistory();
    const escape = window.AppServices._escapeHtml;

    if (history.length === 0) {
      container.innerHTML = '<span style="color: #9ca3af;">No recent activity</span>';
      return;
    }

    container.innerHTML = history.map(n => {
      const timeAgo = window.AppServices.notifications._getRelativeTime(n.timestamp);

      if (n.action) {
        return `<a href="${escape(n.action)}" style="display: flex; align-items: center; gap: 8px; padding: 6px 8px; margin: 0 -8px; border-radius: 4px; text-decoration: none; color: inherit; transition: background 0.15s;"
          onmouseover="this.style.background='rgba(0,0,0,0.05)'"
          onmouseout="this.style.background=''"
          ${n.facet ? `onclick="window.selectFacet && window.selectFacet('${escape(n.facet)}')"` : ''}>
          <span style="font-size: 16px; flex-shrink: 0;">${escape(n.icon)}</span>
          <span style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escape(n.title)}</span>
          <span style="color: #9ca3af; font-size: 11px; flex-shrink: 0;">${timeAgo}</span>
        </a>`;
      } else {
        return `<div style="display: flex; align-items: center; gap: 8px; padding: 6px 8px; margin: 0 -8px;">
          <span style="font-size: 16px; flex-shrink: 0;">${escape(n.icon)}</span>
          <span style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escape(n.title)}</span>
          <span style="color: #9ca3af; font-size: 11px; flex-shrink: 0;">${timeAgo}</span>
        </div>`;
      }
    }).join('');
  }

  function formatDuration(seconds) {
    if (seconds < 60) return `${seconds}s`;
    const minutes = Math.floor(seconds / 60);
    const secs = seconds % 60;
    if (minutes < 60) return `${minutes}m ${secs}s`;
    const hours = Math.floor(minutes / 60);
    const mins = minutes % 60;
    return `${hours}h ${mins}m`;
  }

  function updateBellState() {
    const bell = document.getElementById('notif-bell');
    if (!bell || !('Notification' in window)) {
      if (bell) bell.style.display = 'none';
      return;
    }
    const perm = Notification.permission;
    if (perm === 'granted') {
      bell.textContent = 'ðŸ””';
      bell.style.opacity = '1';
      bell.style.cursor = 'default';
      bell.title = 'Browser notifications enabled';
    } else if (perm === 'denied') {
      bell.textContent = 'ðŸ”•';
      bell.style.opacity = '0.4';
      bell.style.cursor = 'default';
      bell.title = 'Notifications blocked â€” update in browser settings';
    } else {
      bell.textContent = 'ðŸ””';
      bell.style.opacity = '0.5';
      bell.style.cursor = 'pointer';
      bell.title = 'Enable browser notifications';
    }
  }

  const bellEl = document.getElementById('notif-bell');
  if (bellEl) {
    bellEl.addEventListener('click', async (e) => {
      e.stopPropagation();
      if (!('Notification' in window)) return;
      if (Notification.permission === 'default') {
        await AppServices.requestNotificationPermission();
        updateBellState();
      }
    });
  }

  // Update status pane every second
  setInterval(updateStatusPane, 1000);
  // Initial update
  setTimeout(updateStatusPane, 100);
})();
</script>
