{% extends 'base.html' %}
{% import 'macros.html' as macros %}
{% set active = 'todos' %}
{% set domain_lookup = domain_map if domain_map is defined else {} %}

{% block head %}
<style>

.todo-list {
  list-style: none;
  padding: 0;
  margin: 1rem 0;
}

.day-heading-today {
  display: inline-flex;
  align-items: center;
  gap: 0.25rem;
  padding: 0.35rem 0.75rem;
  background: #2563eb;
  color: #ffffff;
  text-decoration: none;
  border-radius: 4px;
  font-size: 0.9rem;
  font-weight: 500;
  transition: background 0.18s ease, color 0.18s ease;
}

.day-heading-today:hover,
.day-heading-today:focus-visible {
  background: #1d4ed8;
  color: #ffffff;
}

.todo-row {
  display: flex;
  align-items: center;
  gap: 0.4rem;
  margin-bottom: 0.25rem;
}

.todo-item {
  display: flex;
  align-items: center;
  gap: 0.4rem;
  justify-content: space-between;
  padding: 0.3rem 0.6rem;
  border: 1px solid #e5e7eb;
  border-radius: 6px;
  background: #ffffff;
  font-size: 0.94rem;
  flex: 1;
  min-width: 0;
}

.todo-row.completed .todo-item {
  background: #f3f4f6;
}

.todo-row.completed .todo-meta,
.todo-row.completed .todo-meta .todo-time {
  color: #9ca3af;
}

.todo-meta {
  display: flex;
  gap: 0.35rem;
  align-items: center;
  flex: 1;
  min-width: 0;
}


.todo-text {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  color: inherit;
  cursor: text;
}


.todo-text:focus {
  outline: 2px solid #9ca3af;
  outline-offset: 1px;
}


.todo-item.editing .todo-meta,
.todo-item.editing .todo-domain-icon {
  display: none;
}


.todo-edit-form {
  display: none;
  flex: 1;
}


.todo-item.editing .todo-edit-form {
  display: flex;
}


.todo-edit-input {
  width: 100%;
  padding: 0.3rem 0.45rem;
  font-size: 0.94rem;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  color: #111827;
  background: #ffffff;
}


.todo-edit-input:focus {
  border-color: #2563eb;
  outline: none;
  box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
}


.todo-time {
  color: #6b7280;
  font-size: 0.76rem;
  flex-shrink: 0;
}

.todo-side {
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.todo-side form {
  display: flex;
  align-items: center;
  justify-content: center;
}

.todo-side button {
  width: 1.8rem;
  height: 1.8rem;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 0;
  line-height: 0;
  border: none;
  border-radius: 9999px;
  cursor: pointer;
  color: #6b7280;
  transition: opacity 0.18s ease, color 0.18s ease, border-color 0.18s ease, background-color 0.18s ease;
}

.todo-side button svg {
  width: 0.95rem;
  height: 0.95rem;
  fill: currentColor;
}

.todo-side button:focus-visible {
  outline: 2px solid #2563eb;
  outline-offset: 2px;
}

.todo-side-move {
  position: relative;
}

.todo-side-move button {
  background: #eef4ff;
  border: 1px solid #c7d7fe;
  color: #4c6ef5;
  opacity: 0;
}

.todo-side-move button:hover,
.todo-side-move button:focus,
.todo-side-move button:focus-visible {
  color: #1d4ed8;
  border-color: #1d4ed8;
  opacity: 1;
}

.todo-side-check {
  padding-right: 0.35rem;
}

.todo-side-check input[type="checkbox"] {
  width: 1.15rem;
  height: 1.15rem;
  cursor: pointer;
  accent-color: #2563eb;
  border-radius: 4px;
}

.todo-row.completed .todo-side-check input[type="checkbox"] {
  accent-color: #9ca3af;
}

.todo-side-remove button {
  background: #f3f4f6;
  border: 1px solid #d1d5db;
  color: #9ca3af;
  opacity: 0;
}

.todo-side-remove button:hover,
.todo-side-remove button:focus,
.todo-side-remove button:focus-visible {
  color: #ef4444;
  border-color: #ef4444;
  opacity: 1;
}

@media (hover: none), (pointer: coarse) {
  .todo-side-move button,
  .todo-side-remove button {
    opacity: 1;
  }
}


.todo-domain-icon {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 1.8rem;
  height: 1.8rem;
  border-radius: 9999px;
  font-size: 0.95rem;
  color: #fff;
  flex-shrink: 0;
}

.todo-domain-icon span[aria-hidden="true"] {
  line-height: 1;
}


.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border: 0;
}

.add-form {
  margin: 1.5rem 0;
  display: flex;
  gap: 0.5rem;
  align-items: center;
}

.add-form input[type="text"] {
  flex: 1;
  padding: 0.5rem 0.75rem;
  border: 1px solid #d1d5db;
  border-radius: 6px;
}

.add-form button {
  padding: 0.5rem 1rem;
  background: #2563eb;
  border: none;
  border-radius: 6px;
  color: #fff;
  cursor: pointer;
}

.flash-messages {
  margin-top: 1rem;
}

.flash-message {
  padding: 0.75rem 1rem;
  border-radius: 6px;
  margin-bottom: 0.5rem;
}

.flash-message.error {
  background: #fee2e2;
  color: #b91c1c;
  border: 1px solid #fecaca;
}

.no-todos {
  margin: 2rem 0;
  padding: 2rem;
  border: 2px dashed #d1d5db;
  border-radius: 8px;
  text-align: center;
  color: #6b7280;
}

.todo-move-popover {
  position: absolute;
  top: 2.4rem;
  right: 0;
  width: 16rem;
  padding: 0.75rem;
  border-radius: 8px;
  border: 1px solid #d1d5db;
  background: #ffffff;
  box-shadow: 0 10px 30px rgba(15, 23, 42, 0.18);
  z-index: 20;
}

.todo-move-popover[hidden] {
  display: none;
}

.todo-move-popover h4 {
  margin: 0 0 0.5rem;
  font-size: 0.88rem;
  font-weight: 600;
  color: #1f2937;
}

.todo-move-popover input[type="date"] {
  width: 100%;
  padding: 0.4rem 0.5rem;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  font-size: 0.9rem;
  color: #111827;
}

.todo-move-popover input[type="date"]:focus {
  border-color: #2563eb;
  outline: none;
  box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.2);
}

.todo-move-actions {
  display: flex;
  justify-content: flex-end;
  gap: 0.5rem;
  margin-top: 0.6rem;
}

.todo-move-actions button {
  padding: 0.35rem 0.75rem;
  font-size: 0.85rem;
  border-radius: 6px;
  border: none;
  cursor: pointer;
}

.todo-move-cancel {
  background: #f3f4f6;
  color: #4b5563;
}

.todo-move-apply {
  background: #2563eb;
  color: #ffffff;
}

.todo-move-message {
  margin-top: 0.5rem;
  font-size: 0.78rem;
  color: #b91c1c;
}

.todo-move-message[hidden] {
  display: none;
}
</style>
{% endblock %}

{% block body %}
<div class="container">
  {{ macros.day_heading(
        title,
        prev_day and url_for('todos.todos_day', day=prev_day),
        next_day and url_for('todos.todos_day', day=next_day),
        today_url=url_for('todos.todos_day', day=today_day)
      ) }}

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="flash-messages">
        {% for category, message in messages %}
          <div class="flash-message {{ category }}">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <form method="post" class="add-form">
    <input type="hidden" name="action" value="add">
    <input
      type="text"
      name="text"
      placeholder="Add a new todo (e.g., Merge PR #think (15:30))"
      autocomplete="off"
    >
    <button type="submit">Add Todo</button>
  </form>

  {% if todos %}
    {% set active_todos = todos | selectattr('completed', 'equalto', False) | list %}
    {% set completed_todos = todos | selectattr('completed', 'equalto', True) | list %}
    <ul class="todo-list">
      {% for item in active_todos + completed_todos %}
        <li class="todo-row {% if item.completed %}completed{% endif %}">
          <div class="todo-side todo-side-check">
            <form method="post" class="todo-check-form">
              <input type="hidden" name="action" value="{{ 'uncomplete' if item.completed else 'complete' }}">
              <input type="hidden" name="index" value="{{ item.index }}">
              <input type="hidden" name="guard" value="{{ item.raw }}">
              <input
                type="checkbox"
                class="todo-check-input"
                aria-label="{{ 'Mark undone' if item.completed else 'Mark done' }}"
                title="{{ 'Mark undone' if item.completed else 'Mark done' }}"
                {% if item.completed %}checked{% endif %}
              >
            </form>
          </div>
          <div class="todo-item">
            <div class="todo-meta">
              <span
                class="todo-text"
                title="{{ item.text or item.raw }}"
                tabindex="0"
                role="button"
              >{{ item.text or item.raw }}</span>
              {% if item.time %}
                <span class="todo-time">{{ item.time }}</span>
              {% endif %}
            </div>
            {% if item.domain %}
              {% set domain_info = domain_lookup.get(item.domain, {}) %}
              {% set domain_color = domain_info.get('color') or '#e5e7eb' %}
              {% set domain_symbol = domain_info.get('emoji') or item.domain[0]|upper %}
              {% set domain_title = domain_info.get('title') or item.domain %}
              {% set domain_text_color = '#374151' if not domain_info.get('color') else '#ffffff' %}
              <span
                class="todo-domain-icon"
                style="background: {{ domain_color }}; color: {{ domain_text_color }};"
                title="{{ domain_title }}"
              >
                <span aria-hidden="true">{{ domain_symbol }}</span>
                <span class="sr-only">Domain {{ domain_title }}</span>
              </span>
            {% endif %}
            <form method="post" class="todo-edit-form" hidden>
              <input type="hidden" name="action" value="edit">
              <input type="hidden" name="index" value="{{ item.index }}">
              <input type="hidden" name="guard" value="{{ item.raw }}">
              <input
                type="text"
                name="text"
                class="todo-edit-input"
                aria-label="Edit todo {{ item.index }}"
                autocomplete="off"
              >
            </form>
          </div>
          <div class="todo-side todo-side-move">
            <button
              type="button"
              class="move"
              aria-label="Move todo"
              title="Move todo"
              aria-haspopup="dialog"
              aria-expanded="false"
            >
              <svg viewBox="0 0 16 16" aria-hidden="true" focusable="false">
                <path d="M2 3.5A1.5 1.5 0 0 1 3.5 2h9A1.5 1.5 0 0 1 14 3.5V5H2zm0 2.5h12v7a1.5 1.5 0 0 1-1.5 1.5h-9A1.5 1.5 0 0 1 2 13V6zm3-1.75a.75.75 0 0 0-1.5 0V6h1.5zm7.5 0a.75.75 0 0 0-1.5 0V6h1.5zM5 9.25a.75.75 0 0 1 .75-.75h4.5a.75.75 0 0 1 0 1.5h-4.5A.75.75 0 0 1 5 9.25zm0 3a.75.75 0 0 1 .75-.75h2a.75.75 0 0 1 0 1.5h-2A.75.75 0 0 1 5 12.25z" />
              </svg>
              <span class="sr-only">Move todo</span>
            </button>
            <div class="todo-move-popover" role="dialog" aria-label="Move todo" hidden>
              <h4>Move to date</h4>
              <input
                type="date"
                class="todo-move-date"
                value="{{ day[:4] }}-{{ day[4:6] }}-{{ day[6:] }}"
                aria-label="Select target day"
              >
              <div class="todo-move-message" role="alert" hidden></div>
              <div class="todo-move-actions">
                <button type="button" class="todo-move-cancel">Cancel</button>
                <button type="button" class="todo-move-apply">Move</button>
              </div>
            </div>
          </div>
          <div class="todo-side todo-side-remove">
            <form method="post">
              <input type="hidden" name="action" value="remove">
              <input type="hidden" name="index" value="{{ item.index }}">
              <input type="hidden" name="guard" value="{{ item.raw }}">
              <button
                type="submit"
                class="remove"
                aria-label="Remove todo"
                title="Remove todo"
              >
                <svg viewBox="0 0 16 16" aria-hidden="true" focusable="false">
                  <path d="M6 2h4l.5 1H14v1H2V3h3.5zM4 14V5h8v9H4zm2-7h1v5H6zm3 0h1v5H9z" />
                </svg>
                <span class="sr-only">Remove todo</span>
              </button>
            </form>
          </div>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <div class="no-todos">
      <p>No todos recorded for this day yet.</p>
      <p>Add a new entry above to start the checklist.</p>
    </div>
  {% endif %}
  <div class="todo-weekly-launch">
    <button type="button" id="runWeeklyScoutBtn">Look for more TODOs</button>
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function () {
  var rows = document.querySelectorAll('.todo-row');
  var addForm = document.querySelector('.add-form');
  var closeActiveEditor = null;
  var closeActiveMove = null;
  var moveEndpoint = {{ url_for('todos.move_todo', day=day)|tojson }};
  var currentDay = {{ day|tojson }};
  var startAgentEndpoint = {{ url_for('agents.start_agent')|tojson }};

  if (addForm) {
    var addInput = addForm.querySelector('input[name="text"]');
    if (addInput) {
      var focusAddInput = function () {
        if (document.activeElement === addInput) {
          return;
        }
        addInput.focus();
        var length = addInput.value.length;
        try {
          addInput.setSelectionRange(length, length);
        } catch (err) {
          // Some browsers may not support setSelectionRange on certain input types.
        }
      };

      if (typeof window.requestAnimationFrame === 'function') {
        window.requestAnimationFrame(focusAddInput);
      } else {
        setTimeout(focusAddInput, 0);
      }

      addInput.addEventListener('keydown', function (event) {
        if (event.key === 'Escape') {
          event.preventDefault();
          addInput.value = '';
          addInput.blur();
          return;
        }

        if (event.key === 'Enter') {
          event.preventDefault();
          var trimmed = addInput.value.trim();
          if (!trimmed) {
            addInput.value = '';
            addInput.focus();
            return;
          }
          addInput.value = trimmed;
          if (typeof addForm.requestSubmit === 'function') {
            addForm.requestSubmit();
          } else {
            addForm.submit();
          }
        }
      });

      addForm.addEventListener('submit', function (event) {
        var trimmed = addInput.value.trim();
        if (!trimmed) {
          event.preventDefault();
          addInput.value = '';
          addInput.focus();
          return;
        }
        addInput.value = trimmed;
      });
    }
  }

  function dayToInputValue(dayString) {
    if (typeof dayString !== 'string' || dayString.length !== 8) {
      return '';
    }
    return dayString.slice(0, 4) + '-' + dayString.slice(4, 6) + '-' + dayString.slice(6, 8);
  }

  function inputValueToDay(inputValue) {
    if (typeof inputValue !== 'string' || inputValue.length !== 10) {
      return '';
    }
    var parts = inputValue.split('-');
    if (parts.length !== 3) {
      return '';
    }
    var year = parts[0];
    var month = parts[1];
    var dayPart = parts[2];
    if (!/^\d{4}$/.test(year) || !/^\d{2}$/.test(month) || !/^\d{2}$/.test(dayPart)) {
      return '';
    }
    return year + month + dayPart;
  }

  function extractBody(guardValue) {
    if (!guardValue) {
      return '';
    }
    var match = guardValue.match(/^- \[(?: |x|X)\]\s?(.*)$/);
    if (match) {
      return match[1];
    }
    var stripped = guardValue.replace(/^- \[[^\]]*\]\s*/, '');
    if (stripped !== guardValue) {
      return stripped;
    }
    return guardValue;
  }

  rows.forEach(function (row) {
    var checkForm = row.querySelector('.todo-check-form');
    var checkInput = checkForm && checkForm.querySelector('.todo-check-input');
    if (checkForm && checkInput) {
      checkInput.addEventListener('change', function () {
        var actionField = checkForm.querySelector('input[name="action"]');
        if (actionField) {
          actionField.value = checkInput.checked ? 'complete' : 'uncomplete';
        }
        if (typeof checkForm.requestSubmit === 'function') {
          checkForm.requestSubmit();
        } else {
          checkForm.submit();
        }
      });
    }

    var item = row.querySelector('.todo-item');
    var textEl = row.querySelector('.todo-text');
    var form = row.querySelector('.todo-edit-form');
    if (!item || !textEl || !form) {
      return;
    }

    var input = form.querySelector('.todo-edit-input');
    var guardInput = form.querySelector('input[name="guard"]');
    if (!input || !guardInput) {
      return;
    }

    var lastTouchTime = 0;

    function getInitialValue() {
      var guardValue = guardInput.value || '';
      var body = extractBody(guardValue);
      if (body) {
        return body;
      }
      return (textEl.textContent || '').trim();
    }

    function closeEditor() {
      if (!item.classList.contains('editing')) {
        return;
      }
      form.hidden = true;
      item.classList.remove('editing');
      if (closeActiveEditor === closeEditor) {
        closeActiveEditor = null;
      }
    }

    function focusText() {
      textEl.focus();
    }

    function cancelEditor() {
      closeEditor();
      focusText();
    }

    function openEditor() {
      if (closeActiveMove && typeof closeActiveMove === 'function') {
        closeActiveMove({ focus: false });
      }
      if (closeActiveEditor && closeActiveEditor !== closeEditor) {
        closeActiveEditor();
      }

      item.classList.add('editing');
      form.hidden = false;

      var value = getInitialValue();
      input.value = value;

      var focusInput = function () {
        input.focus();
        var length = input.value.length;
        try {
          input.setSelectionRange(length, length);
        } catch (err) {
          // Some input types may not support setSelectionRange.
        }
      };

      if (typeof window.requestAnimationFrame === 'function') {
        window.requestAnimationFrame(focusInput);
      } else {
        setTimeout(focusInput, 0);
      }

      closeActiveEditor = closeEditor;
    }

    textEl.addEventListener('dblclick', function (event) {
      event.preventDefault();
      openEditor();
    });

    textEl.addEventListener('keydown', function (event) {
      if (event.key === 'Enter' || event.key === ' ') {
        event.preventDefault();
        openEditor();
      }
    });

    textEl.addEventListener('touchend', function (event) {
      var now = Date.now();
      if (now - lastTouchTime < 300) {
        event.preventDefault();
        openEditor();
      }
      lastTouchTime = now;
    });

    input.addEventListener('keydown', function (event) {
      if (event.key === 'Escape') {
        event.preventDefault();
        cancelEditor();
        return;
      }

      if (event.key === 'Enter') {
        event.preventDefault();
        var trimmed = input.value.trim();
        if (!trimmed) {
          return;
        }
        input.value = trimmed;
        if (typeof form.requestSubmit === 'function') {
          form.requestSubmit();
        } else {
          form.submit();
        }
      }
    });

    form.addEventListener('submit', function (event) {
      var trimmed = input.value.trim();
      if (!trimmed) {
        event.preventDefault();
        input.focus();
        return;
      }
      input.value = trimmed;
    });

    var moveSide = row.querySelector('.todo-side-move');
    var moveButton = moveSide && moveSide.querySelector('.move');
    var movePopover = moveSide && moveSide.querySelector('.todo-move-popover');
    var moveDate = moveSide && moveSide.querySelector('.todo-move-date');
    var moveCancel = moveSide && moveSide.querySelector('.todo-move-cancel');
    var moveApply = moveSide && moveSide.querySelector('.todo-move-apply');
    var moveMessage = moveSide && moveSide.querySelector('.todo-move-message');
    var removeForm = row.querySelector('.todo-side-remove form');
    var removeIndex = removeForm && removeForm.querySelector('input[name="index"]');
    var removeGuard = removeForm && removeForm.querySelector('input[name="guard"]');

    if (!moveSide || !moveButton || !movePopover || !moveDate || !moveCancel || !moveApply || !moveMessage || !removeIndex || !removeGuard) {
      return;
    }

    var moveKeyHandler = null;
    var moveOutsideHandler = null;

    function resetMoveMessage() {
      moveMessage.textContent = '';
      moveMessage.hidden = true;
    }

    function showMoveMessage(text) {
      moveMessage.textContent = text;
      moveMessage.hidden = !text;
    }

    function setMovePending(isPending) {
      moveButton.disabled = isPending;
      moveDate.disabled = isPending;
      moveCancel.disabled = isPending;
      moveApply.disabled = isPending;
    }

    function closeMovePopover(options) {
      if (movePopover.hidden) {
        return;
      }
      movePopover.hidden = true;
      moveButton.setAttribute('aria-expanded', 'false');
      if (moveKeyHandler) {
        document.removeEventListener('keydown', moveKeyHandler, true);
        moveKeyHandler = null;
      }
      if (moveOutsideHandler) {
        document.removeEventListener('mousedown', moveOutsideHandler, true);
        moveOutsideHandler = null;
      }
      resetMoveMessage();
      if (!options || options.focus !== false) {
        moveButton.focus();
      }
      if (closeActiveMove === closeMovePopover) {
        closeActiveMove = null;
      }
    }

    function openMovePopover() {
      if (closeActiveMove && closeActiveMove !== closeMovePopover) {
        closeActiveMove({ focus: false });
      }
      if (closeActiveEditor && closeActiveEditor !== closeEditor) {
        closeActiveEditor();
      }

      if (!moveDate.value) {
        moveDate.value = dayToInputValue(currentDay);
      }

      movePopover.hidden = false;
      moveButton.setAttribute('aria-expanded', 'true');

      moveKeyHandler = function (event) {
        if (event.key === 'Escape') {
          event.preventDefault();
          closeMovePopover();
        }
      };
      moveOutsideHandler = function (event) {
        if (movePopover.contains(event.target) || moveButton.contains(event.target)) {
          return;
        }
        closeMovePopover({ focus: false });
      };

      document.addEventListener('keydown', moveKeyHandler, true);
      document.addEventListener('mousedown', moveOutsideHandler, true);

      var focusDate = function () {
        moveDate.focus();
      };
      if (typeof window.requestAnimationFrame === 'function') {
        window.requestAnimationFrame(focusDate);
      } else {
        setTimeout(focusDate, 0);
      }

      closeActiveMove = closeMovePopover;
    }

    function submitMove(targetValue) {
      resetMoveMessage();
      var selectedValue = typeof targetValue === 'string' ? targetValue : moveDate.value;
      if (!selectedValue) {
        showMoveMessage('Select a date to move this todo.');
        return;
      }

      var targetDay = inputValueToDay(selectedValue);
      if (!targetDay) {
        showMoveMessage('Select a valid date.');
        return;
      }

      var guardValue = removeGuard.value || '';
      var indexValue = removeIndex.value || '';
      var indexNumber = parseInt(indexValue, 10);
      if (!guardValue || !indexNumber) {
        showMoveMessage('Unable to locate this todo.');
        return;
      }

      var navigateAway = false;
      setMovePending(true);

      fetch(moveEndpoint, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          target_day: targetDay,
          guard: guardValue,
          index: indexNumber,
        }),
      })
        .then(function (response) {
          return response
            .json()
            .catch(function () {
              return {};
            })
            .then(function (data) {
              if (!response.ok) {
                var message = data && data.error ? data.error : 'Unable to move todo.';
                throw new Error(message);
              }
              return data;
            });
        })
        .then(function (data) {
          if (!data) {
            showMoveMessage('Unexpected response while moving todo.');
            return;
          }

          if (data.redirect) {
            navigateAway = true;
            window.location.href = data.redirect;
            return;
          }

          if (data.message) {
            showMoveMessage(data.message);
            return;
          }

          navigateAway = true;
          closeMovePopover({ focus: false });
          window.location.reload();
        })
        .catch(function (error) {
          showMoveMessage(error && error.message ? error.message : 'Unable to move todo.');
        })
        .finally(function () {
          if (navigateAway) {
            return;
          }
          setMovePending(false);
        });
    }

    moveButton.addEventListener('click', function (event) {
      event.preventDefault();
      if (!movePopover.hidden) {
        closeMovePopover();
        return;
      }
      openMovePopover();
    });

    moveApply.addEventListener('click', function (event) {
      event.preventDefault();
      submitMove();
    });

    moveCancel.addEventListener('click', function (event) {
      event.preventDefault();
      closeMovePopover();
    });

    moveDate.addEventListener('keydown', function (event) {
      if (event.key === 'Escape') {
        event.preventDefault();
        closeMovePopover();
        return;
      }
      if (event.key === 'Enter') {
        event.preventDefault();
        submitMove();
      }
    });

    moveDate.addEventListener('change', function () {
      if (!moveDate.value) {
        return;
      }
      submitMove(moveDate.value);
    });
  });

  var weeklyScoutBtn = document.getElementById('runWeeklyScoutBtn');
  if (weeklyScoutBtn) {
    weeklyScoutBtn.addEventListener('click', async function () {
      if (weeklyScoutBtn.disabled) {
        return;
      }

      var extra = window.prompt('Add optional instructions for the Weekly Scout (leave blank to skip):');
      if (extra === null) {
        return;
      }

      var promptLines = [
        'Run the TODO Weekly Scout for journal day ' + currentDay + '.',
        'Follow the weekly audit procedure to review the past seven days, validate completions, and add up to five high-impact todos for today.'
      ];

      if (extra && extra.trim()) {
        promptLines.push('Additional operator guidance: ' + extra.trim());
      }

      var originalText = weeklyScoutBtn.textContent;
      weeklyScoutBtn.disabled = true;
      weeklyScoutBtn.textContent = 'Running Weekly TODO Scout';

      try {
        var response = await fetch(startAgentEndpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            prompt: promptLines.join('\n\n'),
            persona: 'todo_weekly'
          })
        });

        var data;
        try {
          data = await response.json();
        } catch (jsonError) {
          data = {};
        }

        if (!response.ok || !data || !data.success) {
          var message = data && data.error ? data.error : 'Unable to start Weekly Scout';
          throw new Error(message);
        }

        weeklyScoutBtn.textContent = 'Weekly Scout queued';
      } catch (error) {
        weeklyScoutBtn.disabled = false;
        weeklyScoutBtn.textContent = originalText;
        var reason = error && error.message ? error.message : String(error);
        window.alert('Failed to start Weekly Scout: ' + reason);
      }
    });
  }
});
</script>
{% endblock %}
