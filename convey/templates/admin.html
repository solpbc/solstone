{% extends 'base.html' %}
{% set title = 'Admin' %}
{% set active = 'admin' %}
{% block head %}
<style>
.container { padding:0 1em; }
button { padding:8px 16px; margin:0.5em 0; }
pre { background:#f5f5f5; padding:0.5em; }
.modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); }
.modal-content { background:white; margin:5% auto; padding:1em; border-radius:8px; max-width:800px; max-height:80vh; overflow:auto; position:relative; }
.close { position:absolute; top:10px; right:15px; cursor:pointer; font-size:24px; }
.spinner { display:inline-block; width:12px; height:12px; border:2px solid #ccc; border-top-color:#333; border-radius:50%; animation:spin 1s linear infinite; margin-left:4px; }
#taskOutput { white-space: pre-wrap; word-wrap: break-word; }
@keyframes spin { to { transform:rotate(360deg); } }

/* Config form styles */
.config-section { max-width: 600px; margin-top: 1em; }
.config-section h3 { color: #333; font-size: 1.3em; margin: 1.5em 0 1em 0; border-bottom: 2px solid #eee; padding-bottom: 0.5em; }
.form-group { margin-bottom: 1.5em; }
.form-group label { display: block; font-weight: 600; color: #333; margin-bottom: 0.5em; font-size: 0.95em; }
.form-group input, .form-group textarea, .form-group select { width: 100%; padding: 0.6em 0.75em; border: 2px solid #ddd; border-radius: 8px; font-size: 0.95em; font-family: inherit; transition: border-color 0.2s, box-shadow 0.2s; box-sizing: border-box; }
.form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
.form-group textarea { resize: vertical; min-height: 60px; }
.form-group small { display: block; margin-top: 0.3em; color: #666; font-size: 0.85em; line-height: 1.4; }
.config-status { margin-top: 1em; padding: 0.75em 1em; border-radius: 8px; font-size: 0.9em; font-weight: 500; display: none; }
.config-status.success { background: #d4edda; color: #155724; display: block; }
.config-status.error { background: #f8d7da; color: #721c24; display: block; }
.config-status.saving { background: #d1ecf1; color: #0c5460; display: block; }
</style>
{% endblock %}
{% block body %}
<div class="container">
  <button id="reindexBtn">Reindex</button>
  <button id="resetIndexesBtn">Reset Indexes</button>
  <button id="summaryBtn">Refresh Summary</button>
  <pre id="status"></pre>
  {% set cats = ['sense','summaries','entity'] %}
  <div class="tabs">
    <div class="tab active" data-target="config">Config</div>
    {% for cat in cats %}
    <div class="tab" data-target="{{ cat }}">{{ cat.capitalize() }}</div>
    {% endfor %}
    <div class="tab" data-target="log">Task Log</div>
  </div>
  <div class="content" id="config">
    <h2>Journal Configuration</h2>
    <div class="config-section">
      <h3>Identity</h3>
      <div class="form-group">
        <label for="config-name">Full Name</label>
        <input type="text" id="config-name" data-field="name" placeholder="Your full name">
        <small>Your full legal or formal name</small>
      </div>
      <div class="form-group">
        <label for="config-preferred">Preferred Name</label>
        <input type="text" id="config-preferred" data-field="preferred" placeholder="Your preferred name">
        <small>Preferred name or nickname to be used when addressing you</small>
      </div>
      <div class="form-group">
        <label for="config-entity">Entity</label>
        <select id="config-entity" data-field="entity">
          <option value="">Select entity...</option>
        </select>
        <small id="entity-display" style="color: #666; margin-top: 0.3em;"></small>
      </div>
      <div class="form-group">
        <label for="config-short-bio">Short Bio</label>
        <textarea id="config-short-bio" data-field="short_bio" rows="3" placeholder="Brief description of yourself (loaded from selected entity)"></textarea>
        <small>This bio is stored in the entity and used across the journal for context</small>
      </div>
      <div class="form-group">
        <label for="config-pronouns">Pronouns</label>
        <select id="config-pronouns" data-field="pronouns">
          <option value="">Select pronouns...</option>
          <option value="she/her/her/herself">she/her/hers/herself</option>
          <option value="he/him/his/himself">he/him/his/himself</option>
          <option value="they/them/their/themselves">they/them/their/themselves</option>
          <option value="ze/zir/zir/zirself">ze/zir/zirs/zirself</option>
          <option value="xe/xem/xyr/xemself">xe/xem/xyrs/xemself</option>
          <option value="it/it/its/itself">it/its/its/itself</option>
        </select>
        <small>Select a pronoun set for use in templates (subject/object/possessive/reflexive)</small>
      </div>
      <div class="form-group">
        <label for="config-aliases">Aliases</label>
        <input type="text" id="config-aliases" data-field="aliases" placeholder="e.g., nickname1, nickname2">
        <small>Comma-separated alternative names or nicknames that may appear in transcripts</small>
      </div>
      <div class="form-group">
        <label for="config-emails">Email Addresses</label>
        <input type="text" id="config-emails" data-field="email_addresses" placeholder="e.g., work@company.com, personal@example.com">
        <small>Comma-separated email addresses for participant detection</small>
      </div>
      <div class="form-group">
        <label for="config-timezone">Home Timezone</label>
        <input type="text" id="config-timezone" data-field="timezone" list="timezone-list" placeholder="e.g., America/New_York">
        <datalist id="timezone-list">
          <option value="UTC">
          <option value="GMT">
          <option value="America/New_York">
          <option value="America/Chicago">
          <option value="America/Denver">
          <option value="America/Phoenix">
          <option value="America/Los_Angeles">
          <option value="America/Anchorage">
          <option value="America/Honolulu">
          <option value="America/Toronto">
          <option value="America/Vancouver">
          <option value="America/Montreal">
          <option value="America/Mexico_City">
          <option value="America/Sao_Paulo">
          <option value="America/Buenos_Aires">
          <option value="America/Santiago">
          <option value="America/Bogota">
          <option value="America/Lima">
          <option value="Europe/London">
          <option value="Europe/Paris">
          <option value="Europe/Berlin">
          <option value="Europe/Rome">
          <option value="Europe/Madrid">
          <option value="Europe/Amsterdam">
          <option value="Europe/Brussels">
          <option value="Europe/Zurich">
          <option value="Europe/Vienna">
          <option value="Europe/Stockholm">
          <option value="Europe/Oslo">
          <option value="Europe/Copenhagen">
          <option value="Europe/Helsinki">
          <option value="Europe/Prague">
          <option value="Europe/Warsaw">
          <option value="Europe/Athens">
          <option value="Europe/Istanbul">
          <option value="Europe/Moscow">
          <option value="Asia/Tokyo">
          <option value="Asia/Shanghai">
          <option value="Asia/Hong_Kong">
          <option value="Asia/Singapore">
          <option value="Asia/Seoul">
          <option value="Asia/Kolkata">
          <option value="Asia/Dubai">
          <option value="Asia/Bangkok">
          <option value="Asia/Manila">
          <option value="Asia/Jakarta">
          <option value="Asia/Taipei">
          <option value="Asia/Jerusalem">
          <option value="Asia/Riyadh">
          <option value="Asia/Tehran">
          <option value="Australia/Sydney">
          <option value="Australia/Melbourne">
          <option value="Australia/Brisbane">
          <option value="Australia/Perth">
          <option value="Australia/Adelaide">
          <option value="Pacific/Auckland">
          <option value="Pacific/Fiji">
          <option value="Africa/Cairo">
          <option value="Africa/Johannesburg">
          <option value="Africa/Lagos">
          <option value="Africa/Nairobi">
        </datalist>
        <small>IANA timezone identifier - type to search or select from list</small>
      </div>
      <div id="config-status" class="config-status"></div>
    </div>
  </div>
  {% for cat in cats %}
  <ul class="content" id="{{ cat }}" style="display:none">
    {% for item in repair_data[cat] %}
    <li><a href="{{ url_for('admin.admin_day_page', day=item.day) }}">{{ item.day }}</a> - {{ item.count }}</li>
    {% else %}
    <li>No items</li>
    {% endfor %}
  </ul>
  {% endfor %}
  <div class="content" id="log" style="display:none">
    <pre id="logOutput"></pre>
  </div>
</div>
<div id="taskModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <pre id="taskOutput"></pre>
  </div>
</div>
<script>
let taskDone=false;
let configData = null;
let saveTimeout = null;
let personEntities = [];
let currentEntityDetails = null;
const tabs = document.querySelectorAll('.tab');
const contents = document.querySelectorAll('.content');
function showTab(id){
  tabs.forEach(t=>t.classList.toggle('active', t.dataset.target===id));
  contents.forEach(c=>{c.style.display=c.id===id?'block':'none';});
  if(id==='config' && !configData) loadConfig();
}
tabs.forEach(t=>t.addEventListener('click', ()=>showTab(t.dataset.target)));
function runTask(data){
  const modal=document.getElementById('taskModal');
  const out=document.getElementById('taskOutput');
  const modalContent=document.querySelector('#taskModal .modal-content');
  out.innerHTML='';
  modal.style.display='block';
  taskDone=false;
  if(data.force) out.innerHTML='[using --force]\n';
  const spinner=document.createElement('span');
  spinner.className='spinner';
  out.appendChild(spinner);
  const scroll=()=>{modalContent.scrollTop=modalContent.scrollHeight;};
  const addLine=html=>{spinner.remove();out.innerHTML+=html+'\n';out.appendChild(spinner);scroll();};
  const ws=new WebSocket(`ws://${location.host}/ws/tasks`);
  const start=Date.now();
  ws.onopen=()=>ws.send(JSON.stringify(data));
  ws.onmessage=e=>{
    const msg=JSON.parse(e.data);
    if(msg.type==='stdout') addLine(msg.text);
    else if(msg.type==='stderr') addLine('<span style="color:red">'+msg.text+'</span>');
    else if(msg.type==='exit'){spinner.remove();out.innerHTML+='[exit '+msg.code+']\n';scroll();ws.close();}
  };
  ws.onclose=()=>{spinner.remove();const s=Math.round((Date.now()-start)/1000);
    const msg=s>=60?(Math.round(s/6)/10+' minutes'):s+' seconds';
    out.innerHTML+=`\n[completed in ${msg}]\n`;scroll();taskDone=true;};
}
document.getElementById('reindexBtn').onclick=()=>runTask({task:'reindex',src:'admin'});
document.getElementById('resetIndexesBtn').onclick=()=>{
  if(confirm('This will delete all search indexes. They will need to be rebuilt. Continue?')){
    runTask({task:'reset_indexes',src:'admin'});
  }
};
document.getElementById('summaryBtn').onclick=()=>runTask({task:'summary',src:'admin'});
function loadLog(){
  fetch('{{ url_for('admin.task_log') }}').then(r=>r.json()).then(data=>{
    const pre=document.getElementById('logOutput');
    pre.textContent=data.map(e=>`${e.since} - ${e.message}`).join('\n');
  });
}
function hideModal(){
  document.getElementById('taskModal').style.display='none';
  if(taskDone) location.reload();
}
document.querySelectorAll('#taskModal .close')[0].onclick=hideModal;
window.onclick=e=>{
  if(e.target==document.getElementById('taskModal')) hideModal();
};

// Config management functions
function loadEntities(){
  return fetch('{{ url_for('entities.entities_list') }}?type=Person')
    .then(r=>r.json())
    .then(entities=>{
      personEntities = entities.filter(e=>e.top); // Only top-level entities
      const select = document.getElementById('config-entity');
      // Clear existing options except first
      while(select.options.length > 1) select.remove(1);
      // Add entity options
      personEntities.forEach(entity=>{
        const opt = document.createElement('option');
        opt.value = entity.name;
        opt.textContent = entity.name;
        select.appendChild(opt);
      });
    })
    .catch(err=>{
      console.error('Error loading entities:', err);
    });
}

function loadConfig(){
  loadEntities().then(()=>{
    fetch('{{ url_for('admin.get_config') }}')
      .then(r=>r.json())
      .then(data=>{
        configData = data;
        populateConfigForm(data);
        setupConfigAutoSave();
      })
      .catch(err=>{
        console.error('Error loading config:', err);
        showConfigStatus('Error loading configuration', 'error');
      });
  });
}

function populateConfigForm(data){
  const identity = data.identity || {};
  document.getElementById('config-name').value = identity.name || '';
  document.getElementById('config-preferred').value = identity.preferred || '';

  // Handle pronouns - match dropdown option to saved structure
  const pronouns = identity.pronouns || {};
  if (pronouns.subject && pronouns.object && pronouns.possessive && pronouns.reflexive) {
    const key = `${pronouns.subject}/${pronouns.object}/${pronouns.possessive}/${pronouns.reflexive}`;
    document.getElementById('config-pronouns').value = key;
  } else {
    document.getElementById('config-pronouns').value = '';
  }

  document.getElementById('config-aliases').value = Array.isArray(identity.aliases) ? identity.aliases.join(', ') : '';
  document.getElementById('config-emails').value = Array.isArray(identity.email_addresses) ? identity.email_addresses.join(', ') : '';

  // Handle entity - auto-match by name prefix if not set
  const entitySelect = document.getElementById('config-entity');
  const entityDisplay = document.getElementById('entity-display');
  let entityValue = identity.entity || '';

  if (!entityValue && identity.name) {
    // Try to auto-match by prefix
    const name = identity.name.trim();
    const match = personEntities.find(e => e.name.toLowerCase().startsWith(name.toLowerCase()));
    if (match) {
      entityValue = match.name;
      // Auto-save the matched entity
      setTimeout(() => saveConfig(), 500);
    }
  }

  entitySelect.value = entityValue;
  updateEntityDisplay();

  // Auto-detect timezone if not set
  const timezoneInput = document.getElementById('config-timezone');
  if (!identity.timezone || identity.timezone === '') {
    try {
      const detectedTz = Intl.DateTimeFormat().resolvedOptions().timeZone;
      if (detectedTz) {
        timezoneInput.value = detectedTz;
        // Auto-save the detected timezone
        setTimeout(() => saveConfig(), 500);
      }
    } catch (e) {
      console.warn('Could not auto-detect timezone:', e);
      timezoneInput.value = '';
    }
  } else {
    timezoneInput.value = identity.timezone;
  }
}

function loadEntityDetails(entityName){
  if (!entityName) {
    currentEntityDetails = null;
    document.getElementById('config-short-bio').value = '';
    return;
  }

  fetch(`{{ url_for('entities.entities_details') }}?type=Person&name=${encodeURIComponent(entityName)}`)
    .then(r=>r.json())
    .then(details=>{
      currentEntityDetails = details;
      if (details.desc) {
        document.getElementById('config-short-bio').value = details.desc;
      } else {
        document.getElementById('config-short-bio').value = '';
      }
    })
    .catch(err=>{
      console.error('Error loading entity details:', err);
      currentEntityDetails = null;
      document.getElementById('config-short-bio').value = '';
    });
}

function updateEntityDisplay(){
  const entitySelect = document.getElementById('config-entity');
  const entityDisplay = document.getElementById('entity-display');
  const selectedEntity = entitySelect.value;

  if (selectedEntity) {
    const entity = personEntities.find(e => e.name === selectedEntity);
    if (entity) {
      entityDisplay.textContent = `Selected: ${entity.name}`;
    } else {
      entityDisplay.textContent = `Selected: ${selectedEntity}`;
    }
    loadEntityDetails(selectedEntity);
  } else {
    entityDisplay.textContent = '';
    loadEntityDetails('');
  }
}

function setupConfigAutoSave(){
  const inputs = document.querySelectorAll('#config input[data-field], #config select[data-field], #config textarea[data-field]');
  inputs.forEach(input=>{
    input.addEventListener('blur', ()=>saveConfigField(input));
    input.addEventListener('change', ()=>{
      if(input.id === 'config-entity') updateEntityDisplay();
      saveConfigField(input);
    });
    if (input.tagName !== 'TEXTAREA') {
      input.addEventListener('keydown', e=>{
        if(e.key==='Enter'){
          e.preventDefault();
          saveConfigField(input);
        }
      });
    }
  });
}

function saveConfigField(input){
  clearTimeout(saveTimeout);
  saveTimeout = setTimeout(()=>saveConfig(), 500);
}

function saveConfig(){
  // Parse selected pronoun set into structured format
  const pronounValue = document.getElementById('config-pronouns').value;
  let pronouns = {subject: '', object: '', possessive: '', reflexive: ''};
  if (pronounValue) {
    const parts = pronounValue.split('/');
    if (parts.length === 4) {
      pronouns = {
        subject: parts[0],
        object: parts[1],
        possessive: parts[2],
        reflexive: parts[3]
      };
    }
  }

  const entityName = document.getElementById('config-entity').value.trim();
  const shortBio = document.getElementById('config-short-bio').value.trim();

  const identity = {
    name: document.getElementById('config-name').value.trim(),
    preferred: document.getElementById('config-preferred').value.trim(),
    pronouns: pronouns,
    aliases: document.getElementById('config-aliases').value.split(',').map(s=>s.trim()).filter(s=>s),
    email_addresses: document.getElementById('config-emails').value.split(',').map(s=>s.trim()).filter(s=>s),
    timezone: document.getElementById('config-timezone').value.trim(),
    entity: entityName
  };

  showConfigStatus('Saving...', 'saving');

  // Save config first
  fetch('{{ url_for('admin.update_config') }}', {
    method: 'PUT',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({identity})
  })
  .then(r=>r.json())
  .then(data=>{
    if(data.success){
      configData = data.config;

      // If entity is selected and short_bio has content, update the entity
      if (entityName && shortBio) {
        return fetch('{{ url_for('entities.api_top_update') }}', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            type: 'Person',
            name: entityName,
            desc: shortBio
          })
        });
      }
      return Promise.resolve();
    } else {
      throw new Error(data.error || 'Unknown error');
    }
  })
  .then(()=>{
    showConfigStatus('Saved', 'success');
    setTimeout(()=>hideConfigStatus(), 2000);
  })
  .catch(err=>{
    console.error('Error saving config:', err);
    showConfigStatus('Error: ' + (err.message || 'Error saving configuration'), 'error');
  });
}

function showConfigStatus(msg, type){
  const status = document.getElementById('config-status');
  status.textContent = msg;
  status.className = 'config-status ' + type;
}

function hideConfigStatus(){
  const status = document.getElementById('config-status');
  status.className = 'config-status';
}

// Load config on page load if config tab is active
if(document.querySelector('.tab.active').dataset.target === 'config'){
  loadConfig();
}

loadLog();
</script>
{% endblock %}
