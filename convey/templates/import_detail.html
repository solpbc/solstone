{% extends 'base.html' %}
{% set title = 'Import Details' %}
{% set active = 'import' %}
{% block head %}
<style>
.container { padding: 0 1em; }
.back-link { display: inline-block; margin-bottom: 1em; color: #007bff; text-decoration: none; }
.back-link:hover { text-decoration: underline; }
.import-header { margin-bottom: 2em; }
.import-header h1 { margin: 0 0 0.5em 0; }
.import-meta { color: #666; font-size: 0.9em; }

/* Tabs */
.tabs { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 1em; }
.tab { padding: 10px 20px; cursor: pointer; border-bottom: 3px solid transparent; margin-bottom: -2px; }
.tab:hover { background: #f5f5f5; }
.tab.active { border-bottom-color: #007bff; font-weight: bold; }
.tab-content { display: none; }
.tab-content.active { display: block; }

/* JSON viewer */
.json-viewer { background: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; padding: 1em; overflow-x: auto; }
.json-viewer pre { margin: 0; font-family: monospace; font-size: 0.9em; }
.json-key { color: #881391; }
.json-string { color: #1a1aa6; }
.json-number { color: #098658; }
.json-boolean { color: #d73a49; }
.json-null { color: #666; }

/* Links section */
.links-section { margin-top: 2em; padding: 1em; background: #f9f9f9; border-radius: 4px; }
.links-section h3 { margin-top: 0; }
.link-item { margin: 0.5em 0; }
.link-item a { color: #007bff; text-decoration: none; }
.link-item a:hover { text-decoration: underline; }

/* Files list */
.files-list { margin-top: 1em; }
.files-list h4 { margin-bottom: 0.5em; }
.files-list ul { margin: 0; padding-left: 1.5em; }
.files-list li { margin: 0.25em 0; font-family: monospace; font-size: 0.9em; color: #666; }

/* Status badge */
.status-badge { display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 0.85em; margin-left: 1em; }
.status-badge.success { background: #d4edda; color: #155724; }
.status-badge.pending { background: #fff3cd; color: #856404; }
.status-badge.failed { background: #f8d7da; color: #721c24; }
.status-badge.running { background: #cfe2ff; color: #084298; }

/* Info grid */
.info-grid { display: grid; grid-template-columns: auto 1fr; gap: 0.5em 1em; margin: 1em 0; }
.info-label { font-weight: bold; color: #666; }
.info-value { color: #333; }

.no-data { color: #999; font-style: italic; padding: 2em; text-align: center; }

/* Summary content */
.summary-content { background: #f9f9f9; border: 1px solid #e0e0e0; border-radius: 4px; padding: 1.5em; overflow-x: auto; min-height: 100px; }
.summary-content h1, .summary-content h2, .summary-content h3 { margin-top: 1em; margin-bottom: 0.5em; color: #333; }
.summary-content h1:first-child, .summary-content h2:first-child { margin-top: 0; }
.summary-content ul, .summary-content ol { margin: 0.5em 0; padding-left: 1.5em; }
.summary-content p { margin: 0.5em 0; line-height: 1.6; }
.summary-content code { background: #f5f5f5; padding: 2px 5px; border-radius: 3px; font-family: monospace; font-size: 0.9em; }
.summary-content pre { background: #f5f5f5; padding: 1em; border-radius: 4px; overflow-x: auto; }
.summary-content blockquote { border-left: 3px solid #007bff; margin: 1em 0; padding-left: 1em; color: #666; background: #f8f9fa; }
.summary-content table { border-collapse: collapse; width: 100%; margin: 1em 0; }
.summary-content table th, .summary-content table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
.summary-content table th { background: #f5f5f5; font-weight: bold; }
.summary-content strong { font-weight: 600; color: #222; }
.summary-loading { text-align: center; color: #666; padding: 2em; }
.summary-loading .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid #ccc; border-top-color: #007bff; border-radius: 50%; animation: spin 0.8s linear infinite; margin-left: 8px; }
@keyframes spin { to { transform: rotate(360deg); } }

/* Re-run section */
.rerun-section { margin-top: 2em; padding: 1em; background: #f0f8ff; border: 1px solid #007bff; border-radius: 4px; }
.rerun-section h3 { margin-top: 0; color: #007bff; }
.rerun-controls { display: flex; align-items: center; gap: 1em; margin-top: 1em; }
.rerun-controls label { font-weight: bold; }
.rerun-controls select { padding: 6px 10px; border: 1px solid #ddd; border-radius: 4px; background: white; min-width: 150px; }
.rerun-controls button { padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
.rerun-controls button:hover { background: #0056b3; }
.rerun-controls button:disabled { background: #ccc; cursor: not-allowed; opacity: 0.6; }
.rerun-note { font-size: 0.9em; color: #666; margin-top: 0.5em; font-style: italic; }

/* Progress display */
.progress-banner { display: none; background: #e7f3ff; border: 1px solid #007bff; border-radius: 4px; padding: 1em; margin: 1em 0; }
.progress-banner.active { display: block; }
.progress-stage { font-weight: bold; color: #007bff; margin-bottom: 0.5em; }
.progress-timing { font-size: 0.9em; color: #666; }
.progress-spinner { display: inline-block; width: 12px; height: 12px; border: 2px solid #007bff; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; margin-left: 6px; }
</style>
{% endblock %}

{% block body %}
<div class="container">
  <a href="{{ url_for('import_view.import_page') }}" class="back-link">‚Üê Back to Imports</a>
  
  <div class="import-header">
    <h1>Import: {{ timestamp }}</h1>
    <div class="import-meta" id="importMeta">
      <span>Loading...</span>
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" data-target="overview">Overview</div>
    <div class="tab" data-target="import-json">Upload Metadata</div>
    <div class="tab" data-target="imported-json">Processing Results</div>
    <div class="tab" data-target="summary" id="summaryTab" style="display:none;">Summary</div>
  </div>

  <div class="tab-content active" id="overview">
    <div class="info-grid" id="overviewContent">
      <div class="info-label">Loading...</div>
    </div>
    
    <div class="links-section" id="linksSection" style="display:none;">
      <h3>Quick Links</h3>
      <div id="quickLinks"></div>
    </div>
    
    <div class="files-list" id="filesList" style="display:none;">
      <h4>Created Files</h4>
      <ul id="filesListContent"></ul>
    </div>
  </div>

  <div class="tab-content" id="import-json">
    <div class="json-viewer">
      <pre id="importJsonContent">Loading...</pre>
    </div>
  </div>

  <div class="tab-content" id="imported-json">
    <div class="json-viewer">
      <pre id="importedJsonContent">Loading...</pre>
    </div>
  </div>

  <div class="tab-content" id="summary">
    <div class="summary-content" id="summaryContent">
      <div class="summary-loading">
        Loading summary<span class="spinner"></span>
      </div>
    </div>
  </div>
  
  <div class="progress-banner" id="progressBanner">
    <div class="progress-stage" id="progressStage">Processing<span class="progress-spinner"></span></div>
    <div class="progress-timing" id="progressTiming"></div>
  </div>

  <div class="rerun-section" id="rerunSection" style="display:none;">
    <h3>Re-run Import</h3>
    <div class="rerun-controls">
      <label for="facetSelect">Facet:</label>
      <select id="facetSelect">
        <option value="">None</option>
      </select>
      <label for="settingInput">Setting:</label>
      <input id="settingInput" placeholder="e.g. Jer lunch with Joe" />
      <button id="rerunBtn">Re-run Import</button>
    </div>
    <div class="rerun-note">
      Re-running will overwrite the existing transcription results with new ones using the selected facet for improved entity recognition.
    </div>
  </div>
</div>

<script>
// Tab switching with lazy loading
const tabs = document.querySelectorAll('.tab');
const contents = document.querySelectorAll('.tab-content');
let summaryLoaded = false;

tabs.forEach(tab => {
  tab.addEventListener('click', () => {
    const target = tab.dataset.target;
    tabs.forEach(t => t.classList.toggle('active', t.dataset.target === target));
    contents.forEach(c => c.classList.toggle('active', c.id === target));
    
    // Lazy load summary when tab is clicked
    if (target === 'summary' && !summaryLoaded) {
      loadSummary();
    }
  });
});

// Function to load summary
function loadSummary() {
  summaryLoaded = true;
  fetch('{{ url_for("import_view.import_summary_api", timestamp=timestamp) }}')
    .then(r => r.json())
    .then(data => {
      const summaryContent = document.getElementById('summaryContent');
      if (data.has_summary) {
        summaryContent.innerHTML = data.html;
      } else {
        summaryContent.innerHTML = data.html || '<div class="no-data">No summary available</div>';
      }
    })
    .catch(err => {
      document.getElementById('summaryContent').innerHTML = '<div class="no-data" style="color: red;">Error loading summary</div>';
    });
}

// Format JSON with syntax highlighting
function formatJson(obj) {
  if (!obj) return '<span class="json-null">No data available</span>';
  
  const json = JSON.stringify(obj, null, 2);
  return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
    let cls = 'json-number';
    if (/^"/.test(match)) {
      if (/:$/.test(match)) {
        cls = 'json-key';
      } else {
        cls = 'json-string';
      }
    } else if (/true|false/.test(match)) {
      cls = 'json-boolean';
    } else if (/null/.test(match)) {
      cls = 'json-null';
    }
    return '<span class="' + cls + '">' + match + '</span>';
  });
}

// Format file size
function formatFileSize(bytes) {
  if (!bytes || bytes === 0) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

// Format elapsed time
function formatElapsed(ms) {
  if (!ms) return '0s';
  const totalSeconds = Math.floor(ms / 1000);
  const mins = Math.floor(totalSeconds / 60);
  const secs = totalSeconds % 60;
  if (mins > 0) {
    return `${mins}m ${secs}s`;
  }
  return `${secs}s`;
}

// Capitalize stage name
function capitalizeStage(stage) {
  if (!stage) return '';
  return stage.charAt(0).toUpperCase() + stage.slice(1);
}

// Format timestamp
function formatTimestamp(timestamp) {
  if (!timestamp) return '-';
  // Convert YYYYMMDD_HHMMSS to readable format
  const match = timestamp.match(/(\d{4})(\d{2})(\d{2})_(\d{2})(\d{2})(\d{2})/);
  if (match) {
    const [_, year, month, day, hour, min, sec] = match;
    return `${year}-${month}-${day} ${hour}:${min}:${sec}`;
  }
  return timestamp;
}

// Global variable to store import data
let importData = null;
const settingInput = document.getElementById('settingInput');

// Load facets for dropdown
function loadFacets() {
  fetch('{{ url_for("facets.facets_list") }}')
    .then(r => r.json())
    .then(facets => {
      const select = document.getElementById('facetSelect');
      const current = importData?.import_json?.facet || ''; // Use current facet from import
      select.innerHTML = '<option value="">None</option>';
      Object.entries(facets).forEach(([name, data]) => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = data.title || name;
        if (name === current) opt.selected = true;
        select.appendChild(opt);
      });
    })
    .catch(() => {/* ignore */});
}

// Show progress banner and listen for importer events
function watchImportProgress(importId) {
  const progressBanner = document.getElementById('progressBanner');
  const progressStage = document.getElementById('progressStage');
  const progressTiming = document.getElementById('progressTiming');

  progressBanner.classList.add('active');
  progressStage.innerHTML = 'Starting<span class="progress-spinner"></span>';
  progressTiming.textContent = '';

  // Listen for importer events for this import
  const cleanup = appEvents.listen('importer', msg => {
    if (msg.import_id !== importId) return;

    if (msg.event === 'started') {
      progressStage.innerHTML = `${capitalizeStage(msg.stage)}<span class="progress-spinner"></span>`;
    } else if (msg.event === 'status') {
      const stageTime = formatElapsed(msg.stage_elapsed_ms);
      const totalTime = formatElapsed(msg.elapsed_ms);
      progressStage.innerHTML = `${capitalizeStage(msg.stage)}<span class="progress-spinner"></span>`;
      progressTiming.textContent = `${stageTime} (${totalTime} total)`;
    } else if (msg.event === 'completed') {
      progressStage.innerHTML = '‚úì Completed';
      progressTiming.textContent = `Total time: ${formatElapsed(msg.duration_ms)}`;
      cleanup();
      // Reload page after successful completion
      setTimeout(() => location.reload(), 2000);
    } else if (msg.event === 'error') {
      progressStage.innerHTML = '‚úó Failed';
      progressTiming.textContent = `Error: ${msg.error || 'Unknown error'}`;
      cleanup();
    }
  });
}

// Handle re-run button click
document.getElementById('rerunBtn').addEventListener('click', () => {
  const facet = document.getElementById('facetSelect').value;
  const setting = settingInput ? settingInput.value.trim() : '';

  if (confirm('This will re-run the import and overwrite existing transcription results. Continue?')) {
    const btn = document.getElementById('rerunBtn');
    btn.disabled = true;
    btn.textContent = 'Starting...';

    // Call the re-run endpoint
    fetch('{{ url_for("import_view.import_rerun", timestamp=timestamp) }}', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ facet: facet, setting: setting })
    })
    .then(r => r.json())
    .then(result => {
      if (result.status === 'ok') {
        btn.disabled = false;
        btn.textContent = 'Re-run Import';
        // Watch progress using importer events with timestamp as import_id
        watchImportProgress('{{ timestamp }}');
      } else {
        alert('Failed to start re-run: ' + (result.error || 'Unknown error'));
        btn.disabled = false;
        btn.textContent = 'Re-run Import';
      }
    })
    .catch(err => {
      alert('Failed to start re-run: ' + err);
      btn.disabled = false;
      btn.textContent = 'Re-run Import';
    });
  }
});

// Load import details
fetch('{{ url_for("import_view.import_detail_api", timestamp=timestamp) }}')
  .then(r => r.json())
  .then(data => {
    importData = data; // Store globally
    // Update header metadata
    const metaDiv = document.getElementById('importMeta');
    if (data.import_json) {
      const uploadTime = new Date(data.import_json.upload_datetime).toLocaleString();
      const fileName = data.import_json.original_filename || 'Unknown';
      const fileSize = formatFileSize(data.import_json.file_size);
      
      // Determine status based on task_id and imported_json
      let statusClass, statusText;
      if (data.imported_json) {
        statusClass = 'success';
        statusText = 'Completed';
      } else if (data.import_json.task_id) {
        // Task was started but no imported.json
        statusClass = 'failed';
        statusText = 'Failed';
      } else {
        statusClass = 'pending';
        statusText = 'Pending';
      }
      
      metaDiv.innerHTML = `
        <span>${fileName} (${fileSize})</span> ‚Ä¢ 
        <span>Uploaded: ${uploadTime}</span>
        <span class="status-badge ${statusClass}">${statusText}</span>
      `;
    }
    
    // Update overview tab
    const overviewContent = document.getElementById('overviewContent');
    let overviewHtml = '';
    
    if (data.import_json) {
      overviewHtml += `<div class="info-label">Original File:</div><div class="info-value">${data.import_json.original_filename || '-'}</div>`;
      overviewHtml += `<div class="info-label">File Size:</div><div class="info-value">${formatFileSize(data.import_json.file_size)}</div>`;
      overviewHtml += `<div class="info-label">MIME Type:</div><div class="info-value">${data.import_json.mime_type || '-'}</div>`;
      overviewHtml += `<div class="info-label">Upload Time:</div><div class="info-value">${new Date(data.import_json.upload_datetime).toLocaleString()}</div>`;
      overviewHtml += `<div class="info-label">Detected Timestamp:</div><div class="info-value">${formatTimestamp(data.import_json.detected_timestamp) || 'Not detected'}</div>`;
      overviewHtml += `<div class="info-label">Import Timestamp:</div><div class="info-value">${formatTimestamp(data.import_json.user_timestamp)}</div>`;
      if (data.import_json.facet) {
        overviewHtml += `<div class="info-label">Facet:</div><div class="info-value">${data.import_json.facet}</div>`;
      }
      if (data.import_json.setting) {
        overviewHtml += `<div class="info-label">Setting:</div><div class="info-value">${data.import_json.setting}</div>`;
      }
      if (settingInput) {
        settingInput.value = data.import_json.setting || '';
      }
    }
    
    if (data.imported_json) {
      overviewHtml += `<div class="info-label">Processing Status:</div><div class="info-value">Completed</div>`;
      overviewHtml += `<div class="info-label">Target Day:</div><div class="info-value">${data.imported_json.target_day || '-'}</div>`;
      overviewHtml += `<div class="info-label">Files Created:</div><div class="info-value">${data.imported_json.total_files_created || 0}</div>`;
      overviewHtml += `<div class="info-label">Processing Time:</div><div class="info-value">${new Date(data.imported_json.processing_completed).toLocaleString()}</div>`;
      
      // Show quick links
      if (data.imported_json.target_day) {
        const linksSection = document.getElementById('linksSection');
        const quickLinks = document.getElementById('quickLinks');
        linksSection.style.display = 'block';
        
        let linksHtml = '';
        linksHtml += `<div class="link-item">üìÖ <a href="/calendar/${data.imported_json.target_day}">View Day in Calendar</a></div>`;
        linksHtml += `<div class="link-item">üìù <a href="/calendar/${data.imported_json.target_day}#transcript">View Transcript</a></div>`;
        quickLinks.innerHTML = linksHtml;
      }
      
      // Show created files
      if (data.imported_json.all_created_files && data.imported_json.all_created_files.length > 0) {
        const filesList = document.getElementById('filesList');
        const filesListContent = document.getElementById('filesListContent');
        filesList.style.display = 'block';
        
        let filesHtml = '';
        data.imported_json.all_created_files.forEach(file => {
          const basename = file.split('/').pop();
          filesHtml += `<li>${basename}</li>`;
        });
        filesListContent.innerHTML = filesHtml;
      }
    } else {
      overviewHtml += `<div class="info-label">Processing Status:</div><div class="info-value">Pending</div>`;
    }
    
    overviewContent.innerHTML = overviewHtml;
    
    // Update JSON tabs
    document.getElementById('importJsonContent').innerHTML = formatJson(data.import_json);
    document.getElementById('importedJsonContent').innerHTML = data.imported_json ? formatJson(data.imported_json) : '<span class="no-data">Processing not yet completed</span>';
    
    // Show summary tab if summary exists
    if (data.has_summary) {
      const summaryTab = document.getElementById('summaryTab');
      summaryTab.style.display = 'block';
    }
    
    // Show re-run section if import is completed or failed and file exists
    if (data.import_json && data.import_json.file_path) {
      // Show re-run section for completed or failed imports
      if (data.imported_json || (data.import_json.task_id && !data.imported_json)) {
        const rerunSection = document.getElementById('rerunSection');
        rerunSection.style.display = 'block';
        
        // Load facets for the dropdown
        loadFacets();
      }
    }
  })
  .catch(err => {
    console.error('Error loading import details:', err);
    document.getElementById('importMeta').innerHTML = '<span style="color:red;">Error loading import details</span>';
    document.getElementById('overviewContent').innerHTML = '<div class="no-data">Error loading data</div>';
    document.getElementById('importJsonContent').innerHTML = '<span class="no-data">Error loading data</span>';
    document.getElementById('importedJsonContent').innerHTML = '<span class="no-data">Error loading data</span>';
  });
</script>
{% endblock %}
