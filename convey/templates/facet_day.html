{% extends 'base.html' %}
{% set active = 'facets' %}
{% block head %}
<style>
/* Modal styling */
.modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); }
.modal-content { background:white; margin:5% auto; padding:1em; border-radius:8px; max-width:600px; position:relative; }
.close { position:absolute; top:10px; right:15px; cursor:pointer; font-size:24px; }
.occ-field { margin-bottom:0.5em; }
.occ-field strong { display:inline-block; width:90px; }
.occ-desc { margin-top:0.5em; white-space:pre-wrap; }

/* Facet header styling */
.facet-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.5rem;
  padding-bottom: 1rem;
  border-bottom: 3px solid {{ facet_data.color or '#6c757d' }};
}

.facet-title {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.facet-emoji {
  font-size: 1.5rem;
}

.facet-name {
  font-size: 1.2rem;
  font-weight: 600;
  color: {{ facet_data.color or '#6c757d' }};
}

.day-title {
  font-size: 1.5rem;
  font-weight: 400;
  margin-left: 1rem;
  color: #333;
}

.nav-arrows {
  margin: 0 0.5rem;
  color: #666;
  text-decoration: none;
  font-size: 1.2rem;
}

.nav-arrows:hover {
  color: #2563eb;
}

/* Calendar navigation */
.calendar-nav {
  display: flex;
  gap: 0.5rem;
  align-items: center;
}

.nav-btn {
  padding: 0.4rem 0.8rem;
  background: #f3f4f6;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  color: #374151;
  text-decoration: none;
  font-size: 0.9rem;
  transition: background 0.15s, border-color 0.15s;
}

.nav-btn:hover {
  background: #e5e7eb;
  border-color: #9ca3af;
}

.nav-btn.today {
  background: #2563eb;
  border-color: #2563eb;
  color: #ffffff;
}

.nav-btn.today:hover {
  background: #1d4ed8;
  border-color: #1d4ed8;
}

.nav-btn.today.disabled {
  background: #9ca3af;
  border-color: #9ca3af;
  cursor: default;
  opacity: 0.6;
}

.nav-btn.today.disabled:hover {
  background: #9ca3af;
  border-color: #9ca3af;
}

/* Back link */
.back-link {
  display: inline-block;
  margin-bottom: 1rem;
  color: #6c757d;
  text-decoration: none;
  font-size: 0.9rem;
}

.back-link:hover {
  color: #2563eb;
}

/* Timeline styles */
.day-view {
  position: relative;
  background: #fff;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  min-height: 400px;
}

.hour-line {
  position: absolute;
  left: 0;
  right: 0;
  border-top: 1px solid #e5e7eb;
  height: 0;
}

.hour-line span {
  position: absolute;
  left: 8px;
  top: -10px;
  background: #fff;
  padding: 0 4px;
  font-size: 0.75rem;
  color: #6b7280;
}

.occ {
  position: absolute;
  border-radius: 4px;
  padding: 4px 6px;
  font-size: 0.75rem;
  color: white;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  cursor: pointer;
  text-decoration: none;
  display: block;
}

.occ:hover {
  opacity: 0.9;
  filter: brightness(0.95);
}

/* Empty state */
.empty-state {
  text-align: center;
  padding: 4rem 2rem;
  color: #6b7280;
}

.empty-state-icon {
  font-size: 3rem;
  margin-bottom: 1rem;
}

.empty-state-text {
  font-size: 1.1rem;
  margin-bottom: 0.5rem;
}

.empty-state-subtext {
  font-size: 0.9rem;
  color: #9ca3af;
}
</style>
{% endblock %}
{% block body %}
<div class="container">
  <a href="{{ url_for('facets.facet_detail', facet_name=facet_name) }}" class="back-link">
    ‚Üê Back to {{ facet_data.title or facet_name }}
  </a>

  <div class="facet-header">
    <div class="facet-title">
      {% if facet_data.emoji %}
      <span class="facet-emoji">{{ facet_data.emoji }}</span>
      {% endif %}
      <span class="facet-name">{{ facet_data.title or facet_name }}</span>
      <span class="day-title">
        {% if prev_day %}<a href="{{ url_for('facets.facet_day', facet_name=facet_name, day=prev_day) }}" class="nav-arrows">‚óÄ</a>{% endif %}
        {{ title }}
        {% if next_day %}<a href="{{ url_for('facets.facet_day', facet_name=facet_name, day=next_day) }}" class="nav-arrows">‚ñ∂</a>{% endif %}
      </span>
    </div>
    <div class="calendar-nav">
      {% if prev_day %}
        <a href="{{ url_for('facets.facet_day', facet_name=facet_name, day=prev_day) }}" class="nav-btn">‚Üê</a>
      {% endif %}

      {% if day == today_day %}
        <span class="nav-btn today disabled">Today</span>
      {% else %}
        <a href="{{ url_for('facets.facet_day', facet_name=facet_name, day=today_day) }}" class="nav-btn today">Today</a>
      {% endif %}

      {% if next_day %}
        <a href="{{ url_for('facets.facet_day', facet_name=facet_name, day=next_day) }}" class="nav-btn">‚Üí</a>
      {% endif %}
    </div>
  </div>

  {% if occurrences %}
    <div id="timelineView"></div>
  {% else %}
    <div class="empty-state">
      <div class="empty-state-icon">üì≠</div>
      <div class="empty-state-text">No activity for {{ facet_data.title or facet_name }} on this day</div>
      <div class="empty-state-subtext">Try navigating to another day to see facet occurrences</div>
    </div>
  {% endif %}

  <div id="eventModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <div id="modalBody"></div>
    </div>
  </div>
</div>

<script>
const occurrences = {{ occurrences | tojson }};
let events = occurrences || [];

function renderTimeline(list) {
  const div = document.getElementById('timelineView');
  if (!list || !list.length) return;

  // Determine time range
  let start = Infinity;
  let end = -Infinity;
  list.forEach((o) => {
    if (!o.startTime) return;
    const s = new Date(o.startTime);
    const e = o.endTime ? new Date(o.endTime) : new Date(s.getTime() + 3600000);
    const startMinutes = s.getHours() * 60 + s.getMinutes();
    // Ignore events at exactly midnight
    if (startMinutes === 0) return;
    start = Math.min(start, startMinutes);
    end = Math.max(end, e.getHours() * 60 + e.getMinutes());
  });

  let startHour = Math.max(Math.floor(start / 60) - 1, 0);
  let endHour = Math.min(Math.ceil(end / 60) + 1, 24);

  const pxPerHour = 66.7;
  let html = `<div class='day-view' style='height:${(endHour - startHour) * pxPerHour}px'>`;

  // Render hour lines
  for (let h = startHour; h <= endHour; h++) {
    const label = h === 0 ? '12am' : h < 12 ? h + 'am' : h === 12 ? '12pm' : (h - 12) + 'pm';
    html += `<div class='hour-line' style='top:${((h - startHour) / (endHour - startHour)) * 100}%'><span>${label}</span></div>`;
  }

  // Process events
  const processedEvents = [];
  const topics = [];

  list.forEach((o, idx) => {
    if (!o.startTime) return;
    const start = new Date(o.startTime);
    const end = o.endTime ? new Date(o.endTime) : new Date(start.getTime() + 5 * 60000);
    let s = start.getHours() * 60 + start.getMinutes();
    let e = end.getHours() * 60 + end.getMinutes();
    s = Math.max(s, startHour * 60);
    e = Math.min(e, endHour * 60);
    if (e <= s) return;

    const topic = o.topic || 'other';
    if (!topics.includes(topic)) topics.push(topic);

    processedEvents.push({
      startMinutes: s,
      endMinutes: e,
      topic: topic,
      title: escapeHtml(o.title || o.summary || topic),
      color: o.color || '#6c757d',
      index: idx
    });
  });

  // Group by topic
  const eventsByTopic = {};
  topics.forEach(topic => {
    eventsByTopic[topic] = processedEvents.filter(e => e.topic === topic);
    eventsByTopic[topic].sort((a, b) => a.startMinutes - b.startMinutes);
  });

  // Calculate columns
  const topicColumnCounts = {};
  topics.forEach(topic => {
    const topicEvents = eventsByTopic[topic];
    const topicColumns = [];

    topicEvents.forEach(event => {
      let columnIndex = 0;
      while (columnIndex < topicColumns.length &&
             topicColumns[columnIndex].some(existing =>
               event.startMinutes < existing.endMinutes &&
               event.endMinutes > existing.startMinutes)) {
        columnIndex++;
      }

      if (columnIndex === topicColumns.length) {
        topicColumns.push([]);
      }

      topicColumns[columnIndex].push(event);
      event.slugColumn = columnIndex;
    });

    topicColumnCounts[topic] = topicColumns.length;
  });

  // Calculate global positions
  let globalColumnOffset = 0;
  const topicColumnOffsets = {};
  topics.forEach(topic => {
    topicColumnOffsets[topic] = globalColumnOffset;
    globalColumnOffset += topicColumnCounts[topic];
  });

  const totalColumns = globalColumnOffset;
  const columnWidth = totalColumns > 0 ? 100 / totalColumns : 100;

  // Assign final positions
  processedEvents.forEach(event => {
    event.column = topicColumnOffsets[event.topic] + event.slugColumn;
  });

  // Render events
  processedEvents.forEach(event => {
    const top = ((event.startMinutes - startHour * 60) / ((endHour - startHour) * 60)) * 100;
    const height = Math.max((event.endMinutes - event.startMinutes) / ((endHour - startHour) * 60) * 100, 0.4);
    const left = event.column * columnWidth;
    const width = columnWidth * 0.95;
    html += `<div class='occ' data-index='${event.index}' style='top:${top}%;height:${height}%;left:${left}%;width:${width}%;background:${event.color}' title='${event.title}'></div>`;
  });

  html += '</div>';
  div.innerHTML = html;
}

function escapeHtml(text) {
  const d = document.createElement('div');
  d.textContent = text;
  return d.innerHTML;
}

function fmtTime(ts) {
  const d = new Date(ts);
  let h = d.getHours();
  const m = d.getMinutes();
  const suf = h >= 12 ? 'p' : 'a';
  h = h % 12;
  if (h === 0) h = 12;
  return m ? `${h}:${String(m).padStart(2, '0')}${suf}` : `${h}${suf}`;
}

function fmtLength(start, end) {
  const s = new Date(start);
  const e = end ? new Date(end) : new Date(s.getTime() + 5 * 60000);
  const mins = Math.max(1, Math.round((e - s) / 60000));
  if (mins >= 60) {
    const h = Math.floor(mins / 60);
    const m = mins % 60;
    return m ? `${h}h ${m}m` : `${h}h`;
  }
  return `${mins}m`;
}

function openModal(idx) {
  const occ = events[idx];
  if (!occ) return;
  const body = document.getElementById('modalBody');

  const topic = occ.topic ? occ.topic.charAt(0).toUpperCase() + occ.topic.slice(1) : '';
  const titleText = `${topic ? topic + ': ' : ''}${occ.title || ''}`.trim();
  const subtitle = occ.subject || occ.summary || '';
  let html = '';
  if (titleText) html += `<h3>${escapeHtml(titleText)}</h3>`;
  if (subtitle) html += `<h4>${escapeHtml(subtitle)}</h4>`;
  if (occ.startTime) {
    const when = fmtTime(occ.startTime);
    const len = fmtLength(occ.startTime, occ.endTime);
    html += `<div class="occ-field"><strong>Started</strong> ${when} - ${len}</div>`;
  }
  if (Array.isArray(occ.participants) && occ.participants.length > 1) {
    html += `<div class="occ-field"><strong>Participants</strong> ${escapeHtml(occ.participants.join(', '))}</div>`;
  }
  if (occ.details) {
    let det = typeof occ.details === 'string' ? occ.details : JSON.stringify(occ.details, null, 2);
    html += `<div class="occ-desc">${escapeHtml(det)}</div>`;
  }
  body.innerHTML = html;
  document.getElementById('eventModal').style.display = 'block';
}

// Render on load
if (occurrences && occurrences.length > 0) {
  renderTimeline(occurrences);

  // Add click handler for event blocks
  document.getElementById('timelineView').onclick = e => {
    const el = e.target.closest('.occ');
    if (el) {
      e.preventDefault();
      openModal(parseInt(el.dataset.index));
    }
  };
}

// Modal close handlers
document.querySelector('#eventModal .close').onclick = () => {
  document.getElementById('eventModal').style.display = 'none';
};
window.onclick = e => {
  const modal = document.getElementById('eventModal');
  if (e.target === modal) modal.style.display = 'none';
};
</script>
{% endblock %}
