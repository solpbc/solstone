<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>{{ title }}</title>
  <link rel="stylesheet" href="{{ url_for('home.static', filename='review.css') }}">
  {% block head %}{% endblock %}
</head>
<body>
  <div class="nav-icons">
    <a id="homeIcon" data-nav-key="home" href="{{ url_for('home.home') }}" class="{% if active=='home' %}current{% endif %}" title="Home">ğŸ <span class="nav-badge" aria-hidden="true"></span></a>
    <a data-nav-key="facets" href="{{ url_for('facets.facets_page') }}" class="{% if active=='facets' %}current{% endif %}" title="Facets">ğŸ¯<span class="nav-badge" aria-hidden="true"></span></a>
    <a data-nav-key="todos" href="{{ url_for('todos.todos_page') }}" class="{% if active=='todos' %}current{% endif %}" title="Todos">âœ…<span class="nav-badge" aria-hidden="true"></span></a>
    <a data-nav-key="inbox" href="{{ url_for('inbox.inbox_page') }}" class="{% if active=='inbox' %}current{% endif %}" title="Inbox">âœ‰ï¸<span class="nav-badge" aria-hidden="true"></span></a>
    <a data-nav-key="calendar" href="{{ url_for('calendar.calendar_page') }}" class="{% if active=='calendar' %}current{% endif %}" title="Calendar">ğŸ“…<span class="nav-badge" aria-hidden="true"></span></a>
    <a data-nav-key="chat" href="{{ url_for('chat.chat_page') }}" class="{% if active=='chat' %}current{% endif %}" title="Chat">ğŸ’¬<span class="nav-badge" aria-hidden="true"></span></a>
    <a data-nav-key="agents" href="{{ url_for('agents.agents_page') }}" class="{% if active=='agents' %}current{% endif %}" title="Agents">ğŸš€<span class="nav-badge" aria-hidden="true"></span></a>
    <a data-nav-key="search" href="{{ url_for('search.search_page') }}" class="{% if active=='search' %}current{% endif %}" title="Search">ğŸ”<span class="nav-badge" aria-hidden="true"></span></a>
    <a data-nav-key="import" href="{{ url_for('import_view.import_page') }}" class="{% if active=='import' %}current{% endif %}" title="Import">ğŸ“¥<span class="nav-badge" aria-hidden="true"></span></a>
    <a data-nav-key="logout" href="{{ url_for('home.logout') }}" title="Logout">ğŸ”’<span class="nav-badge" aria-hidden="true"></span></a>
  </div>
  <script>
  (function(){
    const badgeData = {{ (nav_badges or {})|tojson }};
    if(!badgeData || typeof badgeData !== 'object') return;
    Object.entries(badgeData).forEach(([key, count]) => {
      if(!count || count < 1) return;
      const anchor = document.querySelector(`.nav-icons a[data-nav-key="${key}"]`);
      if(!anchor) return;
      const badge = anchor.querySelector('.nav-badge');
      if(!badge) return;
      const displayValue = count > 99 ? '99+' : String(count);
      badge.textContent = displayValue;
      badge.style.display = 'inline-flex';
      const existingLabel = anchor.getAttribute('aria-label') || anchor.getAttribute('title') || key;
      anchor.setAttribute('aria-label', `${existingLabel} (${displayValue})`);
      anchor.dataset.badgeCount = String(count);
    });
  })();
  </script>
  <script>
  (function(){
    const listeners = {};  // Keyed by tract: 'cortex', 'task', 'indexer', etc.
    let ws;
    let retry = 1000;
    const home = document.getElementById('homeIcon');
    function connect(){
      ws = new WebSocket(`ws://${location.host}/ws/events`);
      ws.onopen = () => {
        if(home) home.classList.add('connected');
        retry = 1000;
      };
      ws.onclose = () => {
        if(home) home.classList.remove('connected');
        retry = Math.min(retry * 1.5, 15000);
        setTimeout(connect, retry);
      };
      ws.onmessage = e => {
        let msg;
        try { msg = JSON.parse(e.data); } catch(err) { return; }

        const tract = msg.tract;
        if(tract && listeners[tract]){
          listeners[tract].forEach(fn => fn(msg));
        }

        // Also support wildcard listeners for all events
        if(listeners['*']){
          listeners['*'].forEach(fn => fn(msg));
        }
      };
    }
    connect();
    window.appEvents = {
      // Listen for events from a specific tract (cortex, task, indexer, etc.)
      listen(tract, fn){
        if(!listeners[tract]) listeners[tract] = [];
        listeners[tract].push(fn);
        // Return cleanup function
        return () => this.unlisten(tract, fn);
      },
      // Remove a specific listener
      unlisten(tract, fn){
        if(listeners[tract]){
          listeners[tract] = listeners[tract].filter(f => f !== fn);
        }
      }
    };
  })();
  </script>
{% block body %}{% endblock %}
  <div id="errorModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <pre id="errorMessage"></pre>
    </div>
  </div>
  <div id="error-log"></div>
  <script>
    (function(){
      const home = document.getElementById('homeIcon');
      const errorLog = document.getElementById('error-log');

      function logError(text) {
        if(errorLog) {
          errorLog.insertAdjacentHTML(
            'beforeend',
            text.replace(/</g,'&lt;') + '<br>'
          );
          errorLog.style.display = 'block';
        }
      }

      if(home){
        window.addEventListener('error', (e) => {
          home.classList.add('error');
          logError(`âŒ ${e.message} @ ${e.filename}:${e.lineno}`);
        });
        window.addEventListener('unhandledrejection', (e) => {
          home.classList.add('error');
          logError(`âš ï¸ Promise: ${e.reason}`);
        });
      }
    })();
  </script>
  <script>
    (function(){
      const modal=document.getElementById('errorModal');
      const close=modal.querySelector('.close');
      const msg=document.getElementById('errorMessage');
      window.showError=text=>{msg.textContent=text;modal.style.display='block';};
      close.onclick=()=>{modal.style.display='none';};
      window.addEventListener('click',e=>{if(e.target===modal)modal.style.display='none';});
    })();
  </script>
</body>
</html>
