{% extends 'base.html' %}
{% set title = domain_data.title or domain_name %}
{% set active = 'domains' %}
{% block head %}
<style>
/* Domain header */
.domain-header {
  position: relative;
  width: 100%;
  padding: 3em 2em;
  margin-bottom: 2em;
  color: white;
  text-shadow: 0 2px 4px rgba(0,0,0,0.3);
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 0 0 16px 16px;
  overflow: hidden;
  box-sizing: border-box;
}

.domain-header.has-color {
  background: var(--domain-color);
}

.domain-header-content {
  display: flex;
  align-items: center;
  gap: 0.5em;
}

.domain-header .domain-emoji {
  font-size: 2.5em;
  opacity: 0.9;
}

.domain-header h1 {
  margin: 0;
  font-size: 2.5em;
  font-weight: 700;
  color: white;
  background: none;
  -webkit-background-clip: unset;
  -webkit-text-fill-color: unset;
  background-clip: unset;
}


/* Back button */
.back-button {
  position: absolute;
  top: 1em;
  left: 1em;
  color: white;
  text-decoration: none;
  font-size: 1.1em;
  opacity: 0.8;
  transition: opacity 0.2s;
}

.back-button:hover {
  opacity: 1;
  color: white;
}

/* Tab navigation */
.tab-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 0 2em;
  box-sizing: border-box;
  overflow-x: auto;
}

.tab-nav {
  display: flex;
  border-bottom: 2px solid #eee;
  margin-bottom: 2em;
}

.tab-button {
  background: none;
  border: none;
  padding: 1em 2em;
  font-size: 1.1em;
  font-weight: 500;
  color: #666;
  cursor: pointer;
  border-bottom: 3px solid transparent;
  transition: all 0.2s;
}

.tab-button:hover {
  color: #333;
  background: #f8f9fa;
}

.tab-button.active {
  color: #667eea;
  border-bottom-color: #667eea;
  background: #f8f9ff;
}

/* Tab content */
.tab-content {
  display: none;
  padding: 1em 0;
}

.tab-content.active {
  display: block;
}

.tab-content h2 {
  color: #333;
  margin-bottom: 1.5em;
  font-size: 1.8em;
}

/* Placeholder content styling */
.placeholder {
  text-align: center;
  padding: 4em;
  color: #666;
  background: #f8f9fa;
  border-radius: 12px;
  border: 2px dashed #ddd;
}

.placeholder h3 {
  color: #999;
  margin-bottom: 1em;
}

.placeholder p {
  line-height: 1.6;
  max-width: 600px;
  margin: 0 auto;
}

/* News tab styling */
.news-days {
  display: flex;
  flex-direction: column;
  gap: 2.5em;
}

.news-day {
  background: white;
  border-radius: 12px;
  padding: 1.5em;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
  border: 1px solid #eef2ff;
}

.news-day-header {
  margin: 0 0 1em 0;
  font-size: 1.5em;
  font-weight: 600;
  color: #333;
  padding-bottom: 0.5em;
  border-bottom: 2px solid #eef2ff;
}

.newsletter-content {
  line-height: 1.6;
  color: #444;
}

.newsletter-content h1 {
  font-size: 1.8em;
  margin: 1em 0 0.5em 0;
  color: #333;
}

.newsletter-content h2 {
  font-size: 1.4em;
  margin: 1em 0 0.5em 0;
  color: #444;
  border-bottom: 1px solid #eee;
  padding-bottom: 0.25em;
}

.newsletter-content h3 {
  font-size: 1.2em;
  margin: 0.8em 0 0.4em 0;
  color: #555;
}

.newsletter-content p {
  margin: 0.8em 0;
}

.newsletter-content ul,
.newsletter-content ol {
  margin: 0.8em 0;
  padding-left: 1.5em;
}

.newsletter-content li {
  margin: 0.4em 0;
}

.newsletter-content blockquote {
  background: #f9f9fa;
  border-left: 4px solid #667eea;
  padding: 0.8em 1em;
  margin: 1em 0;
  color: #555;
}

.newsletter-content code {
  background: #f4f4f5;
  padding: 0.2em 0.4em;
  border-radius: 3px;
  font-family: 'Courier New', monospace;
  font-size: 0.9em;
}

.newsletter-content pre {
  background: #f4f4f5;
  padding: 1em;
  border-radius: 6px;
  overflow-x: auto;
  margin: 1em 0;
}

.newsletter-content pre code {
  background: none;
  padding: 0;
}

.newsletter-content strong {
  font-weight: 600;
  color: #333;
}

.newsletter-content em {
  font-style: italic;
}

.newsletter-content a {
  color: #667eea;
  text-decoration: none;
  border-bottom: 1px solid transparent;
  transition: border-color 0.2s;
}

.newsletter-content a:hover {
  border-bottom-color: #667eea;
}

.news-load-more {
  text-align: center;
  margin-top: 1.5em;
}

.news-load-more button {
  min-width: 200px;
}

/* Entities table styling */
.entities-container {
  background: white;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.entities-table {
  width: 100%;
  border-collapse: collapse;
}

.entities-table th,
.entities-table td {
  padding: 12px;
  text-align: left;
  border-bottom: 1px solid #e0e0e0;
}

.entities-table th {
  background: #f8f9fa;
  font-weight: 600;
  color: #333;
}

.entities-table tr:hover {
  background: #f8f9fa;
}

.entity-type {
  font-weight: 500;
  color: #007bff;
  width: 100px;
}

.entity-name {
  font-weight: 500;
  width: 200px;
}

.entity-desc {
  color: #666;
}


.star-button {
  background: none;
  border: none;
  font-size: 20px;
  cursor: pointer;
  padding: 6px;
  border-radius: 6px;
  transition: all 0.2s;
  width: 36px;
  text-align: center;
  font-weight: bold;
}

.star-button:hover {
  background: #f0f0f0;
  transform: scale(1.1);
}

.star-button.starred {
  color: #ffc107;
  text-shadow: 0 0 3px rgba(255, 193, 7, 0.5);
}

.star-button.unstarred {
  color: #999;
  border: 2px solid #999;
  background: white;
}

.star-button.unstarred:hover {
  color: #ffc107;
  border-color: #ffc107;
  background: #fff9e6;
}

.entities-section {
  margin-bottom: 1.5em;
}

.entities-section h3 {
  margin: 0 0 1em 0;
  padding: 15px 20px;
  background: #f8f9fa;
  border-bottom: 1px solid #e0e0e0;
  font-size: 1.2em;
  color: #333;
}

.loading {
  text-align: center;
  padding: 2em;
  color: #666;
}

.no-entities {
  text-align: center;
  padding: 2em;
  color: #999;
  font-style: italic;
}

/* Description tab content styling */
.description-content {
  max-width: 800px;
}

.description-content p {
  font-size: 1.1em;
  line-height: 1.6;
  color: #333;
  margin-bottom: 2em;
}

/* Description modal */
.description-modal {
  display: none;
  position: fixed;
  z-index: 2000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.6);
}

.description-modal-content {
  background-color: white;
  margin: 10% auto;
  border-radius: 12px;
  width: 90%;
  max-width: 600px;
  position: relative;
  box-shadow: 0 8px 32px rgba(0,0,0,0.2);
  overflow: hidden;
}

.description-close {
  color: #aaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
  line-height: 1;
  position: absolute;
  top: 15px;
  right: 20px;
  background: white;
  z-index: 3;
  transition: color 0.2s;
}

.description-close:hover {
  color: #000;
}

.description-modal-header {
  padding: 20px 40px 15px 20px;
  border-bottom: 1px solid #e0e0e0;
  background: white;
  border-radius: 12px 12px 0 0;
}

.description-modal-header h3 {
  margin: 0;
  color: #333;
  font-size: 1.4em;
}

.description-modal-body {
  padding: 20px;
}

#descriptionText {
  width: 100%;
  min-height: 120px;
  padding: 12px;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  font-size: 1em;
  font-family: inherit;
  resize: vertical;
  margin-bottom: 20px;
  transition: border-color 0.2s;
}

#descriptionText:focus {
  outline: none;
  border-color: #667eea;
}

.description-buttons {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.generate-btn {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  padding: 10px 16px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 1em;
  display: flex;
  align-items: center;
  gap: 6px;
  transition: all 0.2s;
}

.generate-btn:hover:not(:disabled) {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.generate-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

.generate-btn.generating {
  background: #999;
}

.generate-btn.generating .generate-icon {
  animation: sparkle 1.5s infinite;
}

@keyframes sparkle {
  0%, 100% { transform: scale(1) rotate(0deg); }
  50% { transform: scale(1.2) rotate(180deg); }
}

.button-group {
  display: flex;
  gap: 10px;
}

.cancel-btn, .save-btn {
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 1em;
  transition: all 0.2s;
}

.cancel-btn {
  background: #f8f9fa;
  color: #666;
  border: 1px solid #e0e0e0;
}

.cancel-btn:hover {
  background: #e9ecef;
}

.save-btn {
  background: #28a745;
  color: white;
}

.save-btn:hover {
  background: #218838;
  transform: translateY(-1px);
}

/* Entity description editing */
.entity-edit-btn {
  margin-left: 0.5em;
  cursor: pointer;
  font-size: 1em;
  transition: opacity 0.2s, transform 0.2s;
  display: inline-block;
}

.entity-edit-btn:hover {
  opacity: 1;
  transform: scale(1.1);
}

/* Hide pencil icon by default for entities with descriptions */
.has-entity-desc .entity-edit-btn {
  opacity: 0;
}

.has-entity-desc:hover .entity-edit-btn {
  opacity: 0.6;
}

.no-entity-desc-cell .entity-edit-btn {
  opacity: 0.6;
}

.no-entity-desc {
  color: #999;
  font-style: italic;
  cursor: pointer;
  transition: opacity 0.2s;
}

.no-entity-desc:hover {
  opacity: 0.8;
}

/* Matters styling */
.matters-container {
  background: white;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.matters-list {
  padding: 0;
}

.matter-item {
  border-bottom: 1px solid #e0e0e0;
  padding: 20px;
  transition: background-color 0.2s;
  cursor: pointer;
}

.matter-item:hover {
  background: #f8f9fa;
}

.matter-item:last-child {
  border-bottom: none;
}

.matter-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 8px;
}

.matter-title {
  font-size: 1.2em;
  font-weight: 600;
  color: #333;
  margin: 0;
  flex: 1;
}

.matter-meta {
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 0.9em;
  color: #666;
  flex-shrink: 0;
}

.matter-timestamp {
  color: #999;
}

.matter-activity-count {
  display: flex;
  align-items: center;
  gap: 4px;
  background: #e3f2fd;
  color: #1976d2;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 0.8em;
  font-weight: 500;
}

.matter-description {
  color: #666;
  line-height: 1.4;
  margin: 8px 0;
}

.matter-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 12px;
}

.matter-tags {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}

.matter-tag {
  background: #f1f3f4;
  color: #5f6368;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 0.8em;
  font-weight: 500;
}

.matter-status {
  padding: 4px 12px;
  border-radius: 16px;
  font-size: 0.8em;
  font-weight: 500;
  text-transform: capitalize;
}

.matter-status.active {
  background: #e8f5e8;
  color: #2e7d32;
}

.matter-status.completed {
  background: #e3f2fd;
  color: #1976d2;
}

.matter-status.paused {
  background: #fff3e0;
  color: #f57c00;
}

.matter-status.cancelled {
  background: #ffebee;
  color: #c62828;
}

/* Add Matter styles */
.add-matter-item {
  border: 2px dashed #ddd;
  background: #fafafa;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
  color: #666;
  transition: all 0.2s;
  min-height: 100px;
}

.add-matter-item:hover {
  border-color: #667eea;
  color: #667eea;
  background: #f8f9ff;
}

.add-matter-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
}

.add-matter-icon {
  font-size: 2em;
  font-weight: bold;
}

.add-matter-text {
  font-size: 1.1em;
  font-weight: 500;
}

.btn {
  padding: 0.6em 1.2em;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.95em;
  font-weight: 500;
  transition: background-color 0.2s;
}

.btn-primary {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.btn-primary:hover {
  opacity: 0.9;
}

/* Modal styles */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
}

.modal-content {
  background-color: white;
  margin: 8% auto;
  padding: 1.5em;
  border-radius: 12px;
  width: 90%;
  max-width: 420px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.2);
  max-height: 90vh;
  overflow-y: auto;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.2em;
  padding-bottom: 0.4em;
  border-bottom: 1px solid #eee;
}

.modal-header h2 {
  margin: 0;
  color: #333;
}

.close {
  color: #aaa;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
  line-height: 1;
}

.close:hover {
  color: #333;
}

.form-group {
  margin-bottom: 1.2em;
}

.form-group label {
  display: block;
  margin-bottom: 0.5em;
  font-weight: 500;
  color: #333;
}

.form-group input, .form-group textarea {
  width: 100%;
  padding: 0.6em 0.75em;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-size: 0.95em;
  font-family: inherit;
  transition: border-color 0.2s;
  box-sizing: border-box;
}

.form-group input:focus, .form-group textarea:focus {
  outline: none;
  border-color: #667eea;
}

.form-group textarea {
  resize: vertical;
  min-height: 120px;
}

.form-group small {
  display: block;
  margin-top: 0.25em;
  color: #666;
  font-size: 0.9em;
}

.form-actions {
  display: flex;
  gap: 0.8em;
  justify-content: flex-end;
  margin-top: 1.5em;
}

.btn-secondary {
  background: #f5f5f5;
  color: #666;
}

.btn-secondary:hover {
  background: #eee;
}

.error-message {
  background: #fee;
  color: #c33;
  padding: 0.75em;
  border-radius: 6px;
  margin-bottom: 1em;
  border: 1px solid #fcc;
}
</style>
{% endblock %}
{% block body %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<div class="domain-header{% if domain_data.color %} has-color{% endif %}"{% if domain_data.color %} style="--domain-color: {{ domain_data.color }}"{% endif %}>
  <a href="{{ url_for('domains.domains_page') }}" class="back-button">‚Üê Back to Domains</a>
  
  <div class="domain-header-content">
    {% if domain_data.emoji %}
    <div class="domain-emoji">{{ domain_data.emoji }}</div>
    {% endif %}
    <h1>{{ domain_data.title or domain_name }}</h1>
  </div>
</div>

<div class="tab-container">
  <div class="tab-nav">
    <button class="tab-button active" data-tab="news">Newsletters</button>
    <button class="tab-button" data-tab="matters">Matters</button>
    <button class="tab-button" data-tab="entities">Entities</button>
    <button class="tab-button" data-tab="description">Description</button>
  </div>
  
  <div id="matters-tab" class="tab-content">
    <div class="loading" id="matters-loading">Loading matters...</div>
    <div id="matters-content" style="display: none;">
      <div class="matters-container">
        <div class="matters-list" id="matters-list">
        </div>
        <div id="no-matters" class="no-entities" style="display: none;">
          <p>No matters found for this domain yet.</p>
          <button class="btn btn-primary" onclick="openAddMatterModal()">+ Add Matter</button>
        </div>
        <div class="add-matter-card" id="add-matter-card" style="display: none;">
          <div class="matter-item add-matter-item" onclick="openAddMatterModal()">
            <div class="add-matter-content">
              <div class="add-matter-icon">+</div>
              <div class="add-matter-text">Add Matter</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="news-tab" class="tab-content active">
    <div class="loading" id="news-loading">Loading newsletters...</div>
    <div id="news-content" style="display: none;">
      <div id="news-empty" class="no-entities" style="display: none;">
        <p>No newsletters recorded for this domain yet.</p>
      </div>
      <div class="news-days" id="news-days"></div>
      <div class="news-load-more" id="news-load-more-container" style="display: none;">
        <button id="news-load-more" class="btn btn-secondary">Load more newsletters</button>
      </div>
    </div>
  </div>
  
  <div id="entities-tab" class="tab-content">
    <div class="loading" id="entities-loading">Loading entities...</div>
    <div id="entities-content" style="display: none;">
      <div class="entities-section" id="domain-entities-section">
        <div class="entities-container">
          <table class="entities-table">
            <thead>
              <tr>
                <th></th>
                <th class="entity-type">Type</th>
                <th class="entity-name">Name</th>
                <th class="entity-desc">Description</th>
              </tr>
            </thead>
            <tbody id="domain-entities-tbody">
            </tbody>
          </table>
          <div id="no-domain-entities" class="no-entities" style="display: none;">
            No entities added to this domain yet. Star entities below to add them.
          </div>
        </div>
      </div>
      
      <div class="entities-section">
        <div class="entities-container">
          <h3 id="all-entities-title" style="display: flex; align-items: center; justify-content: space-between;">
            <span>Other Entities</span>
            <input type="text" id="entity-search" placeholder="Search entities..." style="
              max-width: 250px;
              padding: 6px 12px;
              border: 1px solid #ddd;
              border-radius: 6px;
              font-size: 0.9em;
              font-family: inherit;
            ">
          </h3>
          <table class="entities-table">
            <thead>
              <tr>
                <th></th>
                <th class="entity-type">Type</th>
                <th class="entity-name">Name</th>
                <th class="entity-desc">Description</th>
              </tr>
            </thead>
            <tbody id="all-entities-tbody">
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  
  <div id="description-tab" class="tab-content">
    {% if domain_data.description %}
    <div class="description-content has-description">
      <p>{{ domain_data.description }}</p>
      <button class="btn btn-primary" onclick="openDescriptionEditor()">‚úèÔ∏è Edit Description</button>
    </div>
    {% else %}
    <div class="description-content no-description">
      <div class="placeholder">
        <h3>No description yet</h3>
        <p>Add a description to help explain what this domain is about and what matters it contains.</p>
        <button class="btn btn-primary" onclick="openDescriptionEditor()">‚ú® Add Description</button>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<!-- Matter Creation Modal -->
<div id="matterModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Create New Matter</h2>
      <span class="close" onclick="closeMatterModal()">&times;</span>
    </div>
    <div id="matterErrorContainer"></div>
    <form id="matterForm">
      <div class="form-group">
        <label for="matterDescription">Description</label>
        <textarea id="matterDescription" name="description" required placeholder="Describe what this matter is about. The AI will generate an appropriate title and structure based on your description..." style="min-height: 200px;"></textarea>
      </div>
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" onclick="closeMatterModal()">Cancel</button>
        <button type="submit" class="btn btn-primary">Create Matter</button>
      </div>
    </form>
  </div>
</div>

<!-- Description Editor Modal -->
<div id="descriptionModal" class="description-modal">
  <div class="description-modal-content">
    <span class="description-close">&times;</span>
    <div class="description-modal-header">
      <h3 id="modal-title">Edit Domain Description</h3>
    </div>
    <div class="description-modal-body">
      <textarea id="descriptionText" placeholder="Enter domain description..."></textarea>
      <div class="description-buttons">
        <button id="generateBtn" class="generate-btn" title="Generate description with AI">
          <span class="generate-icon">‚ú®</span>
          <span class="generate-text">Generate</span>
        </button>
        <div class="button-group">
          <button id="cancelBtn" class="cancel-btn">Cancel</button>
          <button id="saveBtn" class="save-btn">Save</button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const domainName = '{{ domain_name }}';
let entitiesData = null;
let mattersData = null;
let newsCursor = null;
let newsInitialized = false;
let newsLoading = false;

// Tab switching functionality
document.addEventListener('DOMContentLoaded', function() {
  const tabButtons = document.querySelectorAll('.tab-button');
  const tabContents = document.querySelectorAll('.tab-content');
  
  tabButtons.forEach(button => {
    button.addEventListener('click', function() {
      const targetTab = this.dataset.tab;
      
      // Remove active class from all buttons and content
      tabButtons.forEach(btn => btn.classList.remove('active'));
      tabContents.forEach(content => content.classList.remove('active'));
      
      // Add active class to clicked button and corresponding content
      this.classList.add('active');
      document.getElementById(targetTab + '-tab').classList.add('active');
      
      // Load data when tabs are clicked
      if (targetTab === 'entities') {
        if (!entitiesData) {
          loadEntities();
        }
        // Auto-focus the search input when entities tab is opened
        setTimeout(() => {
          const searchInput = document.getElementById('entity-search');
          if (searchInput) {
            searchInput.focus();
          }
        }, 100);
      } else if (targetTab === 'news') {
        if (!newsInitialized) {
          loadNews();
        }
      } else if (targetTab === 'matters' && !mattersData) {
        loadMatters();
      }
    });
  });
  
  // Add entity search functionality
  const entitySearchInput = document.getElementById('entity-search');
  if (entitySearchInput) {
    entitySearchInput.addEventListener('input', function() {
      const searchTerm = this.value.trim();
      if (entitiesData) {
        renderEntities(searchTerm);
      }
    });
  }

  const newsLoadMoreButton = document.getElementById('news-load-more');
  if (newsLoadMoreButton) {
    newsLoadMoreButton.addEventListener('click', () => {
      loadNews();
    });
  }
  
  // Load newsletters by default since news tab is active
  loadNews();
});

// Matter form submission
document.getElementById('matterForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  clearMatterErrors();
  
  const formData = new FormData(e.target);
  const data = Object.fromEntries(formData.entries());
  
  // Generate title from description if not provided
  if (!data.title) {
    data.title = 'New Matter';
  }
  
  try {
    const response = await fetch(`/api/domains/${encodeURIComponent(domainName)}/matters`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(data)
    });
    
    const result = await response.json();
    
    if (response.ok && result.success) {
      closeMatterModal();
      
      // Redirect to chat view to watch the agent run
      if (result.redirect) {
        window.location.href = result.redirect;
      } else if (result.agent_id) {
        window.location.href = `/chat?agent=${result.agent_id}`;
      } else {
        // Fallback: reload matters list if no redirect
        loadMatters();
      }
    } else {
      showMatterError(result.error || 'An error occurred while creating the matter');
    }
  } catch (error) {
    console.error('Error creating matter:', error);
    showMatterError('Network error occurred');
  }
});

// Close modal when clicking outside
window.addEventListener('click', (e) => {
  const modal = document.getElementById('matterModal');
  if (e.target === modal) {
    closeMatterModal();
  }
});

function loadEntities() {
  fetch(`/api/domains/${encodeURIComponent(domainName)}/entities`)
    .then(response => response.json())
    .then(data => {
      entitiesData = data;
      renderEntities();
      document.getElementById('entities-loading').style.display = 'none';
      document.getElementById('entities-content').style.display = 'block';
    })
    .catch(error => {
      console.error('Error loading entities:', error);
      document.getElementById('entities-loading').innerHTML = 'Error loading entities';
    });
}

function loadNews() {
  if (newsLoading) {
    return;
  }

  const loadingEl = document.getElementById('news-loading');
  const contentEl = document.getElementById('news-content');
  const emptyEl = document.getElementById('news-empty');
  const loadMoreContainer = document.getElementById('news-load-more-container');
  const loadMoreButton = document.getElementById('news-load-more');

  newsLoading = true;

  if (!newsInitialized) {
    if (loadingEl) {
      loadingEl.style.display = 'block';
    }
    if (contentEl) {
      contentEl.style.display = 'none';
    }
  } else if (loadMoreButton) {
    loadMoreButton.disabled = true;
    loadMoreButton.textContent = 'Loading...';
  }

  const params = new URLSearchParams();
  if (newsCursor) {
    params.append('cursor', newsCursor);
  }
  params.append('days', '5');

  fetch(`/api/domains/${encodeURIComponent(domainName)}/news?${params.toString()}`)
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        throw new Error(data.error);
      }

      if (!newsInitialized) {
        if (loadingEl) {
          loadingEl.style.display = 'none';
        }
        if (contentEl) {
          contentEl.style.display = 'block';
        }
      }

      const days = Array.isArray(data.days) ? data.days : [];

      if (days.length === 0 && !newsInitialized) {
        if (emptyEl) {
          emptyEl.style.display = 'block';
        }
      } else if (days.length > 0) {
        if (emptyEl) {
          emptyEl.style.display = 'none';
        }
        days.forEach(day => appendNewsDay(day));
      }

      newsCursor = data.next_cursor || null;

      if (loadMoreContainer && loadMoreButton) {
        if (data.has_more && newsCursor) {
          loadMoreContainer.style.display = 'block';
          loadMoreButton.disabled = false;
          loadMoreButton.textContent = 'Load more newsletters';
        } else if (newsInitialized || days.length > 0) {
          loadMoreContainer.style.display = 'none';
          loadMoreButton.disabled = false;
          loadMoreButton.textContent = 'Load more newsletters';
        }
      }

      newsInitialized = true;
      newsLoading = false;
    })
    .catch(error => {
      console.error('Error loading news:', error);

      if (!newsInitialized) {
        if (loadingEl) {
          loadingEl.innerHTML = 'Error loading news: ' + error.message;
        }
      } else if (loadMoreButton) {
        loadMoreButton.disabled = false;
        loadMoreButton.textContent = 'Load previous day';
      }

      newsLoading = false;
    });
}

function appendNewsDay(day) {
  const container = document.getElementById('news-days');
  if (!container) {
    return;
  }

  const section = document.createElement('section');
  section.className = 'news-day';

  const header = document.createElement('h3');
  header.className = 'news-day-header';
  header.textContent = formatNewsDateKey(day.date);
  section.appendChild(header);

  if (day.raw_content) {
    const contentDiv = document.createElement('div');
    contentDiv.className = 'newsletter-content';

    // Configure marked for safe rendering
    marked.setOptions({
      breaks: true,
      gfm: true,
      headerIds: false,
      mangle: false
    });

    // Remove the top-level heading if present (we show it in our header)
    let content = day.raw_content;
    content = content.replace(/^# .+\n+/, '');

    // Render markdown to HTML
    contentDiv.innerHTML = marked.parse(content);
    section.appendChild(contentDiv);
  } else {
    const emptyNotice = document.createElement('div');
    emptyNotice.className = 'no-entities';
    emptyNotice.textContent = 'No newsletter content for this day.';
    section.appendChild(emptyNotice);
  }

  container.appendChild(section);
}

function formatNewsDateKey(dateKey) {
  if (!dateKey || typeof dateKey !== 'string' || dateKey.length !== 8) {
    return dateKey || 'Unknown date';
  }

  const year = Number(dateKey.slice(0, 4));
  const month = Number(dateKey.slice(4, 6)) - 1;
  const day = Number(dateKey.slice(6, 8));

  const dateObj = new Date(year, month, day);
  if (Number.isNaN(dateObj.getTime())) {
    return dateKey;
  }

  return dateObj.toLocaleDateString(undefined, {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
}

function renderEntities(searchTerm = '') {
  if (!entitiesData) return;
  
  const domainTbody = document.getElementById('domain-entities-tbody');
  const allTbody = document.getElementById('all-entities-tbody');
  const noDomainEntities = document.getElementById('no-domain-entities');
  
  // Clear existing content
  domainTbody.innerHTML = '';
  allTbody.innerHTML = '';
  
  // Render domain entities
  const starredEntities = entitiesData.all_entities.filter(e => e.starred);
  if (starredEntities.length === 0) {
    noDomainEntities.style.display = 'block';
    document.getElementById('domain-entities-section').querySelector('table').style.display = 'none';
  } else {
    noDomainEntities.style.display = 'none';
    document.getElementById('domain-entities-section').querySelector('table').style.display = 'table';
    
    starredEntities.forEach(entity => {
      const row = createEntityRow(entity, true);
      domainTbody.appendChild(row);
    });
  }
  
  // Render non-starred entities only (filtering out domain entities)
  const unstarredEntities = entitiesData.all_entities.filter(e => !e.starred);
  
  // Apply search filter if searchTerm is provided
  const filteredEntities = searchTerm 
    ? unstarredEntities.filter(entity => 
        entity.name.toLowerCase().includes(searchTerm.toLowerCase())
      )
    : unstarredEntities;
  
  filteredEntities.forEach(entity => {
    const row = createEntityRow(entity, false);
    allTbody.appendChild(row);
  });
}

function createEntityRow(entity, isDomainSection) {
  const row = document.createElement('tr');
  
  const starCell = document.createElement('td');
  const starButton = document.createElement('button');
  starButton.className = `star-button ${entity.starred ? 'starred' : 'unstarred'}`;
  starButton.innerHTML = entity.starred ? '‚òÖ' : '‚òÜ';
  starButton.onclick = () => toggleEntityStar(entity, starButton);
  starCell.appendChild(starButton);
  
  const typeCell = document.createElement('td');
  typeCell.className = 'entity-type';
  typeCell.textContent = entity.type;
  
  const nameCell = document.createElement('td');
  nameCell.className = 'entity-name';
  nameCell.textContent = entity.name;
  
  const descCell = document.createElement('td');
  descCell.className = 'entity-desc';
  if (entity.desc) {
    descCell.innerHTML = `<span class="entity-desc-text">${entity.desc}</span> <span class="entity-edit-btn" onclick="openEntityDescriptionEditor('${entity.type}', '${entity.name.replace(/'/g, "\\'")}', '${(entity.desc || '').replace(/'/g, "\\'")}')" title="Edit description">‚úèÔ∏è</span>`;
    descCell.classList.add('has-entity-desc');
  } else {
    descCell.innerHTML = `<span class="no-entity-desc" onclick="openEntityDescriptionEditor('${entity.type}', '${entity.name.replace(/'/g, "\\'")}', '')">Add description...</span> <span class="entity-edit-btn" onclick="openEntityDescriptionEditor('${entity.type}', '${entity.name.replace(/'/g, "\\'")}', '')" title="Add description">‚ú®</span>`;
    descCell.classList.add('no-entity-desc-cell');
  }
  
  row.appendChild(starCell);
  row.appendChild(typeCell);
  row.appendChild(nameCell);
  row.appendChild(descCell);
  
  return row;
}

function toggleEntityStar(entity, starButton) {
  const wasStarred = entity.starred;
  
  // Disable button during request
  starButton.disabled = true;
  starButton.style.opacity = '0.5';
  
  const method = wasStarred ? 'DELETE' : 'POST';
  const url = `/api/domains/${encodeURIComponent(domainName)}/entities`;
  
  fetch(url, {
    method: method,
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      type: entity.type,
      name: entity.name,
      desc: entity.desc
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Update entity state
      entity.starred = !wasStarred;
      
      // Update star button
      starButton.className = `star-button ${entity.starred ? 'starred' : 'unstarred'}`;
      starButton.innerHTML = entity.starred ? '‚òÖ' : '‚òÜ';
      
      // Get search input element
      const searchInput = document.getElementById('entity-search');
      
      // If entity was just starred (added to domain) and there was a search term
      if (!wasStarred && searchInput && searchInput.value.trim()) {
        // Clear the search box and refocus it
        searchInput.value = '';
        searchInput.focus();
        // Re-render entities without search filter
        renderEntities('');
      } else {
        // Otherwise maintain current search filter
        const currentSearchTerm = searchInput ? searchInput.value.trim() : '';
        renderEntities(currentSearchTerm);
      }
    } else {
      console.error('Error toggling entity:', data.error);
      alert('Error: ' + (data.error || 'Unknown error'));
    }
    
    // Re-enable button
    starButton.disabled = false;
    starButton.style.opacity = '1';
  })
  .catch(error => {
    console.error('Network error:', error);
    alert('Network error: ' + error.message);
    
    // Re-enable button
    starButton.disabled = false;
    starButton.style.opacity = '1';
  });
}

function loadMatters() {
  fetch(`/api/domains/${encodeURIComponent(domainName)}/matters`)
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        console.error('Error loading matters:', data.error);
        document.getElementById('matters-loading').innerHTML = 'Error loading matters: ' + data.error;
        return;
      }
      
      mattersData = data.matters;
      renderMatters();
      document.getElementById('matters-loading').style.display = 'none';
      document.getElementById('matters-content').style.display = 'block';
    })
    .catch(error => {
      console.error('Error loading matters:', error);
      document.getElementById('matters-loading').innerHTML = 'Error loading matters';
    });
}

function renderMatters() {
  if (!mattersData) return;
  
  const mattersList = document.getElementById('matters-list');
  const noMatters = document.getElementById('no-matters');
  const addMatterCard = document.getElementById('add-matter-card');
  
  // Clear existing content
  mattersList.innerHTML = '';
  
  if (mattersData.length === 0) {
    noMatters.style.display = 'block';
    addMatterCard.style.display = 'none';
    return;
  }
  
  noMatters.style.display = 'none';
  addMatterCard.style.display = 'block';
  
  mattersData.forEach(matter => {
    const matterElement = createMatterElement(matter);
    mattersList.appendChild(matterElement);
  });
}

function createMatterElement(matter) {
  const div = document.createElement('div');
  div.className = 'matter-item';
  
  // Format timestamp
  let timestampText = 'No activity';
  if (matter.log_mtime) {
    timestampText = formatTimeSince(matter.log_mtime);
  }
  
  // Create tags HTML
  let tagsHtml = '';
  if (matter.tags && matter.tags.length > 0) {
    tagsHtml = matter.tags.map(tag => 
      `<span class="matter-tag">${escapeHtml(tag)}</span>`
    ).join('');
  }
  
  // Create status HTML
  let statusHtml = '';
  if (matter.status) {
    statusHtml = `<span class="matter-status ${matter.status}">${escapeHtml(matter.status)}</span>`;
  }
  
  div.innerHTML = `
    <div class="matter-header">
      <h3 class="matter-title">${escapeHtml(matter.title || 'Untitled Matter')}</h3>
      <div class="matter-meta">
        <span class="matter-timestamp">${timestampText}</span>
        <span class="matter-activity-count">
          üìù ${matter.activity_count} ${matter.activity_count === 1 ? 'entry' : 'entries'}
        </span>
      </div>
    </div>
    ${matter.description ? `<div class="matter-description">${escapeHtml(matter.description)}</div>` : ''}
    <div class="matter-footer">
      <div class="matter-tags">${tagsHtml}</div>
      ${statusHtml}
    </div>
  `;
  
  // Add click handler to navigate to matter detail view
  div.onclick = () => {
    window.location.href = `/domains/${encodeURIComponent(domainName)}/matters/${matter.matter_id}`;
  };
  
  return div;
}

function formatTimeSince(epochSeconds) {
  const now = Math.floor(Date.now() / 1000);
  const seconds = now - epochSeconds;
  
  if (seconds < 60) {
    return `${seconds} seconds ago`;
  }
  
  const minutes = Math.floor(seconds / 60);
  if (minutes < 60) {
    return `${minutes} minute${minutes !== 1 ? 's' : ''} ago`;
  }
  
  const hours = Math.floor(minutes / 60);
  if (hours < 24) {
    return `${hours} hour${hours !== 1 ? 's' : ''} ago`;
  }
  
  const days = Math.floor(hours / 24);
  if (days < 7) {
    return `${days} day${days !== 1 ? 's' : ''} ago`;
  }
  
  const weeks = Math.floor(days / 7);
  return `${weeks} week${weeks !== 1 ? 's' : ''} ago`;
}

function openAddMatterModal() {
  const modal = document.getElementById('matterModal');
  const form = document.getElementById('matterForm');
  
  // Reset form
  form.reset();
  clearMatterErrors();
  
  // Set focus to description field
  
  modal.style.display = 'block';
  document.getElementById('matterDescription').focus();
}

function closeMatterModal() {
  const modal = document.getElementById('matterModal');
  const form = document.getElementById('matterForm');
  
  modal.style.display = 'none';
  form.reset();
  clearMatterErrors();
}

function clearMatterErrors() {
  document.getElementById('matterErrorContainer').innerHTML = '';
}

function showMatterError(message) {
  document.getElementById('matterErrorContainer').innerHTML = 
    `<div class="error-message">${message}</div>`;
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Description editor functionality
function openDescriptionEditor() {
  const modal = document.getElementById('descriptionModal');
  const textarea = document.getElementById('descriptionText');
  
  // Set current description
  const currentDesc = '{{ domain_data.description|replace("'", "\\'") }}' || '';
  textarea.value = currentDesc;
  
  modal.style.display = 'block';
  textarea.focus();
}

function closeDescriptionEditor() {
  document.getElementById('descriptionModal').style.display = 'none';
}

// Modal event listeners
document.addEventListener('DOMContentLoaded', function() {
  const modal = document.getElementById('descriptionModal');
  const closeBtn = document.querySelector('.description-close');
  const cancelBtn = document.getElementById('cancelBtn');
  const saveBtn = document.getElementById('saveBtn');
  const generateBtn = document.getElementById('generateBtn');
  
  // Close modal
  closeBtn.onclick = closeDescriptionEditor;
  cancelBtn.onclick = closeDescriptionEditor;
  
  // Click outside to close
  window.onclick = function(event) {
    if (event.target === modal) {
      closeDescriptionEditor();
    }
  };
  
  // Save description
  saveBtn.onclick = function() {
    const description = document.getElementById('descriptionText').value.trim();
    saveDescription(description);
  };
  
  // Generate description
  generateBtn.onclick = function() {
    generateDescription();
  };
});

function saveDescription(description) {
  const saveBtn = document.getElementById('saveBtn');
  const originalText = saveBtn.textContent;
  
  saveBtn.textContent = 'Saving...';
  saveBtn.disabled = true;
  
  fetch(`/api/domains/${encodeURIComponent(domainName)}`, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      description: description
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Update the page description
      const descElement = document.querySelector('.description');
      if (description) {
        descElement.innerHTML = `${description} <span class="edit-description-btn" onclick="openDescriptionEditor()" title="Edit description">‚ú®</span>`;
        descElement.classList.remove('no-description');
      } else {
        descElement.innerHTML = '<span class="add-description-text" onclick="openDescriptionEditor()">Add description...</span> <span class="edit-description-btn" onclick="openDescriptionEditor()" title="Add description">‚ú®</span>';
        descElement.classList.add('no-description');
      }
      closeDescriptionEditor();
    } else {
      alert('Error saving description: ' + (data.error || 'Unknown error'));
    }
    
    saveBtn.textContent = originalText;
    saveBtn.disabled = false;
  })
  .catch(error => {
    console.error('Error saving description:', error);
    alert('Network error: ' + error.message);
    
    saveBtn.textContent = originalText;
    saveBtn.disabled = false;
  });
}

function generateDescription() {
  const generateBtn = document.getElementById('generateBtn');
  const textarea = document.getElementById('descriptionText');
  const generateIcon = generateBtn.querySelector('.generate-icon');
  const generateText = generateBtn.querySelector('.generate-text');
  
  // Update button state
  generateBtn.disabled = true;
  generateBtn.classList.add('generating');
  generateText.textContent = 'Generating...';
  
  const currentDescription = textarea.value.trim();
  
  fetch(`/api/domains/${encodeURIComponent(domainName)}/generate-description`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      current_description: currentDescription,
      domain_name: domainName
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success && data.description) {
      textarea.value = data.description;
      textarea.focus();
    } else {
      alert('Error generating description: ' + (data.error || 'Unknown error'));
    }
    
    // Reset button state
    generateBtn.disabled = false;
    generateBtn.classList.remove('generating');
    generateText.textContent = 'Generate';
  })
  .catch(error => {
    console.error('Error generating description:', error);
    alert('Network error: ' + error.message);
    
    // Reset button state
    generateBtn.disabled = false;
    generateBtn.classList.remove('generating');
    generateText.textContent = 'Generate';
  });
}

// Entity description editing
let currentEntityType = null;
let currentEntityName = null;

function openEntityDescriptionEditor(entityType, entityName, currentDescription) {
  currentEntityType = entityType;
  currentEntityName = entityName;
  
  const modal = document.getElementById('descriptionModal');
  const textarea = document.getElementById('descriptionText');
  const title = document.getElementById('modal-title');
  
  // Update modal title and content
  title.textContent = `Edit ${entityType}: ${entityName}`;
  textarea.placeholder = `Enter description for ${entityName}...`;
  textarea.value = currentDescription || '';
  
  modal.style.display = 'block';
  textarea.focus();
}

// Override save function to handle both domain and entity descriptions
function saveDescription(description) {
  const saveBtn = document.getElementById('saveBtn');
  const originalText = saveBtn.textContent;
  
  saveBtn.textContent = 'Saving...';
  saveBtn.disabled = true;
  
  // Determine if we're editing domain or entity description
  if (currentEntityType && currentEntityName) {
    // Save entity description
    saveEntityDescription(description);
  } else {
    // Save domain description (original functionality)
    saveDomainDescription(description);
  }
}

function saveDomainDescription(description) {
  const saveBtn = document.getElementById('saveBtn');
  
  fetch(`/api/domains/${encodeURIComponent(domainName)}`, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      description: description
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Update the description tab content
      const descContent = document.querySelector('.description-content');
      if (description) {
        descContent.innerHTML = `<p>${description}</p><button class="btn btn-primary" onclick="openDescriptionEditor()">‚úèÔ∏è Edit Description</button>`;
        descContent.classList.remove('no-description');
        descContent.classList.add('has-description');
      } else {
        descContent.innerHTML = `
          <div class="placeholder">
            <h3>No description yet</h3>
            <p>Add a description to help explain what this domain is about and what matters it contains.</p>
            <button class="btn btn-primary" onclick="openDescriptionEditor()">‚ú® Add Description</button>
          </div>
        `;
        descContent.classList.add('no-description');
        descContent.classList.remove('has-description');
      }
      closeDescriptionEditor();
    } else {
      alert('Error saving description: ' + (data.error || 'Unknown error'));
    }
    
    saveBtn.textContent = 'Save';
    saveBtn.disabled = false;
  })
  .catch(error => {
    console.error('Error saving description:', error);
    alert('Network error: ' + error.message);
    
    saveBtn.textContent = 'Save';
    saveBtn.disabled = false;
  });
}

function saveEntityDescription(description) {
  const saveBtn = document.getElementById('saveBtn');
  
  fetch(`/api/domains/${encodeURIComponent(domainName)}/entities/description`, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      type: currentEntityType,
      name: currentEntityName,
      description: description
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Update the entity in our local data
      if (entitiesData && entitiesData.all_entities) {
        const entity = entitiesData.all_entities.find(e => 
          e.type === currentEntityType && e.name === currentEntityName
        );
        if (entity) {
          entity.desc = description;
        }
      }
      
      // Get current search term to maintain filter
      const searchInput = document.getElementById('entity-search');
      const currentSearchTerm = searchInput ? searchInput.value.trim() : '';
      
      // Re-render the entities tables with current search filter
      renderEntities(currentSearchTerm);
      closeDescriptionEditor();
    } else {
      alert('Error saving entity description: ' + (data.error || 'Unknown error'));
    }
    
    saveBtn.textContent = 'Save';
    saveBtn.disabled = false;
  })
  .catch(error => {
    console.error('Error saving entity description:', error);
    alert('Network error: ' + error.message);
    
    saveBtn.textContent = 'Save';
    saveBtn.disabled = false;
  });
}

// Override generate function to handle both domain and entity descriptions
function generateDescription() {
  const generateBtn = document.getElementById('generateBtn');
  const textarea = document.getElementById('descriptionText');
  const generateIcon = generateBtn.querySelector('.generate-icon');
  const generateText = generateBtn.querySelector('.generate-text');
  
  // Update button state
  generateBtn.disabled = true;
  generateBtn.classList.add('generating');
  generateText.textContent = 'Generating...';
  
  const currentDescription = textarea.value.trim();
  
  // Determine API endpoint and payload
  let apiUrl, payload;
  
  if (currentEntityType && currentEntityName) {
    // Generate entity description
    apiUrl = `/api/domains/${encodeURIComponent(domainName)}/entities/generate-description`;
    payload = {
      type: currentEntityType,
      name: currentEntityName,
      current_description: currentDescription
    };
  } else {
    // Generate domain description (original functionality)
    apiUrl = `/api/domains/${encodeURIComponent(domainName)}/generate-description`;
    payload = {
      current_description: currentDescription,
      domain_name: domainName
    };
  }
  
  fetch(apiUrl, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(payload)
  })
  .then(response => response.json())
  .then(data => {
    if (data.success && data.description) {
      textarea.value = data.description;
      textarea.focus();
    } else {
      alert('Error generating description: ' + (data.error || 'Unknown error'));
    }
    
    // Reset button state
    generateBtn.disabled = false;
    generateBtn.classList.remove('generating');
    generateText.textContent = 'Generate';
  })
  .catch(error => {
    console.error('Error generating description:', error);
    alert('Network error: ' + error.message);
    
    // Reset button state
    generateBtn.disabled = false;
    generateBtn.classList.remove('generating');
    generateText.textContent = 'Generate';
  });
}

// Reset entity editing state when modal closes
function closeDescriptionEditor() {
  currentEntityType = null;
  currentEntityName = null;
  document.getElementById('modal-title').textContent = 'Edit Domain Description';
  document.getElementById('descriptionText').placeholder = 'Enter domain description...';
  document.getElementById('descriptionModal').style.display = 'none';
}
</script>
{% endblock %}
