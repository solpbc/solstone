{% extends 'base.html' %}
{% set title = domain_data.title or domain_name %}
{% set active = 'domains' %}
{% block head %}
<style>
/* Domain header */
.domain-header {
  position: relative;
  width: 100%;
  padding: 3em 2em;
  margin-bottom: 2em;
  color: white;
  text-shadow: 0 2px 4px rgba(0,0,0,0.3);
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 0 0 16px 16px;
  overflow: hidden;
  box-sizing: border-box;
}

.domain-header.has-color {
  background: var(--domain-color);
}

.domain-header-content {
  display: flex;
  align-items: center;
  gap: 0.5em;
}

.domain-header .domain-emoji {
  font-size: 2.5em;
  opacity: 0.9;
}

.domain-header h1 {
  margin: 0;
  font-size: 2.5em;
  font-weight: 700;
  color: white;
  background: none;
  -webkit-background-clip: unset;
  -webkit-text-fill-color: unset;
  background-clip: unset;
}


/* Back button */
.back-button {
  position: absolute;
  top: 1em;
  left: 1em;
  color: white;
  text-decoration: none;
  font-size: 1.1em;
  opacity: 0.8;
  transition: opacity 0.2s;
}

.back-button:hover {
  opacity: 1;
  color: white;
}

/* Tab navigation */
.tab-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 0 2em;
  box-sizing: border-box;
  overflow-x: auto;
}

.tab-nav {
  display: flex;
  border-bottom: 2px solid #eee;
  margin-bottom: 2em;
}

.tab-button {
  background: none;
  border: none;
  padding: 1em 2em;
  font-size: 1.1em;
  font-weight: 500;
  color: #666;
  cursor: pointer;
  border-bottom: 3px solid transparent;
  transition: all 0.2s;
}

.tab-button:hover {
  color: #333;
  background: #f8f9fa;
}

.tab-button.active {
  color: #667eea;
  border-bottom-color: #667eea;
  background: #f8f9ff;
}

.tab-link {
  display: flex;
  align-items: center;
  padding: 1em 2em;
  font-size: 1.1em;
  font-weight: 500;
  color: #666;
  text-decoration: none;
  border-bottom: 3px solid transparent;
  transition: all 0.2s;
  margin-left: auto;
}

.tab-link:hover {
  color: #667eea;
  background: #f8f9fa;
}

.tab-link .gear-icon {
  transition: transform 0.3s ease;
}

.tab-link:hover .gear-icon {
  transform: rotate(90deg);
}

/* Tab content */
.tab-content {
  display: none;
  padding: 1em 0;
}

.tab-content.active {
  display: block;
}

.tab-content h2 {
  color: #333;
  margin-bottom: 1.5em;
  font-size: 1.8em;
}

/* Placeholder content styling */
.placeholder {
  text-align: center;
  padding: 4em;
  color: #666;
  background: #f8f9fa;
  border-radius: 12px;
  border: 2px dashed #ddd;
}

.placeholder h3 {
  color: #999;
  margin-bottom: 1em;
}

.placeholder p {
  line-height: 1.6;
  max-width: 600px;
  margin: 0 auto;
}

/* News tab styling */
.news-days {
  display: flex;
  flex-direction: column;
  gap: 2.5em;
}

.news-day {
  background: white;
  border-radius: 12px;
  padding: 1.5em;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
  border: 1px solid #eef2ff;
}

.news-day-header {
  margin: 0 0 1em 0;
  font-size: 1.5em;
  font-weight: 600;
  color: #333;
  padding-bottom: 0.5em;
  border-bottom: 2px solid #eef2ff;
}

.newsletter-content {
  line-height: 1.6;
  color: #444;
}

.newsletter-content h1 {
  font-size: 1.8em;
  margin: 1em 0 0.5em 0;
  color: #333;
}

.newsletter-content h2 {
  font-size: 1.4em;
  margin: 1em 0 0.5em 0;
  color: #444;
  border-bottom: 1px solid #eee;
  padding-bottom: 0.25em;
}

.newsletter-content h3 {
  font-size: 1.2em;
  margin: 0.8em 0 0.4em 0;
  color: #555;
}

.newsletter-content p {
  margin: 0.8em 0;
}

.newsletter-content ul,
.newsletter-content ol {
  margin: 0.8em 0;
  padding-left: 1.5em;
}

.newsletter-content li {
  margin: 0.4em 0;
}

.newsletter-content blockquote {
  background: #f9f9fa;
  border-left: 4px solid #667eea;
  padding: 0.8em 1em;
  margin: 1em 0;
  color: #555;
}

.newsletter-content code {
  background: #f4f4f5;
  padding: 0.2em 0.4em;
  border-radius: 3px;
  font-family: 'Courier New', monospace;
  font-size: 0.9em;
}

.newsletter-content pre {
  background: #f4f4f5;
  padding: 1em;
  border-radius: 6px;
  overflow-x: auto;
  margin: 1em 0;
}

.newsletter-content pre code {
  background: none;
  padding: 0;
}

.newsletter-content strong {
  font-weight: 600;
  color: #333;
}

.newsletter-content em {
  font-style: italic;
}

.newsletter-content a {
  color: #667eea;
  text-decoration: none;
  border-bottom: 1px solid transparent;
  transition: border-color 0.2s;
}

.newsletter-content a:hover {
  border-bottom-color: #667eea;
}

.news-load-more {
  text-align: center;
  margin-top: 1.5em;
}

.news-load-more button {
  min-width: 200px;
}

/* Entities table styling */
.entities-container {
  background: white;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.entities-table {
  width: 100%;
  border-collapse: collapse;
}

.entities-table th,
.entities-table td {
  padding: 12px;
  text-align: left;
  border-bottom: 1px solid #e0e0e0;
}

.entities-table th {
  background: #f8f9fa;
  font-weight: 600;
  color: #333;
}

.entities-table tr:hover {
  background: #f8f9fa;
}

.entity-type {
  font-weight: 500;
  color: #007bff;
  width: 100px;
}

.entity-name {
  font-weight: 500;
  width: 200px;
}

.entity-desc {
  color: #666;
}


.star-button {
  background: none;
  border: none;
  font-size: 20px;
  cursor: pointer;
  padding: 6px;
  border-radius: 6px;
  transition: all 0.2s;
  width: 36px;
  text-align: center;
  font-weight: bold;
}

.star-button:hover {
  background: #f0f0f0;
  transform: scale(1.1);
}

.star-button.starred {
  color: #ffc107;
  text-shadow: 0 0 3px rgba(255, 193, 7, 0.5);
}

.star-button.unstarred {
  color: #999;
  border: 2px solid #999;
  background: white;
}

.star-button.unstarred:hover {
  color: #ffc107;
  border-color: #ffc107;
  background: #fff9e6;
}

.entities-section {
  margin-bottom: 1.5em;
}

.entities-section h3 {
  margin: 0 0 1em 0;
  padding: 15px 20px;
  background: #f8f9fa;
  border-bottom: 1px solid #e0e0e0;
  font-size: 1.2em;
  color: #333;
}

.loading {
  text-align: center;
  padding: 2em;
  color: #666;
}

.no-entities {
  text-align: center;
  padding: 2em;
  color: #999;
  font-style: italic;
}

/* Description tab content styling */
.description-content {
  max-width: 800px;
}

.description-content p {
  font-size: 1.1em;
  line-height: 1.6;
  color: #333;
  margin-bottom: 2em;
}

/* Description modal */
.description-modal {
  display: none;
  position: fixed;
  z-index: 2000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.6);
}

.description-modal-content {
  background-color: white;
  margin: 10% auto;
  border-radius: 12px;
  width: 90%;
  max-width: 600px;
  position: relative;
  box-shadow: 0 8px 32px rgba(0,0,0,0.2);
  overflow: hidden;
}

.description-close {
  color: #aaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
  line-height: 1;
  position: absolute;
  top: 15px;
  right: 20px;
  background: white;
  z-index: 3;
  transition: color 0.2s;
}

.description-close:hover {
  color: #000;
}

.description-modal-header {
  padding: 20px 40px 15px 20px;
  border-bottom: 1px solid #e0e0e0;
  background: white;
  border-radius: 12px 12px 0 0;
}

.description-modal-header h3 {
  margin: 0;
  color: #333;
  font-size: 1.4em;
}

.description-modal-body {
  padding: 20px;
}

#descriptionText {
  width: 100%;
  min-height: 120px;
  padding: 12px;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  font-size: 1em;
  font-family: inherit;
  resize: vertical;
  margin-bottom: 20px;
  transition: border-color 0.2s;
}

#descriptionText:focus {
  outline: none;
  border-color: #667eea;
}

.description-buttons {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.generate-btn {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  padding: 10px 16px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 1em;
  display: flex;
  align-items: center;
  gap: 6px;
  transition: all 0.2s;
}

.generate-btn:hover:not(:disabled) {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.generate-btn:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

.generate-btn.generating {
  background: #999;
}

.generate-btn.generating .generate-icon {
  animation: sparkle 1.5s infinite;
}

@keyframes sparkle {
  0%, 100% { transform: scale(1) rotate(0deg); }
  50% { transform: scale(1.2) rotate(180deg); }
}

.button-group {
  display: flex;
  gap: 10px;
}

.cancel-btn, .save-btn {
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 1em;
  transition: all 0.2s;
}

.cancel-btn {
  background: #f8f9fa;
  color: #666;
  border: 1px solid #e0e0e0;
}

.cancel-btn:hover {
  background: #e9ecef;
}

.save-btn {
  background: #28a745;
  color: white;
}

.save-btn:hover {
  background: #218838;
  transform: translateY(-1px);
}

/* Entity description editing */
.entity-edit-btn {
  margin-left: 0.5em;
  cursor: pointer;
  font-size: 1em;
  transition: opacity 0.2s, transform 0.2s;
  display: inline-block;
}

.entity-edit-btn:hover {
  opacity: 1;
  transform: scale(1.1);
}

/* Hide pencil icon by default for entities with descriptions */
.has-entity-desc .entity-edit-btn {
  opacity: 0;
}

.has-entity-desc:hover .entity-edit-btn {
  opacity: 0.6;
}

.no-entity-desc-cell .entity-edit-btn {
  opacity: 0.6;
}

.no-entity-desc {
  color: #999;
  font-style: italic;
  cursor: pointer;
  transition: opacity 0.2s;
}

.no-entity-desc:hover {
  opacity: 0.8;
}

/* Entity assistant inline add */
.add-entity-button {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 20px;
  cursor: pointer;
  font-size: 0.9em;
  font-weight: 500;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  transition: all 0.2s;
  margin: 0 0 12px 20px;
}

.add-entity-button:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.entity-input-row td {
  padding: 0 !important;
}

.entity-input-row input {
  width: 100%;
  border: 2px solid #667eea;
  border-radius: 0;
  padding: 12px;
  font-size: 1em;
  font-family: inherit;
  box-sizing: border-box;
  outline: none;
}

.entity-input-row input::placeholder {
  color: #999;
  font-style: italic;
}

.entity-generating-row {
  opacity: 0.6;
  background: #f8f9fa;
}

.entity-generating-row .generating-dots {
  display: inline-block;
  animation: ellipsis 1.5s infinite;
}

@keyframes ellipsis {
  0% { content: '.'; }
  33% { content: '..'; }
  66% { content: '...'; }
  100% { content: '.'; }
}

.entity-generating-row .generating-dots::after {
  content: '...';
  animation: ellipsis-dots 1.5s infinite;
}

@keyframes ellipsis-dots {
  0%, 100% { content: '.'; }
  33% { content: '..'; }
  66% { content: '...'; }
}

.btn {
  padding: 0.6em 1.2em;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.95em;
  font-weight: 500;
  transition: background-color 0.2s;
}

.btn-primary {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.btn-primary:hover {
  opacity: 0.9;
}

/* Modal styles */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
}

.modal-content {
  background-color: white;
  margin: 8% auto;
  padding: 1.5em;
  border-radius: 12px;
  width: 90%;
  max-width: 420px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.2);
  max-height: 90vh;
  overflow-y: auto;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1.2em;
  padding-bottom: 0.4em;
  border-bottom: 1px solid #eee;
}

.modal-header h2 {
  margin: 0;
  color: #333;
}

.close {
  color: #aaa;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
  line-height: 1;
}

.close:hover {
  color: #333;
}

.form-group {
  margin-bottom: 1.2em;
}

.form-group label {
  display: block;
  margin-bottom: 0.5em;
  font-weight: 500;
  color: #333;
}

.form-group input, .form-group textarea {
  width: 100%;
  padding: 0.6em 0.75em;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-size: 0.95em;
  font-family: inherit;
  transition: border-color 0.2s;
  box-sizing: border-box;
}

.form-group input:focus, .form-group textarea:focus {
  outline: none;
  border-color: #667eea;
}

.form-group textarea {
  resize: vertical;
  min-height: 120px;
}

.form-group small {
  display: block;
  margin-top: 0.25em;
  color: #666;
  font-size: 0.9em;
}

.form-actions {
  display: flex;
  gap: 0.8em;
  justify-content: flex-end;
  margin-top: 1.5em;
}

.btn-secondary {
  background: #f5f5f5;
  color: #666;
}

.btn-secondary:hover {
  background: #eee;
}

.error-message {
  background: #fee;
  color: #c33;
  padding: 0.75em;
  border-radius: 6px;
  margin-bottom: 1em;
  border: 1px solid #fcc;
}

/* Entity delete button */
.entity-delete-btn {
  opacity: 0;
  cursor: pointer;
  color: #dc3545;
  margin-left: 0.5em;
  transition: opacity 0.2s, transform 0.2s;
  display: inline-block;
}

tr:hover .entity-delete-btn {
  opacity: 0.6;
}

.entity-delete-btn:hover {
  opacity: 1 !important;
  transform: scale(1.1);
}

/* Delete confirmation modal */
.delete-modal {
  display: none;
  position: fixed;
  z-index: 2000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.6);
}

.delete-modal-content {
  background-color: white;
  margin: 10% auto;
  border-radius: 12px;
  width: 90%;
  max-width: 600px;
  position: relative;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
  overflow: hidden;
}

.delete-modal-header {
  padding: 20px;
  border-bottom: 1px solid #e0e0e0;
  background: white;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.delete-modal-header h3 {
  margin: 0;
  color: #dc3545;
  font-size: 1.4em;
}

.delete-modal-body {
  padding: 20px;
}

.delete-warning {
  background: #fff3cd;
  border: 1px solid #ffc107;
  color: #856404;
  padding: 12px;
  border-radius: 6px;
  margin-bottom: 15px;
  font-weight: 500;
}

.delete-days-list {
  max-height: 300px;
  overflow-y: auto;
  margin: 15px 0;
  padding: 10px;
  background: #f8f9fa;
  border-radius: 6px;
}

.delete-day-item {
  padding: 8px;
  margin: 4px 0;
  background: white;
  border-radius: 4px;
  border-left: 3px solid #dc3545;
}

.delete-day-date {
  font-weight: 600;
  color: #333;
}

.delete-day-type {
  color: #007bff;
  font-size: 0.9em;
  margin-left: 8px;
}

.delete-buttons {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
  margin-top: 20px;
}

.btn-danger {
  background: #dc3545;
  color: white;
  padding: 10px 20px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 1em;
  transition: all 0.2s;
}

.btn-danger:hover:not(:disabled) {
  background: #c82333;
  transform: translateY(-1px);
}

.btn-danger:disabled {
  opacity: 0.6;
  cursor: not-allowed;
}
</style>
{% endblock %}
{% block body %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<div class="domain-header{% if domain_data.color %} has-color{% endif %}"{% if domain_data.color %} style="--domain-color: {{ domain_data.color }}"{% endif %}>
  <a href="{{ url_for('domains.domains_page') }}" class="back-button">‚Üê Back to Domains</a>
  
  <div class="domain-header-content">
    {% if domain_data.emoji %}
    <div class="domain-emoji">{{ domain_data.emoji }}</div>
    {% endif %}
    <h1>{{ domain_data.title or domain_name }}</h1>
  </div>
</div>

<div class="tab-container">
  <div class="tab-nav">
    <button class="tab-button active" data-tab="news">Newsletters</button>
    <button class="tab-button" data-tab="entities">Entities</button>
    <button class="tab-button" data-tab="description">Description</button>
    <a href="{{ url_for('domains.entity_manager', domain_name=domain_name) }}" class="tab-link">
      <span>Manage Entities</span>
      <svg class="gear-icon" width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="margin-left: 4px;">
        <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/>
        <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319z"/>
      </svg>
    </a>
  </div>
  
  <div id="news-tab" class="tab-content active">
    <div class="loading" id="news-loading">Loading newsletters...</div>
    <div id="news-content" style="display: none;">
      <div id="news-empty" class="no-entities" style="display: none;">
        <p>No newsletters recorded for this domain yet.</p>
      </div>
      <div class="news-days" id="news-days"></div>
      <div class="news-load-more" id="news-load-more-container" style="display: none;">
        <button id="news-load-more" class="btn btn-secondary">Load more newsletters</button>
      </div>
    </div>
  </div>
  
  <div id="entities-tab" class="tab-content">
    <div class="loading" id="entities-loading">Loading entities...</div>
    <div id="entities-content" style="display: none;">
      <div class="entities-section" id="domain-entities-section">
        <div class="entities-container">
          <button class="add-entity-button" onclick="openEntityAssistInput()" title="Add new entity with AI assistance">
            <span>+</span>
            <span>Add Entity</span>
          </button>
          <table class="entities-table">
            <thead>
              <tr>
                <th></th>
                <th class="entity-type">Type</th>
                <th class="entity-name">Name</th>
                <th class="entity-desc">Description</th>
              </tr>
            </thead>
            <tbody id="domain-entities-tbody">
            </tbody>
          </table>
          <div id="no-domain-entities" class="no-entities" style="display: none;">
            No entities added to this domain yet. Star entities below to add them.
          </div>
        </div>
      </div>
      
      <div class="entities-section">
        <div class="entities-container">
          <h3 id="all-entities-title" style="display: flex; align-items: center; justify-content: space-between;">
            <span>Detected Entities</span>
            <input type="text" id="entity-search" placeholder="Search entities..." style="
              max-width: 250px;
              padding: 6px 12px;
              border: 1px solid #ddd;
              border-radius: 6px;
              font-size: 0.9em;
              font-family: inherit;
            ">
          </h3>
          <table class="entities-table">
            <thead>
              <tr>
                <th></th>
                <th class="entity-type">Type</th>
                <th class="entity-name">Name</th>
                <th class="entity-desc">Description</th>
              </tr>
            </thead>
            <tbody id="all-entities-tbody">
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  
  <div id="description-tab" class="tab-content">
    {% if domain_data.description %}
    <div class="description-content has-description">
      <p>{{ domain_data.description }}</p>
      <button class="btn btn-primary" onclick="openDescriptionEditor()">‚úèÔ∏è Edit Description</button>
    </div>
    {% else %}
    <div class="description-content no-description">
      <div class="placeholder">
        <h3>No description yet</h3>
        <p>Add a description to help explain what this domain is about.</p>
        <button class="btn btn-primary" onclick="openDescriptionEditor()">‚ú® Add Description</button>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<!-- Description Editor Modal -->
<div id="descriptionModal" class="description-modal">
  <div class="description-modal-content">
    <span class="description-close">&times;</span>
    <div class="description-modal-header">
      <h3 id="modal-title">Edit Domain Description</h3>
    </div>
    <div class="description-modal-body">
      <textarea id="descriptionText" placeholder="Enter domain description..."></textarea>
      <div class="description-buttons">
        <button id="generateBtn" class="generate-btn" title="Generate description with AI">
          <span class="generate-icon">‚ú®</span>
          <span class="generate-text">Generate</span>
        </button>
        <div class="button-group">
          <button id="cancelBtn" class="cancel-btn">Cancel</button>
          <button id="saveBtn" class="save-btn">Save</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Delete Entity Confirmation Modal -->
<div id="deleteModal" class="delete-modal">
  <div class="delete-modal-content">
    <div class="delete-modal-header">
      <h3>Delete Detected Entity</h3>
      <span class="close" onclick="closeDeleteModal()">&times;</span>
    </div>
    <div class="delete-modal-body">
      <div class="delete-warning">
        ‚ö†Ô∏è This will permanently remove this entity from all detected day files. This action cannot be undone.
      </div>
      <p>Entity: <strong id="deleteEntityName"></strong></p>
      <div id="deleteLoadingMsg" style="text-align: center; padding: 20px; display: none;">
        <p>Loading preview...</p>
      </div>
      <div id="deleteDaysContainer" style="display: none;">
        <p>Found in <strong id="deleteDaysCount"></strong>:</p>
        <div class="delete-days-list" id="deleteDaysList"></div>
      </div>
      <div class="delete-buttons">
        <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
        <button id="confirmDeleteBtn" class="btn btn-danger" onclick="confirmEntityDelete()">Delete</button>
      </div>
    </div>
  </div>
</div>

<script>
const domainName = '{{ domain_name }}';
let entitiesData = null;
let newsCursor = null;
let newsInitialized = false;
let newsLoading = false;

// Tab switching functionality
document.addEventListener('DOMContentLoaded', function() {
  const tabButtons = document.querySelectorAll('.tab-button');
  const tabContents = document.querySelectorAll('.tab-content');

  function switchToTab(targetTab) {
    // Remove active class from all buttons and content
    tabButtons.forEach(btn => btn.classList.remove('active'));
    tabContents.forEach(content => content.classList.remove('active'));

    // Add active class to clicked button and corresponding content
    const targetButton = document.querySelector(`.tab-button[data-tab="${targetTab}"]`);
    if (targetButton) {
      targetButton.classList.add('active');
    }
    const targetContent = document.getElementById(targetTab + '-tab');
    if (targetContent) {
      targetContent.classList.add('active');
    }

    // Load data when tabs are activated
    if (targetTab === 'entities') {
      if (!entitiesData) {
        loadEntities();
      }
      // Auto-focus the search input when entities tab is opened
      setTimeout(() => {
        const searchInput = document.getElementById('entity-search');
        if (searchInput) {
          searchInput.focus();
        }
      }, 100);
    } else if (targetTab === 'news') {
      if (!newsInitialized) {
        loadNews();
      }
    }
  }

  tabButtons.forEach(button => {
    button.addEventListener('click', function() {
      const targetTab = this.dataset.tab;

      // Update URL hash
      window.location.hash = targetTab;

      switchToTab(targetTab);
    });
  });

  // Check URL hash on page load and activate corresponding tab
  const hash = window.location.hash.substring(1); // Remove the '#'
  if (hash && document.querySelector(`.tab-button[data-tab="${hash}"]`)) {
    switchToTab(hash);
  }
  
  // Add entity search functionality
  const entitySearchInput = document.getElementById('entity-search');
  if (entitySearchInput) {
    entitySearchInput.addEventListener('input', function() {
      const searchTerm = this.value.trim();
      if (entitiesData) {
        renderEntities(searchTerm);
      }
    });
  }

  const newsLoadMoreButton = document.getElementById('news-load-more');
  if (newsLoadMoreButton) {
    newsLoadMoreButton.addEventListener('click', () => {
      loadNews();
    });
  }
  
  // Load newsletters by default since news tab is active
  loadNews();
});

function loadEntities() {
  fetch(`/api/domains/${encodeURIComponent(domainName)}/entities`)
    .then(response => {
      return response.json().then(data => ({ ok: response.ok, status: response.status, data }));
    })
    .then(({ ok, status, data }) => {
      // Check if the API returned an error
      if (!ok || data.error) {
        const errorMsg = data.error || `Server error (${status})`;
        document.getElementById('entities-loading').innerHTML =
          `<div style="color: #c33; background: #fee; padding: 1em; border-radius: 6px; border: 1px solid #fcc;">
            <strong>Error loading entities:</strong><br>${escapeHtml(errorMsg)}
          </div>`;
        return;
      }

      // Transform new API format {attached, detected} to old format {all_entities}
      const all_entities = [];

      // Add attached entities with starred=true
      if (data.attached) {
        data.attached.forEach(entity => {
          all_entities.push({
            type: entity.type,
            name: entity.name,
            desc: entity.description,
            starred: true
          });
        });
      }

      // Add detected entities with starred=false
      if (data.detected) {
        data.detected.forEach(entity => {
          all_entities.push({
            type: entity.type,
            name: entity.name,
            desc: entity.description,
            starred: false,
            count: entity.count,
            last_seen: entity.last_seen
          });
        });
      }

      entitiesData = { all_entities };
      renderEntities();
      document.getElementById('entities-loading').style.display = 'none';
      document.getElementById('entities-content').style.display = 'block';
    })
    .catch(error => {
      console.error('Error loading entities:', error);
      document.getElementById('entities-loading').innerHTML =
        `<div style="color: #c33; background: #fee; padding: 1em; border-radius: 6px; border: 1px solid #fcc;">
          <strong>Error loading entities:</strong><br>${escapeHtml(error.message || 'Network error')}
        </div>`;
    });
}

function loadNews() {
  if (newsLoading) {
    return;
  }

  const loadingEl = document.getElementById('news-loading');
  const contentEl = document.getElementById('news-content');
  const emptyEl = document.getElementById('news-empty');
  const loadMoreContainer = document.getElementById('news-load-more-container');
  const loadMoreButton = document.getElementById('news-load-more');

  newsLoading = true;

  if (!newsInitialized) {
    if (loadingEl) {
      loadingEl.style.display = 'block';
    }
    if (contentEl) {
      contentEl.style.display = 'none';
    }
  } else if (loadMoreButton) {
    loadMoreButton.disabled = true;
    loadMoreButton.textContent = 'Loading...';
  }

  const params = new URLSearchParams();
  if (newsCursor) {
    params.append('cursor', newsCursor);
  }
  params.append('days', '5');

  fetch(`/api/domains/${encodeURIComponent(domainName)}/news?${params.toString()}`)
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        throw new Error(data.error);
      }

      if (!newsInitialized) {
        if (loadingEl) {
          loadingEl.style.display = 'none';
        }
        if (contentEl) {
          contentEl.style.display = 'block';
        }
      }

      const days = Array.isArray(data.days) ? data.days : [];

      if (days.length === 0 && !newsInitialized) {
        if (emptyEl) {
          emptyEl.style.display = 'block';
        }
      } else if (days.length > 0) {
        if (emptyEl) {
          emptyEl.style.display = 'none';
        }
        days.forEach(day => appendNewsDay(day));
      }

      newsCursor = data.next_cursor || null;

      if (loadMoreContainer && loadMoreButton) {
        if (data.has_more && newsCursor) {
          loadMoreContainer.style.display = 'block';
          loadMoreButton.disabled = false;
          loadMoreButton.textContent = 'Load more newsletters';
        } else if (newsInitialized || days.length > 0) {
          loadMoreContainer.style.display = 'none';
          loadMoreButton.disabled = false;
          loadMoreButton.textContent = 'Load more newsletters';
        }
      }

      newsInitialized = true;
      newsLoading = false;
    })
    .catch(error => {
      console.error('Error loading news:', error);

      if (!newsInitialized) {
        if (loadingEl) {
          loadingEl.innerHTML = 'Error loading news: ' + error.message;
        }
      } else if (loadMoreButton) {
        loadMoreButton.disabled = false;
        loadMoreButton.textContent = 'Load previous day';
      }

      newsLoading = false;
    });
}

function appendNewsDay(day) {
  const container = document.getElementById('news-days');
  if (!container) {
    return;
  }

  const section = document.createElement('section');
  section.className = 'news-day';

  const header = document.createElement('h3');
  header.className = 'news-day-header';
  header.textContent = formatNewsDateKey(day.date);
  section.appendChild(header);

  if (day.raw_content) {
    const contentDiv = document.createElement('div');
    contentDiv.className = 'newsletter-content';

    // Configure marked for safe rendering
    marked.setOptions({
      breaks: true,
      gfm: true,
      headerIds: false,
      mangle: false
    });

    // Remove the top-level heading if present (we show it in our header)
    let content = day.raw_content;
    content = content.replace(/^# .+\n+/, '');

    // Render markdown to HTML
    contentDiv.innerHTML = marked.parse(content);
    section.appendChild(contentDiv);
  } else {
    const emptyNotice = document.createElement('div');
    emptyNotice.className = 'no-entities';
    emptyNotice.textContent = 'No newsletter content for this day.';
    section.appendChild(emptyNotice);
  }

  container.appendChild(section);
}

function formatNewsDateKey(dateKey) {
  if (!dateKey || typeof dateKey !== 'string' || dateKey.length !== 8) {
    return dateKey || 'Unknown date';
  }

  const year = Number(dateKey.slice(0, 4));
  const month = Number(dateKey.slice(4, 6)) - 1;
  const day = Number(dateKey.slice(6, 8));

  const dateObj = new Date(year, month, day);
  if (Number.isNaN(dateObj.getTime())) {
    return dateKey;
  }

  return dateObj.toLocaleDateString(undefined, {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
}

function renderEntities(searchTerm = '') {
  if (!entitiesData) return;
  
  const domainTbody = document.getElementById('domain-entities-tbody');
  const allTbody = document.getElementById('all-entities-tbody');
  const noDomainEntities = document.getElementById('no-domain-entities');
  
  // Clear existing content
  domainTbody.innerHTML = '';
  allTbody.innerHTML = '';
  
  // Render domain entities
  const starredEntities = entitiesData.all_entities.filter(e => e.starred);
  if (starredEntities.length === 0) {
    noDomainEntities.style.display = 'block';
    document.getElementById('domain-entities-section').querySelector('table').style.display = 'none';
  } else {
    noDomainEntities.style.display = 'none';
    document.getElementById('domain-entities-section').querySelector('table').style.display = 'table';
    
    starredEntities.forEach(entity => {
      const row = createEntityRow(entity, true);
      domainTbody.appendChild(row);
    });
  }
  
  // Render non-starred entities only (filtering out domain entities)
  const unstarredEntities = entitiesData.all_entities.filter(e => !e.starred);

  // Get set of attached entity names for filtering
  const attachedNames = new Set(starredEntities.map(e => e.name));

  // Filter out detected entities that have exact name match with attached entities
  const uniqueUnstarredEntities = unstarredEntities.filter(entity =>
    !attachedNames.has(entity.name)
  );

  // Apply search filter if searchTerm is provided
  const filteredEntities = searchTerm
    ? uniqueUnstarredEntities.filter(entity =>
        entity.name.toLowerCase().includes(searchTerm.toLowerCase())
      )
    : uniqueUnstarredEntities;
  
  filteredEntities.forEach(entity => {
    const row = createEntityRow(entity, false);
    allTbody.appendChild(row);
  });
}

function createEntityRow(entity, isDomainSection) {
  const row = document.createElement('tr');

  const starCell = document.createElement('td');
  const starButton = document.createElement('button');
  starButton.className = `star-button ${entity.starred ? 'starred' : 'unstarred'}`;
  starButton.innerHTML = entity.starred ? '‚òÖ' : '‚òÜ';
  starButton.onclick = () => toggleEntityStar(entity, starButton);
  starCell.appendChild(starButton);

  const typeCell = document.createElement('td');
  typeCell.className = 'entity-type';
  typeCell.textContent = entity.type;

  const nameCell = document.createElement('td');
  nameCell.className = 'entity-name';
  nameCell.textContent = entity.name;

  // Add detection count badge for detected entities
  if (!entity.starred && entity.count && entity.count > 1) {
    const badge = document.createElement('span');
    badge.style.cssText = 'margin-left: 8px; background: #e3f2fd; color: #1976d2; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; font-weight: 500;';
    badge.textContent = `${entity.count} detections`;
    nameCell.appendChild(badge);
  }

  const descCell = document.createElement('td');
  descCell.className = 'entity-desc';
  if (entity.desc) {
    descCell.innerHTML = `<span class="entity-desc-text">${entity.desc}</span> <span class="entity-edit-btn" onclick="openEntityDescriptionEditor('${entity.type}', '${entity.name.replace(/'/g, "\\'")}', '${(entity.desc || '').replace(/'/g, "\\'")}')" title="Edit description">‚úèÔ∏è</span>`;
    descCell.classList.add('has-entity-desc');
  } else {
    descCell.innerHTML = `<span class="no-entity-desc" onclick="openEntityDescriptionEditor('${entity.type}', '${entity.name.replace(/'/g, "\\'")}', '')">Add description...</span> <span class="entity-edit-btn" onclick="openEntityDescriptionEditor('${entity.type}', '${entity.name.replace(/'/g, "\\'")}', '')" title="Add description">‚ú®</span>`;
    descCell.classList.add('no-entity-desc-cell');
  }

  // Add delete button only for detected entities (not domain section)
  if (!isDomainSection) {
    const deleteBtn = document.createElement('span');
    deleteBtn.className = 'entity-delete-btn';
    deleteBtn.innerHTML = 'üóëÔ∏è';
    deleteBtn.title = 'Delete detected entity';
    deleteBtn.onclick = (e) => {
      e.stopPropagation();
      previewEntityDelete(entity.name);
    };
    descCell.appendChild(deleteBtn);
  }

  row.appendChild(starCell);
  row.appendChild(typeCell);
  row.appendChild(nameCell);
  row.appendChild(descCell);

  return row;
}

function toggleEntityStar(entity, starButton) {
  const wasStarred = entity.starred;
  
  // Disable button during request
  starButton.disabled = true;
  starButton.style.opacity = '0.5';
  
  const method = wasStarred ? 'DELETE' : 'POST';
  const url = `/api/domains/${encodeURIComponent(domainName)}/entities`;
  
  fetch(url, {
    method: method,
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      type: entity.type,
      name: entity.name,
      desc: entity.desc
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Update entity state
      entity.starred = !wasStarred;
      
      // Update star button
      starButton.className = `star-button ${entity.starred ? 'starred' : 'unstarred'}`;
      starButton.innerHTML = entity.starred ? '‚òÖ' : '‚òÜ';
      
      // Get search input element
      const searchInput = document.getElementById('entity-search');
      
      // If entity was just starred (added to domain) and there was a search term
      if (!wasStarred && searchInput && searchInput.value.trim()) {
        // Clear the search box and refocus it
        searchInput.value = '';
        searchInput.focus();
        // Re-render entities without search filter
        renderEntities('');
      } else {
        // Otherwise maintain current search filter
        const currentSearchTerm = searchInput ? searchInput.value.trim() : '';
        renderEntities(currentSearchTerm);
      }
    } else {
      console.error('Error toggling entity:', data.error);
      alert('Error: ' + (data.error || 'Unknown error'));
    }
    
    // Re-enable button
    starButton.disabled = false;
    starButton.style.opacity = '1';
  })
  .catch(error => {
    console.error('Network error:', error);
    alert('Network error: ' + error.message);
    
    // Re-enable button
    starButton.disabled = false;
    starButton.style.opacity = '1';
  });
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Description editor functionality
function openDescriptionEditor() {
  const modal = document.getElementById('descriptionModal');
  const textarea = document.getElementById('descriptionText');
  
  // Set current description
  const currentDesc = '{{ domain_data.description|replace("'", "\\'") }}' || '';
  textarea.value = currentDesc;
  
  modal.style.display = 'block';
  textarea.focus();
}

function closeDescriptionEditor() {
  document.getElementById('descriptionModal').style.display = 'none';
}

// Modal event listeners
document.addEventListener('DOMContentLoaded', function() {
  const modal = document.getElementById('descriptionModal');
  const closeBtn = document.querySelector('.description-close');
  const cancelBtn = document.getElementById('cancelBtn');
  const saveBtn = document.getElementById('saveBtn');
  const generateBtn = document.getElementById('generateBtn');
  
  // Close modal
  closeBtn.onclick = closeDescriptionEditor;
  cancelBtn.onclick = closeDescriptionEditor;
  
  // Click outside to close
  window.onclick = function(event) {
    if (event.target === modal) {
      closeDescriptionEditor();
    }
  };
  
  // Save description
  saveBtn.onclick = function() {
    const description = document.getElementById('descriptionText').value.trim();
    saveDescription(description);
  };
  
  // Generate description
  generateBtn.onclick = function() {
    generateDescription();
  };
});

function saveDescription(description) {
  const saveBtn = document.getElementById('saveBtn');
  const originalText = saveBtn.textContent;
  
  saveBtn.textContent = 'Saving...';
  saveBtn.disabled = true;
  
  fetch(`/api/domains/${encodeURIComponent(domainName)}`, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      description: description
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Update the page description
      const descElement = document.querySelector('.description');
      if (description) {
        descElement.innerHTML = `${description} <span class="edit-description-btn" onclick="openDescriptionEditor()" title="Edit description">‚ú®</span>`;
        descElement.classList.remove('no-description');
      } else {
        descElement.innerHTML = '<span class="add-description-text" onclick="openDescriptionEditor()">Add description...</span> <span class="edit-description-btn" onclick="openDescriptionEditor()" title="Add description">‚ú®</span>';
        descElement.classList.add('no-description');
      }
      closeDescriptionEditor();
    } else {
      alert('Error saving description: ' + (data.error || 'Unknown error'));
    }
    
    saveBtn.textContent = originalText;
    saveBtn.disabled = false;
  })
  .catch(error => {
    console.error('Error saving description:', error);
    alert('Network error: ' + error.message);
    
    saveBtn.textContent = originalText;
    saveBtn.disabled = false;
  });
}

function generateDescription() {
  const generateBtn = document.getElementById('generateBtn');
  const textarea = document.getElementById('descriptionText');
  const generateIcon = generateBtn.querySelector('.generate-icon');
  const generateText = generateBtn.querySelector('.generate-text');

  // Update button state
  generateBtn.disabled = true;
  generateBtn.classList.add('generating');
  generateText.textContent = 'Generating...';

  const currentDescription = textarea.value.trim();

  fetch(`/api/domains/${encodeURIComponent(domainName)}/generate-description`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      current_description: currentDescription,
      domain_name: domainName
    })
  })
  .then(response => response.json())
  .then(data => {
    if (!data.success) {
      alert('Error generating description: ' + (data.error || 'Unknown error'));
      generateBtn.disabled = false;
      generateBtn.classList.remove('generating');
      generateText.textContent = 'Generate';
      return;
    }

    // Subscribe to events from the shared watcher
    const agentId = data.agent_id;

    const eventHandler = (event) => {
      // Only process events for our agent
      if (event.agent_id !== agentId) return;

      if (event.event === 'finish') {
        // Clean up description - strip whitespace
        let description = event.result || '';
        description = description.trim();

        textarea.value = description;
        textarea.focus();

        // Reset button state
        generateBtn.disabled = false;
        generateBtn.classList.remove('generating');
        generateText.textContent = 'Generate';
      } else if (event.event === 'error') {
        alert('Error generating description: ' + (event.error || 'Unknown error'));

        // Reset button state
        generateBtn.disabled = false;
        generateBtn.classList.remove('generating');
        generateText.textContent = 'Generate';
      }
    };

    // Listen for events on the 'domains' view
    appEvents.listen('domains', eventHandler);
  })
  .catch(error => {
    console.error('Error generating description:', error);
    alert('Network error: ' + error.message);

    // Reset button state
    generateBtn.disabled = false;
    generateBtn.classList.remove('generating');
    generateText.textContent = 'Generate';
  });
}

// Entity description editing
let currentEntityType = null;
let currentEntityName = null;

function openEntityDescriptionEditor(entityType, entityName, currentDescription) {
  currentEntityType = entityType;
  currentEntityName = entityName;
  
  const modal = document.getElementById('descriptionModal');
  const textarea = document.getElementById('descriptionText');
  const title = document.getElementById('modal-title');
  
  // Update modal title and content
  title.textContent = `Edit ${entityType}: ${entityName}`;
  textarea.placeholder = `Enter description for ${entityName}...`;
  textarea.value = currentDescription || '';
  
  modal.style.display = 'block';
  textarea.focus();
}

// Override save function to handle both domain and entity descriptions
function saveDescription(description) {
  const saveBtn = document.getElementById('saveBtn');
  const originalText = saveBtn.textContent;
  
  saveBtn.textContent = 'Saving...';
  saveBtn.disabled = true;
  
  // Determine if we're editing domain or entity description
  if (currentEntityType && currentEntityName) {
    // Save entity description
    saveEntityDescription(description);
  } else {
    // Save domain description (original functionality)
    saveDomainDescription(description);
  }
}

function saveDomainDescription(description) {
  const saveBtn = document.getElementById('saveBtn');
  
  fetch(`/api/domains/${encodeURIComponent(domainName)}`, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      description: description
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Update the description tab content
      const descContent = document.querySelector('.description-content');
      if (description) {
        descContent.innerHTML = `<p>${description}</p><button class="btn btn-primary" onclick="openDescriptionEditor()">‚úèÔ∏è Edit Description</button>`;
        descContent.classList.remove('no-description');
        descContent.classList.add('has-description');
      } else {
        descContent.innerHTML = `
          <div class="placeholder">
            <h3>No description yet</h3>
            <p>Add a description to help explain what this domain is about.</p>
            <button class="btn btn-primary" onclick="openDescriptionEditor()">‚ú® Add Description</button>
          </div>
        `;
        descContent.classList.add('no-description');
        descContent.classList.remove('has-description');
      }
      closeDescriptionEditor();
    } else {
      alert('Error saving description: ' + (data.error || 'Unknown error'));
    }
    
    saveBtn.textContent = 'Save';
    saveBtn.disabled = false;
  })
  .catch(error => {
    console.error('Error saving description:', error);
    alert('Network error: ' + error.message);
    
    saveBtn.textContent = 'Save';
    saveBtn.disabled = false;
  });
}

function saveEntityDescription(description) {
  const saveBtn = document.getElementById('saveBtn');
  
  fetch(`/api/domains/${encodeURIComponent(domainName)}/entities/description`, {
    method: 'PUT',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      type: currentEntityType,
      name: currentEntityName,
      description: description
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Update the entity in our local data
      if (entitiesData && entitiesData.all_entities) {
        const entity = entitiesData.all_entities.find(e => 
          e.type === currentEntityType && e.name === currentEntityName
        );
        if (entity) {
          entity.desc = description;
        }
      }
      
      // Get current search term to maintain filter
      const searchInput = document.getElementById('entity-search');
      const currentSearchTerm = searchInput ? searchInput.value.trim() : '';
      
      // Re-render the entities tables with current search filter
      renderEntities(currentSearchTerm);
      closeDescriptionEditor();
    } else {
      alert('Error saving entity description: ' + (data.error || 'Unknown error'));
    }
    
    saveBtn.textContent = 'Save';
    saveBtn.disabled = false;
  })
  .catch(error => {
    console.error('Error saving entity description:', error);
    alert('Network error: ' + error.message);
    
    saveBtn.textContent = 'Save';
    saveBtn.disabled = false;
  });
}

// Override generate function to handle both domain and entity descriptions
function generateDescription() {
  const generateBtn = document.getElementById('generateBtn');
  const textarea = document.getElementById('descriptionText');
  const generateIcon = generateBtn.querySelector('.generate-icon');
  const generateText = generateBtn.querySelector('.generate-text');
  
  // Update button state
  generateBtn.disabled = true;
  generateBtn.classList.add('generating');
  generateText.textContent = 'Generating...';
  
  const currentDescription = textarea.value.trim();
  
  // Determine API endpoint and payload
  let apiUrl, payload;
  
  if (currentEntityType && currentEntityName) {
    // Generate entity description
    apiUrl = `/api/domains/${encodeURIComponent(domainName)}/entities/generate-description`;
    payload = {
      type: currentEntityType,
      name: currentEntityName,
      current_description: currentDescription
    };
  } else {
    // Generate domain description (original functionality)
    apiUrl = `/api/domains/${encodeURIComponent(domainName)}/generate-description`;
    payload = {
      current_description: currentDescription,
      domain_name: domainName
    };
  }
  
  fetch(apiUrl, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(payload)
  })
  .then(response => response.json())
  .then(data => {
    if (!data.success) {
      alert('Error generating description: ' + (data.error || 'Unknown error'));
      generateBtn.disabled = false;
      generateBtn.classList.remove('generating');
      generateText.textContent = 'Generate';
      return;
    }

    // Subscribe to events from the shared watcher
    const agentId = data.agent_id;

    const eventHandler = (event) => {
      // Only process events for our agent
      if (event.agent_id !== agentId) return;

      if (event.event === 'finish') {
        // Clean up description - strip whitespace
        let description = event.result || '';
        description = description.trim();

        textarea.value = description;
        textarea.focus();

        // Reset button state
        generateBtn.disabled = false;
        generateBtn.classList.remove('generating');
        generateText.textContent = 'Generate';
      } else if (event.event === 'error') {
        alert('Error generating description: ' + (event.error || 'Unknown error'));

        // Reset button state
        generateBtn.disabled = false;
        generateBtn.classList.remove('generating');
        generateText.textContent = 'Generate';
      }
    };

    // Listen for events on the 'domains' view
    appEvents.listen('domains', eventHandler);
  })
  .catch(error => {
    console.error('Error generating description:', error);
    alert('Network error: ' + error.message);

    // Reset button state
    generateBtn.disabled = false;
    generateBtn.classList.remove('generating');
    generateText.textContent = 'Generate';
  });
}

// Reset entity editing state when modal closes
function closeDescriptionEditor() {
  currentEntityType = null;
  currentEntityName = null;
  document.getElementById('modal-title').textContent = 'Edit Domain Description';
  document.getElementById('descriptionText').placeholder = 'Enter domain description...';
  document.getElementById('descriptionModal').style.display = 'none';
}

// Entity assistant inline add functionality
let entityAssistAgentId = null;

function openEntityAssistInput() {
  const tbody = document.getElementById('domain-entities-tbody');

  // Check if input row already exists
  if (document.querySelector('.entity-input-row')) {
    return;
  }

  // Create input row
  const inputRow = document.createElement('tr');
  inputRow.className = 'entity-input-row';

  const inputCell = document.createElement('td');
  inputCell.colSpan = 4;

  const input = document.createElement('input');
  input.type = 'text';
  input.placeholder = "Enter their name and we'll figure out the rest...";
  input.id = 'entity-assist-input';

  // Handle keyboard events
  input.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      // Cancel - remove the input row
      inputRow.remove();

      // Show the no entities message if no entities
      const tbody = document.getElementById('domain-entities-tbody');
      if (tbody.children.length === 0) {
        document.getElementById('no-domain-entities').style.display = 'block';
        document.getElementById('domain-entities-section').querySelector('table').style.display = 'none';
      }
    } else if (e.key === 'Enter') {
      e.preventDefault();
      const name = input.value.trim();
      if (name) {
        submitEntityAssist(name);
      }
    }
  });

  inputCell.appendChild(input);
  inputRow.appendChild(inputCell);

  // Insert as first row
  tbody.insertBefore(inputRow, tbody.firstChild);

  // Show table if hidden
  const table = document.getElementById('domain-entities-section').querySelector('table');
  table.style.display = 'table';
  document.getElementById('no-domain-entities').style.display = 'none';

  // Focus the input
  input.focus();
}

function submitEntityAssist(name) {
  const inputRow = document.querySelector('.entity-input-row');
  if (!inputRow) return;

  // Remove input row
  inputRow.remove();

  // Create generating row
  const generatingRow = document.createElement('tr');
  generatingRow.className = 'entity-generating-row';
  generatingRow.id = 'entity-assist-generating-row';

  // Empty cell for star button column
  const starCell = document.createElement('td');
  generatingRow.appendChild(starCell);

  // Empty cell for type column
  const typeCell = document.createElement('td');
  typeCell.className = 'entity-type';
  generatingRow.appendChild(typeCell);

  // Name cell
  const nameCell = document.createElement('td');
  nameCell.className = 'entity-name';
  nameCell.textContent = escapeHtml(name);
  generatingRow.appendChild(nameCell);

  // Description cell with generating text
  const descCell = document.createElement('td');
  descCell.className = 'entity-desc';
  descCell.innerHTML = 'Generating<span class="generating-dots"></span>';
  generatingRow.appendChild(descCell);

  // Insert as first row
  const tbody = document.getElementById('domain-entities-tbody');
  tbody.insertBefore(generatingRow, tbody.firstChild);

  // Submit to backend
  fetch(`/api/domains/${encodeURIComponent(domainName)}/entities/assist`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ name: name })
  })
  .then(response => response.json())
  .then(data => {
    if (!data.success) {
      alert('Error starting entity assistant: ' + (data.error || 'Unknown error'));
      // Remove generating row on error
      const genRow = document.getElementById('entity-assist-generating-row');
      if (genRow) genRow.remove();
      return;
    }

    // Store agent ID for event filtering
    entityAssistAgentId = data.agent_id;
  })
  .catch(error => {
    console.error('Error starting entity assistant:', error);
    alert('Network error: ' + error.message);
    // Remove generating row on error
    const genRow = document.getElementById('entity-assist-generating-row');
    if (genRow) genRow.remove();
  });
}

// Listen for entity assist completion events
appEvents.listen('domains', function(event) {
  // Only process events for our entity assist agent
  if (!entityAssistAgentId || event.agent_id !== entityAssistAgentId) return;

  if (event.event === 'finish') {
    // Clear the agent ID
    entityAssistAgentId = null;

    // Refresh the page to show the new entity
    location.reload();
  } else if (event.event === 'error') {
    // Clear the agent ID
    entityAssistAgentId = null;

    // Remove the generating row
    const genRow = document.getElementById('entity-assist-generating-row');
    if (genRow) genRow.remove();

    // Show error message
    const errorMsg = event.error || 'Unknown error occurred';
    alert('Error creating entity: ' + errorMsg);
  }
});

// Entity deletion functionality
let entityToDelete = null;

function previewEntityDelete(entityName) {
  entityToDelete = entityName;

  const modal = document.getElementById('deleteModal');
  const nameEl = document.getElementById('deleteEntityName');
  const loadingEl = document.getElementById('deleteLoadingMsg');
  const daysContainer = document.getElementById('deleteDaysContainer');
  const confirmBtn = document.getElementById('confirmDeleteBtn');

  // Set entity name
  nameEl.textContent = entityName;

  // Show loading state
  loadingEl.style.display = 'block';
  daysContainer.style.display = 'none';
  confirmBtn.disabled = true;

  // Show modal
  modal.style.display = 'block';

  // Fetch preview
  fetch(`/api/domains/${encodeURIComponent(domainName)}/entities/detected/preview?name=${encodeURIComponent(entityName)}`)
    .then(response => response.json())
    .then(data => {
      if (data.error) {
        throw new Error(data.error);
      }

      const days = data.days || [];

      if (days.length === 0) {
        loadingEl.innerHTML = '<p style="color: #999;">Entity not found in any detected day files.</p>';
        confirmBtn.disabled = true;
        return;
      }

      // Hide loading, show days list
      loadingEl.style.display = 'none';
      daysContainer.style.display = 'block';
      confirmBtn.disabled = false;

      // Update count
      const countText = days.length === 1 ? '1 day' : `${days.length} days`;
      document.getElementById('deleteDaysCount').textContent = countText;

      // Render days list
      const daysList = document.getElementById('deleteDaysList');
      daysList.innerHTML = '';

      days.forEach(day => {
        const dayItem = document.createElement('div');
        dayItem.className = 'delete-day-item';

        const dateStr = formatDayKey(day.day);
        const typeStr = day.type ? ` (${day.type})` : '';

        dayItem.innerHTML = `
          <span class="delete-day-date">${dateStr}</span>
          <span class="delete-day-type">${typeStr}</span>
        `;

        daysList.appendChild(dayItem);
      });
    })
    .catch(error => {
      console.error('Error previewing entity deletion:', error);
      loadingEl.innerHTML = `<p style="color: #c33;">Error: ${escapeHtml(error.message)}</p>`;
      confirmBtn.disabled = true;
    });
}

function closeDeleteModal() {
  document.getElementById('deleteModal').style.display = 'none';
  entityToDelete = null;
}

function confirmEntityDelete() {
  if (!entityToDelete) {
    return;
  }

  const confirmBtn = document.getElementById('confirmDeleteBtn');
  const originalText = confirmBtn.textContent;

  confirmBtn.disabled = true;
  confirmBtn.textContent = 'Deleting...';

  fetch(`/api/domains/${encodeURIComponent(domainName)}/entities/detected`, {
    method: 'DELETE',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      name: entityToDelete
    })
  })
  .then(response => response.json())
  .then(data => {
    if (data.error) {
      throw new Error(data.error);
    }

    const daysModified = data.days_modified || [];

    // Close modal
    closeDeleteModal();

    // Reload entities to reflect changes
    entitiesData = null;
    loadEntities();

    // Show success message
    const successMsg = daysModified.length === 1
      ? 'Entity deleted from 1 day file.'
      : `Entity deleted from ${daysModified.length} day files.`;

    // Simple success notification (could be enhanced with a toast)
    alert(successMsg);
  })
  .catch(error => {
    console.error('Error deleting entity:', error);
    alert('Error deleting entity: ' + error.message);

    confirmBtn.disabled = false;
    confirmBtn.textContent = originalText;
  });
}

function formatDayKey(dayKey) {
  if (!dayKey || typeof dayKey !== 'string' || dayKey.length !== 8) {
    return dayKey || 'Unknown date';
  }

  const year = Number(dayKey.slice(0, 4));
  const month = Number(dayKey.slice(4, 6)) - 1;
  const day = Number(dayKey.slice(6, 8));

  const dateObj = new Date(year, month, day);
  if (Number.isNaN(dateObj.getTime())) {
    return dayKey;
  }

  return dateObj.toLocaleDateString(undefined, {
    year: 'numeric',
    month: 'short',
    day: 'numeric'
  });
}

// Close delete modal when clicking outside
window.addEventListener('click', function(event) {
  const modal = document.getElementById('deleteModal');
  if (event.target === modal) {
    closeDeleteModal();
  }
});
</script>
{% endblock %}
