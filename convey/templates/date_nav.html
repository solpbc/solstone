{# Date Nav - renders below facet bar when app has date_nav enabled #}
{# Requires: day (YYYYMMDD), day_formatted ("Sat Nov 29"), app (app name) #}
{% if day %}
<div class="date-nav">
  <button class="date-nav-arrow" id="date-nav-prev" title="Previous (←)">‹</button>
  <span class="date-nav-label" id="date-nav-label" title="Open month picker">{{ day_formatted }}</span>
  <button class="date-nav-arrow" id="date-nav-next" title="Next (→)">›</button>
  <div class="month-picker"></div>
</div>

<script src="{{ url_for('root.static', filename='month-picker.js') }}"></script>
<script>
(function() {
  const currentDay = '{{ day }}';
  const app = '{{ app }}';
  const baseUrl = `/app/${app}/`;

  function adjustDay(day, delta) {
    const year = parseInt(day.substring(0, 4));
    const month = parseInt(day.substring(4, 6)) - 1;
    const dayNum = parseInt(day.substring(6, 8));
    const date = new Date(year, month, dayNum);
    date.setDate(date.getDate() + delta);
    return date.getFullYear() +
      String(date.getMonth() + 1).padStart(2, '0') +
      String(date.getDate()).padStart(2, '0');
  }

  function getTodayDay() {
    const now = new Date();
    return now.getFullYear() +
      String(now.getMonth() + 1).padStart(2, '0') +
      String(now.getDate()).padStart(2, '0');
  }

  function navigate(day) {
    window.location.href = `${baseUrl}${day}`;
  }

  // Register calendar data provider (if calendar app)
  if (app === 'calendar') {
    MonthPicker.registerDaysEndpoint('/app/calendar/api/days');
    MonthPicker.registerDataProvider('calendar', async (month, facet) => {
      const resp = await fetch(`/app/calendar/api/stats/${month}`);
      if (!resp.ok) return {};
      const raw = await resp.json();
      const result = {};
      for (const [day, facetCounts] of Object.entries(raw)) {
        result[day] = facet
          ? (facetCounts[facet] || 0)
          : Object.values(facetCounts).reduce((a, b) => a + b, 0);
      }
      return result;
    });
  }

  // Initialize month picker
  MonthPicker.init({
    app: app,
    currentDay: currentDay,
    container: '.month-picker'
  });

  // Click label to toggle month picker
  document.getElementById('date-nav-label').addEventListener('click', () => {
    MonthPicker.toggle();
  });

  // Arrow buttons: day nav when closed, month nav when open
  document.getElementById('date-nav-prev').addEventListener('click', () => {
    if (MonthPicker.isOpen()) {
      MonthPicker.navigateMonth(-1);
    } else {
      navigate(adjustDay(currentDay, -1));
    }
  });

  document.getElementById('date-nav-next').addEventListener('click', () => {
    if (MonthPicker.isOpen()) {
      MonthPicker.navigateMonth(1);
    } else {
      navigate(adjustDay(currentDay, 1));
    }
  });

  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    if (e.target.matches('input, textarea, select')) return;

    if (e.key === 'ArrowLeft') {
      e.preventDefault();
      if (MonthPicker.isOpen()) {
        MonthPicker.navigateMonth(-1);
      } else {
        navigate(adjustDay(currentDay, -1));
      }
    }
    if (e.key === 'ArrowRight') {
      e.preventDefault();
      if (MonthPicker.isOpen()) {
        MonthPicker.navigateMonth(1);
      } else {
        navigate(adjustDay(currentDay, 1));
      }
    }
    if (e.key === 't' || e.key === 'T') {
      e.preventDefault();
      navigate(getTodayDay());
    }
  });
})();
</script>
{% endif %}
