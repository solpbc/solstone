{% extends 'base.html' %}
{% import 'macros.html' as macros %}
{% set active = 'calendar' %}
{% block head %}
<style>
  :root{
    --bg:#f8fafc;
    --panel:#ffffff;
    --muted:#6b7280;
    --line:#e5e7eb;
    --dash:#f3f4f6;
    --rail:#f9fafb;
    --primary:#60a5fa;
    --primary-50:#eff6ff;
    --border:#c7d2fe;
  }
  html,body{height:100%;}
  body{margin:0;background:var(--bg);color:#111827;font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, sans-serif;}
  body.dragging{user-select:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none}
  .wrap{max-width:1200px;margin:0 auto;padding:16px;height:100%;box-sizing:border-box;}
  .card{height:80vh;background:var(--panel);border-radius:16px;box-shadow:0 1px 2px rgba(0,0,0,.04);display:grid;grid-template-columns:180px 1fr 180px;overflow:hidden}

  .timeline{position:relative;border-right:1px solid var(--line);user-select:none;height:100%;overflow:hidden;touch-action:pan-y}
  .grid{position:absolute;inset:0}
  .grid .hour{position:absolute;left:0;right:0;border-top:1px solid var(--line)}
  .grid .quarter{position:absolute;left:0;right:0;border-top:1px dashed var(--dash)}
  .labels{position:absolute;left:0;top:0;bottom:0;width:64px;background:var(--rail);border-right:1px solid var(--line);pointer-events:none}
  .label{position:absolute;right:0;padding-right:8px;transform:translateY(-50%);font-size:11px;color:var(--muted)}
  .lane{position:absolute;left:64px;right:0;top:0;bottom:0}

  .sel-wrap{position:absolute;left:58px;right:8px;pointer-events:none;z-index:2}
  .sel{position:absolute;left:-4px;right:-4px;height:100%;background:color-mix(in oklab, var(--primary-50) 70%, transparent);border:1px solid var(--border);border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.06);pointer-events:auto;cursor:grab;touch-action:none}
  .sel:active{cursor:grabbing}

  .bumper{position:absolute;left:40px;right:40px;margin:auto;height:14px;border:1px solid var(--primary);border-radius:999px;background:#dbeafe;cursor:ns-resize;touch-action:none}
  .bumper.top{top:-7px}
  .bumper.bottom{bottom:-7px}

  /* Segments lane */
  .segments{position:absolute;left:64px;right:0;top:0;bottom:0;pointer-events:none;z-index:1}
  .seg{position:absolute;width:40px;border-radius:12px;box-shadow:0 1px 1px rgba(0,0,0,.04);}
  .seg.green{background:color-mix(in oklab, #86efac 60%, transparent);border:1px solid #86efac}
  .seg.yellow{background:color-mix(in oklab, #fde68a 60%, transparent);border:1px solid #facc15}

  .right{padding:24px;display:flex;flex-direction:column;gap:16px;height:100%;box-sizing:border-box;overflow:hidden}
  .h{font-size:20px;font-weight:600;margin:0}
  .muted{color:#6b7280}
  .panel{flex:1;border:1px solid var(--line);border-radius:16px;padding:16px;overflow-y:auto;min-height:0;overflow-x:hidden}
  .panel pre{white-space:pre-wrap;word-wrap:break-word;overflow-wrap:break-word}
  .panel code{white-space:pre-wrap;word-wrap:break-word}
  .btn{padding:8px 12px;border:1px solid #d1d5db;border-radius:12px;background:#fff;cursor:pointer}
  .btn:hover{background:#f9fafb}

  /* Zoomed timeline styles */
  .zoom-timeline{position:relative;border-left:1px solid var(--line);user-select:none;height:100%;overflow:hidden;display:none;touch-action:pan-y}
  .zoom-timeline.active{display:block}
  .zoom-labels{position:absolute;right:0;top:0;bottom:0;width:64px;background:var(--rail);border-left:1px solid var(--line);pointer-events:none}
  .zoom-label{position:absolute;left:0;padding-left:8px;transform:translateY(-50%);font-size:11px;color:var(--muted)}
  .zoom-lane{position:absolute;left:0;right:64px;top:0;bottom:0}
  .zoom-marks{position:absolute;left:8px;right:64px;top:0;bottom:0;pointer-events:none}
  .mark{position:absolute;width:40px;height:2px;border-radius:1px}
  .mark.green{background:#86efac;left:0}
  .mark.yellow{background:#facc15;left:48px}
  .zoom-sel-wrap{position:absolute;left:8px;right:58px;pointer-events:none;z-index:2}
  .zoom-sel{position:absolute;left:-4px;right:-4px;height:100%;background:color-mix(in oklab, var(--primary-50) 40%, transparent);border:1px solid var(--border);border-radius:12px;box-shadow:0 1px 2px rgba(0,0,0,.06);pointer-events:auto;cursor:grab;touch-action:none}
  .zoom-sel:active{cursor:grabbing}
</style>
{% endblock %}
{% block body %}
<div class="container">
  {{ macros.day_heading(title,
        prev_day and url_for('calendar.calendar_transcript_page', day=prev_day),
        next_day and url_for('calendar.calendar_transcript_page', day=next_day)) }}
</div>
<div class="wrap">
  <div class="card">
    <div id="timeline" class="timeline" aria-label="Day timeline (08:00–22:00)">
      <div class="grid" aria-hidden="true"></div>
      <div class="labels" aria-hidden="true"></div>
      <div class="lane" data-role="lane"></div>
      <div class="segments" data-role="segments"></div>
      <div class="sel-wrap" style="top:0;height:0">
        <div class="sel" data-handle="move">
          <div class="bumper top" data-handle="start" title="Drag to adjust start"></div>
          <div class="bumper bottom" data-handle="end" title="Drag to adjust end"></div>
        </div>
      </div>
    </div>

    <div class="right">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div>
          <h2 class="h">Transcript Preview</h2>
          <div class="muted" id="rangeText">Selected range: 09:00 – 10:00</div>
        </div>
        <div style="display:flex;align-items:center;gap:12px">
          <label style="display:flex;align-items:center;gap:4px;cursor:pointer">
            <input type="checkbox" id="audioCheck" checked>
            <span>Audio</span>
          </label>
          <label style="display:flex;align-items:center;gap:4px;cursor:pointer">
            <input type="checkbox" id="screenCheck" checked>
            <span>Screen</span>
          </label>
          <button class="btn" id="requestBtn">Load Transcript</button>
          <button class="btn" id="mediaBtn" style="display:none">Load Media</button>
          <button class="btn" id="downloadBtn" style="display:none">Download Audio</button>
        </div>
      </div>
      <div class="panel" id="panel"></div>
    </div>

    <div id="zoomTimeline" class="zoom-timeline" aria-label="Zoomed timeline">
      <div class="zoom-grid grid" aria-hidden="true"></div>
      <div class="zoom-labels" aria-hidden="true"></div>
      <div class="zoom-lane" data-role="zoom-lane"></div>
      <div class="zoom-marks" data-role="zoom-marks"></div>
      <div class="zoom-sel-wrap" style="top:0;height:0">
        <div class="zoom-sel" data-handle="zoom-move">
          <div class="bumper top" data-handle="zoom-start" title="Drag to adjust start"></div>
          <div class="bumper bottom" data-handle="zoom-end" title="Drag to adjust end"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const START = 8 * 60;
  const END = 22 * 60;
  const STEP = 15;
  const DEFAULT_LEN = 60;
  const MIN_LEN = 15;

  const day = '{{ day }}';

  const root = document.getElementById('timeline');
  const grid = root.querySelector('.grid');
  const labels = root.querySelector('.labels');
  const lane = root.querySelector('.lane');
  const segmentsEl = root.querySelector('[data-role="segments"]');
  const selWrap = root.querySelector('.sel-wrap');
  const sel = root.querySelector('.sel');
  const rangeText = document.getElementById('rangeText');
  const panel = document.getElementById('panel');
  const requestBtn = document.getElementById('requestBtn');
  const mediaBtn = document.getElementById('mediaBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const audioCheck = document.getElementById('audioCheck');
  
  const zoomRoot = document.getElementById('zoomTimeline');
  const zoomGrid = zoomRoot.querySelector('.zoom-grid');
  const zoomLabels = zoomRoot.querySelector('.zoom-labels');
  const zoomMarks = zoomRoot.querySelector('[data-role="zoom-marks"]');
  const zoomSelWrap = zoomRoot.querySelector('.zoom-sel-wrap');
  const zoomSel = zoomRoot.querySelector('.zoom-sel');

  let height = root.clientHeight;
  let ppm = height / (END - START);
  const y = (m) => (m - START) * ppm;
  const mFromY = (py) => Math.max(START, Math.min(END, Math.round(py / ppm) + START));
  const snap = (m) => Math.round(m / STEP) * STEP;
  const hhmm = (m) => String(Math.floor(m/60)).padStart(2,'0') + ':' + String(m%60).padStart(2,'0');
  const hhmmss = (m) => hhmm(m).replace(':','') + '00';

  let range = { start: 9*60, end: 10*60 };
  let zoomRange = { start: 9*60, end: 9*60 + 15 };  // Default 15-minute window in zoom
  let zoomHeight = zoomRoot.clientHeight;
  let zoomPpm = 0;
  let zoomStart = range.start;
  let zoomEnd = range.end;
  
  const zoomY = (m) => (m - zoomStart) * zoomPpm;
  const zoomMFromY = (py) => Math.max(zoomStart, Math.min(zoomEnd, Math.round(py / zoomPpm) + zoomStart));
  const zoomSnap = (m) => Math.round(m) * 1;  // 1-minute precision for zoom

  function addSegment(color, startMin, endMin, column = 0){
    const el = document.createElement('div');
    el.className = 'seg ' + (color === 'yellow' ? 'yellow' : 'green');
    el.style.top = y(startMin) + 'px';
    el.style.height = Math.max(2, y(endMin) - y(startMin)) + 'px';
    const segW = 40;
    const gutter = 8;
    const left = (column === 1 ? gutter + segW + gutter : gutter);
    el.style.left = left + 'px';
    segmentsEl.appendChild(el);
    return el;
  }

  let drag = null;

  function buildGrid(){
    grid.innerHTML = '';
    labels.innerHTML = '';
    for (let h = START/60; h <= END/60; h++) {
      const hourLine = document.createElement('div');
      hourLine.className = 'hour';
      hourLine.style.top = y(h*60) + 'px';
      grid.appendChild(hourLine);

      const lab = document.createElement('div');
      lab.className = 'label';
      lab.style.top = y(h*60) + 'px';
      lab.textContent = String(h).padStart(2,'0') + ':00';
      labels.appendChild(lab);

      if (h < END/60){
        [15,30,45].forEach(m => {
          const q = document.createElement('div');
          q.className = 'quarter';
          q.style.top = y(h*60 + m) + 'px';
          grid.appendChild(q);
        });
      }
    }
  }

  function render(){
    selWrap.style.top = y(range.start) + 'px';
    selWrap.style.height = (y(range.end) - y(range.start)) + 'px';
    const txt = `${hhmm(range.start)} – ${hhmm(range.end)}`;
    rangeText.textContent = 'Selected range: ' + txt;
  }
  
  function renderZoom(){
    zoomSelWrap.style.top = zoomY(zoomRange.start) + 'px';
    zoomSelWrap.style.height = (zoomY(zoomRange.end) - zoomY(zoomRange.start)) + 'px';
  }
  
  function buildZoomGrid(){
    zoomGrid.innerHTML = '';
    zoomLabels.innerHTML = '';
    
    // Calculate minute intervals based on range duration
    const duration = zoomEnd - zoomStart;
    
    // Always show 15-minute intervals for labels
    for (let m = zoomStart; m <= zoomEnd; m++) {
      // Add grid lines for hours and quarter-hours
      if (m % 60 === 0) {
        const line = document.createElement('div');
        line.className = 'hour';
        line.style.top = zoomY(m) + 'px';
        zoomGrid.appendChild(line);
      } else if (m % 15 === 0) {
        const line = document.createElement('div');
        line.className = 'quarter';
        line.style.top = zoomY(m) + 'px';
        zoomGrid.appendChild(line);
      }
      
      // Add labels every 15 minutes
      if (m % 15 === 0) {
        const lab = document.createElement('div');
        lab.className = 'zoom-label';
        lab.style.top = zoomY(m) + 'px';
        lab.textContent = hhmm(m);
        zoomLabels.appendChild(lab);
      }
    }
  }
  
  function fetchZoomFiles(){
    if (!zoomRoot.classList.contains('active')) return;
    
    const audio = document.getElementById('audioCheck').checked;
    const screen = document.getElementById('screenCheck').checked;
    let type = null;
    if (audio && !screen) type = 'audio';
    else if (!audio && screen) type = 'screen';
    
    const start = hhmmss(zoomStart);
    const end = hhmmss(zoomEnd);
    
    fetch(`/calendar/api/raw_files/${day}?start=${start}&end=${end}${type ? '&type=' + type : ''}`)
      .then(r => r.json())
      .then(data => {
        zoomMarks.innerHTML = '';
        (data.files || []).forEach(f => {
          const mark = document.createElement('div');
          mark.className = 'mark ' + (f.type === 'audio' ? 'green' : 'yellow');
          mark.style.top = zoomY(f.minute) + 'px';
          mark.title = `${f.time} - ${f.type}`;
          zoomMarks.appendChild(mark);
        });
      })
      .catch(() => {});
  }

  const ro = new ResizeObserver(() => {
    height = root.clientHeight;
    ppm = height / (END - START);
    buildGrid();
    render();
  });
  ro.observe(root);
  
  const zoomRo = new ResizeObserver(() => {
    if (zoomRoot.classList.contains('active')) {
      zoomHeight = zoomRoot.clientHeight;
      if (zoomEnd > zoomStart) {
        zoomPpm = zoomHeight / (zoomEnd - zoomStart);
        buildZoomGrid();
        renderZoom();
      }
    }
  });
  zoomRo.observe(zoomRoot);

  buildGrid();
  render();

  fetch(`/calendar/api/transcript_ranges/${day}`)
    .then(r => r.json())
    .then(data => {
      (data.audio || []).forEach(rg => {
        const [s,e] = rg.map(t => {
          const [hh,mm] = t.split(':').map(Number);
          return hh*60 + mm;
        });
        addSegment('green', s, e, 0);
      });
      (data.screen || []).forEach(rg => {
        const [s,e] = rg.map(t => {
          const [hh,mm] = t.split(':').map(Number);
          return hh*60 + mm;
        });
        addSegment('yellow', s, e, 1);
      });
    });

  root.addEventListener('click', (e) => {
    if (e.target.closest('.sel')) return;
    const box = root.getBoundingClientRect();
    const py = e.clientY - box.top;
    let mid = snap(mFromY(py));
    let start = Math.max(START, Math.min(END - DEFAULT_LEN, mid - DEFAULT_LEN/2));
    start = snap(start);
    range = { start, end: snap(start + DEFAULT_LEN) };
    render();
  });

  function onPointerMove(ev){
    if (!drag) return;
    ev.preventDefault();
    const dy = ev.clientY - drag.y0;
    const dMin = Math.round((dy / ppm) / STEP) * STEP;
    if (drag.mode === 'move'){
      const len = drag.r0.end - drag.r0.start;
      let s = drag.r0.start + dMin;
      s = Math.max(START, Math.min(END - len, s));
      s = snap(s);
      range = { start: s, end: snap(s + len) };
    } else if (drag.mode === 'start'){
      let s = drag.r0.start + dMin;
      s = Math.max(START, Math.min(drag.r0.end - MIN_LEN, s));
      range = { start: snap(s), end: snap(drag.r0.end) };
    } else if (drag.mode === 'end'){
      let e = drag.r0.end + dMin;
      e = Math.min(END, Math.max(drag.r0.start + MIN_LEN, e));
      range = { start: snap(drag.r0.start), end: snap(e) };
    }
    render();
  }
  function onPointerUp(){ 
    drag = null; 
    document.body.classList.remove('dragging');
    window.removeEventListener('pointermove', onPointerMove); 
    window.removeEventListener('pointerup', onPointerUp); 
  }

  function begin(mode){
    return (ev) => {
      ev.stopPropagation();
      ev.preventDefault();
      document.body.classList.add('dragging');
      drag = { mode, y0: ev.clientY, r0: { ...range } };
      window.addEventListener('pointermove', onPointerMove);
      window.addEventListener('pointerup', onPointerUp);
    };
  }

  sel.addEventListener('pointerdown', begin('move'));
  sel.querySelector('[data-handle="start"]').addEventListener('pointerdown', begin('start'));
  sel.querySelector('[data-handle="end"]').addEventListener('pointerdown', begin('end'));
  
  // Zoom timeline drag handlers (no action yet, just visual)
  function beginZoom(mode){
    return (ev) => {
      if (!zoomRoot.classList.contains('active')) return;
      ev.stopPropagation();
      ev.preventDefault();
      document.body.classList.add('dragging');
      const zoomDrag = { mode, y0: ev.clientY, r0: { ...zoomRange } };
      
      const onZoomMove = (e) => {
        e.preventDefault();
        const dy = e.clientY - zoomDrag.y0;
        const dMin = Math.round(dy / zoomPpm);
        
        if (mode === 'zoom-move'){
          const len = zoomDrag.r0.end - zoomDrag.r0.start;
          let s = zoomDrag.r0.start + dMin;
          s = Math.max(zoomStart, Math.min(zoomEnd - len, s));
          s = zoomSnap(s);
          zoomRange = { start: s, end: zoomSnap(s + len) };
        } else if (mode === 'zoom-start'){
          let s = zoomDrag.r0.start + dMin;
          s = Math.max(zoomStart, Math.min(zoomDrag.r0.end - 1, s));
          zoomRange = { start: zoomSnap(s), end: zoomSnap(zoomDrag.r0.end) };
        } else if (mode === 'zoom-end'){
          let e = zoomDrag.r0.end + dMin;
          e = Math.min(zoomEnd, Math.max(zoomDrag.r0.start + 1, e));
          zoomRange = { start: zoomSnap(zoomDrag.r0.start), end: zoomSnap(e) };
        }
        renderZoom();
      };
      
      const onZoomUp = () => {
        document.body.classList.remove('dragging');
        window.removeEventListener('pointermove', onZoomMove);
        window.removeEventListener('pointerup', onZoomUp);
      };
      
      window.addEventListener('pointermove', onZoomMove);
      window.addEventListener('pointerup', onZoomUp);
    };
  }
  
  zoomSel.addEventListener('pointerdown', beginZoom('zoom-move'));
  zoomSel.querySelector('[data-handle="zoom-start"]').addEventListener('pointerdown', beginZoom('zoom-start'));
  zoomSel.querySelector('[data-handle="zoom-end"]').addEventListener('pointerdown', beginZoom('zoom-end'));

  requestBtn.addEventListener('click', () => {
    const start = hhmmss(range.start);
    const end = hhmmss(range.end);
    const audio = document.getElementById('audioCheck').checked;
    const screen = document.getElementById('screenCheck').checked;
    fetch(`/calendar/api/transcript/${day}?start=${start}&end=${end}&audio=${audio}&screen=${screen}`)
      .then(r => r.json())
      .then(d => {
        panel.innerHTML = d.html || '';
        // Show and update zoom timeline after loading transcript
        zoomRoot.classList.add('active');
        mediaBtn.style.display = 'block'; // Show media button when zoom timeline is active
        // Show download button only if audio is enabled
        downloadBtn.style.display = audio ? 'block' : 'none';
        zoomStart = range.start;
        zoomEnd = range.end;
        zoomHeight = zoomRoot.clientHeight;
        zoomPpm = zoomHeight / (zoomEnd - zoomStart);
        zoomRange = { start: zoomStart, end: Math.min(zoomStart + 15, zoomEnd) }; // Reset zoom range to first 15 minutes
        buildZoomGrid();
        fetchZoomFiles();
        renderZoom();
      });
  });

  mediaBtn.addEventListener('click', () => {
    const start = hhmmss(zoomRange.start);
    const end = hhmmss(zoomRange.end);
    const audio = document.getElementById('audioCheck').checked;
    const screen = document.getElementById('screenCheck').checked;
    let type = null;
    if (audio && !screen) type = 'audio';
    else if (!audio && screen) type = 'screen';
    
    fetch(`/calendar/api/media_files/${day}?start=${start}&end=${end}${type ? '&type=' + type : ''}`)
      .then(r => r.json())
      .then(data => {
        renderMediaFiles(data.media || []);
      })
      .catch(() => {
        panel.innerHTML = '<p>Error loading media files.</p>';
      });
  });

  downloadBtn.addEventListener('click', () => {
    const start = hhmmss(zoomRange.start);
    const end = hhmmss(zoomRange.end);
    
    // Create download URL
    const downloadUrl = `/calendar/api/download_audio/${day}?start=${start}&end=${end}`;
    
    // Trigger download
    const link = document.createElement('a');
    link.href = downloadUrl;
    link.download = ''; // Let server set the filename
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  });

  // Update download button visibility when audio checkbox changes
  audioCheck.addEventListener('change', () => {
    if (zoomRoot.classList.contains('active')) {
      downloadBtn.style.display = audioCheck.checked ? 'block' : 'none';
    }
  });

  function renderMediaFiles(mediaFiles) {
    if (mediaFiles.length === 0) {
      panel.innerHTML = '<p>No media files found in the selected time range.</p>';
      return;
    }

    let html = '';
    mediaFiles.forEach(file => {
      html += `<div style="margin-bottom: 24px;">`;
      html += `<h4 style="margin: 0 0 8px 0; color: #374151; font-size: 14px;">${file.human_time}</h4>`;
      
      if (file.type === 'audio') {
        html += `<audio controls style="width: 100%; max-width: 400px;">`;
        html += `<source src="${file.url}" type="${file.mime_type}">`;
        html += `Your browser does not support the audio element.`;
        html += `</audio>`;
      } else if (file.type === 'screen') {
        html += `<img src="${file.url}" style="max-width: 100%; height: auto; border: 1px solid #e5e7eb; border-radius: 8px;" alt="Screenshot at ${file.human_time}">`;
      }
      
      html += `</div>`;
    });

    panel.innerHTML = html;
  }
})();
</script>
{% endblock %}

