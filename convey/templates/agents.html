{% extends 'base.html' %}
{% set title = 'Agents' %}
{% set active = 'agents' %}
{% block head %}
<style>
{% include 'agents/_styles.html' %}
</style>
{% endblock %}
{% block body %}
<div class="container">
  
  <!-- Tab Navigation -->
  <div class="tab-nav">
    <button class="tab-button active" onclick="switchMainTab('log')">Log</button>
    <button class="tab-button" onclick="switchMainTab('agents')">Agents</button>
    <button class="tab-button" onclick="switchMainTab('topics')">Topics</button>
    <button class="tab-button" onclick="switchMainTab('tools')">Tools</button>
  </div>
  
  <!-- Tab Content -->
  <div class="tab-container">
    
    <!-- Log Tab -->
    <div id="logTab" class="main-tab-content active">
      <!-- Live Agents Section -->
      <div id="liveAgentsSection">
        <div class="section-header">
          <span>Live</span>
          <span class="count" id="liveCount">0</span>
        </div>
        <table id="liveAgentTable"></table>
        <div id="liveEmpty" class="empty-state" style="display: none;">
          No agents currently running
        </div>
      </div>
      
      <!-- Historical Agents Section -->
      <div id="historicalAgentsSection">
        <div class="section-header">
          <span>Completed</span>
          <span class="count" id="historicalCount">0</span>
        </div>
        <table id="historicalAgentTable"></table>
        <div id="historicalEmpty" class="empty-state" style="display: none;">
          No completed agent runs found
        </div>
      </div>
      
      <!-- Pagination -->
      <div id="pagination" class="pagination" style="display: none;">
        <button id="prevBtn" onclick="changePage(-1)">Previous</button>
        <div class="page-info">
          <span id="pageInfo">Page 1 of 1</span>
        </div>
        <button id="nextBtn" onclick="changePage(1)">Next</button>
      </div>
    </div>
    
    <!-- Agents Tab -->
    <div id="agentsTab" class="main-tab-content">
      <div id="agentCards" class="agent-cards"></div>
    </div>
    
    <!-- Topics Tab -->
    <div id="topicsTab" class="main-tab-content">
      <div id="topicCards" class="agent-cards"></div>
    </div>

    <!-- Tools Tab -->
    <div id="toolsTab" class="main-tab-content">
      <div class="tools-container">
        <!-- Tools Filter/Search -->
        <div class="tools-header">
          <input type="text" id="toolsSearch" placeholder="Search tools..." class="tools-search" />
          <div class="pack-filters" id="packFilters"></div>
        </div>

        <!-- Tools Grid -->
        <div id="toolsGrid" class="tools-grid">
          <div class="loading-spinner">Loading tools...</div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Create Agent Modal -->
<div id="createPersonaModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeCreatePersonaModal()">&times;</span>
    <h2>Create New Agent</h2>
    <form id="createPersonaForm" class="input-area">
      <input type="text" id="personaTitle" placeholder="Agent Title" required />
      <textarea id="personaInput" rows="8" placeholder="Describe what this agent should accomplish..." required></textarea>
      <div style="margin: 1rem 0; border-top: 1px solid #ddd; padding-top: 1rem;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
          <div>
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
              <input type="checkbox" id="personaDailySchedule" style="width: auto;">
              <span>Run daily (scheduled agent)</span>
            </label>
          </div>
          <div>
            <label style="display: block;">
              Priority (0-99):
              <input type="number" id="personaPriority" min="0" max="99" placeholder="Default: 50"
                     style="width: 100px; margin-left: 0.5rem; padding: 0.25rem;">
            </label>
          </div>
        </div>
        <div>
          <label style="display: block; margin-bottom: 0.5rem;">
            Tool Packs:
            <select id="personaToolPacks" multiple style="width: 100%; height: 80px; margin-top: 0.5rem;">
              <option value="" selected>Default (All Tools)</option>
              <option value="journal">Journal</option>
              <option value="todo">Todo</option>
              <option value="domains">Domains</option>
            </select>
          </label>
          <small style="color: #666;">Hold Ctrl/Cmd to select multiple. Leave "Default" for all tools.</small>
        </div>
      </div>
      <button type="submit" id="createPromptBtn">Create Prompt</button>
    </form>
    
    <!-- Planning Status -->
    <div id="createPersonaPromptStatus" class="planning-status">
      <div>Creating prompt...</div>
    </div>
    
    <!-- Removed Result Area - now auto-saves and opens edit modal -->
  </div>
</div>

<!-- Create Topic Modal -->
<div id="createTopicModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeCreateTopicModal()">&times;</span>
    <h2>Create New Topic</h2>
    <form id="createTopicForm" class="input-area">
      <input type="text" id="topicTitle" placeholder="Topic Title" required />
      <textarea id="topicInput" rows="8" placeholder="Describe what information this topic should extract..." required></textarea>
      <button type="submit" id="createTopicBtn">Create Topic</button>
    </form>
    
    <!-- Result Area -->
    <div id="topicResult" style="display: none;">
      <h3>Topic Content</h3>
      <div id="topicResultContent" class="prompt-result-box"></div>
      <div class="modal-actions">
        <button onclick="saveNewTopic()">Save Topic</button>
        <button onclick="editTopicContent()">Edit Content</button>
      </div>
    </div>
  </div>
</div>

<!-- Enhanced Agent/Topic Modal -->
<div id="itemModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeItemModal()">&times;</span>

    <div class="modal-header">
      <h3 id="modalTitle" class="modal-title-editable" ondblclick="startTitleEdit()" title="Double-click to edit"></h3>
      <input id="modalTitleInput" class="modal-title-input" style="display: none;"
             onblur="saveTitleEdit()" onkeydown="handleTitleKey(event)" />
    </div>

    <div class="modal-body">
      <!-- Metadata section for agents only -->
      <div id="agentMetadata" class="metadata-section" style="display: none;">
        <div class="metadata-item">
          <label>Schedule</label>
          <div class="checkbox-wrapper" onclick="toggleSchedule()">
            <input type="checkbox" id="modalSchedule" onclick="event.stopPropagation()" onchange="saveMetadata()">
            <span>Daily Execution</span>
          </div>
        </div>

        <div class="metadata-item">
          <label>Priority</label>
          <input type="number" id="modalPriority" min="0" max="99" placeholder="50"
                 onblur="saveMetadata()" onkeydown="if(event.key === 'Escape') this.blur();">
        </div>

        <div class="metadata-item">
          <label>Multi-Domain</label>
          <div class="checkbox-wrapper" onclick="toggleMultiDomain()">
            <input type="checkbox" id="modalMultiDomain" onclick="event.stopPropagation()" onchange="saveMetadata()">
            <span>Run per domain</span>
          </div>
        </div>

        <div class="metadata-item">
          <label>Backend</label>
          <select id="modalBackend" onchange="saveMetadata()">
            <option value="">Default</option>
            <option value="openai">OpenAI</option>
            <option value="anthropic">Anthropic</option>
            <option value="google">Google</option>
            <option value="claude">Claude</option>
          </select>
        </div>

        <div class="metadata-item">
          <label>Model</label>
          <input type="text" id="modalModel" placeholder="Auto"
                 onblur="saveMetadata()" onkeydown="if(event.key === 'Escape') this.blur();">
        </div>

        <div class="metadata-item">
          <label>Tools</label>
          <select id="modalTools" onchange="saveMetadata()">
            <option value="">Default</option>
            <option value="journal">Journal</option>
            <option value="todo">Todo</option>
            <option value="domains">Domains</option>
            <option value="journal,todo">Journal + Todo</option>
            <option value="journal,domains">Journal + Domains</option>
            <option value="custom">Custom...</option>
          </select>
          <input type="text" id="modalToolsCustom" placeholder="e.g., tool1,tool2"
                 style="display: none; margin-top: 0.5rem;"
                 onblur="saveMetadata()" onkeydown="if(event.key === 'Escape') this.blur();">
        </div>
      </div>

      <!-- Prompt/Content section -->
      <div class="prompt-section">
        <div class="prompt-header">
          <span class="prompt-label" id="promptLabel">System Prompt</span>
          <div class="prompt-actions">
            <button id="editPromptBtn" class="edit-prompt-btn" onclick="startPromptEdit()">Edit</button>
            <button id="savePromptBtn" class="save-prompt-btn" style="display: none;" onclick="savePromptEdit()">Save</button>
            <button id="cancelPromptBtn" class="cancel-prompt-btn" style="display: none;" onclick="cancelPromptEdit()">Cancel</button>
            <span id="savingIndicator" class="saving-indicator" style="display: none;">Saved!</span>
          </div>
        </div>
        <div class="prompt-content">
          <div id="promptDisplay" class="prompt-display"></div>
          <textarea id="itemContentEditor" class="prompt-editor" style="display: none;"></textarea>
        </div>
      </div>

      <!-- Topics metadata section -->
      <div id="topicMetadata" class="metadata-section" style="display: none;">
        <div class="metadata-item">
          <label>Status</label>
          <div class="checkbox-wrapper" onclick="toggleTopicEnabled()">
            <input type="checkbox" id="modalTopicEnabled" onclick="event.stopPropagation()" onchange="saveTopicMetadata()">
            <span>Enabled</span>
          </div>
        </div>
        <div class="metadata-item">
          <label>Color</label>
          <input type="color" id="modalTopicColor" onchange="saveTopicMetadata()">
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Planning Modal -->
<div id="promptModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closePromptModal()">&times;</span>
    <div class="modal-header">
      <h3>Agent Prompt</h3>
    </div>
    <div class="modal-body">
      <!-- Tabs -->
      <div class="modal-tabs">
        <button class="modal-tab active" onclick="switchTab('prompt')">Edit Prompt</button>
        <button class="modal-tab" onclick="switchTab('preview')">Preview</button>
        <button class="modal-tab" onclick="switchTab('config')">Configuration</button>
      </div>
      
      <!-- Tab Content -->
      <div id="promptTab" class="tab-content active">
        <textarea id="promptEditor" class="prompt-editor" placeholder="Your execution prompt will appear here..."></textarea>
      </div>
      
      <div id="previewTab" class="tab-content">
        <div id="promptPreview" class="markdown-content"></div>
      </div>
      
      <div id="configTab" class="tab-content">
        <p style="font-size: 0.9rem; color: #666; margin-bottom: 1rem;">
          <em>Note: Prompt generation uses Gemini. Configuration below applies to agent execution.</em>
        </p>
        
        <div class="config-section">
          <label for="agentBackend">Agent Backend</label>
          <select id="agentBackend">
            <option value="openai">OpenAI</option>
            <option value="anthropic">Anthropic</option>
            <option value="google">Google</option>
          </select>
        </div>
        
        <div class="config-section">
          <label for="agentModel">Model (optional)</label>
          <input type="text" id="agentModel" placeholder="Leave empty for default">
        </div>
        
        <div class="config-section">
          <label for="maxTokens">Max Tokens</label>
          <input type="number" id="maxTokens" placeholder="0 for default" min="0">
        </div>
        
        <div class="config-section">
          <label for="agentPersona">Agent</label>
          <select id="agentPersona">
            <option value="default">Default</option>
          </select>
        </div>
        
        <button id="startAgentBtn" class="start-agent-btn" onclick="startAgent()">
          ðŸš€ Start Agent
        </button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
{% include 'agents/_scripts.html' %}
</script>
{% endblock %}
