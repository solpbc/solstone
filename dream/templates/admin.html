{% extends 'base.html' %}
{% set title = 'Admin' %}
{% set active = 'admin' %}
{% block head %}
<style>
body { font-family: sans-serif; margin:0; }
.container { max-width:600px; margin:0 auto; padding:1em; }
button { padding:8px 16px; margin:0.5em 0; }
pre { background:#f5f5f5; padding:0.5em; }
.modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); }
.modal-content { background:white; margin:5% auto; padding:1em; border-radius:8px; max-width:800px; max-height:80vh; overflow:auto; position:relative; }
.close { position:absolute; top:10px; right:15px; cursor:pointer; font-size:24px; }
</style>
{% endblock %}
{% block body %}
<div class="container">
  <h1>Admin</h1>
  <button id="reindexBtn">Reindex</button>
  <button id="summaryBtn">Refresh Summary</button>
  <button id="entitiesBtn">Reload Entities</button>
  <pre id="status"></pre>
</div>
<div id="taskModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <pre id="taskOutput"></pre>
  </div>
</div>
<script>
function runTask(data){
  const modal=document.getElementById('taskModal');
  const out=document.getElementById('taskOutput');
  out.innerHTML='';
  modal.style.display='block';
  const ws=new WebSocket(`ws://${location.hostname}:8765`);
  ws.onopen=()=>ws.send(JSON.stringify(data));
  ws.onmessage=e=>{
    const msg=JSON.parse(e.data);
    if(msg.type==='stdout') out.innerHTML+=msg.text+'\n';
    else if(msg.type==='stderr') out.innerHTML+='<span style="color:red">'+msg.text+'</span>\n';
    else if(msg.type==='exit'){out.innerHTML+='[exit '+msg.code+']\n'; ws.close();}
  };
  ws.onclose=()=>{out.innerHTML+='\n[completed]\n';};
}
document.getElementById('reindexBtn').onclick=()=>runTask({task:'reindex'});
document.getElementById('summaryBtn').onclick=()=>runTask({task:'summary'});
document.getElementById('entitiesBtn').onclick=()=>runTask({task:'reload_entities'});
document.querySelector('.close').onclick=()=>{document.getElementById('taskModal').style.display='none';};
window.onclick=e=>{if(e.target==document.getElementById('taskModal'))document.getElementById('taskModal').style.display='none';};
</script>
{% endblock %}
