{% extends 'base.html' %}
{% set title = 'Admin' %}
{% set active = 'admin' %}
{% block head %}
<style>
.container { padding:0 1em; }
button { padding:8px 16px; margin:0.5em 0; }
pre { background:#f5f5f5; padding:0.5em; }
.modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); }
.modal-content { background:white; margin:5% auto; padding:1em; border-radius:8px; max-width:800px; max-height:80vh; overflow:auto; position:relative; }
.close { position:absolute; top:10px; right:15px; cursor:pointer; font-size:24px; }
.spinner { display:inline-block; width:12px; height:12px; border:2px solid #ccc; border-top-color:#333; border-radius:50%; animation:spin 1s linear infinite; margin-left:4px; }
@keyframes spin { to { transform:rotate(360deg); } }
</style>
{% endblock %}
{% block body %}
<div class="container">
  <h1>Admin</h1>
  <button id="reindexBtn">Reindex</button>
  <button id="summaryBtn">Refresh Summary</button>
  <button id="entitiesBtn">Reload Entities</button>
  <pre id="status"></pre>
  {% set cats = ['hear','see','reduce','ponder','entity'] %}
  <div class="tabs">
    {% for cat in cats %}
    <div class="tab{% if loop.first %} active{% endif %}" data-target="{{ cat }}">{{ cat.capitalize() }}</div>
    {% endfor %}
    <div class="tab" data-target="log">Task Log</div>
  </div>
  {% for cat in cats %}
  <ul class="content" id="{{ cat }}" style="{% if not loop.first %}display:none{% endif %}">
    {% for item in repair_data[cat] %}
    <li><a href="{{ url_for('admin.admin_day_page', day=item.day) }}">{{ item.day }}</a> - {{ item.count }}</li>
    {% else %}
    <li>No items</li>
    {% endfor %}
  </ul>
  {% endfor %}
  <div class="content" id="log" style="display:none">
    <pre id="logOutput"></pre>
  </div>
</div>
<div id="taskModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <pre id="taskOutput"></pre>
  </div>
</div>
<script>
let taskDone=false;
const tabs = document.querySelectorAll('.tab');
const contents = document.querySelectorAll('.content');
function showTab(id){
  tabs.forEach(t=>t.classList.toggle('active', t.dataset.target===id));
  contents.forEach(c=>{c.style.display=c.id===id?'block':'none';});
}
tabs.forEach(t=>t.addEventListener('click', ()=>showTab(t.dataset.target)));
function runTask(data){
  const modal=document.getElementById('taskModal');
  const out=document.getElementById('taskOutput');
  const modalContent=document.querySelector('#taskModal .modal-content');
  out.innerHTML='';
  modal.style.display='block';
  taskDone=false;
  if(data.force) out.innerHTML='[using --force]\n';
  const spinner=document.createElement('span');
  spinner.className='spinner';
  out.appendChild(spinner);
  const scroll=()=>{modalContent.scrollTop=modalContent.scrollHeight;};
  const addLine=html=>{spinner.remove();out.innerHTML+=html+'\n';out.appendChild(spinner);scroll();};
  const ws=new WebSocket(`ws://${location.hostname}:8765`);
  const start=Date.now();
  ws.onopen=()=>ws.send(JSON.stringify(data));
  ws.onmessage=e=>{
    const msg=JSON.parse(e.data);
    if(msg.type==='stdout') addLine(msg.text);
    else if(msg.type==='stderr') addLine('<span style="color:red">'+msg.text+'</span>');
    else if(msg.type==='exit'){spinner.remove();out.innerHTML+='[exit '+msg.code+']\n';scroll();ws.close();}
  };
  ws.onclose=()=>{spinner.remove();const s=Math.round((Date.now()-start)/1000);
    const msg=s>=60?(Math.round(s/6)/10+' minutes'):s+' seconds';
    out.innerHTML+=`\n[completed in ${msg}]\n`;scroll();taskDone=true;};
}
document.getElementById('reindexBtn').onclick=()=>runTask({task:'reindex',src:'admin'});
document.getElementById('summaryBtn').onclick=()=>runTask({task:'summary',src:'admin'});
document.getElementById('entitiesBtn').onclick=()=>runTask({task:'reload_entities',src:'admin'});
function loadLog(){
  fetch('{{ url_for('admin.task_log') }}').then(r=>r.json()).then(data=>{
    const pre=document.getElementById('logOutput');
    pre.textContent=data.map(e=>`${e.since} - ${e.message}`).join('\n');
  });
}
function hideModal(){
  document.getElementById('taskModal').style.display='none';
  if(taskDone) location.reload();
}
document.querySelectorAll('#taskModal .close')[0].onclick=hideModal;
window.onclick=e=>{
  if(e.target==document.getElementById('taskModal')) hideModal();
};
loadLog();
</script>
{% endblock %}
