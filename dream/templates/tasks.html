{% extends 'base.html' %}
{% set title = 'Tasks' %}
{% block head %}
<style>
.container { padding:0 1em; }
table { border-collapse: collapse; width:100%; table-layout: fixed; }
th, td { padding:4px 8px; border-bottom:1px solid #ddd; white-space: nowrap; }
td:first-child { overflow: hidden; text-overflow: ellipsis; }
button { padding:4px 8px; }
.modal { display:none; position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); }
.modal-content { background:white; margin:5% auto; padding:1em; border-radius:8px; max-width:800px; max-height:80vh; overflow:auto; position:relative; }
.close { position:absolute; top:10px; right:15px; cursor:pointer; font-size:24px; }
.spinner { display:inline-block; width:12px; height:12px; border:2px solid #ccc; border-top-color:#333; border-radius:50%; animation:spin 1s linear infinite; margin-left:4px; }
@keyframes spin { to { transform:rotate(360deg); } }
</style>
{% endblock %}
{% block body %}
<div class="container">
  <h1>Tasks</h1>
  <table id="taskTable"></table>
  <button id="clearBtn">Clear Old</button>
</div>
<div id="taskModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <pre id="taskOutput"></pre>
  </div>
</div>
<script>
let taskMap={};
function fmtDur(d){return d>=60?(Math.round(d/6)/10+'m'):d+'s';}
function buildRow(t){
  const tr=document.createElement('tr');
  tr.dataset.id=t.id;
  const name=t.day?t.name+' '+t.day:t.name;
  const dur=fmtDur(t.duration);
  tr.title=t.command||'';
  const exitStr=(t.exit_code===undefined||t.exit_code===null)?'':t.exit_code;
  tr.innerHTML=`<td>${name}</td><td>${t.since}</td><td class="dur">${dur}</td><td>${t.initiator}</td><td class="lines">${t.lines} lines</td><td>${exitStr}</td>`;
  const view=document.createElement('button');view.textContent='Log';
  view.onclick=()=>showLog(t.id);
  const cell=document.createElement('td');cell.appendChild(view);
  if(!t.end && !t.killed){
    const kill=document.createElement('button');kill.textContent='Kill';kill.style.marginLeft='4px';
    kill.onclick=()=>killTask(t.id);
    cell.appendChild(kill);
  }
  if(t.exit_code && t.exit_code!==0) tr.style.background='#fdd';
  if(t.killed) tr.style.background='#fcc';
  tr.appendChild(cell);
  taskMap[t.id]={row:tr,dur:tr.querySelector('.dur'),lines:tr.querySelector('.lines')};
  return tr;
}
function loadTasks(){
  fetch('{{ url_for('tasks.tasks_list') }}').then(r=>r.json()).then(data=>{
    const table=document.getElementById('taskTable');
    table.innerHTML='<tr><th>Task</th><th>Started</th><th>Duration</th><th>From</th><th>Lines</th><th>Exit</th><th></th></tr>';
    taskMap={};
    data.forEach(t=>{table.appendChild(buildRow(t));});
  });
}
function updateStatus(list){
  list.forEach(s=>{
    const info=taskMap[s.id];
    if(!info) return;
    info.dur.textContent=fmtDur(s.duration);
    info.lines.textContent=s.lines+' lines';
  });
}
function showLog(id){
  const modal=document.getElementById('taskModal');
  const out=document.getElementById('taskOutput');
  const content=document.querySelector('#taskModal .modal-content');
  out.textContent='';
  modal.style.display='block';
  const ws=new WebSocket(`ws://${location.host}/ws/tasks`);
  ws.onopen=()=>ws.send(JSON.stringify({attach:id}));
  ws.onmessage=e=>{const m=JSON.parse(e.data);if(m.text) {out.textContent+=m.text+'\n';content.scrollTop=content.scrollHeight;}}
  ws.onclose=()=>{};
  modal.dataset.wsid=id;modal.dataset.ws=ws;
}
function killTask(id){
  const ws=new WebSocket(`ws://${location.host}/ws/tasks`);
  ws.onopen=()=>ws.send(JSON.stringify({kill:id}));
  ws.onclose=()=>loadTasks();
}
function hideModal(){
  const modal=document.getElementById('taskModal');
  const ws=modal.dataset.ws;
  if(ws) try{ws.close();}catch(e){}
  modal.style.display='none';
}
document.querySelector('#taskModal .close').onclick=hideModal;
window.onclick=e=>{if(e.target==document.getElementById('taskModal')) hideModal();};
appEvents.listen('tasks',m=>{if(m.event==='status') updateStatus(m.tasks); else loadTasks();});
loadTasks();
document.getElementById('clearBtn').onclick=()=>{
  fetch('{{ url_for('tasks.clear_old') }}',{method:'POST'}).then(()=>loadTasks());
};
</script>
{% endblock %}
