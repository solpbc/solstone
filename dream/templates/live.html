{% extends 'base.html' %}
{% set title = 'Live' %}
{% set active = 'live' %}
{% block head %}
<style>
body {height:100vh; overflow:hidden;}
.container {height:100vh; display:flex; flex-direction:column; position:relative; padding:0 1em;}
.top-bar {padding:0.5em 0;}
#messages {flex:1; overflow-y:auto; padding:1em; display:flex; flex-direction:column;}
.message {margin-bottom:0.75em; padding:0.5em 0.75em; border-radius:8px; max-width:80%; background:#f1f0f0; align-self:flex-start;}
.message .speaker {font-weight:bold; margin-right:0.25em;}
</style>
{% endblock %}
{% block body %}
<div class="container">
  <div class="top-bar"><button id="joinBtn">Join</button></div>
  <div id="messages"></div>
</div>
<script>
const joinUrl = '{{ url_for('live.live_join') }}';
const leaveUrl = '{{ url_for('live.live_leave') }}';
const messagesDiv = document.getElementById('messages');
function addMessage(id,text,speaker){
  const div=document.createElement('div');
  div.className='message';
  div.dataset.id=id;
  div.innerHTML='<span class="speaker">'+(speaker?speaker+':':'')+'</span><span class="text">'+text+'</span>';
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop=messagesDiv.scrollHeight;
}
function updateSpeaker(id,speaker){
  const el=messagesDiv.querySelector('.message[data-id="'+id+'"] .speaker');
  if(el) el.textContent=speaker+':';
}
appEvents.listen('live', m=>{
  if(m.event==='transcription') addMessage(m.id,m.text,m.speaker);
  if(m.event==='speaker') updateSpeaker(m.id,m.speaker);
  if(m.event==='joined'){ joined=true; joinBtn.textContent='Leave'; }
  if(m.event==='left'){ joined=false; joinBtn.textContent='Join'; }
});
const joinBtn=document.getElementById('joinBtn');
let joined=false;
joinBtn.onclick=()=>{
  if(joined){
    fetch(leaveUrl,{method:'POST'});
  }else{
    fetch(joinUrl,{method:'POST',headers:{'Content-Type':'application/json'},body:'{}'});
  }
};
window.addEventListener('beforeunload',()=>{
  if(joined) navigator.sendBeacon(leaveUrl);
});
</script>
{% endblock %}
