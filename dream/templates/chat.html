{% extends 'base.html' %}
{% set title = 'Chat' %}
{% set active = 'chat' %}
{% block head %}
<style>
body {height:100vh; overflow:hidden;}
.container {height:100vh; display:flex; flex-direction:column; position:relative; padding:0 1em;}
#messages {flex:1; overflow-y:auto; padding:1em; padding-bottom:0; display:flex; flex-direction:column;}
.message {margin-bottom:0.75em; padding:0.5em 0.75em; border-radius:8px; max-width:80%;}
.from-user {background:#dcf8c6; align-self:flex-end;}
.from-bot {background:#f1f0f0; align-self:flex-start;}
#messages .event-card{background:#fff4e5;border:1px solid #f0ad4e;border-radius:6px;padding:0.5em 0.75em;margin-bottom:0.75em;font-size:0.85em;max-width:80%;align-self:flex-start;}
#messages .event-card a{text-decoration:none;color:#007bff;}
#messages .event-card a:hover{text-decoration:underline;}
#drawer {display:none; border-top:1px solid #ddd; padding:0.5em; background:#fafafa;}
</style>
{% endblock %}
{% block body %}
<div class="container">
  <div id="messages"></div>
  <div id="drawer">Attachments drawer</div>
  <div class="input-tray">
    <form id="inputArea" class="input-area">
      <select id="backendSelect">
        <option value="google">Google</option>
        <option value="openai">OpenAI</option>
        <option value="anthropic">Claude</option>
      </select>
      <textarea id="messageInput" rows="1" placeholder="Send a message..."></textarea>
      <button type="submit">Send</button>
      <button type="button" id="clearBtn">Clear</button>
    </form>
  </div>
</div>
<script>
const sendUrl = '{{ url_for('chat.send_message') }}';
const historyUrl = '{{ url_for('chat.chat_history') }}';
const clearUrl = '{{ url_for('chat.clear_history') }}';
const form = document.getElementById('inputArea');
const input = document.getElementById('messageInput');
const messagesDiv = document.getElementById('messages');
const backendSelect = document.getElementById('backendSelect');
const searchBase = '{{ url_for('search.search_page') }}';

function addEventCard(text, url){
  const div=document.createElement('div');
  div.className='event-card';
  const a=document.createElement('a');
  a.href=url;
  a.textContent=text;
  div.appendChild(a);
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop=messagesDiv.scrollHeight;
}

input.focus();

input.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    form.requestSubmit();
  }
});
function addMessage(text, cls){
  const div=document.createElement('div');
  div.className='message '+cls;
  div.textContent=text;
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop=messagesDiv.scrollHeight;
}
document.getElementById('inputArea').onsubmit=async e=>{
  e.preventDefault();
  const text=input.value.trim();
  if(!text)return;
  addMessage(text,'from-user');
  input.value='';
  const r=await fetch(sendUrl,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:text,backend:backendSelect.value})});
  if(r.ok){const d=await r.json();addMessage(d.text,'from-bot');}else{let err='Error';try{const d=await r.json();err=d.error||err;}catch{};if(window.showError)showError(err);}
};

async function loadHistory(){
  const r=await fetch(historyUrl);
  if(!r.ok)return;
  const d=await r.json();
  for(const m of d.history){
    addMessage(m.text,m.role==='user'?'from-user':'from-bot');
  }
}

document.getElementById('clearBtn').onclick=async()=>{
  await fetch(clearUrl,{method:'POST'});
  messagesDiv.innerHTML='';
  input.focus();
};

backendSelect.addEventListener('change', async ()=>{
  await fetch(clearUrl,{method:'POST'});
  messagesDiv.innerHTML='';
  input.focus();
});

appEvents.listen('chat',e=>{
  if(e.event==='tool_start'&&e.args&&e.args.query){
    let idx='summaries';
    if(e.tool.includes('event')) idx='events';
    else if(e.tool.includes('transcript')) idx='transcripts';
    const q=e.args.query+(idx==='summaries'?'':' index:'+idx);
    const url=searchBase+'#q='+encodeURIComponent(q);
    addEventCard('Search '+e.args.query,url);
  }
});

loadHistory();
</script>
{% endblock %}

