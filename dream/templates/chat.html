{% extends 'base.html' %}
{% set title = 'Chat' %}
{% set active = 'chat' %}
{% block head %}
<style>
body {height:100vh; overflow:hidden;}
.container {height:100vh; display:flex; flex-direction:column; position:relative; padding:0 1em;}
#messages {flex:1; overflow-y:auto; padding:1em; padding-bottom:0; display:flex; flex-direction:column;}
.message {margin-bottom:0.75em; padding:0.5em 0.75em; border-radius:8px; max-width:80%;}
.from-user {background:#dcf8c6; align-self:flex-end;}
.from-bot {background:#f1f0f0; align-self:flex-start;}
#messages .event-card{background:#fff4e5;border:1px solid #f0ad4e;border-radius:6px;padding:0.5em 0.75em;margin-bottom:0.75em;font-size:0.85em;max-width:80%;align-self:flex-start;}
#messages .event-card a{text-decoration:none;color:#007bff;}
#messages .event-card a:hover{text-decoration:underline;}
#messages .tool-placard{background:#e3f2fd;border:1px solid #2196f3;border-radius:6px;padding:0.4em 0.6em;margin-bottom:0.5em;font-size:0.8em;max-width:60%;align-self:flex-start;cursor:help;position:relative;}
#messages .tool-placard:hover{background:#bbdefb;}
#messages .tool-placard .tool-name{font-weight:bold;color:#1976d2;}
#messages .tool-placard .tool-tooltip{visibility:hidden;background:#333;color:#fff;text-align:left;border-radius:4px;padding:0.5em;position:absolute;z-index:1000;bottom:125%;left:0;min-width:300px;max-width:500px;font-size:0.75em;font-family:monospace;white-space:pre-wrap;opacity:0;transition:opacity 0.3s;}
#messages .tool-placard:hover .tool-tooltip{visibility:visible;opacity:1;}
#messages .thinking-card{background:#f8f4ff;border:1px solid #9c27b0;border-radius:6px;padding:0.5em 0.75em;margin-bottom:0.75em;font-size:0.85em;max-width:80%;align-self:flex-start;cursor:pointer;}
#messages .thinking-card:hover{background:#f3e5f5;}
#messages .thinking-card .thinking-label{font-weight:bold;color:#7b1fa2;margin-bottom:0.25em;}
#messages .thinking-card .thinking-content{color:#333;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
#messages .thinking-card.expanded .thinking-content{white-space:pre-wrap;overflow:visible;text-overflow:clip;}
#drawer {display:none; border-top:1px solid #ddd; padding:0.5em; background:#fafafa;}
</style>
{% endblock %}
{% block body %}
<div class="container">
  <div id="messages"></div>
  <div id="drawer">Attachments drawer</div>
  <div class="input-tray">
    <form id="inputArea" class="input-area">
      <select id="backendSelect">
        <option value="google">Google</option>
        <option value="openai">OpenAI</option>
        <option value="anthropic">Claude</option>
      </select>
      <textarea id="messageInput" rows="1" placeholder="Send a message..."></textarea>
      <button type="submit">Send</button>
      <button type="button" id="clearBtn">Clear</button>
    </form>
  </div>
</div>
<script>
const sendUrl = '{{ url_for('chat.send_message') }}';
const historyUrl = '{{ url_for('chat.chat_history') }}';
const clearUrl = '{{ url_for('chat.clear_history') }}';
const agentUrl = '{{ url_for('chat.agent_events', agent_id='AGENT_ID') }}';
const form = document.getElementById('inputArea');
const input = document.getElementById('messageInput');
const messagesDiv = document.getElementById('messages');
const backendSelect = document.getElementById('backendSelect');
const searchBase = '{{ url_for('search.search_page') }}';

// Check if viewing historical agent
const fragment = window.location.hash.slice(1);
const isHistorical = fragment && /^\d+$/.test(fragment);

function addEventCard(text, url){
  const div=document.createElement('div');
  div.className='event-card';
  const a=document.createElement('a');
  a.href=url;
  a.textContent=text;
  div.appendChild(a);
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop=messagesDiv.scrollHeight;
}

function addToolPlacard(toolName, args){
  const div=document.createElement('div');
  div.className='tool-placard';
  
  const nameSpan=document.createElement('span');
  nameSpan.className='tool-name';
  nameSpan.textContent=toolName;
  div.appendChild(nameSpan);
  
  if(args){
    const tooltip=document.createElement('div');
    tooltip.className='tool-tooltip';
    tooltip.textContent=JSON.stringify(args, null, 2);
    div.appendChild(tooltip);
  }
  
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop=messagesDiv.scrollHeight;
}

function addThinkingCard(summary, model){
  const div=document.createElement('div');
  div.className='thinking-card';
  
  const label=document.createElement('div');
  label.className='thinking-label';
  label.textContent=`ðŸ’­ Thinking (${model})`;
  div.appendChild(label);
  
  const content=document.createElement('div');
  content.className='thinking-content';
  content.textContent=summary;
  div.appendChild(content);
  
  div.addEventListener('click', () => {
    div.classList.toggle('expanded');
  });
  
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop=messagesDiv.scrollHeight;
}

input.focus();

input.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    form.requestSubmit();
  }
});
function addMessage(text, cls){
  const div=document.createElement('div');
  div.className='message '+cls;
  div.textContent=text;
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop=messagesDiv.scrollHeight;
}
document.getElementById('inputArea').onsubmit=async e=>{
  e.preventDefault();
  const text=input.value.trim();
  if(!text)return;
  
  // Clear previous messages for fresh one-shot conversation
  messagesDiv.innerHTML='';
  
  addMessage(text,'from-user');
  input.value='';
  const r=await fetch(sendUrl,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:text,backend:backendSelect.value})});
  if(r.ok){const d=await r.json();addMessage(d.text,'from-bot');}else{let err='Error';try{const d=await r.json();err=d.error||err;}catch{};if(window.showError)showError(err);}
};

async function loadHistory(){
  const r=await fetch(historyUrl);
  if(!r.ok)return;
  const d=await r.json();
  for(const m of d.history){
    addMessage(m.text,m.role==='user'?'from-user':'from-bot');
  }
}

async function loadHistoricalAgent(agentId){
  const url = agentUrl.replace('AGENT_ID', agentId);
  const r = await fetch(url);
  if(!r.ok){
    showError('Failed to load historical agent: ' + agentId);
    return;
  }
  const d = await r.json();
  
  // Load chat history first
  for(const m of d.history){
    addMessage(m.text, m.role==='user'?'from-user':'from-bot');
  }
  
  // Then replay events
  for(const event of d.events){
    handleHistoricalEvent(event);
  }
}

function handleHistoricalEvent(event){
  if(event.event === 'tool_start'){
    // Handle search tools with special event cards
    if(event.args && event.args.query){
      let idx='summaries';
      if(event.tool.includes('event')) idx='events';
      else if(event.tool.includes('transcript')) idx='transcripts';
      const q=event.args.query+(idx==='summaries'?'':' index:'+idx);
      const url=searchBase+'#q='+encodeURIComponent(q);
      addEventCard('Search '+event.args.query,url);
    } else {
      // Handle all other tools with placards
      addToolPlacard(event.tool, event.args);
    }
  } else if(event.event === 'thinking'){
    // Handle thinking events
    addThinkingCard(event.summary, event.model || 'unknown');
  }
}

// Disable input and controls if viewing historical agent
if(isHistorical){
  form.style.display = 'none';
  // Add a notice that this is historical
  const notice = document.createElement('div');
  notice.style.cssText = 'background:#fff3cd;border:1px solid #ffeaa7;padding:0.75rem;margin:1rem;border-radius:4px;text-align:center;color:#856404;';
  notice.textContent = `Viewing historical agent run: ${fragment} (read-only)`;
  document.querySelector('.container').insertBefore(notice, messagesDiv);
  
  loadHistoricalAgent(fragment);
} else {
  // Live mode - enable normal functionality
  document.getElementById('clearBtn').onclick=async()=>{
    await fetch(clearUrl,{method:'POST'});
    messagesDiv.innerHTML='';
    input.focus();
  };

  backendSelect.addEventListener('change', async ()=>{
    await fetch(clearUrl,{method:'POST'});
    messagesDiv.innerHTML='';
    input.focus();
  });

  appEvents.listen('chat',e=>{
    if(e.event==='tool_start'){
      // Handle search tools with special event cards
      if(e.args&&e.args.query){
        let idx='summaries';
        if(e.tool.includes('event')) idx='events';
        else if(e.tool.includes('transcript')) idx='transcripts';
        const q=e.args.query+(idx==='summaries'?'':' index:'+idx);
        const url=searchBase+'#q='+encodeURIComponent(q);
        addEventCard('Search '+e.args.query,url);
      } else {
        // Handle all other tools with placards
        addToolPlacard(e.tool, e.args);
      }
    } else if(e.event==='thinking'){
      // Handle thinking events
      addThinkingCard(e.summary, e.model || 'unknown');
    }
  });

  loadHistory();
}
</script>
{% endblock %}

