{% extends 'base.html' %}
{% set title = 'Chat' %}
{% set active = 'chat' %}
{% block head %}
<style>
body {height:100vh; overflow:hidden;}
.container {height:100vh; display:flex; flex-direction:column; position:relative; padding:0 1em;}
#messages {flex:1; overflow-y:auto; padding:1em; padding-bottom:0; display:flex; flex-direction:column;}
.message {margin-bottom:0.75em; padding:0.5em 0.75em; border-radius:8px; max-width:80%;}
.from-user {background:#dcf8c6; align-self:flex-end;}
.from-bot {background:#f1f0f0; align-self:flex-start;}
#drawer {display:none; border-top:1px solid #ddd; padding:0.5em; background:#fafafa;}
.input-tray {position:sticky; bottom:0; background:white; border-top:1px solid #ddd; padding:1em; box-shadow:0 -2px 10px rgba(0,0,0,0.1);}
#inputArea {display:flex; gap:0.5em;}
#inputArea textarea {flex:1; resize:none; padding:0.75em; border-radius:12px; border:1px solid #ccc; font-family:inherit; outline:none; box-sizing:border-box;}
#inputArea textarea:focus {border-color:#007bff; box-shadow:0 0 0 2px rgba(0,123,255,0.25);}
#inputArea button {padding:0.75em 1.5em; background:#007bff; color:white; border:none; border-radius:12px; cursor:pointer; font-weight:500;}
#inputArea button:hover {background:#0056b3;}
#inputArea button:disabled {background:#ccc; cursor:not-allowed;}
</style>
{% endblock %}
{% block body %}
<div class="container">
  <div id="messages"></div>
  <div id="drawer">Attachments drawer</div>
  <div class="input-tray">
    <form id="inputArea">
      <textarea id="messageInput" rows="1" placeholder="Send a message..."></textarea>
      <button type="submit">Send</button>
    </form>
  </div>
</div>
<script>
const sendUrl = '{{ url_for('chat.send_message') }}';
const form = document.getElementById('inputArea');
const input = document.getElementById('messageInput');
const messagesDiv = document.getElementById('messages');

input.focus();

input.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    form.requestSubmit();
  }
});
function addMessage(text, cls){
  const div=document.createElement('div');
  div.className='message '+cls;
  div.textContent=text;
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop=messagesDiv.scrollHeight;
}
document.getElementById('inputArea').onsubmit=async e=>{
  e.preventDefault();
  const text=input.value.trim();
  if(!text)return;
  addMessage(text,'from-user');
  input.value='';
  const r=await fetch(sendUrl,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:text})});
  if(r.ok){const d=await r.json();addMessage(d.text,'from-bot');}else{addMessage('Error','from-bot');}
};
</script>
{% endblock %}

