<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>{{ title }}</title>
  <link rel="stylesheet" href="{{ url_for('review.static', filename='review.css') }}">
  {% block head %}{% endblock %}
</head>
<body>
  <div class="nav-icons">
    <a id="homeIcon" href="{{ url_for('review.home') }}" class="{% if active=='home' %}current{% endif %}" title="Home">ğŸ </a>
    <a href="{{ url_for('calendar.calendar_page') }}" class="{% if active=='calendar' %}current{% endif %}" title="Calendar">ğŸ“…</a>
    <a href="{{ url_for('chat.chat_page') }}" class="{% if active=='chat' %}current{% endif %}" title="Chat">ğŸ’¬</a>
    <a href="{{ url_for('agents.agents_page') }}" class="{% if active=='agents' %}current{% endif %}" title="Agents">ğŸš€</a>
    <a href="{{ url_for('search.search_page') }}" class="{% if active=='search' %}current{% endif %}" title="Search">ğŸ”</a>
    <a href="{{ url_for('live.live_page') }}" class="{% if active=='live' %}current{% endif %}" title="Live">ğŸ¤</a>
    <a href="{{ url_for('import_view.import_page') }}" class="{% if active=='import' %}current{% endif %}" title="Import">ğŸ“¥</a>
    <a href="{{ url_for('entities.entities') }}" class="{% if active=='entities' %}current{% endif %}" title="Entities">ğŸ“‘</a>
    <a href="{{ url_for('tasks.tasks_page') }}" class="{% if active=='tasks' %}current{% endif %}" title="Tasks">â³</a>
    <a href="{{ url_for('admin.admin_page') }}" class="{% if active=='admin' %}current{% endif %}" title="Admin">âš™ï¸</a>
    <a href="{{ url_for('review.logout') }}" title="Logout">ğŸ”’</a>
  </div>
  <script>
  (function(){
    const listeners = {};
    let ws;
    let retry = 1000;
    const home = document.getElementById('homeIcon');
    function connect(){
      ws = new WebSocket(`ws://${location.host}/ws/events`);
      ws.onopen = () => {
        if(home) home.classList.add('connected');
        retry = 1000;
      };
      ws.onclose = () => {
        if(home) home.classList.remove('connected');
        retry = Math.min(retry * 1.5, 15000);
        setTimeout(connect, retry);
      };
      ws.onmessage = e => {
        let m;
        try { m = JSON.parse(e.data); } catch(err) { return; }
        if(m.view && listeners[m.view]){
          listeners[m.view].forEach(fn => fn(m));
        }
      };
    }
    connect();
    window.appEvents = {
      listen(view, fn){
        if(!listeners[view]) listeners[view] = [];
        listeners[view].push(fn);
      }
    };
  })();
  </script>
{% block body %}{% endblock %}
  <div id="errorModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <pre id="errorMessage"></pre>
    </div>
  </div>
  <script>
    (function(){
      const home = document.getElementById('homeIcon');
      if(home){
        window.addEventListener('error', () => home.classList.add('error'));
        window.addEventListener('unhandledrejection', () => home.classList.add('error'));
      }
    })();
  </script>
  <script>
    (function(){
      const modal=document.getElementById('errorModal');
      const close=modal.querySelector('.close');
      const msg=document.getElementById('errorMessage');
      window.showError=text=>{msg.textContent=text;modal.style.display='block';};
      close.onclick=()=>{modal.style.display='none';};
      window.addEventListener('click',e=>{if(e.target===modal)modal.style.display='none';});
    })();
  </script>
</body>
</html>
