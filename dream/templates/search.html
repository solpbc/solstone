{% extends 'base.html' %}
{% set title = 'Search' %}
{% set active = 'search' %}
{% block head %}
<style>
.container { padding: 0 1em; }
#resultsTable { width:100%; border-collapse:collapse; margin-top:1em; }
#resultsTable th, #resultsTable td { padding:8px; border-bottom:1px solid #ddd; }
#resultsTable td.date-cell { white-space:nowrap; cursor:pointer; }
#resultsTable td.preview-cell { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:60vw; }
#resultsTable th { background:#f8f9fa; text-align:left; }
.slug-link { font-weight:bold; text-decoration:none; }
.load-more { margin-top:1em; padding:6px 12px; background:#007bff; color:white; border:none; border-radius:4px; cursor:pointer; }
</style>
{% endblock %}
{% block body %}
<div class="container">
  <form id="searchForm" class="input-area">
    <input id="query" type="text" placeholder="Search" />
    <button type="submit">Search</button>
  </form>
  <div class="tabs">
    <div class="tab active" data-index="summaries">Summaries</div>
    <div class="tab" data-index="events">Events</div>
    <div class="tab" data-index="transcripts">Transcripts</div>
  </div>
  <table id="resultsTable" style="display:none">
    <thead></thead>
    <tbody></tbody>
  </table>
  <button id="loadMore" class="load-more" style="display:none"></button>
</div>
<script src="{{ url_for('review.static', filename='colors.js') }}"></script>
<script>
const topicUrl = '{{ url_for('search.search_topic_api') }}';
const occUrl = '{{ url_for('search.search_occurrence_api') }}';
const rawUrl = '{{ url_for('search.search_raw_api') }}';
const dayBase = '{{ url_for('calendar.calendar_day', day='') }}';
const COLORS = window.CATEGORY_COLORS;
  let topicColors = {};
  let colorIndex = 0;
  let query = '';
  let offset = 0;
  let total = 0;
  const limit = 20;

const queryInput = document.getElementById('query');
queryInput.focus();

// Initialize from URL
function loadFromHash(){
  const hashParams = new URLSearchParams(window.location.hash.slice(1));
  query = hashParams.get('q') || '';
  if (query) {
    queryInput.value = query;
    doSearch(true);
  }
}
loadFromHash();
window.addEventListener('hashchange', loadFromHash);

function parseQuery(q){
  let day = '';
  let topic = '';
  let index = 'summaries';
  const terms = [];
  q.split(/\s+/).forEach(part => {
    if(part.startsWith('day:')){
      day = part.slice(4);
    } else if(part.startsWith('topic:')){
      topic = part.slice(6);
    } else if(part.startsWith('index:')){
      index = part.slice(6);
    } else if(part){
      terms.push(part);
    }
  });
  return {text: terms.join(' '), day, topic, index};
}
  function getColor(topic){
    if(!topicColors[topic]){ topicColors[topic] = COLORS[colorIndex % COLORS.length]; colorIndex++; }
    return topicColors[topic];
  }
  function addFilter(type, value){
    const parts = queryInput.value.split(/\s+/).filter(p => p && !p.startsWith(type+':'));
    parts.push(`${type}:${value}`);
    queryInput.value = parts.join(' ');
    query = queryInput.value.trim();
    window.location.hash = `q=${encodeURIComponent(query)}`;
    doSearch(true);
  }
  function renderTopicRows(list){
    const tbody = document.querySelector('#resultsTable tbody');
    list.forEach(item => {
      const tr = document.createElement('tr');
      const tdDate = document.createElement('td');
      tdDate.className = 'date-cell';
      const dlink = document.createElement('a');
      dlink.href = dayBase + item.day;
      dlink.textContent = item.date;
      dlink.onclick = e => {
        if(!(e.ctrlKey||e.metaKey||e.shiftKey)){
          e.preventDefault();
          addFilter('day', item.day);
        }
      };
      tdDate.appendChild(dlink);
      const tdTopic = document.createElement('td');
      const link = document.createElement('a');
      link.className = 'slug-link';
      link.href = dayBase + item.day + '#' + item.topic;
      link.textContent = item.topic;
      link.style.color = item.color || getColor(item.topic);
      link.onclick = e => {
        if(!(e.ctrlKey||e.metaKey||e.shiftKey)){
          e.preventDefault();
          addFilter('topic', item.topic);
        }
      };
      tdTopic.appendChild(link);
      const tdText = document.createElement('td');
      tdText.innerHTML = item.text;
      tr.appendChild(tdDate); tr.appendChild(tdTopic); tr.appendChild(tdText);
      tbody.appendChild(tr);
  });
}

  function renderEventRows(list){
    const tbody = document.querySelector('#resultsTable tbody');
    list.forEach(item => {
      const tr = document.createElement('tr');
      const tdDate = document.createElement('td');
      tdDate.className = 'date-cell';
      const dlink = document.createElement('a');
      dlink.href = dayBase + item.day;
      dlink.textContent = item.date;
      dlink.onclick = e => {
        if(!(e.ctrlKey||e.metaKey||e.shiftKey)){
          e.preventDefault();
          addFilter('day', item.day);
        }
      };
      tdDate.appendChild(dlink);
      const tdTopic = document.createElement('td');
      const link = document.createElement('a');
      link.className = 'slug-link';
      link.href = dayBase + item.day + '#' + item.topic;
      link.textContent = item.topic;
      link.style.color = item.color || getColor(item.topic);
      link.onclick = e => {
        if(!(e.ctrlKey||e.metaKey||e.shiftKey)){
          e.preventDefault();
          addFilter('topic', item.topic);
        }
      };
      tdTopic.appendChild(link);
      const tdStart = document.createElement('td');
      tdStart.textContent = item.start;
      const tdLen = document.createElement('td');
      tdLen.textContent = item.length;
      const tdText = document.createElement('td');
      tdText.innerHTML = item.text;
      tr.appendChild(tdDate); tr.appendChild(tdTopic); tr.appendChild(tdStart);
      tr.appendChild(tdLen); tr.appendChild(tdText);
    tbody.appendChild(tr);
    });
  }

  function renderRawRows(list){
    const tbody = document.querySelector('#resultsTable tbody');
    list.forEach(item => {
      const tr = document.createElement('tr');
      const tdDate = document.createElement('td');
      tdDate.className = 'date-cell';
      const dlink = document.createElement('a');
      dlink.href = dayBase + item.day;
      dlink.textContent = item.date;
      dlink.onclick = e => {
        if(!(e.ctrlKey||e.metaKey||e.shiftKey)){
          e.preventDefault();
          addFilter('day', item.day);
        }
      };
      tdDate.appendChild(dlink);
      const tdTime = document.createElement('td');
      tdTime.textContent = item.time;
      const tdType = document.createElement('td');
      tdType.textContent = item.type;
      const tdPrev = document.createElement('td');
      tdPrev.className = 'preview-cell';
      tdPrev.textContent = item.preview;
      tr.appendChild(tdDate); tr.appendChild(tdTime); tr.appendChild(tdType); tr.appendChild(tdPrev);
      tbody.appendChild(tr);
    });
  }

  function setHeaders(index){
    const thead=document.querySelector('#resultsTable thead');
    if(index==='events'){
      thead.innerHTML='<tr><th>Date</th><th>Topic</th><th>Start</th><th>Length</th><th>Summary</th></tr>';
    } else if(index==='transcripts'){
      thead.innerHTML='<tr><th>Date</th><th>Time</th><th>Type</th><th class="preview-col">Preview</th></tr>';
    } else {
      thead.innerHTML='<tr><th>Date</th><th>Topic</th><th>Sentence</th></tr>';
    }
  }

  function updateTabs(index){
    document.querySelectorAll('.tab').forEach(t=>{
      t.classList.toggle('active', t.dataset.index===index);
    });
  }
function updateLoadMore(){
  const btn = document.getElementById('loadMore');
  if(offset < total){
    btn.textContent = `Load More (${offset}/${total})`;
    btn.style.display = 'block';
  } else {
    btn.style.display = 'none';
  }
}
function doSearch(reset=true){
  const parsed = parseQuery(query);
  if(reset){ offset = 0; topicColors = {}; colorIndex=0; document.querySelector('#resultsTable tbody').innerHTML=''; }
  setHeaders(parsed.index);
  updateTabs(parsed.index);
  let api = topicUrl;
  if(parsed.index==='events') api = occUrl;
  else if(parsed.index==='transcripts') api = rawUrl;
  const url = new URL(api, window.location.origin);
  url.searchParams.set('q', parsed.text);
  if(parsed.day) url.searchParams.set('day', parsed.day);
  if(parsed.topic && parsed.index!=='transcripts') url.searchParams.set('topic', parsed.topic);
  url.searchParams.set('limit', limit);
  url.searchParams.set('offset', offset);
  fetch(url)
    .then(r=>r.json()).then(d=>{
      total = d.total || 0;
      if(parsed.index==='events'){ renderEventRows(d.results || []); }
      else if(parsed.index==='transcripts'){ renderRawRows(d.results || []); }
      else { renderTopicRows(d.results || []); }
      document.getElementById('resultsTable').style.display = 'table';
      offset += d.results.length;
      updateLoadMore();
    });
}
document.getElementById('searchForm').onsubmit = e => {
  e.preventDefault();
  query = queryInput.value.trim();
  if (!query) return;
  window.location.hash = `q=${encodeURIComponent(query)}`;
  doSearch(true);
};
document.getElementById('loadMore').onclick = () => doSearch(false);
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    const idx = tab.dataset.index;
    const parts = queryInput.value.split(/\s+/).filter(p => p && !p.startsWith('index:'));
    if(idx !== 'summaries') parts.push('index:' + idx);
    queryInput.value = parts.join(' ');
    query = queryInput.value.trim();
    window.location.hash = `q=${encodeURIComponent(query)}`;
    doSearch(true);
  });
});
</script>
{% endblock %}
