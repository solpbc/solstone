{% extends 'base.html' %}
{% set title = 'Search' %}
{% set active = 'search' %}
{% block head %}
<style>
.container { padding: 0 1em; }
#resultsTable { width:100%; border-collapse:collapse; margin-top:1em; }
#resultsTable th, #resultsTable td { padding:8px; border-bottom:1px solid #ddd; }
#resultsTable td.date-cell { white-space:nowrap; cursor:pointer; }
#resultsTable th { background:#f8f9fa; text-align:left; }
.slug-link { font-weight:bold; text-decoration:none; }
.load-more { margin-top:1em; padding:6px 12px; background:#007bff; color:white; border:none; border-radius:4px; cursor:pointer; }
</style>
{% endblock %}
{% block body %}
<div class="container">
  <form id="searchForm" class="input-area">
    <input id="query" type="text" placeholder="Search" />
    <button type="submit">Search</button>
  </form>
  <table id="resultsTable" style="display:none">
    <thead>
      <tr><th>Date</th><th>Topic</th><th>Sentence</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <button id="loadMore" class="load-more" style="display:none"></button>
</div>
<script src="{{ url_for('review.static', filename='colors.js') }}"></script>
<script>
const topicUrl = '{{ url_for('search.search_topic_api') }}';
const dayBase = '{{ url_for('calendar.calendar_day', day='') }}';
const COLORS = window.CATEGORY_COLORS;
let topicColors = {};
let colorIndex = 0;
let query = '';
let offset = 0;
let total = 0;
const limit = 20;

const queryInput = document.getElementById('query');
queryInput.focus();

// Initialize from URL
function loadFromHash(){
  const hashParams = new URLSearchParams(window.location.hash.slice(1));
  query = hashParams.get('q') || '';
  if (query) {
    queryInput.value = query;
    doSearch(true);
  }
}
loadFromHash();
window.addEventListener('hashchange', loadFromHash);

function parseQuery(q){
  let day = '';
  let topic = '';
  const terms = [];
  q.split(/\s+/).forEach(part => {
    if(part.startsWith('day:')){
      day = part.slice(4);
    } else if(part.startsWith('topic:')){
      topic = part.slice(6);
    } else if(part){
      terms.push(part);
    }
  });
  return {text: terms.join(' '), day, topic};
}
function getColor(topic){
  if(!topicColors[topic]){ topicColors[topic] = COLORS[colorIndex % COLORS.length]; colorIndex++; }
  return topicColors[topic];
}
function renderRows(list){
  const tbody = document.querySelector('#resultsTable tbody');
  list.forEach(item => {
    const tr = document.createElement('tr');
    const tdDate = document.createElement('td');
    tdDate.className = 'date-cell';
    tdDate.textContent = item.date;
    tdDate.onclick = () => { window.location = dayBase + item.day; };
  const tdTopic = document.createElement('td');
    const link = document.createElement('a');
    link.className = 'slug-link';
    link.href = dayBase + item.day + '#' + item.topic;
    link.textContent = item.topic;
    link.style.color = item.color || getColor(item.topic);
    tdTopic.appendChild(link);
    const tdText = document.createElement('td');
    tdText.innerHTML = item.text;
    tr.appendChild(tdDate); tr.appendChild(tdTopic); tr.appendChild(tdText);
    tbody.appendChild(tr);
  });
}
function updateLoadMore(){
  const btn = document.getElementById('loadMore');
  if(offset < total){
    btn.textContent = `Load More (${offset}/${total})`;
    btn.style.display = 'block';
  } else {
    btn.style.display = 'none';
  }
}
function doSearch(reset=true){
  const parsed = parseQuery(query);
  if(reset){ offset = 0; topicColors = {}; colorIndex=0; document.querySelector('#resultsTable tbody').innerHTML=''; }
  const url = new URL(topicUrl, window.location.origin);
  url.searchParams.set('q', parsed.text);
  if(parsed.day) url.searchParams.set('day', parsed.day);
  if(parsed.topic) url.searchParams.set('topic', parsed.topic);
  url.searchParams.set('limit', limit);
  url.searchParams.set('offset', offset);
  fetch(url)
    .then(r=>r.json()).then(d=>{
      total = d.total || 0;
      renderRows(d.results || []);
      document.getElementById('resultsTable').style.display = 'table';
      offset += d.results.length;
      updateLoadMore();
    });
}
document.getElementById('searchForm').onsubmit = e => {
  e.preventDefault();
  query = queryInput.value.trim();
  if (!query) return;
  window.location.hash = `q=${encodeURIComponent(query)}`;
  doSearch(true);
};
document.getElementById('loadMore').onclick = () => doSearch(false);
</script>
{% endblock %}
