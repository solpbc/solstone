{% extends 'base.html' %}
{% set title = 'Agents' %}
{% set active = 'agents' %}
{% block head %}
<style>
.container { padding: 0 1em; }

/* Agent Cards */
.agent-cards {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 1rem;
  margin-bottom: 2rem;
}

.agent-card {
  background: white;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  padding: 1rem;
  cursor: pointer;
  transition: all 0.2s ease;
  position: relative;
}

.agent-card:hover {
  border-color: #007bff;
  box-shadow: 0 2px 8px rgba(0, 123, 255, 0.1);
}

.agent-card.selected {
  border-color: #007bff;
  background: #f8f9ff;
  box-shadow: 0 0 0 1px #007bff;
}

.agent-card h3 {
  margin: 0 0 0.5rem 0;
  font-size: 1.1rem;
  color: #333;
}

.agent-card p {
  margin: 0;
  color: #666;
  font-size: 0.9rem;
  line-height: 1.4;
}

.agent-card .view-details {
  position: absolute;
  top: 0.5rem;
  right: 0.5rem;
  background: #f0f0f0;
  border: none;
  border-radius: 4px;
  padding: 0.25rem 0.5rem;
  font-size: 0.75rem;
  cursor: pointer;
  opacity: 0;
  transition: opacity 0.2s ease;
}

.agent-card:hover .view-details {
  opacity: 1;
}

.agent-card .view-details:hover {
  background: #007bff;
  color: white;
}

/* Input Form */
.input-area {
  display: flex;
  gap: 0.5rem;
  align-items: flex-end;
  margin-bottom: 2rem;
}

.input-area textarea {
  flex: 1;
  padding: 0.75rem;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-family: inherit;
  resize: vertical;
}

.input-area button {
  padding: 0.75rem 1.5rem;
  background: #007bff;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 1.2rem;
}

.input-area button:disabled {
  background: #ccc;
  cursor: not-allowed;
}

.input-area button:hover:not(:disabled) {
  background: #0056b3;
}

.input-area.busy {
  position: relative;
}

.input-area.busy::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(255, 255, 255, 0.8);
  cursor: wait;
  z-index: 10;
}

.input-area.busy textarea,
.input-area.busy button {
  pointer-events: none;
}

.planning-status {
  margin-top: 0.5rem;
  padding: 0.5rem;
  background: #e3f2fd;
  border: 1px solid #90caf9;
  border-radius: 4px;
  font-size: 0.9rem;
  display: none;
}

.planning-status.show {
  display: block;
}

.selection-status {
  font-size: 0.9rem;
  color: #666;
  margin-bottom: 1rem;
}

.selection-status.required {
  color: #dc3545;
  font-weight: 500;
}

/* Session History Table */
table { 
  border-collapse: collapse; 
  width: 100%; 
  table-layout: fixed; 
  margin-top: 2rem;
}
th, td { 
  padding: 4px 8px; 
  border-bottom: 1px solid #ddd; 
  white-space: nowrap; 
}
td:last-child { 
  overflow: hidden; 
  text-overflow: ellipsis; 
}
tr:hover {
  background-color: #f8f9fa;
}
tr a {
  color: #007bff;
  text-decoration: none;
}
tr a:hover {
  text-decoration: underline;
}

/* Status indicators */
.status-badge {
  display: inline-block;
  padding: 2px 6px;
  border-radius: 3px;
  font-size: 0.75rem;
  font-weight: 500;
  text-transform: uppercase;
  margin-right: 0.5rem;
}

.status-running {
  background-color: #d4edda;
  color: #155724;
}

.status-finished {
  background-color: #d1ecf1;
  color: #0c5460;
}

.status-error {
  background-color: #f8d7da;
  color: #721c24;
}

.status-unknown {
  background-color: #e2e3e5;
  color: #383d41;
}

/* Pagination */
.pagination {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 0.5rem;
  margin-top: 1rem;
  padding: 1rem;
}

.pagination button {
  padding: 0.5rem 1rem;
  border: 1px solid #ddd;
  background: white;
  cursor: pointer;
  border-radius: 4px;
  transition: all 0.2s ease;
}

.pagination button:hover:not(:disabled) {
  background: #007bff;
  color: white;
  border-color: #007bff;
}

.pagination button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.pagination .page-info {
  margin: 0 1rem;
  font-size: 0.9rem;
  color: #666;
}

/* Modal Styling (reused from entities.html) */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
}

.modal-content {
  background-color: white;
  margin: 5% auto;
  border-radius: 8px;
  width: 90%;
  max-width: 800px;
  max-height: 80vh;
  position: relative;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  overflow: hidden;
}

.close {
  color: #aaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
  line-height: 1;
  position: absolute;
  top: 15px;
  right: 20px;
  background: white;
  z-index: 3;
}

.close:hover { 
  color: #000; 
}

.modal-header {
  padding: 20px 40px 15px 20px;
  border-bottom: 1px solid #e0e0e0;
  background: white;
  border-radius: 8px 8px 0 0;
}

.modal-header h3 { 
  margin: 0; 
  color: #333; 
}

.modal-body {
  max-height: calc(80vh - 80px);
  overflow-y: auto;
  padding: 20px;
}

.modal-body .markdown-content h1,
.modal-body .markdown-content h2,
.modal-body .markdown-content h3,
.modal-body .markdown-content h4,
.modal-body .markdown-content h5,
.modal-body .markdown-content h6 {
  margin-top: 1.5rem;
  margin-bottom: 0.75rem;
  color: #333;
}

.modal-body .markdown-content p {
  margin-bottom: 1rem;
  line-height: 1.6;
}

.modal-body .markdown-content ul,
.modal-body .markdown-content ol {
  margin-bottom: 1rem;
  padding-left: 2rem;
}

.modal-body .markdown-content code {
  background: #f8f9fa;
  padding: 0.2rem 0.4rem;
  border-radius: 3px;
  font-family: 'Courier New', monospace;
}

.modal-body .markdown-content pre {
  background: #f8f9fa;
  padding: 1rem;
  border-radius: 4px;
  overflow-x: auto;
  margin-bottom: 1rem;
}

/* Planning Modal Tabs */
.modal-tabs {
  display: flex;
  border-bottom: 1px solid #e0e0e0;
  margin: -20px -20px 20px -20px;
  background: #f8f9fa;
}

.modal-tab {
  padding: 12px 20px;
  cursor: pointer;
  border: none;
  background: none;
  font-size: 0.9rem;
  color: #666;
  transition: all 0.2s ease;
  flex: 1;
  text-align: center;
}

.modal-tab:hover {
  background: #e9ecef;
  color: #333;
}

.modal-tab.active {
  color: #007bff;
  background: white;
  border-bottom: 2px solid #007bff;
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

.plan-editor {
  width: 100%;
  min-height: 400px;
  border: 1px solid #ddd;
  border-radius: 4px;
  padding: 1rem;
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
  font-size: 0.9rem;
  line-height: 1.4;
  resize: vertical;
}

.config-section {
  margin-bottom: 1.5rem;
}

.config-section label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 500;
  color: #333;
}

.config-section select,
.config-section input {
  width: 100%;
  padding: 0.5rem;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 0.9rem;
}

.start-agent-btn {
  background: #28a745;
  color: white;
  border: none;
  padding: 0.75rem 2rem;
  border-radius: 4px;
  cursor: pointer;
  font-size: 1rem;
  margin-top: 1rem;
}

.start-agent-btn:hover {
  background: #218838;
}

.start-agent-btn:disabled {
  background: #6c757d;
  cursor: not-allowed;
}
</style>
{% endblock %}
{% block body %}
<div class="container">
  <h1>Agents</h1>
  
  <!-- Agent Selection Cards -->
  <div id="agentCards" class="agent-cards"></div>
  
  <!-- Input Form -->
  <form id="agentForm" class="input-area">
    <textarea id="agentInput" rows="3" placeholder="Describe what you want to accomplish..."></textarea>
    <button type="submit">‚ú® Create Plan</button>
  </form>
  
  <!-- Planning Status -->
  <div id="planningStatus" class="planning-status">
    <div>üß† Creating execution plan...</div>
  </div>
  
  <!-- Session History -->
  <table id="agentTable"></table>
  
  <!-- Pagination -->
  <div id="pagination" class="pagination" style="display: none;">
    <button id="prevBtn" onclick="changePage(-1)">Previous</button>
    <div class="page-info">
      <span id="pageInfo">Page 1 of 1</span>
    </div>
    <button id="nextBtn" onclick="changePage(1)">Next</button>
  </div>
</div>

<!-- Agent Details Modal -->
<div id="agentModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <div class="modal-header">
      <h3 id="modalTitle"></h3>
    </div>
    <div class="modal-body">
      <div id="modalContent" class="markdown-content"></div>
    </div>
  </div>
</div>

<!-- Planning Modal -->
<div id="planningModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closePlanningModal()">&times;</span>
    <div class="modal-header">
      <h3>Agent Execution Plan</h3>
    </div>
    <div class="modal-body">
      <!-- Tabs -->
      <div class="modal-tabs">
        <button class="modal-tab active" onclick="switchTab('plan')">Edit Plan</button>
        <button class="modal-tab" onclick="switchTab('preview')">Preview</button>
        <button class="modal-tab" onclick="switchTab('config')">Configuration</button>
      </div>
      
      <!-- Tab Content -->
      <div id="planTab" class="tab-content active">
        <textarea id="planEditor" class="plan-editor" placeholder="Your execution plan will appear here..."></textarea>
      </div>
      
      <div id="previewTab" class="tab-content">
        <div id="planPreview" class="markdown-content"></div>
      </div>
      
      <div id="configTab" class="tab-content">
        <p style="font-size: 0.9rem; color: #666; margin-bottom: 1rem;">
          <em>Note: Plan generation uses Gemini. Configuration below applies to agent execution.</em>
        </p>
        
        <div class="config-section">
          <label for="agentBackend">Agent Backend</label>
          <select id="agentBackend">
            <option value="openai">OpenAI</option>
            <option value="anthropic">Anthropic</option>
            <option value="google">Google</option>
          </select>
        </div>
        
        <div class="config-section">
          <label for="agentModel">Model (optional)</label>
          <input type="text" id="agentModel" placeholder="Leave empty for default">
        </div>
        
        <div class="config-section">
          <label for="maxTokens">Max Tokens</label>
          <input type="number" id="maxTokens" placeholder="0 for default" min="0">
        </div>
        
        <div class="config-section">
          <label for="agentPersona">Persona</label>
          <select id="agentPersona">
            <option value="default">Default</option>
          </select>
        </div>
        
        <button id="startAgentBtn" class="start-agent-btn" onclick="startAgent()">
          üöÄ Start Agent
        </button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
let availableAgents = [];

// Load available agents and render cards
function loadAvailableAgents() {
  fetch('{{ url_for('agents.available_agents') }}')
    .then(r => r.json())
    .then(agents => {
      availableAgents = agents;
      renderAgentCards();
    });
}

// Render agent selection cards (for viewing details only)
function renderAgentCards() {
  const container = document.getElementById('agentCards');
  container.innerHTML = '';
  
  availableAgents.forEach(agent => {
    const card = document.createElement('div');
    card.className = 'agent-card';
    card.dataset.agentId = agent.id;
    card.innerHTML = `
      <button class="view-details" onclick="viewAgentDetails('${agent.id}', event)">View Details</button>
      <h3>${agent.title}</h3>
      <p>${agent.description}</p>
    `;
    
    card.addEventListener('click', (e) => {
      if (!e.target.classList.contains('view-details')) {
        viewAgentDetails(agent.id, e);
      }
    });
    
    container.appendChild(card);
  });
}

// View agent details in modal
function viewAgentDetails(agentId, event) {
  event.stopPropagation();
  
  const agent = availableAgents.find(a => a.id === agentId);
  if (!agent) return;
  
  document.getElementById('modalTitle').textContent = agent.title;
  document.getElementById('modalContent').innerHTML = '<p>Loading...</p>';
  document.getElementById('agentModal').style.display = 'block';
  
  // Load and render agent content
  fetch(`{{ url_for('agents.agent_content', agent_id='') }}${agentId}`)
    .then(r => r.json())
    .then(data => {
      if (data.error) {
        document.getElementById('modalContent').innerHTML = `<p>Error: ${data.error}</p>`;
      } else {
        // Convert markdown to HTML
        const html = marked.parse(data.content);
        document.getElementById('modalContent').innerHTML = html;
      }
    })
    .catch(err => {
      document.getElementById('modalContent').innerHTML = `<p>Error loading content: ${err.message}</p>`;
    });
}

// Form submission
document.getElementById('agentForm').onsubmit = function(e) {
  e.preventDefault();
  
  const input = document.getElementById('agentInput');
  if (!input.value.trim()) {
    showError('Please describe what you want to accomplish.');
    return;
  }
  
  // Start planning process
  createPlan(input.value.trim());
};

// Create plan from user input
async function createPlan(userRequest) {
  const form = document.getElementById('agentForm');
  const status = document.getElementById('planningStatus');
  
  // Show busy state
  form.classList.add('busy');
  status.classList.add('show');
  
  try {
    const response = await fetch('{{ url_for('agents.create_plan') }}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        request: userRequest,
        model: '' // Uses Gemini Pro by default
      })
    });
    
    const data = await response.json();
    
    if (!response.ok) {
      throw new Error(data.error || 'Failed to create plan');
    }
    
    // Show planning modal with the plan
    showPlanningModal(data.plan);
    
  } catch (error) {
    showError('Error creating plan: ' + error.message);
  } finally {
    // Remove busy state
    form.classList.remove('busy');
    status.classList.remove('show');
  }
}

// Show planning modal with plan
function showPlanningModal(plan) {
  const modal = document.getElementById('planningModal');
  const editor = document.getElementById('planEditor');
  
  // Set the plan in the editor
  editor.value = plan;
  
  // Update preview
  updatePreview();
  
  // Load available personas
  loadPersonas();
  
  // Show modal
  modal.style.display = 'block';
}

// Close planning modal
function closePlanningModal() {
  document.getElementById('planningModal').style.display = 'none';
}

// Switch between tabs
function switchTab(tabName) {
  // Update tab buttons
  document.querySelectorAll('.modal-tab').forEach(tab => {
    tab.classList.remove('active');
  });
  event.target.classList.add('active');
  
  // Update tab content
  document.querySelectorAll('.tab-content').forEach(content => {
    content.classList.remove('active');
  });
  document.getElementById(tabName + 'Tab').classList.add('active');
  
  // Update preview if switching to preview tab
  if (tabName === 'preview') {
    updatePreview();
  }
}

// Update markdown preview
function updatePreview() {
  const editor = document.getElementById('planEditor');
  const preview = document.getElementById('planPreview');
  
  if (editor.value.trim()) {
    preview.innerHTML = marked.parse(editor.value);
  } else {
    preview.innerHTML = '<p><em>No plan content to preview</em></p>';
  }
}

// Load available personas
function loadPersonas() {
  fetch('{{ url_for('agents.available_agents') }}')
    .then(r => r.json())
    .then(agents => {
      const select = document.getElementById('agentPersona');
      select.innerHTML = '<option value="default">Default</option>';
      
      agents.forEach(agent => {
        const option = document.createElement('option');
        option.value = agent.id;
        option.textContent = agent.title;
        select.appendChild(option);
      });
    })
    .catch(err => {
      console.error('Failed to load personas:', err);
    });
}

// Start agent with current plan and config
async function startAgent() {
  const plan = document.getElementById('planEditor').value.trim();
  if (!plan) {
    showError('Please provide a plan before starting the agent.');
    return;
  }
  
  const backend = document.getElementById('agentBackend').value;
  const model = document.getElementById('agentModel').value.trim();
  const maxTokens = parseInt(document.getElementById('maxTokens').value) || 0;
  const persona = document.getElementById('agentPersona').value;
  
  const startBtn = document.getElementById('startAgentBtn');
  startBtn.disabled = true;
  startBtn.textContent = 'üöÄ Starting...';
  
  try {
    const response = await fetch('{{ url_for('agents.start_agent') }}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        plan: plan,
        backend: backend,
        model: model,
        max_tokens: maxTokens,
        persona: persona
      })
    });
    
    const data = await response.json();
    
    if (!response.ok) {
      throw new Error(data.error || 'Failed to start agent');
    }
    
    // Success - close modal and reload agents
    closePlanningModal();
    loadAgentSessions();
    
    // Clear the input form
    document.getElementById('agentInput').value = '';
    
  } catch (error) {
    showError('Error starting agent: ' + error.message);
  } finally {
    startBtn.disabled = false;
    startBtn.textContent = 'üöÄ Start Agent';
  }
}

// Modal close functionality
document.querySelector('.close').onclick = function() {
  document.getElementById('agentModal').style.display = 'none';
};

window.onclick = function(event) {
  const agentModal = document.getElementById('agentModal');
  const planningModal = document.getElementById('planningModal');
  
  if (event.target == agentModal) {
    agentModal.style.display = 'none';
  }
  if (event.target == planningModal) {
    planningModal.style.display = 'none';
  }
};

// Pagination state
let currentPage = 0;
let pageSize = 10;
let totalAgents = 0;

// Session history table functions
function buildRow(a) {
  const tr = document.createElement('tr');
  const short = a.prompt.length > 80 ? a.prompt.slice(0, 80) + '‚Ä¶' : a.prompt;
  const chatLink = `{{ url_for('chat.chat_page') }}#${a.id}`;
  
  // Status badge
  const statusClass = `status-${a.status || 'unknown'}`;
  const statusBadge = `<span class="status-badge ${statusClass}">${a.status || 'unknown'}</span>`;
  
  // PID indicator for running agents
  const pidIndicator = a.pid ? ` (PID: ${a.pid})` : '';
  
  tr.innerHTML = `
    <td><a href="${chatLink}">${statusBadge}${a.since}</a></td>
    <td>${a.model}${pidIndicator}</td>
    <td>${a.persona}</td>
    <td title="${a.prompt}"><a href="${chatLink}">${short}</a></td>
  `;
  tr.style.cursor = 'pointer';
  tr.onclick = () => window.location.href = chatLink;
  return tr;
}

function loadAgentSessions(page = 0) {
  const offset = page * pageSize;
  fetch(`{{ url_for('agents.agents_list') }}?limit=${pageSize}&offset=${offset}`)
    .then(r => {
      if (!r.ok) {
        throw new Error(`HTTP ${r.status}: ${r.statusText}`);
      }
      return r.json();
    })
    .then(data => {
      // Check for API error response
      if (data.error) {
        throw new Error(data.error);
      }
      
      const agents = data.agents || [];
      const pagination = data.pagination;
      
      const table = document.getElementById('agentTable');
      table.innerHTML = '<tr><th>Status & Started</th><th>Model</th><th>Persona</th><th>Prompt</th></tr>';
      
      if (agents.length > 0) {
        agents.forEach(a => table.appendChild(buildRow(a)));
      } else {
        const noDataRow = document.createElement('tr');
        noDataRow.innerHTML = '<td colspan="4" style="text-align: center; color: #666;">No agents found</td>';
        table.appendChild(noDataRow);
      }
      
      // Update pagination if available
      if (pagination) {
        currentPage = Math.floor(pagination.offset / pagination.limit);
        totalAgents = pagination.total;
        updatePagination(pagination);
      }
      
      // Hide any previous error warnings
      hideConnectionWarning();
    })
    .catch(err => {
      console.error('Failed to load agents:', err);
      showConnectionWarning(err.message);
      
      // Clear the table and show error
      const table = document.getElementById('agentTable');
      table.innerHTML = '<tr><th>Status & Started</th><th>Model</th><th>Persona</th><th>Prompt</th></tr>';
      const errorRow = document.createElement('tr');
      errorRow.innerHTML = '<td colspan="4" style="text-align: center; color: #dc3545;">Connection error - cortex service unavailable</td>';
      table.appendChild(errorRow);
      
      // Hide pagination on error
      document.getElementById('pagination').style.display = 'none';
    });
}

function updatePagination(pagination) {
  const paginationDiv = document.getElementById('pagination');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const pageInfo = document.getElementById('pageInfo');
  
  if (pagination.total > pagination.limit) {
    paginationDiv.style.display = 'flex';
    
    const currentPageNum = Math.floor(pagination.offset / pagination.limit) + 1;
    const totalPages = Math.ceil(pagination.total / pagination.limit);
    
    pageInfo.textContent = `Page ${currentPageNum} of ${totalPages} (${pagination.total} total)`;
    
    prevBtn.disabled = pagination.offset === 0;
    nextBtn.disabled = !pagination.has_more;
  } else {
    paginationDiv.style.display = 'none';
  }
}

function changePage(delta) {
  const newPage = currentPage + delta;
  if (newPage >= 0) {
    loadAgentSessions(newPage);
  }
}

// Connection warning functions
function showConnectionWarning(message) {
  let warning = document.getElementById('connectionWarning');
  if (!warning) {
    warning = document.createElement('div');
    warning.id = 'connectionWarning';
    warning.style.cssText = 'background:#f8d7da;border:1px solid #f5c6cb;color:#721c24;padding:0.75rem;margin:1rem 0;border-radius:4px;text-align:center;';
    const container = document.querySelector('.container');
    const firstChild = container.children[1]; // Insert after h1
    container.insertBefore(warning, firstChild);
  }
  warning.innerHTML = `‚ö†Ô∏è <strong>Cortex Service Unavailable:</strong> ${message}`;
  warning.style.display = 'block';
}

function hideConnectionWarning() {
  const warning = document.getElementById('connectionWarning');
  if (warning) {
    warning.style.display = 'none';
  }
}

// Initialize
loadAvailableAgents();
loadAgentSessions();
</script>
{% endblock %}
